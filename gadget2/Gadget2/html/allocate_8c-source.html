<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GADGET-2: allocate.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>allocate.c</h1><a href="allocate_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00002 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00003 <span class="preprocessor">#include &lt;string.h&gt;</span>
00004 <span class="preprocessor">#include &lt;math.h&gt;</span>
00005 
00006 <span class="preprocessor">#include "<a class="code" href="allvars_8h.html">allvars.h</a>"</span>
00007 <span class="preprocessor">#include "<a class="code" href="proto_8h.html">proto.h</a>"</span>
00008 
<a name="l00019"></a><a class="code" href="proto_8h.html#a1">00019</a> <span class="keywordtype">void</span> <a class="code" href="allocate_8c.html#a0">allocate_commbuffers</a>(<span class="keywordtype">void</span>)
00020 {
00021   size_t bytes;
00022 
00023   <a class="code" href="allvars_8c.html#a11">Exportflag</a> = malloc(<a class="code" href="allvars_8c.html#a1">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));
00024   <a class="code" href="allvars_8c.html#a23">DomainStartList</a> = malloc(<a class="code" href="allvars_8c.html#a1">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00025   <a class="code" href="allvars_8c.html#a24">DomainEndList</a> = malloc(<a class="code" href="allvars_8c.html#a1">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00026 
00027   <a class="code" href="allvars_8c.html#a38">TopNodes</a> = malloc(<a class="code" href="allvars_8h.html#a2">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structtopnode__data.html">topnode_data</a>));
00028 
00029   <a class="code" href="allvars_8c.html#a25">DomainWork</a> = malloc(<a class="code" href="allvars_8h.html#a2">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00030   <a class="code" href="allvars_8c.html#a26">DomainCount</a> = malloc(<a class="code" href="allvars_8h.html#a2">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00031   <a class="code" href="allvars_8c.html#a27">DomainCountSph</a> = malloc(<a class="code" href="allvars_8h.html#a2">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00032   <a class="code" href="allvars_8c.html#a28">DomainTask</a> = malloc(<a class="code" href="allvars_8h.html#a2">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00033   <a class="code" href="allvars_8c.html#a29">DomainNodeIndex</a> = malloc(<a class="code" href="allvars_8h.html#a2">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00034   <a class="code" href="allvars_8c.html#a30">DomainTreeNodeLen</a> = malloc(<a class="code" href="allvars_8h.html#a2">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a35">FLOAT</a>));
00035   <a class="code" href="allvars_8c.html#a31">DomainHmax</a> = malloc(<a class="code" href="allvars_8h.html#a2">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a35">FLOAT</a>));
00036   <a class="code" href="allvars_8c.html#a32">DomainMoment</a> = malloc(<a class="code" href="allvars_8h.html#a2">MAXTOPNODES</a> * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structDomainNODE.html">DomainNODE</a>));
00037 
00038   <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#a49">CommBuffer</a> = malloc(bytes = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o9">BufferSize</a> * 1024 * 1024)))
00039     {
00040       printf(<span class="stringliteral">"failed to allocate memory for `CommBuffer' (%g MB).\n"</span>, bytes / (1024.0 * 1024.0));
00041       <a class="code" href="proto_8h.html#a38">endrun</a>(2);
00042     }
00043 
00044   <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o10">BunchSizeForce</a> =
00045     (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o9">BufferSize</a> * 1024 * 1024) / (<span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structgravdata__index.html">gravdata_index</a>) + 2 * <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structgravdata__in.html">gravdata_in</a>));
00046 
00047   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o10">BunchSizeForce</a> &amp; 1)
00048     <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o10">BunchSizeForce</a> -= 1;    <span class="comment">/* make sure that All.BunchSizeForce is an even number </span>
00049 <span class="comment">                                   --&gt; 8-byte alignment for 64bit processors */</span>
00050 
00051   <a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a> = (<span class="keyword">struct </span><a class="code" href="structgravdata__index.html">gravdata_index</a> *) CommBuffer;
00052   <a class="code" href="allvars_8c.html#a66">GravDataIn</a> = (<span class="keyword">struct </span><a class="code" href="structgravdata__in.html">gravdata_in</a> *) (<a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o10">BunchSizeForce</a>);
00053   <a class="code" href="allvars_8c.html#a67">GravDataGet</a> = <a class="code" href="allvars_8c.html#a66">GravDataIn</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o10">BunchSizeForce</a>;
00054   <a class="code" href="allvars_8c.html#a69">GravDataOut</a> = GravDataIn;     <span class="comment">/* this will overwrite the GravDataIn-Table */</span>
00055   <a class="code" href="allvars_8c.html#a68">GravDataResult</a> = GravDataGet; <span class="comment">/* this will overwrite the GravDataGet-Table */</span>
00056 
00057 
00058   <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o11">BunchSizeDensity</a> =
00059     (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o9">BufferSize</a> * 1024 * 1024) / (2 * <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structdensdata__in.html">densdata_in</a>) + 2 * <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structdensdata__out.html">densdata_out</a>));
00060 
00061   <a class="code" href="allvars_8c.html#a71">DensDataIn</a> = (<span class="keyword">struct </span><a class="code" href="structdensdata__in.html">densdata_in</a> *) CommBuffer;
00062   <a class="code" href="allvars_8c.html#a72">DensDataGet</a> = <a class="code" href="allvars_8c.html#a71">DensDataIn</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o11">BunchSizeDensity</a>;
00063   <a class="code" href="allvars_8c.html#a73">DensDataResult</a> = (<span class="keyword">struct </span><a class="code" href="structdensdata__out.html">densdata_out</a> *) (<a class="code" href="allvars_8c.html#a72">DensDataGet</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o11">BunchSizeDensity</a>);
00064   <a class="code" href="allvars_8c.html#a74">DensDataPartialResult</a> = <a class="code" href="allvars_8c.html#a73">DensDataResult</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o11">BunchSizeDensity</a>;
00065 
00066   <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o12">BunchSizeHydro</a> =
00067     (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o9">BufferSize</a> * 1024 * 1024) / (2 * <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structhydrodata__in.html">hydrodata_in</a>) + 2 * <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structhydrodata__out.html">hydrodata_out</a>));
00068 
00069   <a class="code" href="allvars_8c.html#a75">HydroDataIn</a> = (<span class="keyword">struct </span><a class="code" href="structhydrodata__in.html">hydrodata_in</a> *) CommBuffer;
00070   <a class="code" href="allvars_8c.html#a76">HydroDataGet</a> = <a class="code" href="allvars_8c.html#a75">HydroDataIn</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o12">BunchSizeHydro</a>;
00071   <a class="code" href="allvars_8c.html#a77">HydroDataResult</a> = (<span class="keyword">struct </span><a class="code" href="structhydrodata__out.html">hydrodata_out</a> *) (<a class="code" href="allvars_8c.html#a76">HydroDataGet</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o12">BunchSizeHydro</a>);
00072   <a class="code" href="allvars_8c.html#a78">HydroDataPartialResult</a> = <a class="code" href="allvars_8c.html#a77">HydroDataResult</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o12">BunchSizeHydro</a>;
00073 
00074   <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o13">BunchSizeDomain</a> =
00075     (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o9">BufferSize</a> * 1024 * 1024) / (<span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structparticle__data.html">particle_data</a>) + sizeof(struct sph_particle_data) +
00076                                       sizeof(<a class="code" href="allvars_8h.html#a45">peanokey</a>));
00077 
00078   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o13">BunchSizeDomain</a> &amp; 1)
00079     <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o13">BunchSizeDomain</a> -= 1;   <span class="comment">/* make sure that All.BunchSizeDomain is even </span>
00080 <span class="comment">                                   --&gt; 8-byte alignment of DomainKeyBuf for 64bit processors */</span>
00081 
00082   <a class="code" href="allvars_8c.html#a52">DomainPartBuf</a> = (<span class="keyword">struct </span><a class="code" href="structparticle__data.html">particle_data</a> *) CommBuffer;
00083   <a class="code" href="allvars_8c.html#a54">DomainSphBuf</a> = (<span class="keyword">struct </span>sph_particle_data *) (<a class="code" href="allvars_8c.html#a52">DomainPartBuf</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o13">BunchSizeDomain</a>);
00084   <a class="code" href="allvars_8c.html#a33">DomainKeyBuf</a> = (<a class="code" href="allvars_8h.html#a45">peanokey</a> *) (<a class="code" href="allvars_8c.html#a54">DomainSphBuf</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o13">BunchSizeDomain</a>);
00085 
00086 
00087   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00088     {
00089       printf(<span class="stringliteral">"\nAllocated %d MByte communication buffer per processor.\n\n"</span>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o9">BufferSize</a>);
00090       printf(<span class="stringliteral">"Communication buffer has room for %d particles in gravity computation\n"</span>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o10">BunchSizeForce</a>);
00091       printf(<span class="stringliteral">"Communication buffer has room for %d particles in density computation\n"</span>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o11">BunchSizeDensity</a>);
00092       printf(<span class="stringliteral">"Communication buffer has room for %d particles in hydro computation\n"</span>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o12">BunchSizeHydro</a>);
00093       printf(<span class="stringliteral">"Communication buffer has room for %d particles in domain decomposition\n"</span>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o13">BunchSizeDomain</a>);
00094       printf(<span class="stringliteral">"\n"</span>);
00095     }
00096 }
00097 
00098 
00099 
<a name="l00103"></a><a class="code" href="proto_8h.html#a2">00103</a> <span class="keywordtype">void</span> <a class="code" href="allocate_8c.html#a1">allocate_memory</a>(<span class="keywordtype">void</span>)
00104 {
00105   size_t bytes;
00106   <span class="keywordtype">double</span> bytes_tot = 0;
00107 
00108   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> &gt; 0)
00109     {
00110       <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#a51">P</a> = malloc(bytes = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structparticle__data.html">particle_data</a>))))
00111         {
00112           printf(<span class="stringliteral">"failed to allocate memory for `P' (%g MB).\n"</span>, bytes / (1024.0 * 1024.0));
00113           <a class="code" href="proto_8h.html#a38">endrun</a>(1);
00114         }
00115       bytes_tot += bytes;
00116 
00117       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00118         printf(<span class="stringliteral">"\nAllocated %g MByte for particle storage. %d\n\n"</span>, bytes_tot / (1024.0 * 1024.0), <span class="keyword">sizeof</span>(<span class="keyword">struct</span> particle_data));
00119     }
00120 
00121   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o3">MaxPartSph</a> &gt; 0)
00122     {
00123       bytes_tot = 0;
00124 
00125       <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#a53">SphP</a> = malloc(bytes = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o3">MaxPartSph</a> * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structsph__particle__data.html">sph_particle_data</a>))))
00126         {
00127           printf(<span class="stringliteral">"failed to allocate memory for `SphP' (%g MB) %d.\n"</span>, bytes / (1024.0 * 1024.0), <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sph_particle_data));
00128           <a class="code" href="proto_8h.html#a38">endrun</a>(1);
00129         }
00130       bytes_tot += bytes;
00131 
00132       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00133         printf(<span class="stringliteral">"Allocated %g MByte for storage of SPH data. %d\n\n"</span>, bytes_tot / (1024.0 * 1024.0), <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sph_particle_data));
00134     }
00135 }
00136 
00137 
00138 
00139 
<a name="l00144"></a><a class="code" href="proto_8h.html#a78">00144</a> <span class="keywordtype">void</span> <a class="code" href="allocate_8c.html#a2">free_memory</a>(<span class="keywordtype">void</span>)
00145 {
00146   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o3">MaxPartSph</a> &gt; 0)
00147     free(<a class="code" href="allvars_8c.html#a53">SphP</a>);
00148 
00149   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> &gt; 0)
00150     free(<a class="code" href="allvars_8c.html#a51">P</a>);
00151 }
00152 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 22 15:29:40 2006 for GADGET-2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
