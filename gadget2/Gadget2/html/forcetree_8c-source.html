<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GADGET-2: forcetree.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>forcetree.c</h1><a href="forcetree_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00002 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00003 <span class="preprocessor">#include &lt;string.h&gt;</span>
00004 <span class="preprocessor">#include &lt;math.h&gt;</span>
00005 <span class="preprocessor">#include &lt;time.h&gt;</span>
00006 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
00007 
00008 <span class="preprocessor">#include "<a class="code" href="allvars_8h.html">allvars.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="proto_8h.html">proto.h</a>"</span>
00010 
00011 
00026 <span class="keyword">static</span> <span class="keywordtype">int</span> last;
00027 
00028 
00029 
<a name="l00031"></a><a class="code" href="forcetree_8c.html#a0">00031</a> <span class="preprocessor">#define NTAB 1000</span>
00032 <span class="preprocessor"></span>
00033 <span class="keyword">static</span> <span class="keywordtype">float</span> tabfac, shortrange_table[NTAB], shortrange_table_potential[NTAB];
00034 
00036 <span class="keyword">static</span> <span class="keywordtype">int</span> first_flag = 0;
00037 
00038 
00039 
00040 
00041 <span class="preprocessor">#ifdef PERIODIC</span>
00042 <span class="preprocessor"></span>
<a name="l00043"></a><a class="code" href="forcetree_8c.html#a1">00043</a> <span class="preprocessor">#define NEAREST(x) (((x)&gt;boxhalf)?((x)-boxsize):(((x)&lt;-boxhalf)?((x)+boxsize):(x)))</span>
00044 <span class="preprocessor"></span>
<a name="l00045"></a><a class="code" href="forcetree_8c.html#a2">00045</a> <span class="preprocessor">#define EN  64</span>
00046 <span class="preprocessor"></span>
00049 <span class="keyword">static</span> <a class="code" href="allvars_8h.html#a35">FLOAT</a> fcorrx[<a class="code" href="forcetree_8c.html#a2">EN</a> + 1][<a class="code" href="forcetree_8c.html#a2">EN</a> + 1][<a class="code" href="forcetree_8c.html#a2">EN</a> + 1];
00050 <span class="keyword">static</span> <a class="code" href="allvars_8h.html#a35">FLOAT</a> fcorry[<a class="code" href="forcetree_8c.html#a2">EN</a> + 1][<a class="code" href="forcetree_8c.html#a2">EN</a> + 1][<a class="code" href="forcetree_8c.html#a2">EN</a> + 1];
00051 <span class="keyword">static</span> <a class="code" href="allvars_8h.html#a35">FLOAT</a> fcorrz[<a class="code" href="forcetree_8c.html#a2">EN</a> + 1][<a class="code" href="forcetree_8c.html#a2">EN</a> + 1][<a class="code" href="forcetree_8c.html#a2">EN</a> + 1];
00052 <span class="keyword">static</span> <a class="code" href="allvars_8h.html#a35">FLOAT</a> potcorr[<a class="code" href="forcetree_8c.html#a2">EN</a> + 1][<a class="code" href="forcetree_8c.html#a2">EN</a> + 1][<a class="code" href="forcetree_8c.html#a2">EN</a> + 1];
00053 <span class="keyword">static</span> <span class="keywordtype">double</span> fac_intp;
00054 <span class="preprocessor">#endif</span>
00055 <span class="preprocessor"></span>
00056 
00057 
<a name="l00061"></a><a class="code" href="proto_8h.html#a58">00061</a> <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a58">force_treebuild</a>(<span class="keywordtype">int</span> npart)
00062 {
00063   <a class="code" href="allvars_8c.html#a56">Numnodestree</a> = <a class="code" href="proto_8h.html#a59">force_treebuild_single</a>(npart);
00064 
00065   <a class="code" href="forcetree_8c.html#a18">force_update_pseudoparticles</a>();
00066 
00067   <a class="code" href="forcetree_8c.html#a21">force_flag_localnodes</a>();
00068 
00069   <a class="code" href="allvars_8c.html#a39">TimeOfLastTreeConstruction</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>;
00070 
00071   <span class="keywordflow">return</span> Numnodestree;
00072 }
00073 
00074 
00075 
<a name="l00093"></a><a class="code" href="proto_8h.html#a59">00093</a> <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a59">force_treebuild_single</a>(<span class="keywordtype">int</span> npart)
00094 {
00095   <span class="keywordtype">int</span> i, j, subnode = 0, parent, numnodes;
00096   <span class="keywordtype">int</span> nfree, th, nn, no;
00097   <span class="keyword">struct </span><a class="code" href="structNODE.html">NODE</a> *nfreep;
00098   <span class="keywordtype">double</span> lenhalf, epsilon;
00099   <a class="code" href="allvars_8h.html#a45">peanokey</a> key;
00100 
00101 
00102   <span class="comment">/* create an empty root node  */</span>
00103   nfree = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>;          <span class="comment">/* index of first free node */</span>
00104   nfreep = &amp;<a class="code" href="allvars_8c.html#a58">Nodes</a>[nfree];       <span class="comment">/* select first node */</span>
00105 
00106   nfreep-&gt;<a class="code" href="structNODE.html#o0">len</a> = DomainLen;
00107   <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
00108     nfreep-&gt;<a class="code" href="structNODE.html#o1">center</a>[j] = <a class="code" href="allvars_8c.html#a18">DomainCenter</a>[j];
00109   <span class="keywordflow">for</span>(j = 0; j &lt; 8; j++)
00110     nfreep-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o2">suns</a>[j] = -1;
00111 
00112 
00113   numnodes = 1;
00114   nfreep++;
00115   nfree++;
00116 
00117   <span class="comment">/* create a set of empty nodes corresponding to the top-level domain</span>
00118 <span class="comment">   * grid. We need to generate these nodes first to make sure that we have a</span>
00119 <span class="comment">   * complete top-level tree which allows the easy insertion of the</span>
00120 <span class="comment">   * pseudo-particles at the right place </span>
00121 <span class="comment">   */</span>
00122 
00123   <a class="code" href="proto_8h.html#a52">force_create_empty_nodes</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>, 0, 1, 0, 0, 0, &amp;numnodes, &amp;nfree);
00124 
00125 
00126   <span class="comment">/* if a high-resolution region in a global tree is used, we need to generate</span>
00127 <span class="comment">   * an additional set empty nodes to make sure that we have a complete</span>
00128 <span class="comment">   * top-level tree for the high-resolution inset</span>
00129 <span class="comment">   */</span>
00130 
00131   nfreep = &amp;<a class="code" href="allvars_8c.html#a58">Nodes</a>[nfree];
00132   parent = -1;                  <span class="comment">/* note: will not be used below before it is changed */</span>
00133 
00134 
00135   <span class="comment">/* now we insert all particles */</span>
00136   <span class="keywordflow">for</span>(i = 0; i &lt; npart; i++)
00137     {
00138 
00139       <span class="comment">/* the softening is only used to check whether particles are so close</span>
00140 <span class="comment">       * that the tree needs not to be refined further</span>
00141 <span class="comment">       */</span>
00142       epsilon = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a>];
00143 
00144       key = <a class="code" href="proto_8h.html#a119">peano_hilbert_key</a>((<a class="code" href="allvars_8c.html#a51">P</a>[i].Pos[0] - <a class="code" href="allvars_8c.html#a17">DomainCorner</a>[0]) * <a class="code" href="allvars_8c.html#a20">DomainFac</a>,
00145                               (<a class="code" href="allvars_8c.html#a51">P</a>[i].Pos[1] - <a class="code" href="allvars_8c.html#a17">DomainCorner</a>[1]) * <a class="code" href="allvars_8c.html#a20">DomainFac</a>,
00146                               (<a class="code" href="allvars_8c.html#a51">P</a>[i].Pos[2] - <a class="code" href="allvars_8c.html#a17">DomainCorner</a>[2]) * <a class="code" href="allvars_8c.html#a20">DomainFac</a>, <a class="code" href="allvars_8h.html#a3">BITS_PER_DIMENSION</a>);
00147 
00148       no = 0;
00149       <span class="keywordflow">while</span>(<a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o0">Daughter</a> &gt;= 0)
00150         no = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o0">Daughter</a> + (key - <a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o5">StartKey</a>) / (<a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o4">Size</a> / 8);
00151 
00152       no = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o3">Leaf</a>;
00153       th = <a class="code" href="allvars_8c.html#a29">DomainNodeIndex</a>[no];
00154 
00155       <span class="keywordflow">while</span>(1)
00156         {
00157           <span class="keywordflow">if</span>(th &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>) <span class="comment">/* we are dealing with an internal node */</span>
00158             {
00159               subnode = 0;
00160               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[0] &gt; <a class="code" href="allvars_8c.html#a58">Nodes</a>[th].<a class="code" href="structNODE.html#o1">center</a>[0])
00161                 subnode += 1;
00162               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[1] &gt; <a class="code" href="allvars_8c.html#a58">Nodes</a>[th].<a class="code" href="structNODE.html#o1">center</a>[1])
00163                 subnode += 2;
00164               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[2] &gt; <a class="code" href="allvars_8c.html#a58">Nodes</a>[th].<a class="code" href="structNODE.html#o1">center</a>[2])
00165                 subnode += 4;
00166 
00167               nn = <a class="code" href="allvars_8c.html#a58">Nodes</a>[th].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o2">suns</a>[subnode];
00168 
00169               <span class="keywordflow">if</span>(nn &gt;= 0)       <span class="comment">/* ok, something is in the daughter slot already, need to continue */</span>
00170                 {
00171                   parent = th;
00172                   th = nn;
00173                 }
00174               <span class="keywordflow">else</span>
00175                 {
00176                   <span class="comment">/* here we have found an empty slot where we can attach</span>
00177 <span class="comment">                   * the new particle as a leaf.</span>
00178 <span class="comment">                   */</span>
00179                   <a class="code" href="allvars_8c.html#a58">Nodes</a>[th].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o2">suns</a>[subnode] = i;
00180                   <span class="keywordflow">break</span>;        <span class="comment">/* done for this particle */</span>
00181                 }
00182             }
00183           <span class="keywordflow">else</span>
00184             {
00185               <span class="comment">/* We try to insert into a leaf with a single particle.  Need</span>
00186 <span class="comment">               * to generate a new internal node at this point.</span>
00187 <span class="comment">               */</span>
00188               <a class="code" href="allvars_8c.html#a58">Nodes</a>[parent].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o2">suns</a>[subnode] = nfree;
00189 
00190               nfreep-&gt;<a class="code" href="structNODE.html#o0">len</a> = 0.5 * <a class="code" href="allvars_8c.html#a58">Nodes</a>[parent].<a class="code" href="structNODE.html#o0">len</a>;
00191               lenhalf = 0.25 * <a class="code" href="allvars_8c.html#a58">Nodes</a>[parent].<a class="code" href="structNODE.html#o0">len</a>;
00192 
00193               <span class="keywordflow">if</span>(subnode &amp; 1)
00194                 nfreep-&gt;<a class="code" href="structNODE.html#o1">center</a>[0] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[parent].<a class="code" href="structNODE.html#o1">center</a>[0] + lenhalf;
00195               <span class="keywordflow">else</span>
00196                 nfreep-&gt;<a class="code" href="structNODE.html#o1">center</a>[0] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[parent].<a class="code" href="structNODE.html#o1">center</a>[0] - lenhalf;
00197 
00198               <span class="keywordflow">if</span>(subnode &amp; 2)
00199                 nfreep-&gt;<a class="code" href="structNODE.html#o1">center</a>[1] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[parent].<a class="code" href="structNODE.html#o1">center</a>[1] + lenhalf;
00200               <span class="keywordflow">else</span>
00201                 nfreep-&gt;<a class="code" href="structNODE.html#o1">center</a>[1] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[parent].<a class="code" href="structNODE.html#o1">center</a>[1] - lenhalf;
00202 
00203               <span class="keywordflow">if</span>(subnode &amp; 4)
00204                 nfreep-&gt;<a class="code" href="structNODE.html#o1">center</a>[2] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[parent].<a class="code" href="structNODE.html#o1">center</a>[2] + lenhalf;
00205               <span class="keywordflow">else</span>
00206                 nfreep-&gt;<a class="code" href="structNODE.html#o1">center</a>[2] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[parent].<a class="code" href="structNODE.html#o1">center</a>[2] - lenhalf;
00207 
00208               nfreep-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o2">suns</a>[0] = -1;
00209               nfreep-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o2">suns</a>[1] = -1;
00210               nfreep-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o2">suns</a>[2] = -1;
00211               nfreep-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o2">suns</a>[3] = -1;
00212               nfreep-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o2">suns</a>[4] = -1;
00213               nfreep-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o2">suns</a>[5] = -1;
00214               nfreep-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o2">suns</a>[6] = -1;
00215               nfreep-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o2">suns</a>[7] = -1;
00216 
00217 
00218               subnode = 0;
00219               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[th].<a class="code" href="structparticle__data.html#o0">Pos</a>[0] &gt; nfreep-&gt;<a class="code" href="structNODE.html#o1">center</a>[0])
00220                 subnode += 1;
00221               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[th].<a class="code" href="structparticle__data.html#o0">Pos</a>[1] &gt; nfreep-&gt;<a class="code" href="structNODE.html#o1">center</a>[1])
00222                 subnode += 2;
00223               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[th].<a class="code" href="structparticle__data.html#o0">Pos</a>[2] &gt; nfreep-&gt;<a class="code" href="structNODE.html#o1">center</a>[2])
00224                 subnode += 4;
00225 <span class="preprocessor">#ifndef NOTREERND</span>
00226 <span class="preprocessor"></span>              <span class="keywordflow">if</span>(nfreep-&gt;<a class="code" href="structNODE.html#o0">len</a> &lt; 1.0e-3 * epsilon)
00227                 {
00228                   <span class="comment">/* seems like we're dealing with particles at identical (or extremely close)</span>
00229 <span class="comment">                   * locations. Randomize subnode index to allow tree construction. Note: Multipole moments</span>
00230 <span class="comment">                   * of tree are still correct, but this will only happen well below gravitational softening</span>
00231 <span class="comment">                   * length-scale anyway.</span>
00232 <span class="comment">                   */</span>
00233                   subnode = (int) (8.0 * <a class="code" href="system_8c.html#a0">get_random_number</a>((0xffff &amp; <a class="code" href="allvars_8c.html#a51">P</a>[i].ID) + <a class="code" href="allvars_8c.html#a51">P</a>[i].GravCost));
00234                   <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o12">GravCost</a> += 1;
00235                   <span class="keywordflow">if</span>(subnode &gt;= 8)
00236                     subnode = 7;
00237                 }
00238 <span class="preprocessor">#endif</span>
00239 <span class="preprocessor"></span>              nfreep-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o2">suns</a>[subnode] = th;
00240 
00241               th = nfree;       <span class="comment">/* resume trying to insert the new particle at</span>
00242 <span class="comment">                                 * the newly created internal node</span>
00243 <span class="comment">                                 */</span>
00244 
00245               numnodes++;
00246               nfree++;
00247               nfreep++;
00248 
00249               <span class="keywordflow">if</span>((numnodes) &gt;= MaxNodes)
00250                 {
00251                   printf(<span class="stringliteral">"task %d: maximum number %d of tree-nodes reached.\n"</span>, <a class="code" href="allvars_8c.html#a0">ThisTask</a>, <a class="code" href="allvars_8c.html#a55">MaxNodes</a>);
00252                   printf(<span class="stringliteral">"for particle %d\n"</span>, i);
00253                   <a class="code" href="forcetree_8c.html#a36">dump_particles</a>();
00254                   <a class="code" href="proto_8h.html#a38">endrun</a>(1);
00255                 }
00256             }
00257         }
00258     }
00259 
00260 
00261   <span class="comment">/* insert the pseudo particles that represent the mass distribution of other domains */</span>
00262   <a class="code" href="forcetree_8c.html#a16">force_insert_pseudo_particles</a>();
00263 
00264 
00265   <span class="comment">/* now compute the multipole moments recursively */</span>
00266   last = -1;
00267 
00268   <a class="code" href="proto_8h.html#a75">force_update_node_recursive</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>, -1, -1);
00269 
00270   <span class="keywordflow">if</span>(last &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>)
00271     {
00272       <span class="keywordflow">if</span>(last &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)        <span class="comment">/* a pseudo-particle */</span>
00273         <a class="code" href="allvars_8c.html#a59">Nextnode</a>[last - MaxNodes] = -1;
00274       <span class="keywordflow">else</span>
00275         <a class="code" href="allvars_8c.html#a58">Nodes</a>[last].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a> = -1;
00276     }
00277   <span class="keywordflow">else</span>
00278     <a class="code" href="allvars_8c.html#a59">Nextnode</a>[last] = -1;
00279 
00280   <span class="keywordflow">return</span> numnodes;
00281 }
00282 
00283 
00284 
00292 <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a52">force_create_empty_nodes</a>(<span class="keywordtype">int</span> no, <span class="keywordtype">int</span> topnode, <span class="keywordtype">int</span> bits, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> z, <span class="keywordtype">int</span> *nodecount,
00293                               <span class="keywordtype">int</span> *nextfree)
<a name="l00294"></a><a class="code" href="proto_8h.html#a52">00294</a> {
00295   <span class="keywordtype">int</span> i, j, k, n, sub, count;
00296 
00297   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a38">TopNodes</a>[topnode].<a class="code" href="structtopnode__data.html#o0">Daughter</a> &gt;= 0)
00298     {
00299       <span class="keywordflow">for</span>(i = 0; i &lt; 2; i++)
00300         <span class="keywordflow">for</span>(j = 0; j &lt; 2; j++)
00301           <span class="keywordflow">for</span>(k = 0; k &lt; 2; k++)
00302             {
00303               sub = 7 &amp; <a class="code" href="proto_8h.html#a119">peano_hilbert_key</a>((x &lt;&lt; 1) + i, (y &lt;&lt; 1) + j, (z &lt;&lt; 1) + k, bits);
00304 
00305               count = i + 2 * j + 4 * k;
00306 
00307               <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o2">suns</a>[count] = *nextfree;
00308 
00309 
00310               <a class="code" href="allvars_8c.html#a58">Nodes</a>[*nextfree].<a class="code" href="structNODE.html#o0">len</a> = 0.5 * <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o0">len</a>;
00311               <a class="code" href="allvars_8c.html#a58">Nodes</a>[*nextfree].<a class="code" href="structNODE.html#o1">center</a>[0] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o1">center</a>[0] + (2 * i - 1) * 0.25 * <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o0">len</a>;
00312               <a class="code" href="allvars_8c.html#a58">Nodes</a>[*nextfree].<a class="code" href="structNODE.html#o1">center</a>[1] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o1">center</a>[1] + (2 * j - 1) * 0.25 * <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o0">len</a>;
00313               <a class="code" href="allvars_8c.html#a58">Nodes</a>[*nextfree].<a class="code" href="structNODE.html#o1">center</a>[2] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o1">center</a>[2] + (2 * k - 1) * 0.25 * <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o0">len</a>;
00314 
00315               <span class="keywordflow">for</span>(n = 0; n &lt; 8; n++)
00316                 <a class="code" href="allvars_8c.html#a58">Nodes</a>[*nextfree].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o2">suns</a>[n] = -1;
00317 
00318               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a38">TopNodes</a>[<a class="code" href="allvars_8c.html#a38">TopNodes</a>[topnode].<a class="code" href="structtopnode__data.html#o0">Daughter</a> + sub].<a class="code" href="structtopnode__data.html#o0">Daughter</a> == -1)
00319                 <a class="code" href="allvars_8c.html#a29">DomainNodeIndex</a>[<a class="code" href="allvars_8c.html#a38">TopNodes</a>[<a class="code" href="allvars_8c.html#a38">TopNodes</a>[topnode].<a class="code" href="structtopnode__data.html#o0">Daughter</a> + sub].<a class="code" href="structtopnode__data.html#o3">Leaf</a>] = *nextfree;
00320 
00321               *nextfree = *nextfree + 1;
00322               *nodecount = *nodecount + 1;
00323 
00324               <span class="keywordflow">if</span>((*nodecount) &gt;= MaxNodes)
00325                 {
00326                   printf(<span class="stringliteral">"task %d: maximum number %d of tree-nodes reached.\n"</span>, <a class="code" href="allvars_8c.html#a0">ThisTask</a>, <a class="code" href="allvars_8c.html#a55">MaxNodes</a>);
00327                   printf(<span class="stringliteral">"in create empty nodes\n"</span>);
00328                   <a class="code" href="forcetree_8c.html#a36">dump_particles</a>();
00329                   <a class="code" href="proto_8h.html#a38">endrun</a>(11);
00330                 }
00331 
00332               <a class="code" href="proto_8h.html#a52">force_create_empty_nodes</a>(*nextfree - 1, <a class="code" href="allvars_8c.html#a38">TopNodes</a>[topnode].Daughter + sub,
00333                                        bits + 1, 2 * x + i, 2 * y + j, 2 * z + k, nodecount, nextfree);
00334             }
00335     }
00336 }
00337 
00338 
00339 
00346 <span class="keywordtype">void</span> <a class="code" href="forcetree_8c.html#a16">force_insert_pseudo_particles</a>(<span class="keywordtype">void</span>)
00347 {
<a name="l00348"></a><a class="code" href="proto_8h.html#a55">00348</a>   <span class="keywordtype">int</span> i, index, subnode, nn, th;
00349 
00350   <span class="keywordflow">for</span>(i = 0; i &lt; NTopleaves; i++)
00351     {
00352       index = <a class="code" href="allvars_8c.html#a29">DomainNodeIndex</a>[i];
00353 
00354       <a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#o2">mass</a> = 0;
00355       <a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#o0">s</a>[0] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[index].<a class="code" href="structNODE.html#o1">center</a>[0];
00356       <a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#o0">s</a>[1] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[index].<a class="code" href="structNODE.html#o1">center</a>[1];
00357       <a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#o0">s</a>[2] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[index].<a class="code" href="structNODE.html#o1">center</a>[2];
00358     }
00359 
00360   <span class="keywordflow">for</span>(i = 0; i &lt; NTopleaves; i++)
00361     {
00362       <span class="keywordflow">if</span>(i &lt; DomainMyStart || i &gt; DomainMyLast)
00363         {
00364           th = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>;     <span class="comment">/* select index of first node in tree */</span>
00365 
00366           <span class="keywordflow">while</span>(1)
00367             {
00368               <span class="keywordflow">if</span>(th &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>)     <span class="comment">/* we are dealing with an internal node */</span>
00369                 {
00370                   <span class="keywordflow">if</span>(th &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)
00371                     <a class="code" href="proto_8h.html#a38">endrun</a>(888);        <span class="comment">/* this can't be */</span>
00372 
00373                   subnode = 0;
00374                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#o0">s</a>[0] &gt; <a class="code" href="allvars_8c.html#a58">Nodes</a>[th].<a class="code" href="structNODE.html#o1">center</a>[0])
00375                     subnode += 1;
00376                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#o0">s</a>[1] &gt; <a class="code" href="allvars_8c.html#a58">Nodes</a>[th].<a class="code" href="structNODE.html#o1">center</a>[1])
00377                     subnode += 2;
00378                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#o0">s</a>[2] &gt; <a class="code" href="allvars_8c.html#a58">Nodes</a>[th].<a class="code" href="structNODE.html#o1">center</a>[2])
00379                     subnode += 4;
00380 
00381                   nn = <a class="code" href="allvars_8c.html#a58">Nodes</a>[th].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o2">suns</a>[subnode];
00382 
00383                   <span class="keywordflow">if</span>(nn &gt;= 0)   <span class="comment">/* ok, something is in the daughter slot already, need to continue */</span>
00384                     {
00385                       th = nn;
00386                     }
00387                   <span class="keywordflow">else</span>
00388                     {
00389                       <span class="comment">/* here we have found an empty slot where we can </span>
00390 <span class="comment">                       * attach the pseudo particle as a leaf </span>
00391 <span class="comment">                       */</span>
00392                       <a class="code" href="allvars_8c.html#a58">Nodes</a>[th].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o2">suns</a>[subnode] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + <a class="code" href="allvars_8c.html#a55">MaxNodes</a> + i;
00393 
00394                       <span class="keywordflow">break</span>;    <span class="comment">/* done for this pseudo particle */</span>
00395                     }
00396                 }
00397               <span class="keywordflow">else</span>
00398                 {
00399                   <a class="code" href="proto_8h.html#a38">endrun</a>(889);  <span class="comment">/* this can't be */</span>
00400                 }
00401             }
00402         }
00403     }
00404 }
00405 
00406 
00422 <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a75">force_update_node_recursive</a>(<span class="keywordtype">int</span> no, <span class="keywordtype">int</span> sib, <span class="keywordtype">int</span> father)
00423 {
<a name="l00424"></a><a class="code" href="proto_8h.html#a75">00424</a>   <span class="keywordtype">int</span> j, jj, p, pp, nextsib, suns[8];
00425   <a class="code" href="allvars_8h.html#a35">FLOAT</a> hmax;
00426 
00427 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
00428 <span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
00429 <span class="preprocessor"></span>  <span class="keywordtype">int</span> maxsofttype, diffsoftflag;
00430 <span class="preprocessor">#else</span>
00431 <span class="preprocessor"></span>  <a class="code" href="allvars_8h.html#a35">FLOAT</a> maxsoft;
00432 <span class="preprocessor">#endif</span>
00433 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00434 <span class="preprocessor"></span>  <span class="keyword">struct </span><a class="code" href="structparticle__data.html">particle_data</a> *pa;
00435   <span class="keywordtype">double</span> s[3], vs[3], mass;
00436 
00437   <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> &amp;&amp; no &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)  <span class="comment">/* internal node */</span>
00438     {
00439       <span class="keywordflow">for</span>(j = 0; j &lt; 8; j++)
00440         suns[j] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o2">suns</a>[j];  <span class="comment">/* this "backup" is necessary because the nextnode entry will</span>
00441 <span class="comment">                                           overwrite one element (union!) */</span>
00442       <span class="keywordflow">if</span>(last &gt;= 0)
00443         {
00444           <span class="keywordflow">if</span>(last &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>)
00445             {
00446               <span class="keywordflow">if</span>(last &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)        <span class="comment">/* a pseudo-particle */</span>
00447                 <a class="code" href="allvars_8c.html#a59">Nextnode</a>[last - MaxNodes] = no;
00448               <span class="keywordflow">else</span>
00449                 <a class="code" href="allvars_8c.html#a58">Nodes</a>[last].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a> = no;
00450             }
00451           <span class="keywordflow">else</span>
00452             <a class="code" href="allvars_8c.html#a59">Nextnode</a>[last] = no;
00453         }
00454 
00455       last = no;
00456 
00457       mass = 0;
00458       s[0] = 0;
00459       s[1] = 0;
00460       s[2] = 0;
00461       vs[0] = 0;
00462       vs[1] = 0;
00463       vs[2] = 0;
00464       hmax = 0;
00465 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
00466 <span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
00467 <span class="preprocessor"></span>      maxsofttype = 7;
00468       diffsoftflag = 0;
00469 <span class="preprocessor">#else</span>
00470 <span class="preprocessor"></span>      maxsoft = 0;
00471 <span class="preprocessor">#endif</span>
00472 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00473 <span class="preprocessor"></span>
00474       <span class="keywordflow">for</span>(j = 0; j &lt; 8; j++)
00475         {
00476           <span class="keywordflow">if</span>((p = suns[j]) &gt;= 0)
00477             {
00478               <span class="comment">/* check if we have a sibling on the same level */</span>
00479               <span class="keywordflow">for</span>(jj = j + 1; jj &lt; 8; jj++)
00480                 <span class="keywordflow">if</span>((pp = suns[jj]) &gt;= 0)
00481                   <span class="keywordflow">break</span>;
00482 
00483               <span class="keywordflow">if</span>(jj &lt; 8)        <span class="comment">/* yes, we do */</span>
00484                 nextsib = pp;
00485               <span class="keywordflow">else</span>
00486                 nextsib = sib;
00487 
00488               <a class="code" href="proto_8h.html#a75">force_update_node_recursive</a>(p, nextsib, no);
00489 
00490 
00491               <span class="keywordflow">if</span>(p &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>)      <span class="comment">/* an internal node or pseudo particle */</span>
00492                 {
00493                   <span class="keywordflow">if</span>(p &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)       <span class="comment">/* a pseudo particle */</span>
00494                     {
00495                       <span class="comment">/* nothing to be done here because the mass of the</span>
00496 <span class="comment">                       * pseudo-particle is still zero. This will be changed</span>
00497 <span class="comment">                       * later.</span>
00498 <span class="comment">                       */</span>
00499                     }
00500                   <span class="keywordflow">else</span>
00501                     {
00502                       mass += <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a>;
00503                       s[0] += <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a> * <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[0];
00504                       s[1] += <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a> * <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[1];
00505                       s[2] += <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a> * <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[2];
00506                       vs[0] += <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a> * <a class="code" href="allvars_8c.html#a62">Extnodes</a>[p].<a class="code" href="structextNODE.html#o1">vs</a>[0];
00507                       vs[1] += <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a> * <a class="code" href="allvars_8c.html#a62">Extnodes</a>[p].<a class="code" href="structextNODE.html#o1">vs</a>[1];
00508                       vs[2] += <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a> * <a class="code" href="allvars_8c.html#a62">Extnodes</a>[p].<a class="code" href="structextNODE.html#o1">vs</a>[2];
00509 
00510                       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a62">Extnodes</a>[p].<a class="code" href="structextNODE.html#o0">hmax</a> &gt; hmax)
00511                         hmax = <a class="code" href="allvars_8c.html#a62">Extnodes</a>[p].<a class="code" href="structextNODE.html#o0">hmax</a>;
00512 
00513 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
00514 <span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
00515 <span class="preprocessor"></span>                      diffsoftflag |= (<a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 5) &amp; 1;
00516 
00517                       <span class="keywordflow">if</span>(maxsofttype == 7)
00518                         {
00519                           maxsofttype = (<a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 2) &amp; 7;
00520                         }
00521                       <span class="keywordflow">else</span>
00522                         {
00523                           <span class="keywordflow">if</span>(((<a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 2) &amp; 7) != 7)
00524                             {
00525                               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[((<a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 2) &amp; 7)] &gt;
00526                                  <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[maxsofttype])
00527                                 {
00528                                   maxsofttype = ((<a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 2) &amp; 7);
00529                                   diffsoftflag = 1;
00530                                 }
00531                               <span class="keywordflow">else</span>
00532                                 {
00533                                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[((<a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 2) &amp; 7)] &lt;
00534                                      <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[maxsofttype])
00535                                     diffsoftflag = 1;
00536                                 }
00537                             }
00538                         }
00539 <span class="preprocessor">#else</span>
00540 <span class="preprocessor"></span>                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a58">Nodes</a>[p].maxsoft &gt; maxsoft)
00541                         maxsoft = <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].maxsoft;
00542 <span class="preprocessor">#endif</span>
00543 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00544 <span class="preprocessor"></span>                    }
00545                 }
00546               <span class="keywordflow">else</span>              <span class="comment">/* a particle */</span>
00547                 {
00548                   pa = &amp;<a class="code" href="allvars_8c.html#a51">P</a>[p];
00549 
00550                   mass += pa-&gt;<a class="code" href="structparticle__data.html#o1">Mass</a>;
00551                   s[0] += pa-&gt;<a class="code" href="structparticle__data.html#o1">Mass</a> * pa-&gt;<a class="code" href="structparticle__data.html#o0">Pos</a>[0];
00552                   s[1] += pa-&gt;<a class="code" href="structparticle__data.html#o1">Mass</a> * pa-&gt;<a class="code" href="structparticle__data.html#o0">Pos</a>[1];
00553                   s[2] += pa-&gt;<a class="code" href="structparticle__data.html#o1">Mass</a> * pa-&gt;<a class="code" href="structparticle__data.html#o0">Pos</a>[2];
00554                   vs[0] += pa-&gt;<a class="code" href="structparticle__data.html#o1">Mass</a> * pa-&gt;<a class="code" href="structparticle__data.html#o2">Vel</a>[0];
00555                   vs[1] += pa-&gt;<a class="code" href="structparticle__data.html#o1">Mass</a> * pa-&gt;<a class="code" href="structparticle__data.html#o2">Vel</a>[1];
00556                   vs[2] += pa-&gt;<a class="code" href="structparticle__data.html#o1">Mass</a> * pa-&gt;<a class="code" href="structparticle__data.html#o2">Vel</a>[2];
00557 
00558 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
00559 <span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
00560 <span class="preprocessor"></span>                  <span class="keywordflow">if</span>(maxsofttype == 7)
00561                     {
00562                       maxsofttype = pa-&gt;<a class="code" href="structparticle__data.html#o9">Type</a>;
00563                     }
00564                   <span class="keywordflow">else</span>
00565                     {
00566                       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[pa-&gt;<a class="code" href="structparticle__data.html#o9">Type</a>] &gt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[maxsofttype])
00567                         {
00568                           maxsofttype = pa-&gt;<a class="code" href="structparticle__data.html#o9">Type</a>;
00569                           diffsoftflag = 1;
00570                         }
00571                       <span class="keywordflow">else</span>
00572                         {
00573                           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[pa-&gt;<a class="code" href="structparticle__data.html#o9">Type</a>] &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[maxsofttype])
00574                             diffsoftflag = 1;
00575                         }
00576                     }
00577 <span class="preprocessor">#else</span>
00578 <span class="preprocessor"></span>                  <span class="keywordflow">if</span>(pa-&gt;<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
00579                     {
00580                       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a53">SphP</a>[p].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> &gt; maxsoft)
00581                         maxsoft = <a class="code" href="allvars_8c.html#a53">SphP</a>[p].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
00582                     }
00583                   <span class="keywordflow">else</span>
00584                     {
00585                       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[pa-&gt;<a class="code" href="structparticle__data.html#o9">Type</a>] &gt; maxsoft)
00586                         maxsoft = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[pa-&gt;<a class="code" href="structparticle__data.html#o9">Type</a>];
00587                     }
00588 <span class="preprocessor">#endif</span>
00589 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00590 <span class="preprocessor"></span>                  <span class="keywordflow">if</span>(pa-&gt;<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
00591                     <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a53">SphP</a>[p].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> &gt; hmax)
00592                       hmax = <a class="code" href="allvars_8c.html#a53">SphP</a>[p].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
00593                 }
00594             }
00595         }
00596 
00597 
00598       <span class="keywordflow">if</span>(mass)
00599         {
00600           s[0] /= mass;
00601           s[1] /= mass;
00602           s[2] /= mass;
00603           vs[0] /= mass;
00604           vs[1] /= mass;
00605           vs[2] /= mass;
00606         }
00607       <span class="keywordflow">else</span>
00608         {
00609           s[0] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o1">center</a>[0];
00610           s[1] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o1">center</a>[1];
00611           s[2] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o1">center</a>[2];
00612         }
00613 
00614       <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[0] = s[0];
00615       <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[1] = s[1];
00616       <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[2] = s[2];
00617       <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a> = mass;
00618 
00619 
00620 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
00621 <span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
00622 <span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> = 4 * maxsofttype + 32 * diffsoftflag;
00623 <span class="preprocessor">#else</span>
00624 <span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> = 0;
00625       <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].maxsoft = maxsoft;
00626 <span class="preprocessor">#endif</span>
00627 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00628 <span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> = 0;
00629 <span class="preprocessor">#endif</span>
00630 <span class="preprocessor"></span>
00631 
00632       <a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o1">vs</a>[0] = vs[0];
00633       <a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o1">vs</a>[1] = vs[1];
00634       <a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o1">vs</a>[2] = vs[2];
00635       <a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o0">hmax</a> = hmax;
00636 
00637       <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o6">sibling</a> = sib;
00638       <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o8">father</a> = father;
00639     }
00640   <span class="keywordflow">else</span>                          <span class="comment">/* single particle or pseudo particle */</span>
00641     {
00642       <span class="keywordflow">if</span>(last &gt;= 0)
00643         {
00644           <span class="keywordflow">if</span>(last &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>)
00645             {
00646               <span class="keywordflow">if</span>(last &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)        <span class="comment">/* a pseudo-particle */</span>
00647                 <a class="code" href="allvars_8c.html#a59">Nextnode</a>[last - MaxNodes] = no;
00648               <span class="keywordflow">else</span>
00649                 <a class="code" href="allvars_8c.html#a58">Nodes</a>[last].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a> = no;
00650             }
00651           <span class="keywordflow">else</span>
00652             <a class="code" href="allvars_8c.html#a59">Nextnode</a>[last] = no;
00653         }
00654 
00655       last = no;
00656 
00657       <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>)      <span class="comment">/* only set it for single particles */</span>
00658         <a class="code" href="allvars_8c.html#a60">Father</a>[no] = father;
00659     }
00660 
00661 }
00662 
00663 
00664 
00671 <span class="keywordtype">void</span> <a class="code" href="forcetree_8c.html#a18">force_update_pseudoparticles</a>(<span class="keywordtype">void</span>)
00672 {
<a name="l00673"></a><a class="code" href="proto_8h.html#a76">00673</a>   <a class="code" href="forcetree_8c.html#a19">force_exchange_pseudodata</a>();
00674 
00675   <a class="code" href="forcetree_8c.html#a20">force_treeupdate_pseudos</a>();
00676 }
00677 
00678 
00679 
00684 <span class="keywordtype">void</span> <a class="code" href="forcetree_8c.html#a19">force_exchange_pseudodata</a>(<span class="keywordtype">void</span>)
00685 {
<a name="l00686"></a><a class="code" href="proto_8h.html#a53">00686</a>   <span class="keywordtype">int</span> i, no;
00687   MPI_Status status;
00688   <span class="keywordtype">int</span> level, sendTask, recvTask;
00689 
00690   <span class="keywordflow">for</span>(i = DomainMyStart; i &lt;= DomainMyLast; i++)
00691     {
00692       no = <a class="code" href="allvars_8c.html#a29">DomainNodeIndex</a>[i];
00693 
00694       <span class="comment">/* read out the multipole moments from the local base cells */</span>
00695       <a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#o0">s</a>[0] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[0];
00696       <a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#o0">s</a>[1] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[1];
00697       <a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#o0">s</a>[2] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[2];
00698       <a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#o1">vs</a>[0] = <a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o1">vs</a>[0];
00699       <a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#o1">vs</a>[1] = <a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o1">vs</a>[1];
00700       <a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#o1">vs</a>[2] = <a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o1">vs</a>[2];
00701       <a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#o2">mass</a> = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a>;
00702 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
00703 <span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
00704 <span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].bitflags = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a>;
00705 <span class="preprocessor">#else</span>
00706 <span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].maxsoft = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].maxsoft;
00707 <span class="preprocessor">#endif</span>
00708 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00709 <span class="preprocessor"></span>    }
00710 
00711   <span class="comment">/* share the pseudo-particle data accross CPUs */</span>
00712 
00713   <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; PTask); level++)
00714     {
00715       sendTask = ThisTask;
00716       recvTask = <a class="code" href="allvars_8c.html#a0">ThisTask</a> ^ level;
00717 
00718       <span class="keywordflow">if</span>(recvTask &lt; NTask)
00719         MPI_Sendrecv(&amp;DomainMoment[DomainStartList[sendTask]],
00720                      (DomainEndList[sendTask] - DomainStartList[sendTask] + 1) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structDomainNODE.html">DomainNODE</a>),
00721                      MPI_BYTE, recvTask, TAG_DMOM,
00722                      &amp;DomainMoment[DomainStartList[recvTask]],
00723                      (DomainEndList[recvTask] - DomainStartList[recvTask] + 1) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> DomainNODE),
00724                      MPI_BYTE, recvTask, TAG_DMOM, MPI_COMM_WORLD, &amp;status);
00725     }
00726 
00727 }
00728 
00732 <span class="keywordtype">void</span> <a class="code" href="forcetree_8c.html#a20">force_treeupdate_pseudos</a>(<span class="keywordtype">void</span>)
00733 {
<a name="l00734"></a><a class="code" href="proto_8h.html#a67">00734</a>   <span class="keywordtype">int</span> i, k, no;
00735   <a class="code" href="allvars_8h.html#a35">FLOAT</a> sold[3], vsold[3], snew[3], vsnew[3], massold, massnew, mm;
00736 
00737 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
00738 <span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
00739 <span class="preprocessor"></span>  <span class="keywordtype">int</span> maxsofttype, diffsoftflag;
00740 <span class="preprocessor">#else</span>
00741 <span class="preprocessor"></span>  <a class="code" href="allvars_8h.html#a35">FLOAT</a> maxsoft;
00742 <span class="preprocessor">#endif</span>
00743 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00744 <span class="preprocessor"></span>
00745   <span class="keywordflow">for</span>(i = 0; i &lt; NTopleaves; i++)
00746     <span class="keywordflow">if</span>(i &lt; DomainMyStart || i &gt; DomainMyLast)
00747       {
00748         no = <a class="code" href="allvars_8c.html#a29">DomainNodeIndex</a>[i];
00749 
00750         <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00751           {
00752             sold[k] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[k];
00753             vsold[k] = <a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o1">vs</a>[k];
00754           }
00755         massold = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a>;
00756 
00757         <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00758           {
00759             snew[k] = <a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#o0">s</a>[k];
00760             vsnew[k] = <a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#o1">vs</a>[k];
00761           }
00762         massnew = <a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].<a class="code" href="structDomainNODE.html#o2">mass</a>;
00763 
00764 
00765 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
00766 <span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
00767 <span class="preprocessor"></span>        maxsofttype = (<a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].bitflags &gt;&gt; 2) &amp; 7;
00768         diffsoftflag = (<a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].bitflags &gt;&gt; 5) &amp; 1;
00769 <span class="preprocessor">#else</span>
00770 <span class="preprocessor"></span>        maxsoft = <a class="code" href="allvars_8c.html#a32">DomainMoment</a>[i].maxsoft;
00771 <span class="preprocessor">#endif</span>
00772 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00773 <span class="preprocessor"></span>        <span class="keywordflow">do</span>
00774           {
00775             mm = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a> + massnew - massold;
00776             <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00777               {
00778                 <span class="keywordflow">if</span>(mm &gt; 0)
00779                   {
00780                     <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[k] =
00781                       (<a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a> * <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[k] + massnew * snew[k] - massold * sold[k]) / mm;
00782                     <a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o1">vs</a>[k] =
00783                       (<a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a> * <a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o1">vs</a>[k] + massnew * vsnew[k] -
00784                        massold * vsold[k]) / mm;
00785                   }
00786               }
00787             <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a> = mm;
00788 
00789 
00790 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
00791 <span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
00792 <span class="preprocessor"></span>            diffsoftflag |= (<a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 5) &amp; 1;
00793 
00794             <span class="keywordflow">if</span>(maxsofttype == 7)
00795               maxsofttype = (<a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 2) &amp; 7;
00796             <span class="keywordflow">else</span>
00797               {
00798                 <span class="keywordflow">if</span>(((<a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 2) &amp; 7) != 7)
00799                   {
00800                     <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[((<a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 2) &amp; 7)] &gt;
00801                        <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[maxsofttype])
00802                       {
00803                         maxsofttype = ((<a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 2) &amp; 7);
00804                         diffsoftflag = 1;
00805                       }
00806                     <span class="keywordflow">else</span>
00807                       {
00808                         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[((<a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 2) &amp; 7)] &lt;
00809                            <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[maxsofttype])
00810                           diffsoftflag = 1;
00811                       }
00812                   }
00813               }
00814 
00815             <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> = (<a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &amp; 3) + 4 * maxsofttype + 32 * diffsoftflag;
00816 <span class="preprocessor">#else</span>
00817 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a58">Nodes</a>[no].maxsoft &lt; maxsoft)
00818               <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].maxsoft = maxsoft;
00819             maxsoft = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].maxsoft;
00820 <span class="preprocessor">#endif</span>
00821 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00822 <span class="preprocessor"></span>            no = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o8">father</a>;
00823 
00824           }
00825         <span class="keywordflow">while</span>(no &gt;= 0);
00826       }
00827 }
00828 
00829 
00830 
00834 <span class="keywordtype">void</span> <a class="code" href="forcetree_8c.html#a21">force_flag_localnodes</a>(<span class="keywordtype">void</span>)
00835 {
<a name="l00836"></a><a class="code" href="proto_8h.html#a54">00836</a>   <span class="keywordtype">int</span> no, i;
00837 
00838   <span class="comment">/* mark all top-level nodes */</span>
00839 
00840   <span class="keywordflow">for</span>(i = 0; i &lt; NTopleaves; i++)
00841     {
00842       no = <a class="code" href="allvars_8c.html#a29">DomainNodeIndex</a>[i];
00843 
00844       <span class="keywordflow">while</span>(no &gt;= 0)
00845         {
00846           <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &amp; 1))
00847             <span class="keywordflow">break</span>;
00848 
00849           <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> |= 1;
00850 
00851           no = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o8">father</a>;
00852         }
00853     }
00854 
00855   <span class="comment">/* mark top-level nodes that contain local particles */</span>
00856 
00857   <span class="keywordflow">for</span>(i = DomainMyStart; i &lt;= DomainMyLast; i++)
00858     {
00859       <span class="comment">/*</span>
00860 <span class="comment">         if(DomainMoment[i].mass &gt; 0)</span>
00861 <span class="comment">       */</span>
00862       {
00863         no = <a class="code" href="allvars_8c.html#a29">DomainNodeIndex</a>[i];
00864 
00865         <span class="keywordflow">while</span>(no &gt;= 0)
00866           {
00867             <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &amp; 2))
00868               <span class="keywordflow">break</span>;
00869 
00870             <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> |= 2;
00871 
00872             no = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o8">father</a>;
00873           }
00874       }
00875     }
00876 }
00877 
00878 
00879 
00885 <span class="keywordtype">void</span> <a class="code" href="forcetree_8c.html#a22">force_update_len</a>(<span class="keywordtype">void</span>)
00886 {
<a name="l00887"></a><a class="code" href="proto_8h.html#a69">00887</a>   <span class="keywordtype">int</span> i, no;
00888   MPI_Status status;
00889   <span class="keywordtype">int</span> level, sendTask, recvTask;
00890 
00891   <a class="code" href="forcetree_8c.html#a23">force_update_node_len_local</a>();
00892 
00893   <span class="comment">/* first update the side-lengths of all local nodes */</span>
00894   <span class="keywordflow">for</span>(i = DomainMyStart; i &lt;= DomainMyLast; i++)
00895     {
00896       no = <a class="code" href="allvars_8c.html#a29">DomainNodeIndex</a>[i];
00897 
00898       <a class="code" href="allvars_8c.html#a30">DomainTreeNodeLen</a>[i] = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o0">len</a>;
00899     }
00900 
00901   <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; PTask); level++)
00902     {
00903       sendTask = ThisTask;
00904       recvTask = <a class="code" href="allvars_8c.html#a0">ThisTask</a> ^ level;
00905 
00906       <span class="keywordflow">if</span>(recvTask &lt; NTask)
00907         MPI_Sendrecv(&amp;DomainTreeNodeLen[DomainStartList[sendTask]],
00908                      (DomainEndList[sendTask] - DomainStartList[sendTask] + 1) * <span class="keyword">sizeof</span>(FLOAT),
00909                      MPI_BYTE, recvTask, TAG_NODELEN,
00910                      &amp;DomainTreeNodeLen[DomainStartList[recvTask]],
00911                      (DomainEndList[recvTask] - DomainStartList[recvTask] + 1) * <span class="keyword">sizeof</span>(FLOAT),
00912                      MPI_BYTE, recvTask, TAG_NODELEN, MPI_COMM_WORLD, &amp;status);
00913     }
00914 
00915   <span class="comment">/* Finally, we update the top-level tree. */</span>
00916   <a class="code" href="forcetree_8c.html#a24">force_update_node_len_toptree</a>();
00917 }
00918 
00919 
00923 <span class="keywordtype">void</span> <a class="code" href="forcetree_8c.html#a23">force_update_node_len_local</a>(<span class="keywordtype">void</span>)
00924 {
<a name="l00925"></a><a class="code" href="proto_8h.html#a73">00925</a>   <span class="keywordtype">int</span> i, p, k, no;
00926   <a class="code" href="allvars_8h.html#a35">FLOAT</a> dist, distmax;
00927 
00928   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00929     {
00930       no = <a class="code" href="allvars_8c.html#a60">Father</a>[i];
00931 
00932       <span class="keywordflow">for</span>(k = 0, distmax = 0; k &lt; 3; k++)
00933         {
00934           dist = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[k] - <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o1">center</a>[k];
00935           <span class="keywordflow">if</span>(dist &lt; 0)
00936             dist = -dist;
00937           <span class="keywordflow">if</span>(dist &gt; distmax)
00938             distmax = dist;
00939         }
00940 
00941       <span class="keywordflow">if</span>(distmax + distmax &gt; <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o0">len</a>)
00942         {
00943           <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o0">len</a> = distmax + distmax;
00944           p = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o8">father</a>;
00945 
00946           <span class="keywordflow">while</span>(p &gt;= 0)
00947             {
00948               distmax = <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o1">center</a>[0] - <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o1">center</a>[0];
00949               <span class="keywordflow">if</span>(distmax &lt; 0)
00950                 distmax = -distmax;
00951               distmax = distmax + distmax + <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o0">len</a>;
00952 
00953               <span class="keywordflow">if</span>(0.999999 * distmax &gt; <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o0">len</a>)
00954                 {
00955                   <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o0">len</a> = distmax;
00956                   no = p;
00957                   p = <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o8">father</a>;
00958                 }
00959               <span class="keywordflow">else</span>
00960                 <span class="keywordflow">break</span>;
00961             }
00962         }
00963     }
00964 }
00965 
00966 
00970 <span class="keywordtype">void</span> <a class="code" href="forcetree_8c.html#a24">force_update_node_len_toptree</a>(<span class="keywordtype">void</span>)
00971 {
<a name="l00972"></a><a class="code" href="proto_8h.html#a74">00972</a>   <span class="keywordtype">int</span> i, no, p;
00973   <a class="code" href="allvars_8h.html#a35">FLOAT</a> distmax;
00974 
00975   <span class="keywordflow">for</span>(i = 0; i &lt; NTopleaves; i++)
00976     <span class="keywordflow">if</span>(i &lt; DomainMyStart || i &gt; DomainMyLast)
00977       {
00978         no = <a class="code" href="allvars_8c.html#a29">DomainNodeIndex</a>[i];
00979 
00980         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o0">len</a> &lt; <a class="code" href="allvars_8c.html#a30">DomainTreeNodeLen</a>[i])
00981           <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o0">len</a> = <a class="code" href="allvars_8c.html#a30">DomainTreeNodeLen</a>[i];
00982 
00983         p = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o8">father</a>;
00984 
00985         <span class="keywordflow">while</span>(p &gt;= 0)
00986           {
00987             distmax = <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o1">center</a>[0] - <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o1">center</a>[0];
00988             <span class="keywordflow">if</span>(distmax &lt; 0)
00989               distmax = -distmax;
00990             distmax = distmax + distmax + <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o0">len</a>;
00991 
00992             <span class="keywordflow">if</span>(0.999999 * distmax &gt; <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o0">len</a>)
00993               {
00994                 <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o0">len</a> = distmax;
00995                 no = p;
00996                 p = <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o8">father</a>;
00997               }
00998             <span class="keywordflow">else</span>
00999               <span class="keywordflow">break</span>;
01000           }
01001       }
01002 }
01003 
01004 
01005 
01006 
01014 <span class="keywordtype">void</span> <a class="code" href="forcetree_8c.html#a25">force_update_hmax</a>(<span class="keywordtype">void</span>)
01015 {
<a name="l01016"></a><a class="code" href="proto_8h.html#a68">01016</a>   <span class="keywordtype">int</span> i, no;
01017   MPI_Status status;
01018   <span class="keywordtype">int</span> level, sendTask, recvTask;
01019 
01020   <a class="code" href="forcetree_8c.html#a26">force_update_node_hmax_local</a>();
01021 
01022   <span class="keywordflow">for</span>(i = DomainMyStart; i &lt;= DomainMyLast; i++)
01023     {
01024       no = <a class="code" href="allvars_8c.html#a29">DomainNodeIndex</a>[i];
01025 
01026       <a class="code" href="allvars_8c.html#a31">DomainHmax</a>[i] = <a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o0">hmax</a>;
01027     }
01028 
01029   <span class="comment">/* share the hmax-data of the pseudo-particles accross CPUs */</span>
01030 
01031   <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; PTask); level++)
01032     {
01033       sendTask = ThisTask;
01034       recvTask = <a class="code" href="allvars_8c.html#a0">ThisTask</a> ^ level;
01035 
01036       <span class="keywordflow">if</span>(recvTask &lt; NTask)
01037         MPI_Sendrecv(&amp;DomainHmax[DomainStartList[sendTask]],
01038                      (DomainEndList[sendTask] - DomainStartList[sendTask] + 1) * <span class="keyword">sizeof</span>(FLOAT),
01039                      MPI_BYTE, recvTask, TAG_HMAX,
01040                      &amp;DomainHmax[DomainStartList[recvTask]],
01041                      (DomainEndList[recvTask] - DomainStartList[recvTask] + 1) * <span class="keyword">sizeof</span>(FLOAT),
01042                      MPI_BYTE, recvTask, TAG_HMAX, MPI_COMM_WORLD, &amp;status);
01043     }
01044 
01045 
01046   <a class="code" href="forcetree_8c.html#a27">force_update_node_hmax_toptree</a>();
01047 }
01048 
01051 <span class="keywordtype">void</span> <a class="code" href="forcetree_8c.html#a26">force_update_node_hmax_local</a>(<span class="keywordtype">void</span>)
01052 {
<a name="l01053"></a><a class="code" href="proto_8h.html#a71">01053</a>   <span class="keywordtype">int</span> i, p, no;
01054 
01055   <span class="keywordflow">for</span>(i = 0; i &lt; N_gas; i++)
01056     {
01057 
01058       no = <a class="code" href="allvars_8c.html#a60">Father</a>[i];
01059 
01060       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> &gt; <a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o0">hmax</a>)
01061         {
01062 
01063           <a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o0">hmax</a> = <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
01064           p = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o8">father</a>;
01065 
01066           <span class="keywordflow">while</span>(p &gt;= 0)
01067             {
01068               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o0">hmax</a> &gt; <a class="code" href="allvars_8c.html#a62">Extnodes</a>[p].<a class="code" href="structextNODE.html#o0">hmax</a>)
01069                 {
01070                   <a class="code" href="allvars_8c.html#a62">Extnodes</a>[p].<a class="code" href="structextNODE.html#o0">hmax</a> = <a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o0">hmax</a>;
01071                   no = p;
01072                   p = <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o8">father</a>;
01073                 }
01074               <span class="keywordflow">else</span>
01075                 <span class="keywordflow">break</span>;
01076             }
01077         }
01078 
01079     }
01080 }
01081 
01082 
01083 
01084 
01087 <span class="keywordtype">void</span> <a class="code" href="forcetree_8c.html#a27">force_update_node_hmax_toptree</a>(<span class="keywordtype">void</span>)
01088 {
<a name="l01089"></a><a class="code" href="proto_8h.html#a72">01089</a> 
01090   <span class="keywordtype">int</span> i, no, p;
01091 
01092 
01093   <span class="keywordflow">for</span>(i = 0; i &lt; NTopleaves; i++)
01094     <span class="keywordflow">if</span>(i &lt; DomainMyStart || i &gt; DomainMyLast)
01095       {
01096         no = <a class="code" href="allvars_8c.html#a29">DomainNodeIndex</a>[i];
01097 
01098         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o0">hmax</a> &lt; <a class="code" href="allvars_8c.html#a31">DomainHmax</a>[i])
01099           <a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o0">hmax</a> = <a class="code" href="allvars_8c.html#a31">DomainHmax</a>[i];
01100 
01101         p = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o8">father</a>;
01102 
01103         <span class="keywordflow">while</span>(p &gt;= 0)
01104           {
01105             <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o0">hmax</a> &gt; <a class="code" href="allvars_8c.html#a62">Extnodes</a>[p].<a class="code" href="structextNODE.html#o0">hmax</a>)
01106               {
01107                 <a class="code" href="allvars_8c.html#a62">Extnodes</a>[p].<a class="code" href="structextNODE.html#o0">hmax</a> = <a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o0">hmax</a>;
01108                 no = p;
01109                 p = <a class="code" href="allvars_8c.html#a58">Nodes</a>[p].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o8">father</a>;
01110               }
01111             <span class="keywordflow">else</span>
01112               <span class="keywordflow">break</span>;
01113           }
01114       }
01115 }
01116 
01117 
01118 
01119 
01120 
01126 <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a60">force_treeevaluate</a>(<span class="keywordtype">int</span> target, <span class="keywordtype">int</span> mode, <span class="keywordtype">double</span> *ewaldcountsum)
01127 {
<a name="l01128"></a><a class="code" href="proto_8h.html#a60">01128</a>   <span class="keyword">struct </span><a class="code" href="structNODE.html">NODE</a> *nop = 0;
01129   <span class="keywordtype">int</span> no, ninteractions, ptype;
01130   <span class="keywordtype">double</span> r2, dx, dy, dz, mass, r, fac, u, h, h_inv, h3_inv;
01131   <span class="keywordtype">double</span> acc_x, acc_y, acc_z, pos_x, pos_y, pos_z, aold;
01132 <span class="preprocessor">#if defined(UNEQUALSOFTENINGS) &amp;&amp; !defined(ADAPTIVE_GRAVSOFT_FORGAS)</span>
01133 <span class="preprocessor"></span>  <span class="keywordtype">int</span> maxsofttype;
01134 <span class="preprocessor">#endif</span>
01135 <span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
01136 <span class="preprocessor"></span>  <span class="keywordtype">double</span> soft = 0;
01137 <span class="preprocessor">#endif</span>
01138 <span class="preprocessor"></span><span class="preprocessor">#ifdef PERIODIC</span>
01139 <span class="preprocessor"></span>  <span class="keywordtype">double</span> boxsize, boxhalf;
01140 
01141   boxsize = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
01142   boxhalf = 0.5 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
01143 <span class="preprocessor">#endif</span>
01144 <span class="preprocessor"></span>
01145   acc_x = 0;
01146   acc_y = 0;
01147   acc_z = 0;
01148   ninteractions = 0;
01149 
01150   <span class="keywordflow">if</span>(mode == 0)
01151     {
01152       pos_x = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o0">Pos</a>[0];
01153       pos_y = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o0">Pos</a>[1];
01154       pos_z = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o0">Pos</a>[2];
01155       ptype = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o9">Type</a>;
01156       aold = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o90">ErrTolForceAcc</a> * <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o7">OldAcc</a>;
01157 <span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
01158 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
01159         soft = <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
01160 <span class="preprocessor">#endif</span>
01161 <span class="preprocessor"></span>    }
01162   <span class="keywordflow">else</span>
01163     {
01164       pos_x = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o0">Pos</a>[0];
01165       pos_y = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o0">Pos</a>[1];
01166       pos_z = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o0">Pos</a>[2];
01167 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
01168 <span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].Type;
01169 <span class="preprocessor">#else</span>
01170 <span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a51">P</a>[0].<a class="code" href="structparticle__data.html#o9">Type</a>;
01171 <span class="preprocessor">#endif</span>
01172 <span class="preprocessor"></span>      aold = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o90">ErrTolForceAcc</a> * <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o6">w</a>.<a class="code" href="structgravdata__in.html#o4">OldAcc</a>;
01173 <span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
01174 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
01175         soft = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].Soft;
01176 <span class="preprocessor">#endif</span>
01177 <span class="preprocessor"></span>    }
01178 
01179 
01180 
01181 <span class="preprocessor">#ifndef UNEQUALSOFTENINGS</span>
01182 <span class="preprocessor"></span>  h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
01183   h_inv = 1.0 / h;
01184   h3_inv = h_inv * h_inv * h_inv;
01185 <span class="preprocessor">#endif</span>
01186 <span class="preprocessor"></span>  no = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>;             <span class="comment">/* root node */</span>
01187 
01188   <span class="keywordflow">while</span>(no &gt;= 0)
01189     {
01190       <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>)      <span class="comment">/* single particle */</span>
01191         {
01192           <span class="comment">/* the index of the node is the index of the particle */</span>
01193           <span class="comment">/* observe the sign */</span>
01194 
01195           dx = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o0">Pos</a>[0] - pos_x;
01196           dy = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o0">Pos</a>[1] - pos_y;
01197           dz = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o0">Pos</a>[2] - pos_z;
01198 
01199           mass = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o1">Mass</a>;
01200         }
01201       <span class="keywordflow">else</span>
01202         {
01203           <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)      <span class="comment">/* pseudo particle */</span>
01204             {
01205               <span class="keywordflow">if</span>(mode == 0)
01206                 {
01207                   <a class="code" href="allvars_8c.html#a11">Exportflag</a>[<a class="code" href="allvars_8c.html#a28">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)]] = 1;
01208                 }
01209               no = <a class="code" href="allvars_8c.html#a59">Nextnode</a>[no - MaxNodes];
01210               <span class="keywordflow">continue</span>;
01211             }
01212           nop = &amp;<a class="code" href="allvars_8c.html#a58">Nodes</a>[no];
01213           dx = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[0] - pos_x;
01214           dy = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[1] - pos_y;
01215           dz = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[2] - pos_z;
01216 
01217           mass = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a>;
01218         }
01219 <span class="preprocessor">#ifdef PERIODIC</span>
01220 <span class="preprocessor"></span>      dx = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dx);
01221       dy = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dy);
01222       dz = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dz);
01223 <span class="preprocessor">#endif</span>
01224 <span class="preprocessor"></span>      r2 = dx * dx + dy * dy + dz * dz;
01225 
01226       <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>)
01227         {
01228 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
01229 <span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
01230 <span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
01231             h = soft;
01232           <span class="keywordflow">else</span>
01233             h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
01234 
01235           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
01236             {
01237               <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a53">SphP</a>[no].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>)
01238                 h = <a class="code" href="allvars_8c.html#a53">SphP</a>[no].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
01239             }
01240           <span class="keywordflow">else</span>
01241             {
01242               <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a>])
01243                 h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a>];
01244             }
01245 <span class="preprocessor">#else</span>
01246 <span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
01247           <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a>])
01248             h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a>];
01249 <span class="preprocessor">#endif</span>
01250 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01251 <span class="preprocessor"></span>          no = <a class="code" href="allvars_8c.html#a59">Nextnode</a>[no];
01252         }
01253       <span class="keywordflow">else</span>                      <span class="comment">/* we have an  internal node. Need to check opening criterion */</span>
01254         {
01255           <span class="keywordflow">if</span>(mode == 1)
01256             {
01257               <span class="keywordflow">if</span>((nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &amp; 3) == 1)  <span class="comment">/* if it's a top-level node</span>
01258 <span class="comment">                                                 * which does not contain</span>
01259 <span class="comment">                                                 * local particles we can</span>
01260 <span class="comment">                                                 * continue to do a short-cut */</span>
01261                 {
01262                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o6">sibling</a>;
01263                   <span class="keywordflow">continue</span>;
01264                 }
01265             }
01266 
01267 
01268           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o89">ErrTolTheta</a>)   <span class="comment">/* check Barnes-Hut opening criterion */</span>
01269             {
01270               <span class="keywordflow">if</span>(nop-&gt;<a class="code" href="structNODE.html#o0">len</a> * nop-&gt;<a class="code" href="structNODE.html#o0">len</a> &gt; r2 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o89">ErrTolTheta</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o89">ErrTolTheta</a>)
01271                 {
01272                   <span class="comment">/* open cell */</span>
01273                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
01274                   <span class="keywordflow">continue</span>;
01275                 }
01276             }
01277           <span class="keywordflow">else</span>                  <span class="comment">/* check relative opening criterion */</span>
01278             {
01279               <span class="keywordflow">if</span>(mass * nop-&gt;<a class="code" href="structNODE.html#o0">len</a> * nop-&gt;<a class="code" href="structNODE.html#o0">len</a> &gt; r2 * r2 * aold)
01280                 {
01281                   <span class="comment">/* open cell */</span>
01282                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
01283                   <span class="keywordflow">continue</span>;
01284                 }
01285 
01286               <span class="comment">/* check in addition whether we lie inside the cell */</span>
01287 
01288               <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[0] - pos_x) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#o0">len</a>)
01289                 {
01290                   <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[1] - pos_y) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#o0">len</a>)
01291                     {
01292                       <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[2] - pos_z) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#o0">len</a>)
01293                         {
01294                           no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
01295                           <span class="keywordflow">continue</span>;
01296                         }
01297                     }
01298                 }
01299             }
01300 
01301 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
01302 <span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
01303 <span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
01304           maxsofttype = (nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 2) &amp; 7;
01305           <span class="keywordflow">if</span>(maxsofttype == 7) <span class="comment">/* may only occur for zero mass top-level nodes */</span>
01306             {
01307               <span class="keywordflow">if</span>(mass &gt; 0)
01308                 <a class="code" href="proto_8h.html#a38">endrun</a>(986);
01309               no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
01310               <span class="keywordflow">continue</span>;
01311             }
01312           <span class="keywordflow">else</span>
01313             {
01314               <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[maxsofttype])
01315                 {
01316                   h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[maxsofttype];
01317                   <span class="keywordflow">if</span>(r2 &lt; h * h)
01318                     {
01319                       <span class="keywordflow">if</span>(((nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 5) &amp; 1))        <span class="comment">/* bit-5 signals that there are particles of different softening in the node */</span>
01320                         {
01321                           no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
01322                           <span class="keywordflow">continue</span>;
01323                         }
01324                     }
01325                 }
01326             }
01327 <span class="preprocessor">#else</span>
01328 <span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
01329             h = soft;
01330           <span class="keywordflow">else</span>
01331             h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
01332 
01333           <span class="keywordflow">if</span>(h &lt; nop-&gt;maxsoft)
01334             {
01335               h = nop-&gt;maxsoft;
01336               <span class="keywordflow">if</span>(r2 &lt; h * h)
01337                 {
01338                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
01339                   <span class="keywordflow">continue</span>;
01340                 }
01341             }
01342 <span class="preprocessor">#endif</span>
01343 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01344 <span class="preprocessor"></span>
01345           no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o6">sibling</a>;        <span class="comment">/* ok, node can be used */</span>
01346 
01347           <span class="keywordflow">if</span>(mode == 1)
01348             {
01349               <span class="keywordflow">if</span>(((nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a>) &amp; 1))     <span class="comment">/* Bit 0 signals that this node belongs to top-level tree */</span>
01350                 <span class="keywordflow">continue</span>;
01351             }
01352         }
01353 
01354       r = sqrt(r2);
01355 
01356       <span class="keywordflow">if</span>(r &gt;= h)
01357         fac = mass / (r2 * r);
01358       <span class="keywordflow">else</span>
01359         {
01360 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
01361 <span class="preprocessor"></span>          h_inv = 1.0 / h;
01362           h3_inv = h_inv * h_inv * h_inv;
01363 <span class="preprocessor">#endif</span>
01364 <span class="preprocessor"></span>          u = r * h_inv;
01365           <span class="keywordflow">if</span>(u &lt; 0.5)
01366             fac = mass * h3_inv * (10.666666666667 + u * u * (32.0 * u - 38.4));
01367           <span class="keywordflow">else</span>
01368             fac =
01369               mass * h3_inv * (21.333333333333 - 48.0 * u +
01370                                38.4 * u * u - 10.666666666667 * u * u * u - 0.066666666667 / (u * u * u));
01371         }
01372 
01373       acc_x += dx * fac;
01374       acc_y += dy * fac;
01375       acc_z += dz * fac;
01376 
01377       ninteractions++;
01378     }
01379 
01380 
01381   <span class="comment">/* store result at the proper place */</span>
01382   <span class="keywordflow">if</span>(mode == 0)
01383     {
01384       <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[0] = acc_x;
01385       <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[1] = acc_y;
01386       <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[2] = acc_z;
01387       <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o12">GravCost</a> = ninteractions;
01388     }
01389   <span class="keywordflow">else</span>
01390     {
01391       <a class="code" href="allvars_8c.html#a68">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o1">Acc</a>[0] = acc_x;
01392       <a class="code" href="allvars_8c.html#a68">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o1">Acc</a>[1] = acc_y;
01393       <a class="code" href="allvars_8c.html#a68">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o1">Acc</a>[2] = acc_z;
01394       <a class="code" href="allvars_8c.html#a68">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#o6">w</a>.<a class="code" href="structgravdata__in.html#o5">Ninteractions</a> = ninteractions;
01395     }
01396 
01397 <span class="preprocessor">#ifdef PERIODIC</span>
01398 <span class="preprocessor"></span>  *ewaldcountsum += <a class="code" href="proto_8h.html#a62">force_treeevaluate_ewald_correction</a>(target, mode, pos_x, pos_y, pos_z, aold);
01399 <span class="preprocessor">#endif</span>
01400 <span class="preprocessor"></span>
01401   <span class="keywordflow">return</span> ninteractions;
01402 }
01403 
01404 
01405 
01406 
01407 
01408 
01409 <span class="preprocessor">#ifdef PMGRID</span>
01410 <span class="preprocessor"></span>
01420 <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a65">force_treeevaluate_shortrange</a>(<span class="keywordtype">int</span> target, <span class="keywordtype">int</span> mode)
01421 {
<a name="l01422"></a><a class="code" href="proto_8h.html#a65">01422</a>   <span class="keyword">struct </span><a class="code" href="structNODE.html">NODE</a> *nop = 0;
01423   <span class="keywordtype">int</span> no, ptype, ninteractions, tabindex;
01424   <span class="keywordtype">double</span> r2, dx, dy, dz, mass, r, fac, u, h, h_inv, h3_inv;
01425   <span class="keywordtype">double</span> acc_x, acc_y, acc_z, pos_x, pos_y, pos_z, aold;
01426   <span class="keywordtype">double</span> eff_dist;
01427   <span class="keywordtype">double</span> rcut, asmth, asmthfac, rcut2, dist;
01428 <span class="preprocessor">#if defined(UNEQUALSOFTENINGS) &amp;&amp; !defined(ADAPTIVE_GRAVSOFT_FORGAS)</span>
01429 <span class="preprocessor"></span>  <span class="keywordtype">int</span> maxsofttype;
01430 <span class="preprocessor">#endif</span>
01431 <span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
01432 <span class="preprocessor"></span>  <span class="keywordtype">double</span> soft = 0;
01433 <span class="preprocessor">#endif</span>
01434 <span class="preprocessor"></span><span class="preprocessor">#ifdef PERIODIC</span>
01435 <span class="preprocessor"></span>  <span class="keywordtype">double</span> boxsize, boxhalf;
01436 
01437   boxsize = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
01438   boxhalf = 0.5 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
01439 <span class="preprocessor">#endif</span>
01440 <span class="preprocessor"></span>
01441 
01442   acc_x = 0;
01443   acc_y = 0;
01444   acc_z = 0;
01445   ninteractions = 0;
01446 
01447   <span class="keywordflow">if</span>(mode == 0)
01448     {
01449       pos_x = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o0">Pos</a>[0];
01450       pos_y = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o0">Pos</a>[1];
01451       pos_z = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o0">Pos</a>[2];
01452       ptype = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o9">Type</a>;
01453       aold = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o90">ErrTolForceAcc</a> * <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o7">OldAcc</a>;
01454 <span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
01455 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
01456         soft = <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
01457 <span class="preprocessor">#endif</span>
01458 <span class="preprocessor"></span>    }
01459   <span class="keywordflow">else</span>
01460     {
01461       pos_x = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o0">Pos</a>[0];
01462       pos_y = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o0">Pos</a>[1];
01463       pos_z = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o0">Pos</a>[2];
01464 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
01465 <span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].Type;
01466 <span class="preprocessor">#else</span>
01467 <span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a51">P</a>[0].<a class="code" href="structparticle__data.html#o9">Type</a>;
01468 <span class="preprocessor">#endif</span>
01469 <span class="preprocessor"></span>      aold = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o90">ErrTolForceAcc</a> * <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o6">w</a>.<a class="code" href="structgravdata__in.html#o4">OldAcc</a>;
01470 <span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
01471 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
01472         soft = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].Soft;
01473 <span class="preprocessor">#endif</span>
01474 <span class="preprocessor"></span>    }
01475 
01476   rcut = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o64">Rcut</a>[0];
01477   asmth = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o63">Asmth</a>[0];
01478 <span class="preprocessor">#ifdef PLACEHIGHRESREGION</span>
01479 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(((1 &lt;&lt; ptype) &amp; (PLACEHIGHRESREGION)))
01480     {
01481       rcut = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o64">Rcut</a>[1];
01482       asmth = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o63">Asmth</a>[1];
01483     }
01484 <span class="preprocessor">#endif</span>
01485 <span class="preprocessor"></span>  rcut2 = rcut * rcut;
01486 
01487   asmthfac = 0.5 / asmth * (<a class="code" href="forcetree_8c.html#a0">NTAB</a> / 3.0);
01488 
01489 <span class="preprocessor">#ifndef UNEQUALSOFTENINGS</span>
01490 <span class="preprocessor"></span>  h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
01491   h_inv = 1.0 / h;
01492   h3_inv = h_inv * h_inv * h_inv;
01493 <span class="preprocessor">#endif</span>
01494 <span class="preprocessor"></span>  no = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>;             <span class="comment">/* root node */</span>
01495 
01496   <span class="keywordflow">while</span>(no &gt;= 0)
01497     {
01498       <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>)
01499         {
01500           <span class="comment">/* the index of the node is the index of the particle */</span>
01501           dx = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o0">Pos</a>[0] - pos_x;
01502           dy = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o0">Pos</a>[1] - pos_y;
01503           dz = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o0">Pos</a>[2] - pos_z;
01504 <span class="preprocessor">#ifdef PERIODIC</span>
01505 <span class="preprocessor"></span>          dx = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dx);
01506           dy = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dy);
01507           dz = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dz);
01508 <span class="preprocessor">#endif</span>
01509 <span class="preprocessor"></span>          r2 = dx * dx + dy * dy + dz * dz;
01510 
01511           mass = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o1">Mass</a>;
01512 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
01513 <span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
01514 <span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
01515             h = soft;
01516           <span class="keywordflow">else</span>
01517             h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
01518 
01519           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
01520             {
01521               <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a53">SphP</a>[no].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>)
01522                 h = <a class="code" href="allvars_8c.html#a53">SphP</a>[no].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
01523             }
01524           <span class="keywordflow">else</span>
01525             {
01526               <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a>])
01527                 h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a>];
01528             }
01529 <span class="preprocessor">#else</span>
01530 <span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
01531           <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a>])
01532             h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a>];
01533 <span class="preprocessor">#endif</span>
01534 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01535 <span class="preprocessor"></span>          no = <a class="code" href="allvars_8c.html#a59">Nextnode</a>[no];
01536         }
01537       <span class="keywordflow">else</span>                      <span class="comment">/* we have an  internal node */</span>
01538         {
01539           <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)      <span class="comment">/* pseudo particle */</span>
01540             {
01541               <span class="keywordflow">if</span>(mode == 0)
01542                 {
01543                   <a class="code" href="allvars_8c.html#a11">Exportflag</a>[<a class="code" href="allvars_8c.html#a28">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)]] = 1;
01544                 }
01545               no = <a class="code" href="allvars_8c.html#a59">Nextnode</a>[no - MaxNodes];
01546               <span class="keywordflow">continue</span>;
01547             }
01548 
01549           nop = &amp;<a class="code" href="allvars_8c.html#a58">Nodes</a>[no];
01550 
01551           <span class="keywordflow">if</span>(mode == 1)
01552             {
01553               <span class="keywordflow">if</span>((nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &amp; 3) == 1)  <span class="comment">/* if it's a top-level node</span>
01554 <span class="comment">                                                 * which does not contain</span>
01555 <span class="comment">                                                 * local particles we can</span>
01556 <span class="comment">                                                 * continue at this point</span>
01557 <span class="comment">                                                 */</span>
01558                 {
01559                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o6">sibling</a>;
01560                   <span class="keywordflow">continue</span>;
01561                 }
01562             }
01563 
01564           mass = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a>;
01565 
01566           dx = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[0] - pos_x;
01567           dy = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[1] - pos_y;
01568           dz = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[2] - pos_z;
01569 <span class="preprocessor">#ifdef PERIODIC</span>
01570 <span class="preprocessor"></span>          dx = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dx);
01571           dy = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dy);
01572           dz = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dz);
01573 <span class="preprocessor">#endif</span>
01574 <span class="preprocessor"></span>          r2 = dx * dx + dy * dy + dz * dz;
01575 
01576           <span class="keywordflow">if</span>(r2 &gt; rcut2)
01577             {
01578               <span class="comment">/* check whether we can stop walking along this branch */</span>
01579               eff_dist = rcut + 0.5 * nop-&gt;<a class="code" href="structNODE.html#o0">len</a>;
01580 <span class="preprocessor">#ifdef PERIODIC</span>
01581 <span class="preprocessor"></span>              dist = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[0] - pos_x);
01582 <span class="preprocessor">#else</span>
01583 <span class="preprocessor"></span>              dist = nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[0] - pos_x;
01584 <span class="preprocessor">#endif</span>
01585 <span class="preprocessor"></span>              <span class="keywordflow">if</span>(dist &lt; -eff_dist || dist &gt; eff_dist)
01586                 {
01587                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o6">sibling</a>;
01588                   <span class="keywordflow">continue</span>;
01589                 }
01590 <span class="preprocessor">#ifdef PERIODIC</span>
01591 <span class="preprocessor"></span>              dist = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[1] - pos_y);
01592 <span class="preprocessor">#else</span>
01593 <span class="preprocessor"></span>              dist = nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[1] - pos_y;
01594 <span class="preprocessor">#endif</span>
01595 <span class="preprocessor"></span>              <span class="keywordflow">if</span>(dist &lt; -eff_dist || dist &gt; eff_dist)
01596                 {
01597                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o6">sibling</a>;
01598                   <span class="keywordflow">continue</span>;
01599                 }
01600 <span class="preprocessor">#ifdef PERIODIC</span>
01601 <span class="preprocessor"></span>              dist = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[2] - pos_z);
01602 <span class="preprocessor">#else</span>
01603 <span class="preprocessor"></span>              dist = nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[2] - pos_z;
01604 <span class="preprocessor">#endif</span>
01605 <span class="preprocessor"></span>              <span class="keywordflow">if</span>(dist &lt; -eff_dist || dist &gt; eff_dist)
01606                 {
01607                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o6">sibling</a>;
01608                   <span class="keywordflow">continue</span>;
01609                 }
01610             }
01611 
01612 
01613           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o89">ErrTolTheta</a>)   <span class="comment">/* check Barnes-Hut opening criterion */</span>
01614             {
01615               <span class="keywordflow">if</span>(nop-&gt;<a class="code" href="structNODE.html#o0">len</a> * nop-&gt;<a class="code" href="structNODE.html#o0">len</a> &gt; r2 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o89">ErrTolTheta</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o89">ErrTolTheta</a>)
01616                 {
01617                   <span class="comment">/* open cell */</span>
01618                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
01619                   <span class="keywordflow">continue</span>;
01620                 }
01621             }
01622           <span class="keywordflow">else</span>                  <span class="comment">/* check relative opening criterion */</span>
01623             {
01624               <span class="keywordflow">if</span>(mass * nop-&gt;<a class="code" href="structNODE.html#o0">len</a> * nop-&gt;<a class="code" href="structNODE.html#o0">len</a> &gt; r2 * r2 * aold)
01625                 {
01626                   <span class="comment">/* open cell */</span>
01627                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
01628                   <span class="keywordflow">continue</span>;
01629                 }
01630 
01631               <span class="comment">/* check in addition whether we lie inside the cell */</span>
01632 
01633               <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[0] - pos_x) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#o0">len</a>)
01634                 {
01635                   <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[1] - pos_y) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#o0">len</a>)
01636                     {
01637                       <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[2] - pos_z) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#o0">len</a>)
01638                         {
01639                           no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
01640                           <span class="keywordflow">continue</span>;
01641                         }
01642                     }
01643                 }
01644             }
01645 
01646 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
01647 <span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
01648 <span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
01649           maxsofttype = (nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 2) &amp; 7;
01650           <span class="keywordflow">if</span>(maxsofttype == 7) <span class="comment">/* may only occur for zero mass top-level nodes */</span>
01651             {
01652               <span class="keywordflow">if</span>(mass &gt; 0)
01653                 <a class="code" href="proto_8h.html#a38">endrun</a>(987);
01654               no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
01655               <span class="keywordflow">continue</span>;
01656             }
01657           <span class="keywordflow">else</span>
01658             {
01659               <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[maxsofttype])
01660                 {
01661                   h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[maxsofttype];
01662                   <span class="keywordflow">if</span>(r2 &lt; h * h)
01663                     {
01664                       <span class="keywordflow">if</span>(((nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 5) &amp; 1))        <span class="comment">/* bit-5 signals that there are particles of different softening in the node */</span>
01665                         {
01666                           no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
01667                           
01668                           <span class="keywordflow">continue</span>;
01669                         }
01670                     }
01671                 }
01672             }
01673 <span class="preprocessor">#else</span>
01674 <span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
01675             h = soft;
01676           <span class="keywordflow">else</span>
01677             h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
01678 
01679           <span class="keywordflow">if</span>(h &lt; nop-&gt;maxsoft)
01680             {
01681               h = nop-&gt;maxsoft;
01682               <span class="keywordflow">if</span>(r2 &lt; h * h)
01683                 {
01684                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
01685                   <span class="keywordflow">continue</span>;
01686                 }
01687             }
01688 <span class="preprocessor">#endif</span>
01689 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01690 <span class="preprocessor"></span>          no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o6">sibling</a>;        <span class="comment">/* ok, node can be used */</span>
01691 
01692           <span class="keywordflow">if</span>(mode == 1)
01693             {
01694               <span class="keywordflow">if</span>(((nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a>) &amp; 1))     <span class="comment">/* Bit 0 signals that this node belongs to top-level tree */</span>
01695                 <span class="keywordflow">continue</span>;
01696             }
01697         }
01698 
01699       r = sqrt(r2);
01700 
01701       <span class="keywordflow">if</span>(r &gt;= h)
01702         fac = mass / (r2 * r);
01703       <span class="keywordflow">else</span>
01704         {
01705 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
01706 <span class="preprocessor"></span>          h_inv = 1.0 / h;
01707           h3_inv = h_inv * h_inv * h_inv;
01708 <span class="preprocessor">#endif</span>
01709 <span class="preprocessor"></span>          u = r * h_inv;
01710           <span class="keywordflow">if</span>(u &lt; 0.5)
01711             fac = mass * h3_inv * (10.666666666667 + u * u * (32.0 * u - 38.4));
01712           <span class="keywordflow">else</span>
01713             fac =
01714               mass * h3_inv * (21.333333333333 - 48.0 * u +
01715                                38.4 * u * u - 10.666666666667 * u * u * u - 0.066666666667 / (u * u * u));
01716         }
01717 
01718       tabindex = (int) (asmthfac * r);
01719 
01720       <span class="keywordflow">if</span>(tabindex &lt; NTAB)
01721         {
01722           fac *= shortrange_table[tabindex];
01723 
01724           acc_x += dx * fac;
01725           acc_y += dy * fac;
01726           acc_z += dz * fac;
01727 
01728           ninteractions++;
01729         }
01730     }
01731 
01732 
01733   <span class="comment">/* store result at the proper place */</span>
01734   <span class="keywordflow">if</span>(mode == 0)
01735     {
01736       <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[0] = acc_x;
01737       <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[1] = acc_y;
01738       <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[2] = acc_z;
01739       <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o12">GravCost</a> = ninteractions;
01740     }
01741   <span class="keywordflow">else</span>
01742     {
01743       <a class="code" href="allvars_8c.html#a68">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o1">Acc</a>[0] = acc_x;
01744       <a class="code" href="allvars_8c.html#a68">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o1">Acc</a>[1] = acc_y;
01745       <a class="code" href="allvars_8c.html#a68">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o1">Acc</a>[2] = acc_z;
01746       <a class="code" href="allvars_8c.html#a68">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#o6">w</a>.<a class="code" href="structgravdata__in.html#o5">Ninteractions</a> = ninteractions;
01747     }
01748 
01749   <span class="keywordflow">return</span> ninteractions;
01750 }
01751 
01752 <span class="preprocessor">#endif</span>
01753 <span class="preprocessor"></span>
01754 
01755 
01756 <span class="preprocessor">#ifdef PERIODIC</span>
01757 <span class="preprocessor"></span>
01775 <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a62">force_treeevaluate_ewald_correction</a>(<span class="keywordtype">int</span> target, <span class="keywordtype">int</span> mode, <span class="keywordtype">double</span> pos_x, <span class="keywordtype">double</span> pos_y, <span class="keywordtype">double</span> pos_z,
01776                                         <span class="keywordtype">double</span> aold)
<a name="l01777"></a><a class="code" href="proto_8h.html#a62">01777</a> {
01778   <span class="keyword">struct </span><a class="code" href="structNODE.html">NODE</a> *nop = 0;
01779   <span class="keywordtype">int</span> no, cost;
01780   <span class="keywordtype">double</span> dx, dy, dz, mass, r2;
01781   <span class="keywordtype">int</span> signx, signy, signz;
01782   <span class="keywordtype">int</span> i, j, k, openflag;
01783   <span class="keywordtype">double</span> u, v, w;
01784   <span class="keywordtype">double</span> f1, f2, f3, f4, f5, f6, f7, f8;
01785   <span class="keywordtype">double</span> acc_x, acc_y, acc_z;
01786   <span class="keywordtype">double</span> boxsize, boxhalf;
01787 
01788   boxsize = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
01789   boxhalf = 0.5 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
01790 
01791   acc_x = 0;
01792   acc_y = 0;
01793   acc_z = 0;
01794   cost = 0;
01795 
01796   no = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>;
01797 
01798   <span class="keywordflow">while</span>(no &gt;= 0)
01799     {
01800       <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>)      <span class="comment">/* single particle */</span>
01801         {
01802           <span class="comment">/* the index of the node is the index of the particle */</span>
01803           <span class="comment">/* observe the sign */</span>
01804 
01805           dx = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o0">Pos</a>[0] - pos_x;
01806           dy = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o0">Pos</a>[1] - pos_y;
01807           dz = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o0">Pos</a>[2] - pos_z;
01808           mass = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o1">Mass</a>;
01809         }
01810       <span class="keywordflow">else</span>
01811         {
01812           <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)      <span class="comment">/* pseudo particle */</span>
01813             {
01814               <span class="keywordflow">if</span>(mode == 0)
01815                 {
01816                   <a class="code" href="allvars_8c.html#a11">Exportflag</a>[<a class="code" href="allvars_8c.html#a28">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)]] = 1;
01817                 }
01818 
01819               no = <a class="code" href="allvars_8c.html#a59">Nextnode</a>[no - MaxNodes];
01820               <span class="keywordflow">continue</span>;
01821             }
01822 
01823           nop = &amp;<a class="code" href="allvars_8c.html#a58">Nodes</a>[no];
01824           dx = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[0] - pos_x;
01825           dy = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[1] - pos_y;
01826           dz = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[2] - pos_z;
01827           mass = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a>;
01828         }
01829 
01830       dx = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dx);
01831       dy = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dy);
01832       dz = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dz);
01833 
01834       <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>)
01835         no = <a class="code" href="allvars_8c.html#a59">Nextnode</a>[no];
01836       <span class="keywordflow">else</span>                      <span class="comment">/* we have an  internal node. Need to check opening criterion */</span>
01837         {
01838           openflag = 0;
01839 
01840           r2 = dx * dx + dy * dy + dz * dz;
01841 
01842           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o89">ErrTolTheta</a>)   <span class="comment">/* check Barnes-Hut opening criterion */</span>
01843             {
01844               <span class="keywordflow">if</span>(nop-&gt;<a class="code" href="structNODE.html#o0">len</a> * nop-&gt;<a class="code" href="structNODE.html#o0">len</a> &gt; r2 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o89">ErrTolTheta</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o89">ErrTolTheta</a>)
01845                 {
01846                   openflag = 1;
01847                 }
01848             }
01849           <span class="keywordflow">else</span>                  <span class="comment">/* check relative opening criterion */</span>
01850             {
01851               <span class="keywordflow">if</span>(mass * nop-&gt;<a class="code" href="structNODE.html#o0">len</a> * nop-&gt;<a class="code" href="structNODE.html#o0">len</a> &gt; r2 * r2 * aold)
01852                 {
01853                   openflag = 1;
01854                 }
01855               <span class="keywordflow">else</span>
01856                 {
01857                   <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[0] - pos_x) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#o0">len</a>)
01858                     {
01859                       <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[1] - pos_y) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#o0">len</a>)
01860                         {
01861                           <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[2] - pos_z) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#o0">len</a>)
01862                             {
01863                               openflag = 1;
01864                             }
01865                         }
01866                     }
01867                 }
01868             }
01869 
01870           <span class="keywordflow">if</span>(openflag)
01871             {
01872               <span class="comment">/* now we check if we can avoid opening the cell */</span>
01873 
01874               u = nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[0] - pos_x;
01875               <span class="keywordflow">if</span>(u &gt; boxhalf)
01876                 u -= boxsize;
01877               <span class="keywordflow">if</span>(u &lt; -boxhalf)
01878                 u += boxsize;
01879 
01880               <span class="keywordflow">if</span>(fabs(u) &gt; 0.5 * (boxsize - nop-&gt;<a class="code" href="structNODE.html#o0">len</a>))
01881                 {
01882                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
01883                   <span class="keywordflow">continue</span>;
01884                 }
01885 
01886               u = nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[1] - pos_y;
01887               <span class="keywordflow">if</span>(u &gt; boxhalf)
01888                 u -= boxsize;
01889               <span class="keywordflow">if</span>(u &lt; -boxhalf)
01890                 u += boxsize;
01891 
01892               <span class="keywordflow">if</span>(fabs(u) &gt; 0.5 * (boxsize - nop-&gt;<a class="code" href="structNODE.html#o0">len</a>))
01893                 {
01894                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
01895                   <span class="keywordflow">continue</span>;
01896                 }
01897 
01898               u = nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[2] - pos_z;
01899               <span class="keywordflow">if</span>(u &gt; boxhalf)
01900                 u -= boxsize;
01901               <span class="keywordflow">if</span>(u &lt; -boxhalf)
01902                 u += boxsize;
01903 
01904               <span class="keywordflow">if</span>(fabs(u) &gt; 0.5 * (boxsize - nop-&gt;<a class="code" href="structNODE.html#o0">len</a>))
01905                 {
01906                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
01907                   <span class="keywordflow">continue</span>;
01908                 }
01909 
01910               <span class="comment">/* if the cell is too large, we need to refine</span>
01911 <span class="comment">               * it further </span>
01912 <span class="comment">               */</span>
01913               <span class="keywordflow">if</span>(nop-&gt;<a class="code" href="structNODE.html#o0">len</a> &gt; 0.20 * boxsize)
01914                 {
01915                   <span class="comment">/* cell is too large */</span>
01916                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
01917                   <span class="keywordflow">continue</span>;
01918                 }
01919             }
01920 
01921           no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o6">sibling</a>;        <span class="comment">/* ok, node can be used */</span>
01922 
01923           <span class="keywordflow">if</span>(mode == 1)
01924             {
01925               <span class="keywordflow">if</span>((nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &amp; 1))       <span class="comment">/* Bit 0 signals that this node belongs to top-level tree */</span>
01926                 <span class="keywordflow">continue</span>;
01927             }
01928         }
01929 
01930       <span class="comment">/* compute the Ewald correction force */</span>
01931 
01932       <span class="keywordflow">if</span>(dx &lt; 0)
01933         {
01934           dx = -dx;
01935           signx = +1;
01936         }
01937       <span class="keywordflow">else</span>
01938         signx = -1;
01939 
01940       <span class="keywordflow">if</span>(dy &lt; 0)
01941         {
01942           dy = -dy;
01943           signy = +1;
01944         }
01945       <span class="keywordflow">else</span>
01946         signy = -1;
01947 
01948       <span class="keywordflow">if</span>(dz &lt; 0)
01949         {
01950           dz = -dz;
01951           signz = +1;
01952         }
01953       <span class="keywordflow">else</span>
01954         signz = -1;
01955 
01956       u = dx * fac_intp;
01957       i = (int) u;
01958       <span class="keywordflow">if</span>(i &gt;= EN)
01959         i = <a class="code" href="forcetree_8c.html#a2">EN</a> - 1;
01960       u -= i;
01961       v = dy * fac_intp;
01962       j = (int) v;
01963       <span class="keywordflow">if</span>(j &gt;= EN)
01964         j = <a class="code" href="forcetree_8c.html#a2">EN</a> - 1;
01965       v -= j;
01966       w = dz * fac_intp;
01967       k = (int) w;
01968       <span class="keywordflow">if</span>(k &gt;= EN)
01969         k = <a class="code" href="forcetree_8c.html#a2">EN</a> - 1;
01970       w -= k;
01971 
01972       <span class="comment">/* compute factors for trilinear interpolation */</span>
01973 
01974       f1 = (1 - u) * (1 - v) * (1 - w);
01975       f2 = (1 - u) * (1 - v) * (w);
01976       f3 = (1 - u) * (v) * (1 - w);
01977       f4 = (1 - u) * (v) * (w);
01978       f5 = (u) * (1 - v) * (1 - w);
01979       f6 = (u) * (1 - v) * (w);
01980       f7 = (u) * (v) * (1 - w);
01981       f8 = (u) * (v) * (w);
01982 
01983       acc_x += mass * signx * (fcorrx[i][j][k] * f1 +
01984                                fcorrx[i][j][k + 1] * f2 +
01985                                fcorrx[i][j + 1][k] * f3 +
01986                                fcorrx[i][j + 1][k + 1] * f4 +
01987                                fcorrx[i + 1][j][k] * f5 +
01988                                fcorrx[i + 1][j][k + 1] * f6 +
01989                                fcorrx[i + 1][j + 1][k] * f7 + fcorrx[i + 1][j + 1][k + 1] * f8);
01990 
01991       acc_y += mass * signy * (fcorry[i][j][k] * f1 +
01992                                fcorry[i][j][k + 1] * f2 +
01993                                fcorry[i][j + 1][k] * f3 +
01994                                fcorry[i][j + 1][k + 1] * f4 +
01995                                fcorry[i + 1][j][k] * f5 +
01996                                fcorry[i + 1][j][k + 1] * f6 +
01997                                fcorry[i + 1][j + 1][k] * f7 + fcorry[i + 1][j + 1][k + 1] * f8);
01998 
01999       acc_z += mass * signz * (fcorrz[i][j][k] * f1 +
02000                                fcorrz[i][j][k + 1] * f2 +
02001                                fcorrz[i][j + 1][k] * f3 +
02002                                fcorrz[i][j + 1][k + 1] * f4 +
02003                                fcorrz[i + 1][j][k] * f5 +
02004                                fcorrz[i + 1][j][k + 1] * f6 +
02005                                fcorrz[i + 1][j + 1][k] * f7 + fcorrz[i + 1][j + 1][k + 1] * f8);
02006       cost++;
02007     }
02008 
02009 
02010   <span class="comment">/* add the result at the proper place */</span>
02011 
02012   <span class="keywordflow">if</span>(mode == 0)
02013     {
02014       <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[0] += acc_x;
02015       <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[1] += acc_y;
02016       <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[2] += acc_z;
02017       <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o12">GravCost</a> += cost;
02018     }
02019   <span class="keywordflow">else</span>
02020     {
02021       <a class="code" href="allvars_8c.html#a68">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o1">Acc</a>[0] += acc_x;
02022       <a class="code" href="allvars_8c.html#a68">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o1">Acc</a>[1] += acc_y;
02023       <a class="code" href="allvars_8c.html#a68">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o1">Acc</a>[2] += acc_z;
02024       <a class="code" href="allvars_8c.html#a68">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#o6">w</a>.<a class="code" href="structgravdata__in.html#o5">Ninteractions</a> += cost;
02025     }
02026 
02027   <span class="keywordflow">return</span> cost;
02028 }
02029 
02030 <span class="preprocessor">#endif</span>
02031 <span class="preprocessor"></span>
02032 
02033 
02034 
02035 
02036 
02041 <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a63">force_treeevaluate_potential</a>(<span class="keywordtype">int</span> target, <span class="keywordtype">int</span> mode)
02042 {
<a name="l02043"></a><a class="code" href="proto_8h.html#a63">02043</a>   <span class="keyword">struct </span><a class="code" href="structNODE.html">NODE</a> *nop = 0;
02044   <span class="keywordtype">int</span> no, ptype;
02045   <span class="keywordtype">double</span> r2, dx, dy, dz, mass, r, u, h, h_inv, wp;
02046   <span class="keywordtype">double</span> pot, pos_x, pos_y, pos_z, aold;
02047 <span class="preprocessor">#if defined(UNEQUALSOFTENINGS) &amp;&amp; !defined(ADAPTIVE_GRAVSOFT_FORGAS)</span>
02048 <span class="preprocessor"></span>  <span class="keywordtype">int</span> maxsofttype;
02049 <span class="preprocessor">#endif</span>
02050 <span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
02051 <span class="preprocessor"></span>  <span class="keywordtype">double</span> soft = 0;
02052 <span class="preprocessor">#endif</span>
02053 <span class="preprocessor"></span><span class="preprocessor">#ifdef PERIODIC</span>
02054 <span class="preprocessor"></span>  <span class="keywordtype">double</span> boxsize, boxhalf;
02055 
02056   boxsize = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
02057   boxhalf = 0.5 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
02058 <span class="preprocessor">#endif</span>
02059 <span class="preprocessor"></span>
02060   pot = 0;
02061 
02062   <span class="keywordflow">if</span>(mode == 0)
02063     {
02064       pos_x = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o0">Pos</a>[0];
02065       pos_y = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o0">Pos</a>[1];
02066       pos_z = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o0">Pos</a>[2];
02067       ptype = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o9">Type</a>;
02068       aold = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o90">ErrTolForceAcc</a> * <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o7">OldAcc</a>;
02069 <span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
02070 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
02071         soft = <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
02072 <span class="preprocessor">#endif</span>
02073 <span class="preprocessor"></span>    }
02074   <span class="keywordflow">else</span>
02075     {
02076       pos_x = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o0">Pos</a>[0];
02077       pos_y = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o0">Pos</a>[1];
02078       pos_z = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o0">Pos</a>[2];
02079 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
02080 <span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].Type;
02081 <span class="preprocessor">#else</span>
02082 <span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a51">P</a>[0].<a class="code" href="structparticle__data.html#o9">Type</a>;
02083 <span class="preprocessor">#endif</span>
02084 <span class="preprocessor"></span>      aold = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o90">ErrTolForceAcc</a> * <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o6">w</a>.<a class="code" href="structgravdata__in.html#o4">OldAcc</a>;
02085 <span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
02086 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
02087         soft = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].Soft;
02088 <span class="preprocessor">#endif</span>
02089 <span class="preprocessor"></span>    }
02090 
02091 
02092 <span class="preprocessor">#ifndef UNEQUALSOFTENINGS</span>
02093 <span class="preprocessor"></span>  h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
02094   h_inv = 1.0 / h;
02095 <span class="preprocessor">#endif</span>
02096 <span class="preprocessor"></span>  no = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>;
02097 
02098   <span class="keywordflow">while</span>(no &gt;= 0)
02099     {
02100       <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>)      <span class="comment">/* single particle */</span>
02101         {
02102           <span class="comment">/* the index of the node is the index of the particle */</span>
02103           <span class="comment">/* observe the sign */</span>
02104 
02105           dx = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o0">Pos</a>[0] - pos_x;
02106           dy = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o0">Pos</a>[1] - pos_y;
02107           dz = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o0">Pos</a>[2] - pos_z;
02108           mass = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o1">Mass</a>;
02109         }
02110       <span class="keywordflow">else</span>
02111         {
02112           <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)      <span class="comment">/* pseudo particle */</span>
02113             {
02114               <span class="keywordflow">if</span>(mode == 0)
02115                 {
02116                   <a class="code" href="allvars_8c.html#a11">Exportflag</a>[<a class="code" href="allvars_8c.html#a28">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)]] = 1;
02117                 }
02118               no = <a class="code" href="allvars_8c.html#a59">Nextnode</a>[no - MaxNodes];
02119               <span class="keywordflow">continue</span>;
02120             }
02121 
02122           nop = &amp;<a class="code" href="allvars_8c.html#a58">Nodes</a>[no];
02123           dx = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[0] - pos_x;
02124           dy = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[1] - pos_y;
02125           dz = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[2] - pos_z;
02126           mass = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a>;
02127         }
02128 
02129 <span class="preprocessor">#ifdef PERIODIC</span>
02130 <span class="preprocessor"></span>      dx = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dx);
02131       dy = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dy);
02132       dz = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dz);
02133 <span class="preprocessor">#endif</span>
02134 <span class="preprocessor"></span>      r2 = dx * dx + dy * dy + dz * dz;
02135 
02136       <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>)
02137         {
02138 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
02139 <span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
02140 <span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
02141             h = soft;
02142           <span class="keywordflow">else</span>
02143             h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
02144 
02145           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
02146             {
02147               <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a53">SphP</a>[no].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>)
02148                 h = <a class="code" href="allvars_8c.html#a53">SphP</a>[no].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
02149             }
02150           <span class="keywordflow">else</span>
02151             {
02152               <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a>])
02153                 h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a>];
02154             }
02155 <span class="preprocessor">#else</span>
02156 <span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
02157           <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a>])
02158             h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a>];
02159 <span class="preprocessor">#endif</span>
02160 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02161 <span class="preprocessor"></span>          no = <a class="code" href="allvars_8c.html#a59">Nextnode</a>[no];
02162         }
02163       <span class="keywordflow">else</span>                      <span class="comment">/* we have an internal node. Need to check opening criterion */</span>
02164         {
02165           <span class="keywordflow">if</span>(mode == 1)
02166             {
02167               <span class="keywordflow">if</span>((nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &amp; 3) == 1)  <span class="comment">/* if it's a top-level node</span>
02168 <span class="comment">                                                 * which does not contain</span>
02169 <span class="comment">                                                 * local particles we can make</span>
02170 <span class="comment">                                                 * a short-cut </span>
02171 <span class="comment">                                                 */</span>
02172                 {
02173                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o6">sibling</a>;
02174                   <span class="keywordflow">continue</span>;
02175                 }
02176             }
02177 
02178           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o89">ErrTolTheta</a>)   <span class="comment">/* check Barnes-Hut opening criterion */</span>
02179             {
02180               <span class="keywordflow">if</span>(nop-&gt;<a class="code" href="structNODE.html#o0">len</a> * nop-&gt;<a class="code" href="structNODE.html#o0">len</a> &gt; r2 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o89">ErrTolTheta</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o89">ErrTolTheta</a>)
02181                 {
02182                   <span class="comment">/* open cell */</span>
02183                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
02184                   <span class="keywordflow">continue</span>;
02185                 }
02186             }
02187           <span class="keywordflow">else</span>                  <span class="comment">/* check relative opening criterion */</span>
02188             {
02189               <span class="keywordflow">if</span>(mass * nop-&gt;<a class="code" href="structNODE.html#o0">len</a> * nop-&gt;<a class="code" href="structNODE.html#o0">len</a> &gt; r2 * r2 * aold)
02190                 {
02191                   <span class="comment">/* open cell */</span>
02192                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
02193                   <span class="keywordflow">continue</span>;
02194                 }
02195 
02196               <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[0] - pos_x) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#o0">len</a>)
02197                 {
02198                   <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[1] - pos_y) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#o0">len</a>)
02199                     {
02200                       <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[2] - pos_z) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#o0">len</a>)
02201                         {
02202                           no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
02203                           <span class="keywordflow">continue</span>;
02204                         }
02205                     }
02206                 }
02207             }
02208 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
02209 <span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
02210 <span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
02211           maxsofttype = (nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 2) &amp; 7;
02212           <span class="keywordflow">if</span>(maxsofttype == 7) <span class="comment">/* may only occur for zero mass top-level nodes */</span>
02213             {
02214               <span class="keywordflow">if</span>(mass &gt; 0)
02215                 <a class="code" href="proto_8h.html#a38">endrun</a>(988);
02216               no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
02217               <span class="keywordflow">continue</span>;
02218             }
02219           <span class="keywordflow">else</span>
02220             {
02221               <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[maxsofttype])
02222                 {
02223                   h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[maxsofttype];
02224                   <span class="keywordflow">if</span>(r2 &lt; h * h)
02225                     {
02226                       <span class="keywordflow">if</span>(((nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 5) &amp; 1))        <span class="comment">/* bit-5 signals that there are particles of different softening in the node */</span>
02227                         {
02228                           no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
02229                           <span class="keywordflow">continue</span>;
02230                         }
02231                     }
02232                 }
02233             }
02234 <span class="preprocessor">#else</span>
02235 <span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
02236             h = soft;
02237           <span class="keywordflow">else</span>
02238             h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
02239 
02240           <span class="keywordflow">if</span>(h &lt; nop-&gt;maxsoft)
02241             {
02242               h = nop-&gt;maxsoft;
02243               <span class="keywordflow">if</span>(r2 &lt; h * h)
02244                 {
02245                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
02246                   <span class="keywordflow">continue</span>;
02247                 }
02248             }
02249 <span class="preprocessor">#endif</span>
02250 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02251 <span class="preprocessor"></span>
02252           no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o6">sibling</a>;        <span class="comment">/* node can be used */</span>
02253 
02254           <span class="keywordflow">if</span>(mode == 1)
02255             {
02256               <span class="keywordflow">if</span>(((nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a>) &amp; 1))     <span class="comment">/* Bit 0 signals that this node belongs to top-level tree */</span>
02257                 <span class="keywordflow">continue</span>;
02258             }
02259         }
02260 
02261       r = sqrt(r2);
02262 
02263       <span class="keywordflow">if</span>(r &gt;= h)
02264         pot -= mass / r;
02265       <span class="keywordflow">else</span>
02266         {
02267 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
02268 <span class="preprocessor"></span>          h_inv = 1.0 / h;
02269 <span class="preprocessor">#endif</span>
02270 <span class="preprocessor"></span>          u = r * h_inv;
02271 
02272           <span class="keywordflow">if</span>(u &lt; 0.5)
02273             wp = -2.8 + u * u * (5.333333333333 + u * u * (6.4 * u - 9.6));
02274           <span class="keywordflow">else</span>
02275             wp =
02276               -3.2 + 0.066666666667 / u + u * u * (10.666666666667 +
02277                                                    u * (-16.0 + u * (9.6 - 2.133333333333 * u)));
02278 
02279           pot += mass * h_inv * wp;
02280         }
02281 <span class="preprocessor">#ifdef PERIODIC</span>
02282 <span class="preprocessor"></span>      pot += mass * <a class="code" href="proto_8h.html#a44">ewald_pot_corr</a>(dx, dy, dz);
02283 <span class="preprocessor">#endif</span>
02284 <span class="preprocessor"></span>    }
02285 
02286   <span class="comment">/* store result at the proper place */</span>
02287 
02288   <span class="keywordflow">if</span>(mode == 0)
02289     <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o6">Potential</a> = pot;
02290   <span class="keywordflow">else</span>
02291     <a class="code" href="allvars_8c.html#a68">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o2">Potential</a> = pot;
02292 }
02293 
02294 
02295 
02296 
02297 <span class="preprocessor">#ifdef PMGRID</span>
02298 <span class="preprocessor"></span>
02302 <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a64">force_treeevaluate_potential_shortrange</a>(<span class="keywordtype">int</span> target, <span class="keywordtype">int</span> mode)
02303 {
<a name="l02304"></a><a class="code" href="proto_8h.html#a64">02304</a>   <span class="keyword">struct </span><a class="code" href="structNODE.html">NODE</a> *nop = 0;
02305   <span class="keywordtype">int</span> no, ptype, tabindex;
02306   <span class="keywordtype">double</span> r2, dx, dy, dz, mass, r, u, h, h_inv, wp;
02307   <span class="keywordtype">double</span> pot, pos_x, pos_y, pos_z, aold;
02308   <span class="keywordtype">double</span> eff_dist, fac, rcut, asmth, asmthfac;
02309   <span class="keywordtype">double</span> dxx, dyy, dzz;
02310 <span class="preprocessor">#if defined(UNEQUALSOFTENINGS) &amp;&amp; !defined(ADAPTIVE_GRAVSOFT_FORGAS)</span>
02311 <span class="preprocessor"></span>  <span class="keywordtype">int</span> maxsofttype;
02312 <span class="preprocessor">#endif</span>
02313 <span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
02314 <span class="preprocessor"></span>  <span class="keywordtype">double</span> soft = 0;
02315 <span class="preprocessor">#endif</span>
02316 <span class="preprocessor"></span>
02317 <span class="preprocessor">#ifdef PERIODIC</span>
02318 <span class="preprocessor"></span>  <span class="keywordtype">double</span> boxsize, boxhalf;
02319 
02320   boxsize = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
02321   boxhalf = 0.5 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
02322 <span class="preprocessor">#endif</span>
02323 <span class="preprocessor"></span>
02324   pot = 0;
02325 
02326   <span class="keywordflow">if</span>(mode == 0)
02327     {
02328       pos_x = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o0">Pos</a>[0];
02329       pos_y = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o0">Pos</a>[1];
02330       pos_z = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o0">Pos</a>[2];
02331       ptype = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o9">Type</a>;
02332       aold = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o90">ErrTolForceAcc</a> * <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o7">OldAcc</a>;
02333 <span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
02334 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
02335         soft = <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
02336 <span class="preprocessor">#endif</span>
02337 <span class="preprocessor"></span>    }
02338   <span class="keywordflow">else</span>
02339     {
02340       pos_x = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o0">Pos</a>[0];
02341       pos_y = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o0">Pos</a>[1];
02342       pos_z = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o0">Pos</a>[2];
02343 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
02344 <span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].Type;
02345 <span class="preprocessor">#else</span>
02346 <span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a51">P</a>[0].<a class="code" href="structparticle__data.html#o9">Type</a>;
02347 <span class="preprocessor">#endif</span>
02348 <span class="preprocessor"></span>      aold = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o90">ErrTolForceAcc</a> * <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o6">w</a>.<a class="code" href="structgravdata__in.html#o4">OldAcc</a>;
02349 <span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
02350 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(ptype == 0)
02351         soft = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].Soft;
02352 <span class="preprocessor">#endif</span>
02353 <span class="preprocessor"></span>    }
02354 
02355 
02356   rcut = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o64">Rcut</a>[0];
02357   asmth = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o63">Asmth</a>[0];
02358 <span class="preprocessor">#ifdef PLACEHIGHRESREGION</span>
02359 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(((1 &lt;&lt; ptype) &amp; (PLACEHIGHRESREGION)))
02360     {
02361       rcut = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o64">Rcut</a>[1];
02362       asmth = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o63">Asmth</a>[1];
02363     }
02364 <span class="preprocessor">#endif</span>
02365 <span class="preprocessor"></span>  asmthfac = 0.5 / asmth * (<a class="code" href="forcetree_8c.html#a0">NTAB</a> / 3.0);
02366 
02367 <span class="preprocessor">#ifndef UNEQUALSOFTENINGS</span>
02368 <span class="preprocessor"></span>  h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
02369   h_inv = 1.0 / h;
02370 <span class="preprocessor">#endif</span>
02371 <span class="preprocessor"></span>
02372   no = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>;
02373 
02374   <span class="keywordflow">while</span>(no &gt;= 0)
02375     {
02376       <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>)      <span class="comment">/* single particle */</span>
02377         {
02378           <span class="comment">/* the index of the node is the index of the particle */</span>
02379           <span class="comment">/* observe the sign  */</span>
02380 
02381           dx = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o0">Pos</a>[0] - pos_x;
02382           dy = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o0">Pos</a>[1] - pos_y;
02383           dz = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o0">Pos</a>[2] - pos_z;
02384           mass = <a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o1">Mass</a>;
02385         }
02386       <span class="keywordflow">else</span>
02387         {
02388           <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)      <span class="comment">/* pseudo particle */</span>
02389             {
02390               <span class="keywordflow">if</span>(mode == 0)
02391                 {
02392                   <a class="code" href="allvars_8c.html#a11">Exportflag</a>[<a class="code" href="allvars_8c.html#a28">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)]] = 1;
02393                 }
02394               no = <a class="code" href="allvars_8c.html#a59">Nextnode</a>[no - MaxNodes];
02395               <span class="keywordflow">continue</span>;
02396             }
02397 
02398           nop = &amp;<a class="code" href="allvars_8c.html#a58">Nodes</a>[no];
02399           dx = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[0] - pos_x;
02400           dy = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[1] - pos_y;
02401           dz = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o3">s</a>[2] - pos_z;
02402           mass = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a>;
02403         }
02404 
02405 <span class="preprocessor">#ifdef PERIODIC</span>
02406 <span class="preprocessor"></span>      dx = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dx);
02407       dy = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dy);
02408       dz = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dz);
02409 <span class="preprocessor">#endif</span>
02410 <span class="preprocessor"></span>      r2 = dx * dx + dy * dy + dz * dz;
02411 
02412       <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>)
02413         {
02414 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
02415 <span class="preprocessor"></span><span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
02416 <span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
02417             h = soft;
02418           <span class="keywordflow">else</span>
02419             h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
02420 
02421           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
02422             {
02423               <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a53">SphP</a>[no].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>)
02424                 h = <a class="code" href="allvars_8c.html#a53">SphP</a>[no].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
02425             }
02426           <span class="keywordflow">else</span>
02427             {
02428               <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a>])
02429                 h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a>];
02430             }
02431 <span class="preprocessor">#else</span>
02432 <span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
02433           <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a>])
02434             h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[<a class="code" href="allvars_8c.html#a51">P</a>[no].<a class="code" href="structparticle__data.html#o9">Type</a>];
02435 <span class="preprocessor">#endif</span>
02436 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02437 <span class="preprocessor"></span>          no = <a class="code" href="allvars_8c.html#a59">Nextnode</a>[no];
02438         }
02439       <span class="keywordflow">else</span>                      <span class="comment">/* we have an  internal node. Need to check opening criterion */</span>
02440         {
02441           <span class="comment">/* check whether we can stop walking along this branch */</span>
02442           <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)      <span class="comment">/* pseudo particle */</span>
02443             {
02444               <span class="keywordflow">if</span>(mode == 0)
02445                 {
02446                   <a class="code" href="allvars_8c.html#a11">Exportflag</a>[<a class="code" href="allvars_8c.html#a28">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)]] = 1;
02447                 }
02448               no = <a class="code" href="allvars_8c.html#a59">Nextnode</a>[no - MaxNodes];
02449               <span class="keywordflow">continue</span>;
02450             }
02451 
02452           <span class="keywordflow">if</span>(mode == 1)
02453             {
02454               <span class="keywordflow">if</span>((nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &amp; 3) == 1)  <span class="comment">/* if it's a top-level node which does not contain local particles */</span>
02455                 {
02456                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o6">sibling</a>;
02457                   <span class="keywordflow">continue</span>;
02458                 }
02459             }
02460 
02461           eff_dist = rcut + 0.5 * nop-&gt;<a class="code" href="structNODE.html#o0">len</a>;
02462 
02463           dxx = nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[0] - pos_x; <span class="comment">/* observe the sign ! */</span>
02464           dyy = nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[1] - pos_y; <span class="comment">/* this vector is -y in my thesis notation */</span>
02465           dzz = nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[2] - pos_z;
02466 <span class="preprocessor">#ifdef PERIODIC</span>
02467 <span class="preprocessor"></span>          dxx = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dxx);
02468           dyy = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dyy);
02469           dzz = <a class="code" href="forcetree_8c.html#a1">NEAREST</a>(dzz);
02470 <span class="preprocessor">#endif</span>
02471 <span class="preprocessor"></span>          <span class="keywordflow">if</span>(dxx &lt; -eff_dist || dxx &gt; eff_dist)
02472             {
02473               no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o6">sibling</a>;
02474               <span class="keywordflow">continue</span>;
02475             }
02476 
02477           <span class="keywordflow">if</span>(dyy &lt; -eff_dist || dyy &gt; eff_dist)
02478             {
02479               no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o6">sibling</a>;
02480               <span class="keywordflow">continue</span>;
02481             }
02482 
02483           <span class="keywordflow">if</span>(dzz &lt; -eff_dist || dzz &gt; eff_dist)
02484             {
02485               no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o6">sibling</a>;
02486               <span class="keywordflow">continue</span>;
02487             }
02488 
02489           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o89">ErrTolTheta</a>)   <span class="comment">/* check Barnes-Hut opening criterion */</span>
02490             {
02491               <span class="keywordflow">if</span>(nop-&gt;<a class="code" href="structNODE.html#o0">len</a> * nop-&gt;<a class="code" href="structNODE.html#o0">len</a> &gt; r2 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o89">ErrTolTheta</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o89">ErrTolTheta</a>)
02492                 {
02493                   <span class="comment">/* open cell */</span>
02494                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
02495                   <span class="keywordflow">continue</span>;
02496                 }
02497             }
02498           <span class="keywordflow">else</span>                  <span class="comment">/* check relative opening criterion */</span>
02499             {
02500               <span class="keywordflow">if</span>(mass * nop-&gt;<a class="code" href="structNODE.html#o0">len</a> * nop-&gt;<a class="code" href="structNODE.html#o0">len</a> &gt; r2 * r2 * aold)
02501                 {
02502                   <span class="comment">/* open cell */</span>
02503                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
02504                   <span class="keywordflow">continue</span>;
02505                 }
02506 
02507               <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[0] - pos_x) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#o0">len</a>)
02508                 {
02509                   <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[1] - pos_y) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#o0">len</a>)
02510                     {
02511                       <span class="keywordflow">if</span>(fabs(nop-&gt;<a class="code" href="structNODE.html#o1">center</a>[2] - pos_z) &lt; 0.60 * nop-&gt;<a class="code" href="structNODE.html#o0">len</a>)
02512                         {
02513                           no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
02514                           <span class="keywordflow">continue</span>;
02515                         }
02516                     }
02517                 }
02518             }
02519 
02520 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
02521 <span class="preprocessor"></span><span class="preprocessor">#ifndef ADAPTIVE_GRAVSOFT_FORGAS</span>
02522 <span class="preprocessor"></span>          h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
02523           maxsofttype = (nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 2) &amp; 7;
02524           <span class="keywordflow">if</span>(maxsofttype == 7) <span class="comment">/* may only occur for zero mass top-level nodes */</span>
02525             {
02526               <span class="keywordflow">if</span>(mass &gt; 0)
02527                 <a class="code" href="proto_8h.html#a38">endrun</a>(989);
02528               no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
02529               <span class="keywordflow">continue</span>;
02530             }
02531           <span class="keywordflow">else</span>
02532             {
02533               <span class="keywordflow">if</span>(h &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[maxsofttype])
02534                 {
02535                   h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[maxsofttype];
02536                   <span class="keywordflow">if</span>(r2 &lt; h * h)
02537                     {
02538                       <span class="comment">/* bit-5 signals that there are particles of</span>
02539 <span class="comment">                       * different softening in the node</span>
02540 <span class="comment">                       */</span>
02541                       <span class="keywordflow">if</span>(((nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a> &gt;&gt; 5) &amp; 1))
02542                         {
02543                           no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
02544                           <span class="keywordflow">continue</span>;
02545                         }
02546                     }
02547                 }
02548             }
02549 <span class="preprocessor">#else</span>
02550 <span class="preprocessor"></span>          <span class="keywordflow">if</span>(ptype == 0)
02551             h = soft;
02552           <span class="keywordflow">else</span>
02553             h = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype];
02554 
02555           <span class="keywordflow">if</span>(h &lt; nop-&gt;maxsoft)
02556             {
02557               h = nop-&gt;maxsoft;
02558               <span class="keywordflow">if</span>(r2 &lt; h * h)
02559                 {
02560                   no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;
02561                   <span class="keywordflow">continue</span>;
02562                 }
02563             }
02564 <span class="preprocessor">#endif</span>
02565 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02566 <span class="preprocessor"></span>          no = nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o6">sibling</a>;        <span class="comment">/* node can be used */</span>
02567 
02568           <span class="keywordflow">if</span>(mode == 1)
02569             {
02570               <span class="keywordflow">if</span>(((nop-&gt;<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o5">bitflags</a>) &amp; 1))     <span class="comment">/* Bit 0 signals that this node belongs to top-level tree */</span>
02571                 <span class="keywordflow">continue</span>;
02572             }
02573         }
02574 
02575       r = sqrt(r2);
02576 
02577       tabindex = (int) (r * asmthfac);
02578 
02579       <span class="keywordflow">if</span>(tabindex &lt; NTAB)
02580         {
02581           fac = shortrange_table_potential[tabindex];
02582 
02583           <span class="keywordflow">if</span>(r &gt;= h)
02584             pot -= fac * mass / r;
02585           <span class="keywordflow">else</span>
02586             {
02587 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
02588 <span class="preprocessor"></span>              h_inv = 1.0 / h;
02589 <span class="preprocessor">#endif</span>
02590 <span class="preprocessor"></span>              u = r * h_inv;
02591 
02592               <span class="keywordflow">if</span>(u &lt; 0.5)
02593                 wp = -2.8 + u * u * (5.333333333333 + u * u * (6.4 * u - 9.6));
02594               <span class="keywordflow">else</span>
02595                 wp =
02596                   -3.2 + 0.066666666667 / u + u * u * (10.666666666667 +
02597                                                        u * (-16.0 + u * (9.6 - 2.133333333333 * u)));
02598               pot += fac * mass * h_inv * wp;
02599             }
02600         }
02601     }
02602 
02603 
02604   <span class="comment">/* store result at the proper place */</span>
02605   <span class="keywordflow">if</span>(mode == 0)
02606     <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o6">Potential</a> = pot;
02607   <span class="keywordflow">else</span>
02608     <a class="code" href="allvars_8c.html#a68">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o2">Potential</a> = pot;
02609 }
02610 
02611 <span class="preprocessor">#endif</span>
02612 <span class="preprocessor"></span>
02613 
02614 
02620 <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a57">force_treeallocate</a>(<span class="keywordtype">int</span> maxnodes, <span class="keywordtype">int</span> maxpart)
02621 {
<a name="l02622"></a><a class="code" href="proto_8h.html#a57">02622</a>   <span class="keywordtype">int</span> i;
02623   size_t bytes;
02624   <span class="keywordtype">double</span> allbytes = 0;
02625   <span class="keywordtype">double</span> u;
02626 
02627   <a class="code" href="allvars_8c.html#a55">MaxNodes</a> = maxnodes;
02628 
02629   <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#a57">Nodes_base</a> = malloc(bytes = (MaxNodes + 1) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structNODE.html">NODE</a>))))
02630     {
02631       printf(<span class="stringliteral">"failed to allocate memory for %d tree-nodes (%g MB).\n"</span>, <a class="code" href="allvars_8c.html#a55">MaxNodes</a>, bytes / (1024.0 * 1024.0));
02632       <a class="code" href="proto_8h.html#a38">endrun</a>(3);
02633     }
02634   allbytes += bytes;
02635 
02636   <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#a61">Extnodes_base</a> = malloc(bytes = (MaxNodes + 1) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structextNODE.html">extNODE</a>))))
02637     {
02638       printf(<span class="stringliteral">"failed to allocate memory for %d tree-extnodes (%g MB).\n"</span>, MaxNodes,
02639              bytes / (1024.0 * 1024.0));
02640       <a class="code" href="proto_8h.html#a38">endrun</a>(3);
02641     }
02642   allbytes += bytes;
02643 
02644   <a class="code" href="allvars_8c.html#a58">Nodes</a> = <a class="code" href="allvars_8c.html#a57">Nodes_base</a> - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>;
02645   <a class="code" href="allvars_8c.html#a62">Extnodes</a> = <a class="code" href="allvars_8c.html#a61">Extnodes_base</a> - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>;
02646 
02647   <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#a59">Nextnode</a> = malloc(bytes = (maxpart + MAXTOPNODES) * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>))))
02648     {
02649       printf(<span class="stringliteral">"Failed to allocate %d spaces for 'Nextnode' array (%g MB)\n"</span>, maxpart + MAXTOPNODES,
02650              bytes / (1024.0 * 1024.0));
02651       exit(0);
02652     }
02653   allbytes += bytes;
02654 
02655   <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#a60">Father</a> = malloc(bytes = (maxpart) * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>))))
02656     {
02657       printf(<span class="stringliteral">"Failed to allocate %d spaces for 'Father' array (%g MB)\n"</span>, maxpart, bytes / (1024.0 * 1024.0));
02658       exit(0);
02659     }
02660   allbytes += bytes;
02661 
02662   <span class="keywordflow">if</span>(first_flag == 0)
02663     {
02664       first_flag = 1;
02665 
02666       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
02667         printf(<span class="stringliteral">"\nAllocated %g MByte for BH-tree. %d\n\n"</span>, allbytes / (1024.0 * 1024.0),
02668                <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structNODE.html">NODE</a>) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structextNODE.html">extNODE</a>));
02669 
02670       tabfac = <a class="code" href="forcetree_8c.html#a0">NTAB</a> / 3.0;
02671 
02672       <span class="keywordflow">for</span>(i = 0; i &lt; NTAB; i++)
02673         {
02674           u = 3.0 / <a class="code" href="forcetree_8c.html#a0">NTAB</a> * (i + 0.5);
02675           shortrange_table[i] = erfc(u) + 2.0 * u / sqrt(M_PI) * exp(-u * u);
02676           shortrange_table_potential[i] = erfc(u);
02677         }
02678     }
02679 }
02680 
02681 
02685 <span class="keywordtype">void</span> <a class="code" href="forcetree_8c.html#a34">force_treefree</a>(<span class="keywordtype">void</span>)
02686 {
<a name="l02687"></a><a class="code" href="proto_8h.html#a66">02687</a>   free(Father);
02688   free(Nextnode);
02689   free(Extnodes_base);
02690   free(Nodes_base);
02691 }
02692 
02693 
02694 
02695 
02701 <span class="preprocessor">#ifdef FORCETEST</span>
02702 <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a61">force_treeevaluate_direct</a>(<span class="keywordtype">int</span> target, <span class="keywordtype">int</span> mode)
02703 {
<a name="l02704"></a><a class="code" href="proto_8h.html#a61">02704</a>   <span class="keywordtype">double</span> epsilon;
02705   <span class="keywordtype">double</span> h, h_inv, dx, dy, dz, r, r2, u, r_inv, fac;
02706   <span class="keywordtype">int</span> i, ptype;
02707   <span class="keywordtype">double</span> pos_x, pos_y, pos_z;
02708   <span class="keywordtype">double</span> acc_x, acc_y, acc_z;
02709 
02710 <span class="preprocessor">#ifdef PERIODIC</span>
02711 <span class="preprocessor"></span>  <span class="keywordtype">double</span> fcorr[3];
02712 <span class="preprocessor">#endif</span>
02713 <span class="preprocessor"></span><span class="preprocessor">#ifdef PERIODIC</span>
02714 <span class="preprocessor"></span>  <span class="keywordtype">double</span> boxsize, boxhalf;
02715 
02716   boxsize = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
02717   boxhalf = 0.5 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
02718 <span class="preprocessor">#endif</span>
02719 <span class="preprocessor"></span>
02720   acc_x = 0;
02721   acc_y = 0;
02722   acc_z = 0;
02723 
02724   <span class="keywordflow">if</span>(mode == 0)
02725     {
02726       pos_x = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o0">Pos</a>[0];
02727       pos_y = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o0">Pos</a>[1];
02728       pos_z = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o0">Pos</a>[2];
02729       ptype = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o9">Type</a>;
02730     }
02731   <span class="keywordflow">else</span>
02732     {
02733       pos_x = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o0">Pos</a>[0];
02734       pos_y = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o0">Pos</a>[1];
02735       pos_z = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o0">Pos</a>[2];
02736 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
02737 <span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[target].Type;
02738 <span class="preprocessor">#else</span>
02739 <span class="preprocessor"></span>      ptype = <a class="code" href="allvars_8c.html#a51">P</a>[0].<a class="code" href="structparticle__data.html#o9">Type</a>;
02740 <span class="preprocessor">#endif</span>
02741 <span class="preprocessor"></span>    }
02742 
02743   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
02744     {
02745       epsilon = <a class="code" href="system_8c.html#a4">dmax</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[P[i].Type], <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[ptype]);
02746 
02747       h = epsilon;
02748       h_inv = 1 / h;
02749 
02750       dx = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[0] - pos_x;
02751       dy = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[1] - pos_y;
02752       dz = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[2] - pos_z;
02753 
02754 <span class="preprocessor">#ifdef PERIODIC</span>
02755 <span class="preprocessor"></span>      <span class="keywordflow">while</span>(dx &gt; boxhalf)
02756         dx -= boxsize;
02757       <span class="keywordflow">while</span>(dy &gt; boxhalf)
02758         dy -= boxsize;
02759       <span class="keywordflow">while</span>(dz &gt; boxhalf)
02760         dz -= boxsize;
02761       <span class="keywordflow">while</span>(dx &lt; -boxhalf)
02762         dx += boxsize;
02763       <span class="keywordflow">while</span>(dy &lt; -boxhalf)
02764         dy += boxsize;
02765       <span class="keywordflow">while</span>(dz &lt; -boxhalf)
02766         dz += boxsize;
02767 <span class="preprocessor">#endif</span>
02768 <span class="preprocessor"></span>      r2 = dx * dx + dy * dy + dz * dz;
02769 
02770       r = sqrt(r2);
02771 
02772       u = r * h_inv;
02773 
02774       <span class="keywordflow">if</span>(u &gt;= 1)
02775         {
02776           r_inv = 1 / r;
02777 
02778           fac = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o1">Mass</a> * r_inv * r_inv * r_inv;
02779         }
02780       <span class="keywordflow">else</span>
02781         {
02782           <span class="keywordflow">if</span>(u &lt; 0.5)
02783             fac = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o1">Mass</a> * h_inv * h_inv * h_inv * (10.666666666667 + u * u * (32.0 * u - 38.4));
02784           <span class="keywordflow">else</span>
02785             fac =
02786               <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o1">Mass</a> * h_inv * h_inv * h_inv * (21.333333333333 -
02787                                                    48.0 * u + 38.4 * u * u -
02788                                                    10.666666666667 * u * u *
02789                                                    u - 0.066666666667 / (u * u * u));
02790         }
02791 
02792       acc_x += dx * fac;
02793       acc_y += dy * fac;
02794       acc_z += dz * fac;
02795 
02796 <span class="preprocessor">#ifdef PERIODIC</span>
02797 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(u &gt; 1.0e-5)
02798         {
02799           <a class="code" href="proto_8h.html#a41">ewald_corr</a>(dx, dy, dz, fcorr);
02800 
02801           acc_x += <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o1">Mass</a> * fcorr[0];
02802           acc_y += <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o1">Mass</a> * fcorr[1];
02803           acc_z += <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o1">Mass</a> * fcorr[2];
02804         }
02805 <span class="preprocessor">#endif</span>
02806 <span class="preprocessor"></span>    }
02807 
02808 
02809   <span class="keywordflow">if</span>(mode == 0)
02810     {
02811       <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o5">GravAccelDirect</a>[0] = acc_x;
02812       <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o5">GravAccelDirect</a>[1] = acc_y;
02813       <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o5">GravAccelDirect</a>[2] = acc_z;
02814     }
02815   <span class="keywordflow">else</span>
02816     {
02817       <a class="code" href="allvars_8c.html#a68">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o1">Acc</a>[0] = acc_x;
02818       <a class="code" href="allvars_8c.html#a68">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o1">Acc</a>[1] = acc_y;
02819       <a class="code" href="allvars_8c.html#a68">GravDataResult</a>[target].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o1">Acc</a>[2] = acc_z;
02820     }
02821 
02822 
02823   <span class="keywordflow">return</span> NumPart;
02824 }
02825 <span class="preprocessor">#endif</span>
02826 <span class="preprocessor"></span>
02827 
02833 <span class="keywordtype">void</span> <a class="code" href="forcetree_8c.html#a36">dump_particles</a>(<span class="keywordtype">void</span>)
02834 {
<a name="l02835"></a><a class="code" href="proto_8h.html#a36">02835</a>   FILE *fd;
02836   <span class="keywordtype">char</span> buffer[200];
02837   <span class="keywordtype">int</span> i;
02838 
02839   sprintf(buffer, <span class="stringliteral">"particles%d.dat"</span>, ThisTask);
02840   fd = fopen(buffer, <span class="stringliteral">"w"</span>);
02841   <a class="code" href="proto_8h.html#a108">my_fwrite</a>(&amp;NumPart, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), fd);
02842 
02843   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
02844     <a class="code" href="proto_8h.html#a108">my_fwrite</a>(&amp;P[i].Pos[0], 3, <span class="keyword">sizeof</span>(FLOAT), fd);
02845 
02846   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
02847     <a class="code" href="proto_8h.html#a108">my_fwrite</a>(&amp;P[i].Vel[0], 3, <span class="keyword">sizeof</span>(FLOAT), fd);
02848 
02849   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
02850     <a class="code" href="proto_8h.html#a108">my_fwrite</a>(&amp;P[i].ID, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), fd);
02851 
02852   fclose(fd);
02853 }
02854 
02855 
02856 
02857 <span class="preprocessor">#ifdef PERIODIC</span>
02858 <span class="preprocessor"></span>
02872 <span class="keywordtype">void</span> <a class="code" href="forcetree_8c.html#a37">ewald_init</a>(<span class="keywordtype">void</span>)
02873 {
<a name="l02874"></a><a class="code" href="proto_8h.html#a43">02874</a>   <span class="keywordtype">int</span> i, j, k, beg, len, size, n, task, count;
02875   <span class="keywordtype">double</span> x[3], force[3];
02876   <span class="keywordtype">char</span> buf[200];
02877   FILE *fd;
02878 
02879   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
02880     {
02881       printf(<span class="stringliteral">"initialize Ewald correction...\n"</span>);
02882       fflush(stdout);
02883     }
02884 
02885 <span class="preprocessor">#ifdef DOUBLEPRECISION</span>
02886 <span class="preprocessor"></span>  sprintf(buf, <span class="stringliteral">"ewald_spc_table_%d_dbl.dat"</span>, EN);
02887 <span class="preprocessor">#else</span>
02888 <span class="preprocessor"></span>  sprintf(buf, <span class="stringliteral">"ewald_spc_table_%d.dat"</span>, EN);
02889 <span class="preprocessor">#endif</span>
02890 <span class="preprocessor"></span>
02891   <span class="keywordflow">if</span>((fd = fopen(buf, <span class="stringliteral">"r"</span>)))
02892     {
02893       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
02894         {
02895           printf(<span class="stringliteral">"\nreading Ewald tables from file `%s'\n"</span>, buf);
02896           fflush(stdout);
02897         }
02898 
02899       <a class="code" href="proto_8h.html#a107">my_fread</a>(&amp;fcorrx[0][0][0], <span class="keyword">sizeof</span>(FLOAT), (EN + 1) * (EN + 1) * (EN + 1), fd);
02900       <a class="code" href="proto_8h.html#a107">my_fread</a>(&amp;fcorry[0][0][0], <span class="keyword">sizeof</span>(FLOAT), (EN + 1) * (EN + 1) * (EN + 1), fd);
02901       <a class="code" href="proto_8h.html#a107">my_fread</a>(&amp;fcorrz[0][0][0], <span class="keyword">sizeof</span>(FLOAT), (EN + 1) * (EN + 1) * (EN + 1), fd);
02902       <a class="code" href="proto_8h.html#a107">my_fread</a>(&amp;potcorr[0][0][0], <span class="keyword">sizeof</span>(FLOAT), (EN + 1) * (EN + 1) * (EN + 1), fd);
02903       fclose(fd);
02904     }
02905   <span class="keywordflow">else</span>
02906     {
02907       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
02908         {
02909           printf(<span class="stringliteral">"\nNo Ewald tables in file `%s' found.\nRecomputing them...\n"</span>, buf);
02910           fflush(stdout);
02911         }
02912 
02913       <span class="comment">/* ok, let's recompute things. Actually, we do that in parallel. */</span>
02914 
02915       size = (<a class="code" href="forcetree_8c.html#a2">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a2">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a2">EN</a> + 1) / NTask;
02916 
02917 
02918       beg = <a class="code" href="allvars_8c.html#a0">ThisTask</a> * size;
02919       len = size;
02920       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == (<a class="code" href="allvars_8c.html#a1">NTask</a> - 1))
02921         len = (<a class="code" href="forcetree_8c.html#a2">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a2">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a2">EN</a> + 1) - beg;
02922 
02923       <span class="keywordflow">for</span>(i = 0, count = 0; i &lt;= EN; i++)
02924         <span class="keywordflow">for</span>(j = 0; j &lt;= EN; j++)
02925           <span class="keywordflow">for</span>(k = 0; k &lt;= EN; k++)
02926             {
02927               n = (i * (<a class="code" href="forcetree_8c.html#a2">EN</a> + 1) + j) * (<a class="code" href="forcetree_8c.html#a2">EN</a> + 1) + k;
02928               <span class="keywordflow">if</span>(n &gt;= beg &amp;&amp; n &lt; (beg + len))
02929                 {
02930                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
02931                     {
02932                       <span class="keywordflow">if</span>((count % (len / 20)) == 0)
02933                         {
02934                           printf(<span class="stringliteral">"%4.1f percent done\n"</span>, count / (len / 100.0));
02935                           fflush(stdout);
02936                         }
02937                     }
02938 
02939                   x[0] = 0.5 * ((double) i) / EN;
02940                   x[1] = 0.5 * ((double) j) / EN;
02941                   x[2] = 0.5 * ((double) k) / EN;
02942 
02943                   <a class="code" href="proto_8h.html#a42">ewald_force</a>(i, j, k, x, force);
02944 
02945                   fcorrx[i][j][k] = force[0];
02946                   fcorry[i][j][k] = force[1];
02947                   fcorrz[i][j][k] = force[2];
02948 
02949                   <span class="keywordflow">if</span>(i + j + k == 0)
02950                     potcorr[i][j][k] = 2.8372975;
02951                   <span class="keywordflow">else</span>
02952                     potcorr[i][j][k] = <a class="code" href="proto_8h.html#a45">ewald_psi</a>(x);
02953 
02954                   count++;
02955                 }
02956             }
02957 
02958       <span class="keywordflow">for</span>(task = 0; task &lt; NTask; task++)
02959         {
02960           beg = task * size;
02961           len = size;
02962           <span class="keywordflow">if</span>(task == (<a class="code" href="allvars_8c.html#a1">NTask</a> - 1))
02963             len = (<a class="code" href="forcetree_8c.html#a2">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a2">EN</a> + 1) * (<a class="code" href="forcetree_8c.html#a2">EN</a> + 1) - beg;
02964 
02965 <span class="preprocessor">#ifdef DOUBLEPRECISION</span>
02966 <span class="preprocessor"></span>          MPI_Bcast(&amp;fcorrx[0][0][beg], len, MPI_DOUBLE, task, MPI_COMM_WORLD);
02967           MPI_Bcast(&amp;fcorry[0][0][beg], len, MPI_DOUBLE, task, MPI_COMM_WORLD);
02968           MPI_Bcast(&amp;fcorrz[0][0][beg], len, MPI_DOUBLE, task, MPI_COMM_WORLD);
02969           MPI_Bcast(&amp;potcorr[0][0][beg], len, MPI_DOUBLE, task, MPI_COMM_WORLD);
02970 <span class="preprocessor">#else</span>
02971 <span class="preprocessor"></span>          MPI_Bcast(&amp;fcorrx[0][0][beg], len, MPI_FLOAT, task, MPI_COMM_WORLD);
02972           MPI_Bcast(&amp;fcorry[0][0][beg], len, MPI_FLOAT, task, MPI_COMM_WORLD);
02973           MPI_Bcast(&amp;fcorrz[0][0][beg], len, MPI_FLOAT, task, MPI_COMM_WORLD);
02974           MPI_Bcast(&amp;potcorr[0][0][beg], len, MPI_FLOAT, task, MPI_COMM_WORLD);
02975 <span class="preprocessor">#endif</span>
02976 <span class="preprocessor"></span>        }
02977 
02978       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
02979         {
02980           printf(<span class="stringliteral">"\nwriting Ewald tables to file `%s'\n"</span>, buf);
02981           fflush(stdout);
02982 
02983           <span class="keywordflow">if</span>((fd = fopen(buf, <span class="stringliteral">"w"</span>)))
02984             {
02985               <a class="code" href="proto_8h.html#a108">my_fwrite</a>(&amp;fcorrx[0][0][0], <span class="keyword">sizeof</span>(FLOAT), (EN + 1) * (EN + 1) * (EN + 1), fd);
02986               <a class="code" href="proto_8h.html#a108">my_fwrite</a>(&amp;fcorry[0][0][0], <span class="keyword">sizeof</span>(FLOAT), (EN + 1) * (EN + 1) * (EN + 1), fd);
02987               <a class="code" href="proto_8h.html#a108">my_fwrite</a>(&amp;fcorrz[0][0][0], <span class="keyword">sizeof</span>(FLOAT), (EN + 1) * (EN + 1) * (EN + 1), fd);
02988               <a class="code" href="proto_8h.html#a108">my_fwrite</a>(&amp;potcorr[0][0][0], <span class="keyword">sizeof</span>(FLOAT), (EN + 1) * (EN + 1) * (EN + 1), fd);
02989               fclose(fd);
02990             }
02991         }
02992     }
02993 
02994   fac_intp = 2 * <a class="code" href="forcetree_8c.html#a2">EN</a> / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
02995 
02996   <span class="keywordflow">for</span>(i = 0; i &lt;= EN; i++)
02997     <span class="keywordflow">for</span>(j = 0; j &lt;= EN; j++)
02998       <span class="keywordflow">for</span>(k = 0; k &lt;= EN; k++)
02999         {
03000           potcorr[i][j][k] /= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
03001           fcorrx[i][j][k] /= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
03002           fcorry[i][j][k] /= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
03003           fcorrz[i][j][k] /= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
03004         }
03005 
03006   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
03007     {
03008       printf(<span class="stringliteral">"initialization of periodic boundaries finished.\n"</span>);
03009       fflush(stdout);
03010     }
03011 }
03012 
03013 
03020 <span class="preprocessor">#ifdef FORCETEST</span>
03021 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a41">ewald_corr</a>(<span class="keywordtype">double</span> dx, <span class="keywordtype">double</span> dy, <span class="keywordtype">double</span> dz, <span class="keywordtype">double</span> *fper)
03022 {
<a name="l03023"></a><a class="code" href="proto_8h.html#a41">03023</a>   <span class="keywordtype">int</span> signx, signy, signz;
03024   <span class="keywordtype">int</span> i, j, k;
03025   <span class="keywordtype">double</span> u, v, w;
03026   <span class="keywordtype">double</span> f1, f2, f3, f4, f5, f6, f7, f8;
03027 
03028   <span class="keywordflow">if</span>(dx &lt; 0)
03029     {
03030       dx = -dx;
03031       signx = +1;
03032     }
03033   <span class="keywordflow">else</span>
03034     signx = -1;
03035 
03036   <span class="keywordflow">if</span>(dy &lt; 0)
03037     {
03038       dy = -dy;
03039       signy = +1;
03040     }
03041   <span class="keywordflow">else</span>
03042     signy = -1;
03043 
03044   <span class="keywordflow">if</span>(dz &lt; 0)
03045     {
03046       dz = -dz;
03047       signz = +1;
03048     }
03049   <span class="keywordflow">else</span>
03050     signz = -1;
03051 
03052   u = dx * fac_intp;
03053   i = (int) u;
03054   <span class="keywordflow">if</span>(i &gt;= EN)
03055     i = <a class="code" href="forcetree_8c.html#a2">EN</a> - 1;
03056   u -= i;
03057   v = dy * fac_intp;
03058   j = (int) v;
03059   <span class="keywordflow">if</span>(j &gt;= EN)
03060     j = <a class="code" href="forcetree_8c.html#a2">EN</a> - 1;
03061   v -= j;
03062   w = dz * fac_intp;
03063   k = (int) w;
03064   <span class="keywordflow">if</span>(k &gt;= EN)
03065     k = <a class="code" href="forcetree_8c.html#a2">EN</a> - 1;
03066   w -= k;
03067 
03068   f1 = (1 - u) * (1 - v) * (1 - w);
03069   f2 = (1 - u) * (1 - v) * (w);
03070   f3 = (1 - u) * (v) * (1 - w);
03071   f4 = (1 - u) * (v) * (w);
03072   f5 = (u) * (1 - v) * (1 - w);
03073   f6 = (u) * (1 - v) * (w);
03074   f7 = (u) * (v) * (1 - w);
03075   f8 = (u) * (v) * (w);
03076 
03077   fper[0] = signx * (fcorrx[i][j][k] * f1 +
03078                      fcorrx[i][j][k + 1] * f2 +
03079                      fcorrx[i][j + 1][k] * f3 +
03080                      fcorrx[i][j + 1][k + 1] * f4 +
03081                      fcorrx[i + 1][j][k] * f5 +
03082                      fcorrx[i + 1][j][k + 1] * f6 +
03083                      fcorrx[i + 1][j + 1][k] * f7 + fcorrx[i + 1][j + 1][k + 1] * f8);
03084 
03085   fper[1] = signy * (fcorry[i][j][k] * f1 +
03086                      fcorry[i][j][k + 1] * f2 +
03087                      fcorry[i][j + 1][k] * f3 +
03088                      fcorry[i][j + 1][k + 1] * f4 +
03089                      fcorry[i + 1][j][k] * f5 +
03090                      fcorry[i + 1][j][k + 1] * f6 +
03091                      fcorry[i + 1][j + 1][k] * f7 + fcorry[i + 1][j + 1][k + 1] * f8);
03092 
03093   fper[2] = signz * (fcorrz[i][j][k] * f1 +
03094                      fcorrz[i][j][k + 1] * f2 +
03095                      fcorrz[i][j + 1][k] * f3 +
03096                      fcorrz[i][j + 1][k + 1] * f4 +
03097                      fcorrz[i + 1][j][k] * f5 +
03098                      fcorrz[i + 1][j][k + 1] * f6 +
03099                      fcorrz[i + 1][j + 1][k] * f7 + fcorrz[i + 1][j + 1][k + 1] * f8);
03100 }
03101 <span class="preprocessor">#endif</span>
03102 <span class="preprocessor"></span>
03103 
03110 <span class="keywordtype">double</span> <a class="code" href="proto_8h.html#a44">ewald_pot_corr</a>(<span class="keywordtype">double</span> dx, <span class="keywordtype">double</span> dy, <span class="keywordtype">double</span> dz)
03111 {
<a name="l03112"></a><a class="code" href="proto_8h.html#a44">03112</a>   <span class="keywordtype">int</span> i, j, k;
03113   <span class="keywordtype">double</span> u, v, w;
03114   <span class="keywordtype">double</span> f1, f2, f3, f4, f5, f6, f7, f8;
03115 
03116   <span class="keywordflow">if</span>(dx &lt; 0)
03117     dx = -dx;
03118 
03119   <span class="keywordflow">if</span>(dy &lt; 0)
03120     dy = -dy;
03121 
03122   <span class="keywordflow">if</span>(dz &lt; 0)
03123     dz = -dz;
03124 
03125   u = dx * fac_intp;
03126   i = (int) u;
03127   <span class="keywordflow">if</span>(i &gt;= EN)
03128     i = <a class="code" href="forcetree_8c.html#a2">EN</a> - 1;
03129   u -= i;
03130   v = dy * fac_intp;
03131   j = (int) v;
03132   <span class="keywordflow">if</span>(j &gt;= EN)
03133     j = <a class="code" href="forcetree_8c.html#a2">EN</a> - 1;
03134   v -= j;
03135   w = dz * fac_intp;
03136   k = (int) w;
03137   <span class="keywordflow">if</span>(k &gt;= EN)
03138     k = <a class="code" href="forcetree_8c.html#a2">EN</a> - 1;
03139   w -= k;
03140 
03141   f1 = (1 - u) * (1 - v) * (1 - w);
03142   f2 = (1 - u) * (1 - v) * (w);
03143   f3 = (1 - u) * (v) * (1 - w);
03144   f4 = (1 - u) * (v) * (w);
03145   f5 = (u) * (1 - v) * (1 - w);
03146   f6 = (u) * (1 - v) * (w);
03147   f7 = (u) * (v) * (1 - w);
03148   f8 = (u) * (v) * (w);
03149 
03150   <span class="keywordflow">return</span> potcorr[i][j][k] * f1 +
03151     potcorr[i][j][k + 1] * f2 +
03152     potcorr[i][j + 1][k] * f3 +
03153     potcorr[i][j + 1][k + 1] * f4 +
03154     potcorr[i + 1][j][k] * f5 +
03155     potcorr[i + 1][j][k + 1] * f6 + potcorr[i + 1][j + 1][k] * f7 + potcorr[i + 1][j + 1][k + 1] * f8;
03156 }
03157 
03158 
03159 
03163 <span class="keywordtype">double</span> <a class="code" href="proto_8h.html#a45">ewald_psi</a>(<span class="keywordtype">double</span> x[3])
03164 {
<a name="l03165"></a><a class="code" href="proto_8h.html#a45">03165</a>   <span class="keywordtype">double</span> alpha, psi;
03166   <span class="keywordtype">double</span> r, sum1, sum2, hdotx;
03167   <span class="keywordtype">double</span> dx[3];
03168   <span class="keywordtype">int</span> i, n[3], h[3], h2;
03169 
03170   alpha = 2.0;
03171 
03172   <span class="keywordflow">for</span>(n[0] = -4, sum1 = 0; n[0] &lt;= 4; n[0]++)
03173     <span class="keywordflow">for</span>(n[1] = -4; n[1] &lt;= 4; n[1]++)
03174       <span class="keywordflow">for</span>(n[2] = -4; n[2] &lt;= 4; n[2]++)
03175         {
03176           <span class="keywordflow">for</span>(i = 0; i &lt; 3; i++)
03177             dx[i] = x[i] - n[i];
03178 
03179           r = sqrt(dx[0] * dx[0] + dx[1] * dx[1] + dx[2] * dx[2]);
03180           sum1 += erfc(alpha * r) / r;
03181         }
03182 
03183   <span class="keywordflow">for</span>(h[0] = -4, sum2 = 0; h[0] &lt;= 4; h[0]++)
03184     <span class="keywordflow">for</span>(h[1] = -4; h[1] &lt;= 4; h[1]++)
03185       <span class="keywordflow">for</span>(h[2] = -4; h[2] &lt;= 4; h[2]++)
03186         {
03187           hdotx = x[0] * h[0] + x[1] * h[1] + x[2] * h[2];
03188           h2 = h[0] * h[0] + h[1] * h[1] + h[2] * h[2];
03189           <span class="keywordflow">if</span>(h2 &gt; 0)
03190             sum2 += 1 / (M_PI * h2) * exp(-M_PI * M_PI * h2 / (alpha * alpha)) * cos(2 * M_PI * hdotx);
03191         }
03192 
03193   r = sqrt(x[0] * x[0] + x[1] * x[1] + x[2] * x[2]);
03194 
03195   psi = M_PI / (alpha * alpha) - sum1 - sum2 + 1 / r;
03196 
03197   <span class="keywordflow">return</span> psi;
03198 }
03199 
03200 
03204 <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a42">ewald_force</a>(<span class="keywordtype">int</span> iii, <span class="keywordtype">int</span> jjj, <span class="keywordtype">int</span> kkk, <span class="keywordtype">double</span> x[3], <span class="keywordtype">double</span> force[3])
03205 {
<a name="l03206"></a><a class="code" href="proto_8h.html#a42">03206</a>   <span class="keywordtype">double</span> alpha, r2;
03207   <span class="keywordtype">double</span> r, val, hdotx, dx[3];
03208   <span class="keywordtype">int</span> i, h[3], n[3], h2;
03209 
03210   alpha = 2.0;
03211 
03212   <span class="keywordflow">for</span>(i = 0; i &lt; 3; i++)
03213     force[i] = 0;
03214 
03215   <span class="keywordflow">if</span>(iii == 0 &amp;&amp; jjj == 0 &amp;&amp; kkk == 0)
03216     <span class="keywordflow">return</span>;
03217 
03218   r2 = x[0] * x[0] + x[1] * x[1] + x[2] * x[2];
03219 
03220   <span class="keywordflow">for</span>(i = 0; i &lt; 3; i++)
03221     force[i] += x[i] / (r2 * sqrt(r2));
03222 
03223   <span class="keywordflow">for</span>(n[0] = -4; n[0] &lt;= 4; n[0]++)
03224     <span class="keywordflow">for</span>(n[1] = -4; n[1] &lt;= 4; n[1]++)
03225       <span class="keywordflow">for</span>(n[2] = -4; n[2] &lt;= 4; n[2]++)
03226         {
03227           <span class="keywordflow">for</span>(i = 0; i &lt; 3; i++)
03228             dx[i] = x[i] - n[i];
03229 
03230           r = sqrt(dx[0] * dx[0] + dx[1] * dx[1] + dx[2] * dx[2]);
03231 
03232           val = erfc(alpha * r) + 2 * alpha * r / sqrt(M_PI) * exp(-alpha * alpha * r * r);
03233 
03234           <span class="keywordflow">for</span>(i = 0; i &lt; 3; i++)
03235             force[i] -= dx[i] / (r * r * r) * val;
03236         }
03237 
03238   <span class="keywordflow">for</span>(h[0] = -4; h[0] &lt;= 4; h[0]++)
03239     <span class="keywordflow">for</span>(h[1] = -4; h[1] &lt;= 4; h[1]++)
03240       <span class="keywordflow">for</span>(h[2] = -4; h[2] &lt;= 4; h[2]++)
03241         {
03242           hdotx = x[0] * h[0] + x[1] * h[1] + x[2] * h[2];
03243           h2 = h[0] * h[0] + h[1] * h[1] + h[2] * h[2];
03244 
03245           <span class="keywordflow">if</span>(h2 &gt; 0)
03246             {
03247               val = 2.0 / ((double) h2) * exp(-M_PI * M_PI * h2 / (alpha * alpha)) * sin(2 * M_PI * hdotx);
03248 
03249               <span class="keywordflow">for</span>(i = 0; i &lt; 3; i++)
03250                 force[i] -= h[i] * val;
03251             }
03252         }
03253 }
03254 
03255 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 22 15:29:40 2006 for GADGET-2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
