<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GADGET-2: density.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>density.c</h1><a href="density_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00002 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00003 <span class="preprocessor">#include &lt;string.h&gt;</span>
00004 <span class="preprocessor">#include &lt;math.h&gt;</span>
00005 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
00006 
00007 <span class="preprocessor">#include "<a class="code" href="allvars_8h.html">allvars.h</a>"</span>
00008 <span class="preprocessor">#include "<a class="code" href="proto_8h.html">proto.h</a>"</span>
00009 
00010 
00021 <span class="preprocessor">#ifdef PERIODIC</span>
00022 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">double</span> boxSize, boxHalf;
00023 
00024 <span class="preprocessor">#ifdef LONG_X</span>
00025 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">double</span> boxSize_X, boxHalf_X;
00026 <span class="preprocessor">#else</span>
<a name="l00027"></a><a class="code" href="density_8c.html#a0">00027</a> <span class="preprocessor"></span><span class="preprocessor">#define boxSize_X boxSize</span>
<a name="l00028"></a><a class="code" href="density_8c.html#a1">00028</a> <span class="preprocessor"></span><span class="preprocessor">#define boxHalf_X boxHalf</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Y</span>
00031 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">double</span> boxSize_Y, boxHalf_Y;
00032 <span class="preprocessor">#else</span>
<a name="l00033"></a><a class="code" href="density_8c.html#a2">00033</a> <span class="preprocessor"></span><span class="preprocessor">#define boxSize_Y boxSize</span>
<a name="l00034"></a><a class="code" href="density_8c.html#a3">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define boxHalf_Y boxHalf</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Z</span>
00037 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">double</span> boxSize_Z, boxHalf_Z;
00038 <span class="preprocessor">#else</span>
<a name="l00039"></a><a class="code" href="density_8c.html#a4">00039</a> <span class="preprocessor"></span><span class="preprocessor">#define boxSize_Z boxSize</span>
<a name="l00040"></a><a class="code" href="density_8c.html#a5">00040</a> <span class="preprocessor"></span><span class="preprocessor">#define boxHalf_Z boxHalf</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00043 <span class="preprocessor"></span>
00044 
<a name="l00056"></a><a class="code" href="proto_8h.html#a14">00056</a> <span class="keywordtype">void</span> <a class="code" href="density_8c.html#a8">density</a>(<span class="keywordtype">void</span>)
00057 {
00058   <span class="keywordtype">long</span> <span class="keywordtype">long</span> ntot, ntotleft;
00059   <span class="keywordtype">int</span> *noffset, *nbuffer, *nsend, *nsend_local, *numlist, *ndonelist;
00060   <span class="keywordtype">int</span> i, j, n, ndone, npleft, maxfill, source, iter = 0;
00061   <span class="keywordtype">int</span> level, ngrp, sendTask, recvTask, place, nexport;
00062   <span class="keywordtype">double</span> dt_entr, tstart, tend, tstart_ngb = 0, tend_ngb = 0;
00063   <span class="keywordtype">double</span> sumt, sumcomm, timengb, sumtimengb;
00064   <span class="keywordtype">double</span> timecomp = 0, timeimbalance = 0, timecommsumm = 0, sumimbalance;
00065   MPI_Status status;
00066 
00067 <span class="preprocessor">#ifdef PERIODIC</span>
00068 <span class="preprocessor"></span>  boxSize = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
00069   boxHalf = 0.5 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
00070 <span class="preprocessor">#ifdef LONG_X</span>
00071 <span class="preprocessor"></span>  <a class="code" href="density_8c.html#a1">boxHalf_X</a> = boxHalf * LONG_X;
00072   <a class="code" href="density_8c.html#a0">boxSize_X</a> = boxSize * LONG_X;
00073 <span class="preprocessor">#endif</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Y</span>
00075 <span class="preprocessor"></span>  <a class="code" href="density_8c.html#a3">boxHalf_Y</a> = boxHalf * LONG_Y;
00076   <a class="code" href="density_8c.html#a2">boxSize_Y</a> = boxSize * LONG_Y;
00077 <span class="preprocessor">#endif</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Z</span>
00079 <span class="preprocessor"></span>  <a class="code" href="density_8c.html#a5">boxHalf_Z</a> = boxHalf * LONG_Z;
00080   <a class="code" href="density_8c.html#a4">boxSize_Z</a> = boxSize * LONG_Z;
00081 <span class="preprocessor">#endif</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00083 <span class="preprocessor"></span>
00084 
00085   noffset = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);        <span class="comment">/* offsets of bunches in common list */</span>
00086   nbuffer = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00087   nsend_local = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00088   nsend = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a> * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00089   ndonelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00090 
00091   <span class="keywordflow">for</span>(n = 0, <a class="code" href="allvars_8c.html#a8">NumSphUpdate</a> = 0; n &lt; N_gas; n++)
00092     {
00093       <a class="code" href="allvars_8c.html#a53">SphP</a>[n].<a class="code" href="structsph__particle__data.html#o3">Left</a> = <a class="code" href="allvars_8c.html#a53">SphP</a>[n].<a class="code" href="structsph__particle__data.html#o4">Right</a> = 0;
00094 
00095       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[n].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> == <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)
00096         <a class="code" href="allvars_8c.html#a8">NumSphUpdate</a>++;
00097     }
00098 
00099   numlist = malloc(<a class="code" href="allvars_8c.html#a1">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00100   MPI_Allgather(&amp;<a class="code" href="allvars_8c.html#a8">NumSphUpdate</a>, 1, MPI_INT, numlist, 1, MPI_INT, MPI_COMM_WORLD);
00101   <span class="keywordflow">for</span>(i = 0, ntot = 0; i &lt; NTask; i++)
00102     ntot += numlist[i];
00103   free(numlist);
00104 
00105 
00106 
00107   <span class="comment">/* we will repeat the whole thing for those particles where we didn't</span>
00108 <span class="comment">   * find enough neighbours</span>
00109 <span class="comment">   */</span>
00110   <span class="keywordflow">do</span>
00111     {
00112       i = 0;                    <span class="comment">/* beginn with this index */</span>
00113       ntotleft = ntot;          <span class="comment">/* particles left for all tasks together */</span>
00114 
00115       <span class="keywordflow">while</span>(ntotleft &gt; 0)
00116         {
00117           <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00118             nsend_local[j] = 0;
00119 
00120           <span class="comment">/* do local particles and prepare export list */</span>
00121           tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00122           <span class="keywordflow">for</span>(nexport = 0, ndone = 0; i &lt; <a class="code" href="allvars_8c.html#a4">N_gas</a> &amp;&amp; nexport &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o11">BunchSizeDensity</a> - NTask; i++)
00123             <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> == <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)
00124               {
00125                 ndone++;
00126 
00127                 <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00128                   <a class="code" href="allvars_8c.html#a11">Exportflag</a>[j] = 0;
00129 
00130                 <a class="code" href="proto_8h.html#a16">density_evaluate</a>(i, 0);
00131 
00132                 <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00133                   {
00134                     <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a11">Exportflag</a>[j])
00135                       {
00136                         <a class="code" href="allvars_8c.html#a71">DensDataIn</a>[nexport].<a class="code" href="structdensdata__in.html#o0">Pos</a>[0] = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[0];
00137                         <a class="code" href="allvars_8c.html#a71">DensDataIn</a>[nexport].<a class="code" href="structdensdata__in.html#o0">Pos</a>[1] = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[1];
00138                         <a class="code" href="allvars_8c.html#a71">DensDataIn</a>[nexport].<a class="code" href="structdensdata__in.html#o0">Pos</a>[2] = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[2];
00139                         <a class="code" href="allvars_8c.html#a71">DensDataIn</a>[nexport].<a class="code" href="structdensdata__in.html#o1">Vel</a>[0] = <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o9">VelPred</a>[0];
00140                         <a class="code" href="allvars_8c.html#a71">DensDataIn</a>[nexport].<a class="code" href="structdensdata__in.html#o1">Vel</a>[1] = <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o9">VelPred</a>[1];
00141                         <a class="code" href="allvars_8c.html#a71">DensDataIn</a>[nexport].<a class="code" href="structdensdata__in.html#o1">Vel</a>[2] = <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o9">VelPred</a>[2];
00142                         <a class="code" href="allvars_8c.html#a71">DensDataIn</a>[nexport].<a class="code" href="structdensdata__in.html#o2">Hsml</a> = <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
00143                         <a class="code" href="allvars_8c.html#a71">DensDataIn</a>[nexport].<a class="code" href="structdensdata__in.html#o3">Index</a> = i;
00144                         <a class="code" href="allvars_8c.html#a71">DensDataIn</a>[nexport].<a class="code" href="structdensdata__in.html#o4">Task</a> = j;
00145                         nexport++;
00146                         nsend_local[j]++;
00147                       }
00148                   }
00149               }
00150           tend = <a class="code" href="proto_8h.html#a145">second</a>();
00151           timecomp += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00152 
00153           qsort(<a class="code" href="allvars_8c.html#a71">DensDataIn</a>, nexport, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdensdata__in.html">densdata_in</a>), <a class="code" href="density_8c.html#a10">dens_compare_key</a>);
00154 
00155           <span class="keywordflow">for</span>(j = 1, noffset[0] = 0; j &lt; NTask; j++)
00156             noffset[j] = noffset[j - 1] + nsend_local[j - 1];
00157 
00158           tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00159 
00160           MPI_Allgather(nsend_local, <a class="code" href="allvars_8c.html#a1">NTask</a>, MPI_INT, nsend, <a class="code" href="allvars_8c.html#a1">NTask</a>, MPI_INT, MPI_COMM_WORLD);
00161 
00162           tend = <a class="code" href="proto_8h.html#a145">second</a>();
00163           timeimbalance += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00164 
00165 
00166           <span class="comment">/* now do the particles that need to be exported */</span>
00167 
00168           <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; PTask); level++)
00169             {
00170               tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00171               <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00172                 nbuffer[j] = 0;
00173               <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; PTask); ngrp++)
00174                 {
00175                   maxfill = 0;
00176                   <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00177                     {
00178                       <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00179                         <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j])
00180                           maxfill = nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00181                     }
00182                   <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o11">BunchSizeDensity</a>)
00183                     <span class="keywordflow">break</span>;
00184 
00185                   sendTask = ThisTask;
00186                   recvTask = <a class="code" href="allvars_8c.html#a0">ThisTask</a> ^ ngrp;
00187 
00188                   <span class="keywordflow">if</span>(recvTask &lt; NTask)
00189                     {
00190                       <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a0">ThisTask</a> * <a class="code" href="allvars_8c.html#a1">NTask</a> + recvTask] &gt; 0 || nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + ThisTask] &gt; 0)
00191                         {
00192                           <span class="comment">/* get the particles */</span>
00193                           MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a71">DensDataIn</a>[noffset[recvTask]],
00194                                        nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> densdata_in), MPI_BYTE,
00195                                        recvTask, <a class="code" href="tags_8h.html#a25">TAG_DENS_A</a>,
00196                                        &amp;<a class="code" href="allvars_8c.html#a72">DensDataGet</a>[nbuffer[<a class="code" href="allvars_8c.html#a0">ThisTask</a>]],
00197                                        nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + <a class="code" href="allvars_8c.html#a0">ThisTask</a>] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> densdata_in),
00198                                        MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a25">TAG_DENS_A</a>, MPI_COMM_WORLD, &amp;status);
00199                         }
00200                     }
00201 
00202                   <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00203                     <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00204                       nbuffer[j] += nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00205                 }
00206               tend = <a class="code" href="proto_8h.html#a145">second</a>();
00207               timecommsumm += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00208 
00209 
00210               tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00211               <span class="keywordflow">for</span>(j = 0; j &lt; nbuffer[ThisTask]; j++)
00212                 <a class="code" href="proto_8h.html#a16">density_evaluate</a>(j, 1);
00213               tend = <a class="code" href="proto_8h.html#a145">second</a>();
00214               timecomp += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00215 
00216               <span class="comment">/* do a block to explicitly measure imbalance */</span>
00217               tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00218               MPI_Barrier(MPI_COMM_WORLD);
00219               tend = <a class="code" href="proto_8h.html#a145">second</a>();
00220               timeimbalance += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00221 
00222               <span class="comment">/* get the result */</span>
00223               tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00224               <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00225                 nbuffer[j] = 0;
00226               <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; PTask); ngrp++)
00227                 {
00228                   maxfill = 0;
00229                   <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00230                     {
00231                       <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00232                         <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j])
00233                           maxfill = nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00234                     }
00235                   <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o11">BunchSizeDensity</a>)
00236                     <span class="keywordflow">break</span>;
00237 
00238                   sendTask = ThisTask;
00239                   recvTask = <a class="code" href="allvars_8c.html#a0">ThisTask</a> ^ ngrp;
00240 
00241                   <span class="keywordflow">if</span>(recvTask &lt; NTask)
00242                     {
00243                       <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a0">ThisTask</a> * <a class="code" href="allvars_8c.html#a1">NTask</a> + recvTask] &gt; 0 || nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + ThisTask] &gt; 0)
00244                         {
00245                           <span class="comment">/* send the results */</span>
00246                           MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a73">DensDataResult</a>[nbuffer[<a class="code" href="allvars_8c.html#a0">ThisTask</a>]],
00247                                        nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + <a class="code" href="allvars_8c.html#a0">ThisTask</a>] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdensdata__out.html">densdata_out</a>),
00248                                        MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a26">TAG_DENS_B</a>,
00249                                        &amp;<a class="code" href="allvars_8c.html#a74">DensDataPartialResult</a>[noffset[recvTask]],
00250                                        nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> densdata_out),
00251                                        MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a26">TAG_DENS_B</a>, MPI_COMM_WORLD, &amp;status);
00252 
00253                           <span class="comment">/* add the result to the particles */</span>
00254                           <span class="keywordflow">for</span>(j = 0; j &lt; nsend_local[recvTask]; j++)
00255                             {
00256                               source = j + noffset[recvTask];
00257                               place = <a class="code" href="allvars_8c.html#a71">DensDataIn</a>[source].<a class="code" href="structdensdata__in.html#o3">Index</a>;
00258 
00259                               <a class="code" href="allvars_8c.html#a53">SphP</a>[place].<a class="code" href="structsph__particle__data.html#o5">NumNgb</a> += <a class="code" href="allvars_8c.html#a74">DensDataPartialResult</a>[source].<a class="code" href="structdensdata__out.html#o4">Ngb</a>;
00260                               <a class="code" href="allvars_8c.html#a53">SphP</a>[place].<a class="code" href="structsph__particle__data.html#o1">Density</a> += <a class="code" href="allvars_8c.html#a74">DensDataPartialResult</a>[source].<a class="code" href="structdensdata__out.html#o0">Rho</a>;
00261                               <a class="code" href="allvars_8c.html#a53">SphP</a>[place].<a class="code" href="structsph__particle__data.html#o10">DivVel</a> += <a class="code" href="allvars_8c.html#a74">DensDataPartialResult</a>[source].<a class="code" href="structdensdata__out.html#o1">Div</a>;
00262 
00263                               <a class="code" href="allvars_8c.html#a53">SphP</a>[place].<a class="code" href="structsph__particle__data.html#o13">DhsmlDensityFactor</a> += <a class="code" href="allvars_8c.html#a74">DensDataPartialResult</a>[source].<a class="code" href="structdensdata__out.html#o3">DhsmlDensity</a>;
00264 
00265                               <a class="code" href="allvars_8c.html#a53">SphP</a>[place].<a class="code" href="structsph__particle__data.html#o12">Rot</a>[0] += <a class="code" href="allvars_8c.html#a74">DensDataPartialResult</a>[source].<a class="code" href="structdensdata__out.html#o2">Rot</a>[0];
00266                               <a class="code" href="allvars_8c.html#a53">SphP</a>[place].<a class="code" href="structsph__particle__data.html#o12">Rot</a>[1] += <a class="code" href="allvars_8c.html#a74">DensDataPartialResult</a>[source].<a class="code" href="structdensdata__out.html#o2">Rot</a>[1];
00267                               <a class="code" href="allvars_8c.html#a53">SphP</a>[place].<a class="code" href="structsph__particle__data.html#o12">Rot</a>[2] += <a class="code" href="allvars_8c.html#a74">DensDataPartialResult</a>[source].<a class="code" href="structdensdata__out.html#o2">Rot</a>[2];
00268                             }
00269                         }
00270                     }
00271 
00272                   <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00273                     <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00274                       nbuffer[j] += nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00275                 }
00276               tend = <a class="code" href="proto_8h.html#a145">second</a>();
00277               timecommsumm += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00278 
00279               level = ngrp - 1;
00280             }
00281 
00282           MPI_Allgather(&amp;ndone, 1, MPI_INT, ndonelist, 1, MPI_INT, MPI_COMM_WORLD);
00283           <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00284             ntotleft -= ndonelist[j];
00285         }
00286 
00287 
00288 
00289       <span class="comment">/* do final operations on results */</span>
00290       tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00291       <span class="keywordflow">for</span>(i = 0, npleft = 0; i &lt; N_gas; i++)
00292         {
00293           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> == <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)
00294             {
00295               {
00296                 <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o13">DhsmlDensityFactor</a> =
00297                   1 / (1 + <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> * <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o13">DhsmlDensityFactor</a> / (<a class="code" href="allvars_8h.html#a36">NUMDIMS</a> * <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o1">Density</a>));
00298 
00299                 <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o11">CurlVel</a> = sqrt(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].Rot[0] * <a class="code" href="allvars_8c.html#a53">SphP</a>[i].Rot[0] +
00300                                        <a class="code" href="allvars_8c.html#a53">SphP</a>[i].Rot[1] * <a class="code" href="allvars_8c.html#a53">SphP</a>[i].Rot[1] +
00301                                        <a class="code" href="allvars_8c.html#a53">SphP</a>[i].Rot[2] * <a class="code" href="allvars_8c.html#a53">SphP</a>[i].Rot[2]) / <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o1">Density</a>;
00302 
00303                 <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o10">DivVel</a> /= <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o1">Density</a>;
00304 
00305                 dt_entr = (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a> - (<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o11">Ti_begstep</a> + <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a>) / 2) * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00306 
00307                 <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o6">Pressure</a> =
00308                   (<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o0">Entropy</a> + <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o7">DtEntropy</a> * dt_entr) * <a class="code" href="proto_8h.html#a133">pow</a>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].Density, <a class="code" href="allvars_8h.html#a9">GAMMA</a>);
00309               }
00310 
00311 
00312               <span class="comment">/* now check whether we had enough neighbours */</span>
00313 
00314               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o5">NumNgb</a> &lt; (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o16">DesNumNgb</a> - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o17">MaxNumNgbDeviation</a>) ||
00315                  (<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o5">NumNgb</a> &gt; (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o16">DesNumNgb</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o17">MaxNumNgbDeviation</a>)
00316                   &amp;&amp; <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> &gt; (1.01 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o98">MinGasHsml</a>)))
00317                 {
00318                   <span class="comment">/* need to redo this particle */</span>
00319                   npleft++;
00320 
00321                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o3">Left</a> &gt; 0 &amp;&amp; <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o4">Right</a> &gt; 0)
00322                     <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o4">Right</a> - <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o3">Left</a>) &lt; 1.0e-3 * <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o3">Left</a>)
00323                       {
00324                         <span class="comment">/* this one should be ok */</span>
00325                         npleft--;
00326                         <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> = -<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> - 1; <span class="comment">/* Mark as inactive */</span>
00327                         <span class="keywordflow">continue</span>;
00328                       }
00329 
00330                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o5">NumNgb</a> &lt; (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o16">DesNumNgb</a> - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o17">MaxNumNgbDeviation</a>))
00331                     <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o3">Left</a> = <a class="code" href="system_8c.html#a4">dmax</a>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].Hsml, <a class="code" href="allvars_8c.html#a53">SphP</a>[i].Left);
00332                   <span class="keywordflow">else</span>
00333                     {
00334                       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o4">Right</a> != 0)
00335                         {
00336                           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> &lt; <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o4">Right</a>)
00337                             <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o4">Right</a> = <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
00338                         }
00339                       <span class="keywordflow">else</span>
00340                         <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o4">Right</a> = <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
00341                     }
00342 
00343                   <span class="keywordflow">if</span>(iter &gt;= <a class="code" href="allvars_8h.html#a34">MAXITER</a> - 10)
00344                     {
00345                       printf
00346                         (<span class="stringliteral">"i=%d task=%d ID=%d Hsml=%g Left=%g Right=%g Ngbs=%g Right-Left=%g\n   pos=(%g|%g|%g)\n"</span>,
00347                          i, ThisTask, (int) <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o8">ID</a>, <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>, <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o3">Left</a>, <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o4">Right</a>,
00348                          (float) <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o5">NumNgb</a>, <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o4">Right</a> - <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o3">Left</a>, <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[0], <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[1],
00349                          <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[2]);
00350                       fflush(stdout);
00351                     }
00352 
00353                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o4">Right</a> &gt; 0 &amp;&amp; <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o3">Left</a> &gt; 0)
00354                     <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> = <a class="code" href="proto_8h.html#a133">pow</a>(0.5 * (<a class="code" href="proto_8h.html#a133">pow</a>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].Left, 3) + <a class="code" href="proto_8h.html#a133">pow</a>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].Right, 3)), 1.0 / 3);
00355                   <span class="keywordflow">else</span>
00356                     {
00357                       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o4">Right</a> == 0 &amp;&amp; <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o3">Left</a> == 0)
00358                         <a class="code" href="proto_8h.html#a38">endrun</a>(8188);   <span class="comment">/* can't occur */</span>
00359 
00360                       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o4">Right</a> == 0 &amp;&amp; <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o3">Left</a> &gt; 0)
00361                         {
00362                           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a> == 0 &amp;&amp; fabs(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].NumNgb - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o16">DesNumNgb</a>) &lt; 0.5 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o16">DesNumNgb</a>)
00363                             {
00364                               <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> *=
00365                                 1 - (<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o5">NumNgb</a> -
00366                                      <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o16">DesNumNgb</a>) / (<a class="code" href="allvars_8h.html#a36">NUMDIMS</a> * <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o5">NumNgb</a>) * <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o13">DhsmlDensityFactor</a>;
00367                             }
00368                           <span class="keywordflow">else</span>
00369                             <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> *= 1.26;
00370                         }
00371 
00372                       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o4">Right</a> &gt; 0 &amp;&amp; <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o3">Left</a> == 0)
00373                         {
00374                           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a> == 0 &amp;&amp; fabs(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].NumNgb - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o16">DesNumNgb</a>) &lt; 0.5 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o16">DesNumNgb</a>)
00375                             {
00376                               <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> *=
00377                                 1 - (<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o5">NumNgb</a> -
00378                                      <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o16">DesNumNgb</a>) / (<a class="code" href="allvars_8h.html#a36">NUMDIMS</a> * <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o5">NumNgb</a>) * <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o13">DhsmlDensityFactor</a>;
00379                             }
00380                           <span class="keywordflow">else</span>
00381                             <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> /= 1.26;
00382                         }
00383                     }
00384 
00385                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o98">MinGasHsml</a>)
00386                     <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o98">MinGasHsml</a>;
00387                 }
00388               <span class="keywordflow">else</span>
00389                 <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> = -<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> - 1; <span class="comment">/* Mark as inactive */</span>
00390             }
00391         }
00392       tend = <a class="code" href="proto_8h.html#a145">second</a>();
00393       timecomp += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00394 
00395 
00396       numlist = malloc(<a class="code" href="allvars_8c.html#a1">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00397       MPI_Allgather(&amp;npleft, 1, MPI_INT, numlist, 1, MPI_INT, MPI_COMM_WORLD);
00398       <span class="keywordflow">for</span>(i = 0, ntot = 0; i &lt; NTask; i++)
00399         ntot += numlist[i];
00400       free(numlist);
00401 
00402       <span class="keywordflow">if</span>(ntot &gt; 0)
00403         {
00404           <span class="keywordflow">if</span>(iter == 0)
00405             tstart_ngb = <a class="code" href="proto_8h.html#a145">second</a>();
00406 
00407           iter++;
00408 
00409           <span class="keywordflow">if</span>(iter &gt; 0 &amp;&amp; <a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00410             {
00411               printf(<span class="stringliteral">"ngb iteration %d: need to repeat for %d%09d particles.\n"</span>, iter,
00412                      (<span class="keywordtype">int</span>) (ntot / 1000000000), (<span class="keywordtype">int</span>) (ntot % 1000000000));
00413               fflush(stdout);
00414             }
00415 
00416           <span class="keywordflow">if</span>(iter &gt; MAXITER)
00417             {
00418               printf(<span class="stringliteral">"failed to converge in neighbour iteration in density()\n"</span>);
00419               fflush(stdout);
00420               <a class="code" href="proto_8h.html#a38">endrun</a>(1155);
00421             }
00422         }
00423       <span class="keywordflow">else</span>
00424         tend_ngb = <a class="code" href="proto_8h.html#a145">second</a>();
00425     }
00426   <span class="keywordflow">while</span>(ntot &gt; 0);
00427 
00428 
00429   <span class="comment">/* mark as active again */</span>
00430   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00431     <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> &lt; 0)
00432       <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> = -<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> - 1;
00433 
00434   free(ndonelist);
00435   free(nsend);
00436   free(nsend_local);
00437   free(nbuffer);
00438   free(noffset);
00439 
00440 
00441   <span class="comment">/* collect some timing information */</span>
00442   <span class="keywordflow">if</span>(iter &gt; 0)
00443     timengb = <a class="code" href="system_8c.html#a3">timediff</a>(tstart_ngb, tend_ngb);
00444   <span class="keywordflow">else</span>
00445     timengb = 0;
00446 
00447   MPI_Reduce(&amp;timengb, &amp;sumtimengb, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
00448   MPI_Reduce(&amp;timecomp, &amp;sumt, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
00449   MPI_Reduce(&amp;timecommsumm, &amp;sumcomm, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
00450   MPI_Reduce(&amp;timeimbalance, &amp;sumimbalance, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
00451 
00452   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00453     {
00454       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o80">CPU_HydCompWalk</a> += sumt / NTask;
00455       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o81">CPU_HydCommSumm</a> += sumcomm / NTask;
00456       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o82">CPU_HydImbalance</a> += sumimbalance / NTask;
00457       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o84">CPU_EnsureNgb</a> += sumtimengb / NTask;
00458     }
00459 }
00460 
00461 
00462 
<a name="l00467"></a><a class="code" href="proto_8h.html#a16">00467</a> <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a16">density_evaluate</a>(<span class="keywordtype">int</span> target, <span class="keywordtype">int</span> mode)
00468 {
00469   <span class="keywordtype">int</span> j, n, startnode, numngb, numngb_inbox;
00470   <span class="keywordtype">double</span> h, h2, fac, hinv, hinv3, hinv4;
00471   <span class="keywordtype">double</span> rho, divv, wk, dwk;
00472   <span class="keywordtype">double</span> dx, dy, dz, r, r2, u, mass_j;
00473   <span class="keywordtype">double</span> dvx, dvy, dvz, rotv[3];
00474   <span class="keywordtype">double</span> weighted_numngb, dhsmlrho;
00475   <a class="code" href="allvars_8h.html#a35">FLOAT</a> *pos, *vel;
00476 
00477   <span class="keywordflow">if</span>(mode == 0)
00478     {
00479       pos = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o0">Pos</a>;
00480       vel = <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o9">VelPred</a>;
00481       h = <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
00482     }
00483   <span class="keywordflow">else</span>
00484     {
00485       pos = <a class="code" href="allvars_8c.html#a72">DensDataGet</a>[target].<a class="code" href="structdensdata__in.html#o0">Pos</a>;
00486       vel = <a class="code" href="allvars_8c.html#a72">DensDataGet</a>[target].<a class="code" href="structdensdata__in.html#o1">Vel</a>;
00487       h = <a class="code" href="allvars_8c.html#a72">DensDataGet</a>[target].<a class="code" href="structdensdata__in.html#o2">Hsml</a>;
00488     }
00489 
00490   h2 = h * h;
00491   hinv = 1.0 / h;
00492 <span class="preprocessor">#ifndef  TWODIMS</span>
00493 <span class="preprocessor"></span>  hinv3 = hinv * hinv * hinv;
00494 <span class="preprocessor">#else</span>
00495 <span class="preprocessor"></span>  hinv3 = hinv * hinv / boxSize_Z;
00496 <span class="preprocessor">#endif</span>
00497 <span class="preprocessor"></span>  hinv4 = hinv3 * hinv;
00498 
00499   rho = divv = rotv[0] = rotv[1] = rotv[2] = 0;
00500   weighted_numngb = 0;
00501   dhsmlrho = 0;
00502 
00503   startnode = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>;
00504   numngb = 0;
00505   <span class="keywordflow">do</span>
00506     {
00507       numngb_inbox = <a class="code" href="proto_8h.html#a113">ngb_treefind_variable</a>(&amp;pos[0], h, &amp;startnode);
00508 
00509       <span class="keywordflow">for</span>(n = 0; n &lt; numngb_inbox; n++)
00510         {
00511           j = <a class="code" href="allvars_8c.html#a12">Ngblist</a>[n];
00512 
00513           dx = pos[0] - <a class="code" href="allvars_8c.html#a51">P</a>[j].<a class="code" href="structparticle__data.html#o0">Pos</a>[0];
00514           dy = pos[1] - <a class="code" href="allvars_8c.html#a51">P</a>[j].<a class="code" href="structparticle__data.html#o0">Pos</a>[1];
00515           dz = pos[2] - <a class="code" href="allvars_8c.html#a51">P</a>[j].<a class="code" href="structparticle__data.html#o0">Pos</a>[2];
00516 
00517 <span class="preprocessor">#ifdef PERIODIC                 </span><span class="comment">/*  now find the closest image in the given box size  */</span>
00518           <span class="keywordflow">if</span>(dx &gt; boxHalf_X)
00519             dx -= boxSize_X;
00520           <span class="keywordflow">if</span>(dx &lt; -boxHalf_X)
00521             dx += boxSize_X;
00522           <span class="keywordflow">if</span>(dy &gt; boxHalf_Y)
00523             dy -= boxSize_Y;
00524           <span class="keywordflow">if</span>(dy &lt; -boxHalf_Y)
00525             dy += boxSize_Y;
00526           <span class="keywordflow">if</span>(dz &gt; boxHalf_Z)
00527             dz -= boxSize_Z;
00528           <span class="keywordflow">if</span>(dz &lt; -boxHalf_Z)
00529             dz += boxSize_Z;
00530 <span class="preprocessor">#endif</span>
00531 <span class="preprocessor"></span>          r2 = dx * dx + dy * dy + dz * dz;
00532 
00533           <span class="keywordflow">if</span>(r2 &lt; h2)
00534             {
00535               numngb++;
00536 
00537               r = sqrt(r2);
00538 
00539               u = r * hinv;
00540 
00541               <span class="keywordflow">if</span>(u &lt; 0.5)
00542                 {
00543                   wk = hinv3 * (<a class="code" href="allvars_8h.html#a37">KERNEL_COEFF_1</a> + <a class="code" href="allvars_8h.html#a38">KERNEL_COEFF_2</a> * (u - 1) * u * u);
00544                   dwk = hinv4 * u * (<a class="code" href="allvars_8h.html#a39">KERNEL_COEFF_3</a> * u - KERNEL_COEFF_4);
00545                 }
00546               <span class="keywordflow">else</span>
00547                 {
00548                   wk = hinv3 * <a class="code" href="allvars_8h.html#a41">KERNEL_COEFF_5</a> * (1.0 - u) * (1.0 - u) * (1.0 - u);
00549                   dwk = hinv4 * <a class="code" href="allvars_8h.html#a42">KERNEL_COEFF_6</a> * (1.0 - u) * (1.0 - u);
00550                 }
00551 
00552               mass_j = <a class="code" href="allvars_8c.html#a51">P</a>[j].<a class="code" href="structparticle__data.html#o1">Mass</a>;
00553 
00554               rho += mass_j * wk;
00555 
00556               weighted_numngb += <a class="code" href="allvars_8h.html#a43">NORM_COEFF</a> * wk / hinv3;
00557 
00558               dhsmlrho += -mass_j * (<a class="code" href="allvars_8h.html#a36">NUMDIMS</a> * hinv * wk + u * dwk);
00559 
00560               <span class="keywordflow">if</span>(r &gt; 0)
00561                 {
00562                   fac = mass_j * dwk / r;
00563 
00564                   dvx = vel[0] - <a class="code" href="allvars_8c.html#a53">SphP</a>[j].<a class="code" href="structsph__particle__data.html#o9">VelPred</a>[0];
00565                   dvy = vel[1] - <a class="code" href="allvars_8c.html#a53">SphP</a>[j].<a class="code" href="structsph__particle__data.html#o9">VelPred</a>[1];
00566                   dvz = vel[2] - <a class="code" href="allvars_8c.html#a53">SphP</a>[j].<a class="code" href="structsph__particle__data.html#o9">VelPred</a>[2];
00567 
00568                   divv -= fac * (dx * dvx + dy * dvy + dz * dvz);
00569 
00570                   rotv[0] += fac * (dz * dvy - dy * dvz);
00571                   rotv[1] += fac * (dx * dvz - dz * dvx);
00572                   rotv[2] += fac * (dy * dvx - dx * dvy);
00573                 }
00574             }
00575         }
00576     }
00577   <span class="keywordflow">while</span>(startnode &gt;= 0);
00578 
00579   <span class="keywordflow">if</span>(mode == 0)
00580     {
00581       <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o5">NumNgb</a> = weighted_numngb;
00582       <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o1">Density</a> = rho;
00583       <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o10">DivVel</a> = divv;
00584       <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o13">DhsmlDensityFactor</a> = dhsmlrho;
00585       <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o12">Rot</a>[0] = rotv[0];
00586       <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o12">Rot</a>[1] = rotv[1];
00587       <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o12">Rot</a>[2] = rotv[2];
00588     }
00589   <span class="keywordflow">else</span>
00590     {
00591       <a class="code" href="allvars_8c.html#a73">DensDataResult</a>[target].<a class="code" href="structdensdata__out.html#o0">Rho</a> = rho;
00592       <a class="code" href="allvars_8c.html#a73">DensDataResult</a>[target].<a class="code" href="structdensdata__out.html#o1">Div</a> = divv;
00593       <a class="code" href="allvars_8c.html#a73">DensDataResult</a>[target].<a class="code" href="structdensdata__out.html#o4">Ngb</a> = weighted_numngb;
00594       <a class="code" href="allvars_8c.html#a73">DensDataResult</a>[target].<a class="code" href="structdensdata__out.html#o3">DhsmlDensity</a> = dhsmlrho;
00595       <a class="code" href="allvars_8c.html#a73">DensDataResult</a>[target].<a class="code" href="structdensdata__out.html#o2">Rot</a>[0] = rotv[0];
00596       <a class="code" href="allvars_8c.html#a73">DensDataResult</a>[target].<a class="code" href="structdensdata__out.html#o2">Rot</a>[1] = rotv[1];
00597       <a class="code" href="allvars_8c.html#a73">DensDataResult</a>[target].<a class="code" href="structdensdata__out.html#o2">Rot</a>[2] = rotv[2];
00598     }
00599 }
00600 
00601 
00602 
00603 
<a name="l00607"></a><a class="code" href="proto_8h.html#a13">00607</a> <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a13">dens_compare_key</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *a, <span class="keyword">const</span> <span class="keywordtype">void</span> *b)
00608 {
00609   <span class="keywordflow">if</span>(((<span class="keyword">struct </span><a class="code" href="structdensdata__in.html">densdata_in</a> *) a)-&gt;Task &lt; (((<span class="keyword">struct </span><a class="code" href="structdensdata__in.html">densdata_in</a> *) b)-&gt;Task))
00610     <span class="keywordflow">return</span> -1;
00611 
00612   <span class="keywordflow">if</span>(((<span class="keyword">struct </span><a class="code" href="structdensdata__in.html">densdata_in</a> *) a)-&gt;Task &gt; (((<span class="keyword">struct </span><a class="code" href="structdensdata__in.html">densdata_in</a> *) b)-&gt;Task))
00613     <span class="keywordflow">return</span> +1;
00614 
00615   <span class="keywordflow">return</span> 0;
00616 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 22 15:29:40 2006 for GADGET-2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
