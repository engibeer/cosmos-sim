<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GADGET-2: timestep.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>timestep.c</h1><a href="timestep_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00002 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00003 <span class="preprocessor">#include &lt;string.h&gt;</span>
00004 <span class="preprocessor">#include &lt;math.h&gt;</span>
00005 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
00006 <span class="preprocessor">#include "<a class="code" href="allvars_8h.html">allvars.h</a>"</span>
00007 <span class="preprocessor">#include "<a class="code" href="proto_8h.html">proto.h</a>"</span>
00008 
00013 <span class="keyword">static</span> <span class="keywordtype">double</span> fac1, fac2, fac3, hubble_a, atime, a3inv;
00014 <span class="keyword">static</span> <span class="keywordtype">double</span> dt_displacement = 0;
00015 
00016 
<a name="l00024"></a><a class="code" href="timestep_8c.html#a7">00024</a> <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a0">advance_and_find_timesteps</a>(<span class="keywordtype">void</span>)
00025 {
00026   <span class="keywordtype">int</span> i, j, no, ti_step, ti_min, tend, tstart;
00027   <span class="keywordtype">double</span> dt_entr, dt_entr2, dt_gravkick, dt_hydrokick, dt_gravkick2, dt_hydrokick2, t0, t1;
00028   <span class="keywordtype">double</span> minentropy, aphys;
00029   <a class="code" href="allvars_8h.html#a35">FLOAT</a> dv[3];
00030 
00031 <span class="preprocessor">#ifdef FLEXSTEPS</span>
00032 <span class="preprocessor"></span>  <span class="keywordtype">int</span> ti_grp;
00033 <span class="preprocessor">#endif</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#if defined(PSEUDOSYMMETRIC) &amp;&amp; !defined(FLEXSTEPS)</span>
00035 <span class="preprocessor"></span>  <span class="keywordtype">double</span> apred, prob;
00036   <span class="keywordtype">int</span> ti_step2;
00037 <span class="preprocessor">#endif</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#ifdef PMGRID</span>
00039 <span class="preprocessor"></span>  <span class="keywordtype">double</span> dt_gravkickA, dt_gravkickB;
00040 <span class="preprocessor">#endif</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#ifdef MAKEGLASS</span>
00042 <span class="preprocessor"></span>  <span class="keywordtype">double</span> disp, dispmax, globmax, dmean, fac, disp2sum, globdisp2sum;
00043 <span class="preprocessor">#endif</span>
00044 <span class="preprocessor"></span>
00045   t0 = <a class="code" href="proto_8h.html#a145">second</a>();
00046 
00047   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00048     {
00049       fac1 = 1 / (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>);
00050       fac2 = 1 / <a class="code" href="proto_8h.html#a133">pow</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>, 3 * <a class="code" href="allvars_8h.html#a9">GAMMA</a> - 2);
00051       fac3 = <a class="code" href="proto_8h.html#a133">pow</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>, 3 * (1 - <a class="code" href="allvars_8h.html#a9">GAMMA</a>) / 2.0);
00052       hubble_a = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o36">Omega0</a> / (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>)
00053         + (1 - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o36">Omega0</a> - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o37">OmegaLambda</a>) / (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>) + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o37">OmegaLambda</a>;
00054 
00055       hubble_a = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> * sqrt(hubble_a);
00056       a3inv = 1 / (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>);
00057       atime = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>;
00058     }
00059   <span class="keywordflow">else</span>
00060     fac1 = fac2 = fac3 = hubble_a = a3inv = atime = 1;
00061 
00062 <span class="preprocessor">#ifdef NOPMSTEPADJUSTMENT</span>
00063 <span class="preprocessor"></span>  dt_displacement = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o93">MaxSizeTimestep</a>;
00064 <span class="preprocessor">#else</span>
00065 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a14">Flag_FullStep</a> || dt_displacement == 0)
00066     <a class="code" href="timestep_8c.html#a9">find_dt_displacement_constraint</a>(hubble_a * atime * atime);
00067 <span class="preprocessor">#endif</span>
00068 <span class="preprocessor"></span>
00069 <span class="preprocessor">#ifdef PMGRID</span>
00070 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00071     dt_gravkickB = <a class="code" href="proto_8h.html#a83">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o62">PM_Ti_begstep</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>) -
00072       <a class="code" href="proto_8h.html#a83">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o62">PM_Ti_begstep</a>, (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o62">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a>) / 2);
00073   <span class="keywordflow">else</span>
00074     dt_gravkickB = (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a> - (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o62">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a>) / 2) * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00075 
00076   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a> == <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)       <span class="comment">/* need to do long-range kick */</span>
00077     {
00078       <span class="comment">/* make sure that we reconstruct the domain/tree next time because we don't kick the tree nodes in this case */</span>
00079       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o23">NumForcesSinceLastDomainDecomp</a> = 1 + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o96">TreeDomainUpdateFrequency</a>;
00080     }
00081 <span class="preprocessor">#endif</span>
00082 <span class="preprocessor"></span>
00083 
00084 <span class="preprocessor">#ifdef MAKEGLASS</span>
00085 <span class="preprocessor"></span>  <span class="keywordflow">for</span>(i = 0, dispmax = 0, disp2sum = 0; i &lt; NumPart; i++)
00086     {
00087       <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
00088         {
00089           <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o4">GravPM</a>[j] *= -1;
00090           <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[j] *= -1;
00091           <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[j] += <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o4">GravPM</a>[j];
00092           <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o4">GravPM</a>[j] = 0;
00093         }
00094 
00095       disp = sqrt(<a class="code" href="allvars_8c.html#a51">P</a>[i].GravAccel[0] * <a class="code" href="allvars_8c.html#a51">P</a>[i].GravAccel[0] +
00096                   <a class="code" href="allvars_8c.html#a51">P</a>[i].GravAccel[1] * <a class="code" href="allvars_8c.html#a51">P</a>[i].GravAccel[1] + <a class="code" href="allvars_8c.html#a51">P</a>[i].GravAccel[2] * <a class="code" href="allvars_8c.html#a51">P</a>[i].GravAccel[2]);
00097 
00098       disp *= 2.0 / (3 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a>);
00099 
00100       disp2sum += disp * disp;
00101 
00102       <span class="keywordflow">if</span>(disp &gt; dispmax)
00103         dispmax = disp;
00104     }
00105 
00106   MPI_Allreduce(&amp;dispmax, &amp;globmax, 1, MPI_DOUBLE, MPI_MAX, MPI_COMM_WORLD);
00107   MPI_Allreduce(&amp;disp2sum, &amp;globdisp2sum, 1, MPI_DOUBLE, MPI_SUM, MPI_COMM_WORLD);
00108 
00109   dmean = <a class="code" href="proto_8h.html#a133">pow</a>(<a class="code" href="allvars_8c.html#a51">P</a>[0].Mass / (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o36">Omega0</a> * 3 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> / (8 * M_PI * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o24">G</a>)), 1.0 / 3);
00110 
00111   <span class="keywordflow">if</span>(globmax &gt; dmean)
00112     fac = dmean / globmax;
00113   <span class="keywordflow">else</span>
00114     fac = 1.0;
00115 
00116   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00117     {
00118       printf(<span class="stringliteral">"\nglass-making:  dmean= %g  global disp-maximum= %g  rms= %g\n\n"</span>,
00119              dmean, globmax, sqrt(globdisp2sum / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a>));
00120       fflush(stdout);
00121     }
00122 
00123   <span class="keywordflow">for</span>(i = 0, dispmax = 0; i &lt; NumPart; i++)
00124     {
00125       <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
00126         {
00127           <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o2">Vel</a>[j] = 0;
00128           <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[j] += fac * <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[j] * 2.0 / (3 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a>);
00129           <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[j] = 0;
00130         }
00131     }
00132 <span class="preprocessor">#endif</span>
00133 <span class="preprocessor"></span>
00134 
00135 
00136 
00137   <span class="comment">/* Now assign new timesteps and kick */</span>
00138 
00139 <span class="preprocessor">#ifdef FLEXSTEPS</span>
00140 <span class="preprocessor"></span>  <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a> % (4 * <a class="code" href="allvars_8c.html#a50">All</a>.PresentMinStep)) == 0)
00141     <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.PresentMinStep &lt; TIMEBASE)
00142       <a class="code" href="allvars_8c.html#a50">All</a>.PresentMinStep *= 2;
00143 
00144   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00145     {
00146       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> == <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)
00147         {
00148           ti_step = <a class="code" href="timestep_8c.html#a8">get_timestep</a>(i, &amp;aphys, 0);
00149 
00150           <span class="comment">/* make it a power 2 subdivision */</span>
00151           ti_min = TIMEBASE;
00152           <span class="keywordflow">while</span>(ti_min &gt; ti_step)
00153             ti_min &gt;&gt;= 1;
00154           ti_step = ti_min;
00155 
00156           <span class="keywordflow">if</span>(ti_step &lt; <a class="code" href="allvars_8c.html#a50">All</a>.PresentMinStep)
00157             <a class="code" href="allvars_8c.html#a50">All</a>.PresentMinStep = ti_step;
00158         }
00159     }
00160 
00161   ti_step = <a class="code" href="allvars_8c.html#a50">All</a>.PresentMinStep;
00162   MPI_Allreduce(&amp;ti_step, &amp;<a class="code" href="allvars_8c.html#a50">All</a>.PresentMinStep, 1, MPI_INT, MPI_MIN, MPI_COMM_WORLD);
00163 
00164   <span class="keywordflow">if</span>(dt_displacement &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o93">MaxSizeTimestep</a>)
00165     ti_step = (int) (dt_displacement / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>);
00166   <span class="keywordflow">else</span>
00167     ti_step = (int) (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o93">MaxSizeTimestep</a> / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>);
00168 
00169   <span class="comment">/* make it a power 2 subdivision */</span>
00170   ti_min = TIMEBASE;
00171   <span class="keywordflow">while</span>(ti_min &gt; ti_step)
00172     ti_min &gt;&gt;= 1;
00173   <a class="code" href="allvars_8c.html#a50">All</a>.PresentMaxStep = ti_min;
00174 
00175 
00176   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00177     printf(<span class="stringliteral">"Syn Range = %g  PresentMinStep = %d  PresentMaxStep = %d \n"</span>,
00178            (<span class="keywordtype">double</span>) <a class="code" href="allvars_8c.html#a50">All</a>.PresentMaxStep / <a class="code" href="allvars_8c.html#a50">All</a>.PresentMinStep, <a class="code" href="allvars_8c.html#a50">All</a>.PresentMinStep, <a class="code" href="allvars_8c.html#a50">All</a>.PresentMaxStep);
00179 
00180 <span class="preprocessor">#endif</span>
00181 <span class="preprocessor"></span>
00182 
00183   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00184     {
00185       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> == <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)
00186         {
00187           ti_step = <a class="code" href="timestep_8c.html#a8">get_timestep</a>(i, &amp;aphys, 0);
00188 
00189           <span class="comment">/* make it a power 2 subdivision */</span>
00190           ti_min = TIMEBASE;
00191           <span class="keywordflow">while</span>(ti_min &gt; ti_step)
00192             ti_min &gt;&gt;= 1;
00193           ti_step = ti_min;
00194 
00195 <span class="preprocessor">#ifdef FLEXSTEPS</span>
00196 <span class="preprocessor"></span>          ti_grp = <a class="code" href="allvars_8c.html#a51">P</a>[i].FlexStepGrp % <a class="code" href="allvars_8c.html#a50">All</a>.PresentMaxStep;
00197           ti_grp = (ti_grp / <a class="code" href="allvars_8c.html#a50">All</a>.PresentMinStep) * <a class="code" href="allvars_8c.html#a50">All</a>.PresentMinStep;
00198           ti_step = ((<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> + ti_grp + ti_step) / ti_step) * ti_step - (<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> + ti_grp);
00199 <span class="preprocessor">#else</span>
00200 <span class="preprocessor"></span>
00201 <span class="preprocessor">#ifdef PSEUDOSYMMETRIC</span>
00202 <span class="preprocessor"></span>          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a> != 0)
00203             {
00204               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> &gt; <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o11">Ti_begstep</a>)
00205                 {
00206                   apred = aphys + ((aphys - <a class="code" href="allvars_8c.html#a51">P</a>[i].AphysOld) / (<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> - <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o11">Ti_begstep</a>)) * ti_step;
00207                   <span class="keywordflow">if</span>(fabs(apred - aphys) &lt; 0.5 * aphys)
00208                     {
00209                       ti_step2 = <a class="code" href="timestep_8c.html#a8">get_timestep</a>(i, &amp;apred, -1);
00210                       ti_min = TIMEBASE;
00211                       <span class="keywordflow">while</span>(ti_min &gt; ti_step2)
00212                         ti_min &gt;&gt;= 1;
00213                       ti_step2 = ti_min;
00214 
00215                       <span class="keywordflow">if</span>(ti_step2 &lt; ti_step)
00216                         {
00217                           <a class="code" href="timestep_8c.html#a8">get_timestep</a>(i, &amp;apred, ti_step);
00218                           prob =
00219                             ((apred - aphys) / (aphys - <a class="code" href="allvars_8c.html#a51">P</a>[i].AphysOld) * (<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> -
00220                                                                           <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o11">Ti_begstep</a>)) / ti_step;
00221                           <span class="keywordflow">if</span>(prob &lt; <a class="code" href="system_8c.html#a0">get_random_number</a>(<a class="code" href="allvars_8c.html#a51">P</a>[i].ID))
00222                             ti_step /= 2;
00223                         }
00224                       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ti_step2 &gt; ti_step)
00225                         {
00226                           <a class="code" href="timestep_8c.html#a8">get_timestep</a>(i, &amp;apred, 2 * ti_step);
00227                           prob =
00228                             ((apred - aphys) / (aphys - <a class="code" href="allvars_8c.html#a51">P</a>[i].AphysOld) * (<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> -
00229                                                                           <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o11">Ti_begstep</a>)) / ti_step;
00230                           <span class="keywordflow">if</span>(prob &lt; <a class="code" href="system_8c.html#a0">get_random_number</a>(<a class="code" href="allvars_8c.html#a51">P</a>[i].ID + 1))
00231                             ti_step *= 2;
00232                         }
00233                     }
00234                 }
00235               <a class="code" href="allvars_8c.html#a51">P</a>[i].AphysOld = aphys;
00236             }
00237 <span class="preprocessor">#endif</span>
00238 <span class="preprocessor"></span>
00239 <span class="preprocessor">#ifdef SYNCHRONIZATION</span>
00240 <span class="preprocessor"></span>          <span class="keywordflow">if</span>(ti_step &gt; (<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> - <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o11">Ti_begstep</a>))     <span class="comment">/* timestep wants to increase */</span>
00241             {
00242               <span class="keywordflow">if</span>(((<a class="code" href="allvars_8h.html#a1">TIMEBASE</a> - <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a>) % ti_step) &gt; 0)
00243                 ti_step = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> - <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o11">Ti_begstep</a>;    <span class="comment">/* leave at old step */</span>
00244             }
00245 <span class="preprocessor">#endif</span>
00246 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* end of FLEXSTEPS */</span>
00247 
00248           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a> == TIMEBASE)        <span class="comment">/* we here finish the last timestep. */</span>
00249             ti_step = 0;
00250 
00251           <span class="keywordflow">if</span>((<a class="code" href="allvars_8h.html#a1">TIMEBASE</a> - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>) &lt; ti_step)     <span class="comment">/* check that we don't run beyond the end */</span>
00252             ti_step = <a class="code" href="allvars_8h.html#a1">TIMEBASE</a> - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>;
00253 
00254           tstart = (<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o11">Ti_begstep</a> + <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a>) / 2;     <span class="comment">/* midpoint of old step */</span>
00255           tend = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> + ti_step / 2; <span class="comment">/* midpoint of new step */</span>
00256 
00257           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00258             {
00259               dt_entr = (tend - tstart) * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00260               dt_entr2 = (tend - <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a>) * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00261               dt_gravkick = <a class="code" href="proto_8h.html#a83">get_gravkick_factor</a>(tstart, tend);
00262               dt_hydrokick = <a class="code" href="proto_8h.html#a84">get_hydrokick_factor</a>(tstart, tend);
00263               dt_gravkick2 = <a class="code" href="proto_8h.html#a83">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a51">P</a>[i].Ti_endstep, tend);
00264               dt_hydrokick2 = <a class="code" href="proto_8h.html#a84">get_hydrokick_factor</a>(<a class="code" href="allvars_8c.html#a51">P</a>[i].Ti_endstep, tend);
00265             }
00266           <span class="keywordflow">else</span>
00267             {
00268               dt_entr = dt_gravkick = dt_hydrokick = (tend - tstart) * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00269               dt_gravkick2 = dt_hydrokick2 = dt_entr2 = (tend - <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a>) * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00270             }
00271 
00272           <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o11">Ti_begstep</a> = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a>;
00273           <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o11">Ti_begstep</a> + ti_step;
00274 
00275 
00276           <span class="comment">/* do the kick */</span>
00277 
00278           <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
00279             {
00280               dv[j] = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[j] * dt_gravkick;
00281               <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o2">Vel</a>[j] += dv[j];
00282             }
00283 
00284           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a> == 0)    <span class="comment">/* SPH stuff */</span>
00285             {
00286               <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
00287                 {
00288                   dv[j] += <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o8">HydroAccel</a>[j] * dt_hydrokick;
00289                   <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o2">Vel</a>[j] += <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o8">HydroAccel</a>[j] * dt_hydrokick;
00290 
00291                   <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o9">VelPred</a>[j] =
00292                     <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o2">Vel</a>[j] - dt_gravkick2 * <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[j] - dt_hydrokick2 * <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o8">HydroAccel</a>[j];
00293 <span class="preprocessor">#ifdef PMGRID</span>
00294 <span class="preprocessor"></span>                  <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o9">VelPred</a>[j] += <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o4">GravPM</a>[j] * dt_gravkickB;
00295 <span class="preprocessor">#endif</span>
00296 <span class="preprocessor"></span>                }
00297 
00298               <span class="comment">/* In case of cooling, we prevent that the entropy (and</span>
00299 <span class="comment">                 hence temperature decreases by more than a factor 0.5 */</span>
00300 
00301               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o7">DtEntropy</a> * dt_entr &gt; -0.5 * <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o0">Entropy</a>)
00302                 <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o0">Entropy</a> += <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o7">DtEntropy</a> * dt_entr;
00303               <span class="keywordflow">else</span>
00304                 <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o0">Entropy</a> *= 0.5;
00305 
00306               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o21">MinEgySpec</a>)
00307                 {
00308                   minentropy = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o21">MinEgySpec</a> * <a class="code" href="allvars_8h.html#a10">GAMMA_MINUS1</a> / <a class="code" href="proto_8h.html#a133">pow</a>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].Density * a3inv, <a class="code" href="allvars_8h.html#a10">GAMMA_MINUS1</a>);
00309                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o0">Entropy</a> &lt; minentropy)
00310                     {
00311                       <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o0">Entropy</a> = minentropy;
00312                       <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o7">DtEntropy</a> = 0;
00313                     }
00314                 }
00315 
00316               <span class="comment">/* In case the timestep increases in the new step, we</span>
00317 <span class="comment">                 make sure that we do not 'overcool' when deriving</span>
00318 <span class="comment">                 predicted temperatures. The maximum timespan over</span>
00319 <span class="comment">                 which prediction can occur is ti_step/2, i.e. from</span>
00320 <span class="comment">                 the middle to the end of the current step */</span>
00321 
00322               dt_entr = ti_step / 2 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00323               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o0">Entropy</a> + <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o7">DtEntropy</a> * dt_entr &lt; 0.5 * <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o0">Entropy</a>)
00324                 <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o7">DtEntropy</a> = -0.5 * <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o0">Entropy</a> / dt_entr;
00325             }
00326 
00327 
00328           <span class="comment">/* if tree is not going to be reconstructed, kick parent nodes dynamically.</span>
00329 <span class="comment">           */</span>
00330           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o23">NumForcesSinceLastDomainDecomp</a> &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o96">TreeDomainUpdateFrequency</a>)
00331             {
00332               no = <a class="code" href="allvars_8c.html#a60">Father</a>[i];
00333               <span class="keywordflow">while</span>(no &gt;= 0)
00334                 {
00335                   <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
00336                     <a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o1">vs</a>[j] += dv[j] * <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o1">Mass</a> / <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o4">mass</a>;
00337 
00338                   no = <a class="code" href="allvars_8c.html#a58">Nodes</a>[no].<a class="code" href="structNODE.html#o10">u</a>.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o8">father</a>;
00339                 }
00340             }
00341         }
00342     }
00343 
00344 
00345 
00346 <span class="preprocessor">#ifdef PMGRID</span>
00347 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a> == <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)       <span class="comment">/* need to do long-range kick */</span>
00348     {
00349       ti_step = TIMEBASE;
00350       <span class="keywordflow">while</span>(ti_step &gt; (dt_displacement / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>))
00351         ti_step &gt;&gt;= 1;
00352 
00353       <span class="keywordflow">if</span>(ti_step &gt; (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a> - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o62">PM_Ti_begstep</a>))     <span class="comment">/* PM-timestep wants to increase */</span>
00354         {
00355           <span class="comment">/* we only increase if an integer number of steps will bring us to the end */</span>
00356           <span class="keywordflow">if</span>(((<a class="code" href="allvars_8h.html#a1">TIMEBASE</a> - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a>) % ti_step) &gt; 0)
00357             ti_step = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a> - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o62">PM_Ti_begstep</a>;    <span class="comment">/* leave at old step */</span>
00358         }
00359 
00360       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a> == TIMEBASE)    <span class="comment">/* we here finish the last timestep. */</span>
00361         ti_step = 0;
00362 
00363       tstart = (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o62">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a>) / 2;
00364       tend = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a> + ti_step / 2;
00365 
00366       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00367         dt_gravkick = <a class="code" href="proto_8h.html#a83">get_gravkick_factor</a>(tstart, tend);
00368       <span class="keywordflow">else</span>
00369         dt_gravkick = (tend - tstart) * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00370 
00371       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o62">PM_Ti_begstep</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a>;
00372       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o62">PM_Ti_begstep</a> + ti_step;
00373 
00374       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00375         dt_gravkickB = -<a class="code" href="proto_8h.html#a83">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o62">PM_Ti_begstep</a>, (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o62">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a>) / 2);
00376       <span class="keywordflow">else</span>
00377         dt_gravkickB =
00378           -((<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o62">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a>) / 2 - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o62">PM_Ti_begstep</a>) * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00379 
00380       <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00381         {
00382           <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)        <span class="comment">/* do the kick */</span>
00383             <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o2">Vel</a>[j] += <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o4">GravPM</a>[j] * dt_gravkick;
00384 
00385           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
00386             {
00387               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00388                 {
00389                   dt_gravkickA = <a class="code" href="proto_8h.html#a83">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a51">P</a>[i].Ti_begstep, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>) -
00390                     <a class="code" href="proto_8h.html#a83">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a51">P</a>[i].Ti_begstep, (<a class="code" href="allvars_8c.html#a51">P</a>[i].Ti_begstep + <a class="code" href="allvars_8c.html#a51">P</a>[i].Ti_endstep) / 2);
00391                   dt_hydrokick = <a class="code" href="proto_8h.html#a84">get_hydrokick_factor</a>(<a class="code" href="allvars_8c.html#a51">P</a>[i].Ti_begstep, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>) -
00392                     <a class="code" href="proto_8h.html#a84">get_hydrokick_factor</a>(<a class="code" href="allvars_8c.html#a51">P</a>[i].Ti_begstep, (<a class="code" href="allvars_8c.html#a51">P</a>[i].Ti_begstep + <a class="code" href="allvars_8c.html#a51">P</a>[i].Ti_endstep) / 2);
00393                 }
00394               <span class="keywordflow">else</span>
00395                 dt_gravkickA = dt_hydrokick =
00396                   (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a> - (<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o11">Ti_begstep</a> + <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a>) / 2) * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00397 
00398               <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
00399                 <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o9">VelPred</a>[j] = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o2">Vel</a>[j]
00400                   + <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[j] * dt_gravkickA
00401                   + <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o8">HydroAccel</a>[j] * dt_hydrokick + <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o4">GravPM</a>[j] * dt_gravkickB;
00402             }
00403         }
00404     }
00405 <span class="preprocessor">#endif</span>
00406 <span class="preprocessor"></span>
00407   t1 = <a class="code" href="proto_8h.html#a145">second</a>();
00408   <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o86">CPU_TimeLine</a> += <a class="code" href="system_8c.html#a3">timediff</a>(t0, t1);
00409 }
00410 
00411 
00412 
00413 
00423 <span class="keywordtype">int</span> <a class="code" href="timestep_8c.html#a8">get_timestep</a>(<span class="keywordtype">int</span> p,         
00424                  <span class="keywordtype">double</span> *aphys, 
00425                  <span class="keywordtype">int</span> flag        )
00427 {
00428   <span class="keywordtype">double</span> ax, ay, az, ac, csnd;
00429   <span class="keywordtype">double</span> dt = 0, dt_courant = 0, dt_accel;
00430   <span class="keywordtype">int</span> ti_step;
00431 
00432 <span class="preprocessor">#ifdef CONDUCTION</span>
00433 <span class="preprocessor"></span>  <span class="keywordtype">double</span> dt_cond;
00434 <span class="preprocessor">#endif</span>
00435 <span class="preprocessor"></span>
00436   <span class="keywordflow">if</span>(flag == 0)
<a name="l00437"></a><a class="code" href="timestep_8c.html#a8">00437</a>     {
00438       ax = fac1 * <a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[0];
00439       ay = fac1 * <a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[1];
00440       az = fac1 * <a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[2];
00441 
00442 <span class="preprocessor">#ifdef PMGRID</span>
00443 <span class="preprocessor"></span>      ax += fac1 * <a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o4">GravPM</a>[0];
00444       ay += fac1 * <a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o4">GravPM</a>[1];
00445       az += fac1 * <a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o4">GravPM</a>[2];
00446 <span class="preprocessor">#endif</span>
00447 <span class="preprocessor"></span>
00448       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
00449         {
00450           ax += fac2 * <a class="code" href="allvars_8c.html#a53">SphP</a>[p].<a class="code" href="structsph__particle__data.html#o8">HydroAccel</a>[0];
00451           ay += fac2 * <a class="code" href="allvars_8c.html#a53">SphP</a>[p].<a class="code" href="structsph__particle__data.html#o8">HydroAccel</a>[1];
00452           az += fac2 * <a class="code" href="allvars_8c.html#a53">SphP</a>[p].<a class="code" href="structsph__particle__data.html#o8">HydroAccel</a>[2];
00453         }
00454 
00455       ac = sqrt(ax * ax + ay * ay + az * az);   <span class="comment">/* this is now the physical acceleration */</span>
00456       *aphys = ac;
00457     }
00458   <span class="keywordflow">else</span>
00459     ac = *aphys;
00460 
00461   <span class="keywordflow">if</span>(ac == 0)
00462     ac = 1.0e-30;
00463 
00464   <span class="keywordflow">switch</span> (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o44">TypeOfTimestepCriterion</a>)
00465     {
00466     <span class="keywordflow">case</span> 0:
00467       <span class="keywordflow">if</span>(flag &gt; 0)
00468         {
00469           dt = flag * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00470           dt /= hubble_a;       <span class="comment">/* convert dloga to physical timestep  */</span>
00471           ac = 2 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o91">ErrTolIntAccuracy</a> * atime * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o9">Type</a>] / (dt * dt);
00472           *aphys = ac;
00473           <span class="keywordflow">return</span> flag;
00474         }
00475       dt = dt_accel = sqrt(2 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o91">ErrTolIntAccuracy</a> * atime * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[P[p].Type] / ac);
00476 <span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
00477 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
00478         dt = dt_accel = sqrt(2 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o91">ErrTolIntAccuracy</a> * atime * SphP[p].Hsml / 2.8 / ac);
00479 <span class="preprocessor">#endif</span>
00480 <span class="preprocessor"></span>      <span class="keywordflow">break</span>;
00481     <span class="keywordflow">default</span>:
00482       <a class="code" href="proto_8h.html#a38">endrun</a>(888);
00483       <span class="keywordflow">break</span>;
00484     }
00485 
00486   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
00487     {
00488       csnd = sqrt(GAMMA * SphP[p].Pressure / SphP[p].Density);
00489 
00490       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00491         dt_courant = 2 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o95">CourantFac</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> * <a class="code" href="allvars_8c.html#a53">SphP</a>[p].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> / (fac3 * <a class="code" href="allvars_8c.html#a53">SphP</a>[p].<a class="code" href="structsph__particle__data.html#o14">MaxSignalVel</a>);
00492       <span class="keywordflow">else</span>
00493         dt_courant = 2 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o95">CourantFac</a> * <a class="code" href="allvars_8c.html#a53">SphP</a>[p].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> / <a class="code" href="allvars_8c.html#a53">SphP</a>[p].<a class="code" href="structsph__particle__data.html#o14">MaxSignalVel</a>;
00494 
00495       <span class="keywordflow">if</span>(dt_courant &lt; dt)
00496         dt = dt_courant;
00497     }
00498 
00499   <span class="comment">/* convert the physical timestep to dloga if needed. Note: If comoving integration has not been selected,</span>
00500 <span class="comment">     hubble_a=1.</span>
00501 <span class="comment">   */</span>
00502   dt *= hubble_a;
00503 
00504   <span class="keywordflow">if</span>(dt &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o93">MaxSizeTimestep</a>)
00505     dt = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o93">MaxSizeTimestep</a>;
00506 
00507   <span class="keywordflow">if</span>(dt &gt;= dt_displacement)
00508     dt = dt_displacement;
00509 
00510   <span class="keywordflow">if</span>(dt &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o92">MinSizeTimestep</a>)
00511     {
00512 <span class="preprocessor">#ifndef NOSTOP_WHEN_BELOW_MINTIMESTEP</span>
00513 <span class="preprocessor"></span>      printf(<span class="stringliteral">"warning: Timestep wants to be below the limit `MinSizeTimestep'\n"</span>);
00514 
00515       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
00516         {
00517           printf
00518             (<span class="stringliteral">"Part-ID=%d  dt=%g dtc=%g ac=%g xyz=(%g|%g|%g)  hsml=%g  maxsignalvel=%g dt0=%g eps=%g\n"</span>,
00519              (int) <a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o8">ID</a>, dt, dt_courant * hubble_a, ac, <a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o0">Pos</a>[0], <a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o0">Pos</a>[1], <a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o0">Pos</a>[2],
00520              <a class="code" href="allvars_8c.html#a53">SphP</a>[p].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>, <a class="code" href="allvars_8c.html#a53">SphP</a>[p].<a class="code" href="structsph__particle__data.html#o14">MaxSignalVel</a>,
00521              sqrt(2 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o91">ErrTolIntAccuracy</a> * atime * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[P[p].Type] / ac) * hubble_a,
00522              <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o9">Type</a>]);
00523         }
00524       <span class="keywordflow">else</span>
00525         {
00526           printf(<span class="stringliteral">"Part-ID=%d  dt=%g ac=%g xyz=(%g|%g|%g)\n"</span>, (<span class="keywordtype">int</span>) P[p].ID, dt, ac, P[p].Pos[0], P[p].Pos[1],
00527                  P[p].Pos[2]);
00528         }
00529       fflush(stdout);
00530       <a class="code" href="proto_8h.html#a38">endrun</a>(888);
00531 <span class="preprocessor">#endif</span>
00532 <span class="preprocessor"></span>      dt = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o92">MinSizeTimestep</a>;
00533     }
00534 
00535   ti_step = dt / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00536 
00537   <span class="keywordflow">if</span>(!(ti_step &gt; 0 &amp;&amp; ti_step &lt; TIMEBASE))
00538     {
00539       printf(<span class="stringliteral">"\nError: A timestep of size zero was assigned on the integer timeline!\n"</span>
00540              <span class="stringliteral">"We better stop.\n"</span>
00541              <span class="stringliteral">"Task=%d Part-ID=%d dt=%g tibase=%g ti_step=%d ac=%g xyz=(%g|%g|%g) tree=(%g|%g%g)\n\n"</span>,
00542              ThisTask, (<span class="keywordtype">int</span>) P[p].ID, dt, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>, ti_step, ac,
00543              P[p].Pos[0], P[p].Pos[1], P[p].Pos[2], P[p].GravAccel[0], P[p].GravAccel[1], P[p].GravAccel[2]);
00544 <span class="preprocessor">#ifdef PMGRID</span>
00545 <span class="preprocessor"></span>      printf(<span class="stringliteral">"pm_force=(%g|%g|%g)\n"</span>, P[p].GravPM[0], P[p].GravPM[1], P[p].GravPM[2]);
00546 <span class="preprocessor">#endif</span>
00547 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
00548         printf(<span class="stringliteral">"hydro-frc=(%g|%g|%g)\n"</span>, SphP[p].HydroAccel[0], SphP[p].HydroAccel[1], SphP[p].HydroAccel[2]);
00549 
00550       fflush(stdout);
00551       <a class="code" href="proto_8h.html#a38">endrun</a>(818);
00552     }
00553 
00554   <span class="keywordflow">return</span> ti_step;
00555 }
00556 
00557 
00566 <span class="keywordtype">void</span> <a class="code" href="timestep_8c.html#a9">find_dt_displacement_constraint</a>(<span class="keywordtype">double</span> hfac  )
00567 {
00568   <span class="keywordtype">int</span> i, j, type, *temp;
00569   <span class="keywordtype">int</span> count[6];
00570   <span class="keywordtype">long</span> <span class="keywordtype">long</span> count_sum[6];
00571   <span class="keywordtype">double</span> v[6], v_sum[6], mim[6], min_mass[6];
00572   <span class="keywordtype">double</span> dt, dmean, asmth = 0;
00573 
00574   dt_displacement = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o93">MaxSizeTimestep</a>;
00575 
00576   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00577     {
00578       <span class="keywordflow">for</span>(type = 0; type &lt; 6; type++)
00579         {
00580           count[type] = 0;
00581           v[type] = 0;
<a name="l00582"></a><a class="code" href="timestep_8c.html#a9">00582</a>           mim[type] = 1.0e30;
00583         }
00584 
00585       <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00586         {
00587           v[<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a>] += <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o2">Vel</a>[0] * <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o2">Vel</a>[0] + <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o2">Vel</a>[1] * <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o2">Vel</a>[1] + <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o2">Vel</a>[2] * <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o2">Vel</a>[2];
00588           <span class="keywordflow">if</span>(mim[<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a>] &gt; <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o1">Mass</a>)
00589             mim[<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a>] = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o1">Mass</a>;
00590           count[<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a>]++;
00591         }
00592 
00593       MPI_Allreduce(v, v_sum, 6, MPI_DOUBLE, MPI_SUM, MPI_COMM_WORLD);
00594       MPI_Allreduce(mim, min_mass, 6, MPI_DOUBLE, MPI_MIN, MPI_COMM_WORLD);
00595 
00596       temp = malloc(NTask * 6 * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00597       MPI_Allgather(count, 6, MPI_INT, temp, 6, MPI_INT, MPI_COMM_WORLD);
00598       <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
00599         {
00600           count_sum[i] = 0;
00601           <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00602             count_sum[i] += temp[j * 6 + i];
00603         }
00604       free(temp);
00605 
00606       <span class="keywordflow">for</span>(type = 0; type &lt; 6; type++)
00607         {
00608           <span class="keywordflow">if</span>(count_sum[type] &gt; 0)
00609             {
00610               <span class="keywordflow">if</span>(type == 0)
00611                 dmean =
00612                   <a class="code" href="proto_8h.html#a133">pow</a>(min_mass[type] / (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o38">OmegaBaryon</a> * 3 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> / (8 * M_PI * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o24">G</a>)),
00613                       1.0 / 3);
00614               <span class="keywordflow">else</span>
00615                 dmean =
00616                   <a class="code" href="proto_8h.html#a133">pow</a>(min_mass[type] /
00617                       ((<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o36">Omega0</a> - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o38">OmegaBaryon</a>) * 3 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> / (8 * M_PI * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o24">G</a>)),
00618                       1.0 / 3);
00619 
00620               dt = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o94">MaxRMSDisplacementFac</a> * hfac * dmean / sqrt(v_sum[type] / count_sum[type]);
00621 
00622 <span class="preprocessor">#ifdef PMGRID</span>
00623 <span class="preprocessor"></span>              asmth = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o63">Asmth</a>[0];
00624 <span class="preprocessor">#ifdef PLACEHIGHRESREGION</span>
00625 <span class="preprocessor"></span>              <span class="keywordflow">if</span>(((1 &lt;&lt; type) &amp; (PLACEHIGHRESREGION)))
00626                 asmth = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o63">Asmth</a>[1];
00627 <span class="preprocessor">#endif</span>
00628 <span class="preprocessor"></span>              <span class="keywordflow">if</span>(asmth &lt; dmean)
00629                 dt = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o94">MaxRMSDisplacementFac</a> * hfac * asmth / sqrt(v_sum[type] / count_sum[type]);
00630 <span class="preprocessor">#endif</span>
00631 <span class="preprocessor"></span>
00632               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00633                 printf(<span class="stringliteral">"type=%d  dmean=%g asmth=%g minmass=%g a=%g  sqrt(&lt;p^2&gt;)=%g  dlogmax=%g\n"</span>,
00634                        type, dmean, asmth, min_mass[type], <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>, sqrt(v_sum[type] / count_sum[type]), dt);
00635 
00636               <span class="keywordflow">if</span>(dt &lt; dt_displacement)
00637                 dt_displacement = dt;
00638             }
00639         }
00640 
00641       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00642         printf(<span class="stringliteral">"displacement time constraint: %g  (%g)\n"</span>, dt_displacement, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o93">MaxSizeTimestep</a>);
00643     }
00644 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 22 15:29:41 2006 for GADGET-2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
