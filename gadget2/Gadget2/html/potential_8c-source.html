<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GADGET-2: potential.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>potential.c</h1><a href="potential_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00002 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00003 <span class="preprocessor">#include &lt;string.h&gt;</span>
00004 <span class="preprocessor">#include &lt;math.h&gt;</span>
00005 <span class="preprocessor">#include &lt;float.h&gt;</span>
00006 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
00007 
00008 
00009 <span class="preprocessor">#include "<a class="code" href="allvars_8h.html">allvars.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="proto_8h.html">proto.h</a>"</span>
00011 
00012 
<a name="l00022"></a><a class="code" href="proto_8h.html#a12">00022</a> <span class="keywordtype">void</span> <a class="code" href="potential_8c.html#a0">compute_potential</a>(<span class="keywordtype">void</span>)
00023 {
00024   <span class="keywordtype">int</span> i;
00025 
00026 <span class="preprocessor">#ifndef NOGRAVITY</span>
00027 <span class="preprocessor"></span>  <span class="keywordtype">long</span> <span class="keywordtype">long</span> ntot, ntotleft;
00028   <span class="keywordtype">int</span> j, k, level, sendTask, recvTask;
00029   <span class="keywordtype">int</span> ndone;
00030   <span class="keywordtype">int</span> maxfill, ngrp, place, nexport;
00031   <span class="keywordtype">int</span> *nsend, *noffset, *nsend_local, *nbuffer, *ndonelist, *numlist;
00032   <span class="keywordtype">double</span> fac;
00033   <span class="keywordtype">double</span> t0, t1, tstart, tend;
00034   MPI_Status status;
00035   <span class="keywordtype">double</span> r2;
00036 
00037   t0 = <a class="code" href="proto_8h.html#a145">second</a>();
00038 
00039   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00040     <a class="code" href="gravtree_8c.html#a1">set_softenings</a>();
00041 
00042   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00043     {
00044       printf(<span class="stringliteral">"Start computation of potential for all particles...\n"</span>);
00045       fflush(stdout);
00046     }
00047 
00048 
00049   tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00050   <span class="keywordflow">if</span>(TreeReconstructFlag)
00051     {
00052       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00053         printf(<span class="stringliteral">"Tree construction.\n"</span>);
00054 
00055       <a class="code" href="proto_8h.html#a58">force_treebuild</a>(<a class="code" href="allvars_8c.html#a3">NumPart</a>);
00056 
00057       <a class="code" href="allvars_8c.html#a13">TreeReconstructFlag</a> = 0;
00058 
00059       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00060         printf(<span class="stringliteral">"Tree construction done.\n"</span>);
00061     }
00062   tend = <a class="code" href="proto_8h.html#a145">second</a>();
00063   <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o71">CPU_TreeConstruction</a> += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00064 
00065   numlist = malloc(<a class="code" href="allvars_8c.html#a1">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00066   MPI_Allgather(&amp;<a class="code" href="allvars_8c.html#a3">NumPart</a>, 1, MPI_INT, numlist, 1, MPI_INT, MPI_COMM_WORLD);
00067   <span class="keywordflow">for</span>(i = 0, ntot = 0; i &lt; NTask; i++)
00068     ntot += numlist[i];
00069   free(numlist);
00070 
00071   noffset = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);        <span class="comment">/* offsets of bunches in common list */</span>
00072   nbuffer = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00073   nsend_local = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00074   nsend = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a> * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00075   ndonelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00076 
00077   i = 0;                        <span class="comment">/* beginn with this index */</span>
00078   ntotleft = ntot;              <span class="comment">/* particles left for all tasks together */</span>
00079 
00080   <span class="keywordflow">while</span>(ntotleft &gt; 0)
00081     {
00082       <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00083         nsend_local[j] = 0;
00084 
00085       <span class="comment">/* do local particles and prepare export list */</span>
00086       <span class="keywordflow">for</span>(nexport = 0, ndone = 0; i &lt; <a class="code" href="allvars_8c.html#a3">NumPart</a> &amp;&amp; nexport &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o10">BunchSizeForce</a> - NTask; i++)
00087         {
00088           ndone++;
00089 
00090           <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00091             <a class="code" href="allvars_8c.html#a11">Exportflag</a>[j] = 0;
00092 
00093 <span class="preprocessor">#ifndef PMGRID</span>
00094 <span class="preprocessor"></span>          <a class="code" href="proto_8h.html#a63">force_treeevaluate_potential</a>(i, 0);
00095 <span class="preprocessor">#else</span>
00096 <span class="preprocessor"></span>          <a class="code" href="proto_8h.html#a64">force_treeevaluate_potential_shortrange</a>(i, 0);
00097 <span class="preprocessor">#endif</span>
00098 <span class="preprocessor"></span>
00099           <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00100             {
00101               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a11">Exportflag</a>[j])
00102                 {
00103                   <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00104                     <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[nexport].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o0">Pos</a>[k] = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[k];
00105 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
00106 <span class="preprocessor"></span>                  <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[nexport].Type = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a>;
00107 <span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
00108 <span class="preprocessor"></span>                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
00109                     <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[nexport].Soft = <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
00110 <span class="preprocessor">#endif</span>
00111 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00112 <span class="preprocessor"></span>                  <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[nexport].<a class="code" href="structgravdata__in.html#o6">w</a>.<a class="code" href="structgravdata__in.html#o4">OldAcc</a> = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o7">OldAcc</a>;
00113 
00114                   <a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a>[nexport].<a class="code" href="structgravdata__index.html#o0">Task</a> = j;
00115                   <a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a>[nexport].<a class="code" href="structgravdata__index.html#o1">Index</a> = i;
00116                   <a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a>[nexport].<a class="code" href="structgravdata__index.html#o2">SortIndex</a> = nexport;
00117 
00118                   nexport++;
00119                   nsend_local[j]++;
00120                 }
00121             }
00122         }
00123 
00124       qsort(<a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a>, nexport, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__index.html">gravdata_index</a>), <a class="code" href="gravtree_8c.html#a2">grav_tree_compare_key</a>);
00125 
00126       <span class="keywordflow">for</span>(j = 0; j &lt; nexport; j++)
00127         <a class="code" href="allvars_8c.html#a66">GravDataIn</a>[j] = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[<a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a>[j].<a class="code" href="structgravdata__index.html#o2">SortIndex</a>];
00128 
00129       <span class="keywordflow">for</span>(j = 1, noffset[0] = 0; j &lt; NTask; j++)
00130         noffset[j] = noffset[j - 1] + nsend_local[j - 1];
00131 
00132       MPI_Allgather(nsend_local, <a class="code" href="allvars_8c.html#a1">NTask</a>, MPI_INT, nsend, <a class="code" href="allvars_8c.html#a1">NTask</a>, MPI_INT, MPI_COMM_WORLD);
00133 
00134       <span class="comment">/* now do the particles that need to be exported */</span>
00135 
00136       <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; PTask); level++)
00137         {
00138           <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00139             nbuffer[j] = 0;
00140           <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; PTask); ngrp++)
00141             {
00142               maxfill = 0;
00143               <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00144                 {
00145                   <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00146                     <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j])
00147                       maxfill = nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00148                 }
00149               <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o10">BunchSizeForce</a>)
00150                 <span class="keywordflow">break</span>;
00151 
00152               sendTask = ThisTask;
00153               recvTask = <a class="code" href="allvars_8c.html#a0">ThisTask</a> ^ ngrp;
00154 
00155               <span class="keywordflow">if</span>(recvTask &lt; NTask)
00156                 {
00157                   <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a0">ThisTask</a> * <a class="code" href="allvars_8c.html#a1">NTask</a> + recvTask] &gt; 0 || nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + ThisTask] &gt; 0)
00158                     {
00159                       <span class="comment">/* get the particles */</span>
00160                       MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a66">GravDataIn</a>[noffset[recvTask]],
00161                                    nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__in.html">gravdata_in</a>), MPI_BYTE,
00162                                    recvTask, <a class="code" href="tags_8h.html#a23">TAG_POTENTIAL_A</a>,
00163                                    &amp;<a class="code" href="allvars_8c.html#a67">GravDataGet</a>[nbuffer[<a class="code" href="allvars_8c.html#a0">ThisTask</a>]],
00164                                    nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + <a class="code" href="allvars_8c.html#a0">ThisTask</a>] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> gravdata_in), MPI_BYTE,
00165                                    recvTask, <a class="code" href="tags_8h.html#a23">TAG_POTENTIAL_A</a>, MPI_COMM_WORLD, &amp;status);
00166                     }
00167                 }
00168 
00169               <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00170                 <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00171                   nbuffer[j] += nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00172             }
00173 
00174           <span class="keywordflow">for</span>(j = 0; j &lt; nbuffer[ThisTask]; j++)
00175             {
00176 <span class="preprocessor">#ifndef PMGRID</span>
00177 <span class="preprocessor"></span>              <a class="code" href="proto_8h.html#a63">force_treeevaluate_potential</a>(j, 1);
00178 <span class="preprocessor">#else</span>
00179 <span class="preprocessor"></span>              <a class="code" href="proto_8h.html#a64">force_treeevaluate_potential_shortrange</a>(j, 1);
00180 <span class="preprocessor">#endif</span>
00181 <span class="preprocessor"></span>            }
00182 
00183 
00184           <span class="comment">/* get the result */</span>
00185           <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00186             nbuffer[j] = 0;
00187           <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; PTask); ngrp++)
00188             {
00189               maxfill = 0;
00190               <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00191                 {
00192                   <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00193                     <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j])
00194                       maxfill = nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00195                 }
00196               <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o10">BunchSizeForce</a>)
00197                 <span class="keywordflow">break</span>;
00198 
00199               sendTask = ThisTask;
00200               recvTask = <a class="code" href="allvars_8c.html#a0">ThisTask</a> ^ ngrp;
00201 
00202               <span class="keywordflow">if</span>(recvTask &lt; NTask)
00203                 {
00204                   <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a0">ThisTask</a> * <a class="code" href="allvars_8c.html#a1">NTask</a> + recvTask] &gt; 0 || nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + ThisTask] &gt; 0)
00205                     {
00206                       <span class="comment">/* send the results */</span>
00207                       MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a68">GravDataResult</a>[nbuffer[<a class="code" href="allvars_8c.html#a0">ThisTask</a>]],
00208                                    nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + <a class="code" href="allvars_8c.html#a0">ThisTask</a>] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__in.html">gravdata_in</a>),
00209                                    MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a24">TAG_POTENTIAL_B</a>,
00210                                    &amp;<a class="code" href="allvars_8c.html#a69">GravDataOut</a>[noffset[recvTask]],
00211                                    nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> gravdata_in),
00212                                    MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a24">TAG_POTENTIAL_B</a>, MPI_COMM_WORLD, &amp;status);
00213 
00214                       <span class="comment">/* add the result to the particles */</span>
00215                       <span class="keywordflow">for</span>(j = 0; j &lt; nsend_local[recvTask]; j++)
00216                         {
00217                           place = <a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a>[noffset[recvTask] + j].<a class="code" href="structgravdata__index.html#o1">Index</a>;
00218 
00219                           <a class="code" href="allvars_8c.html#a51">P</a>[place].<a class="code" href="structparticle__data.html#o6">Potential</a> += <a class="code" href="allvars_8c.html#a69">GravDataOut</a>[j + noffset[recvTask]].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o2">Potential</a>;
00220                         }
00221                     }
00222                 }
00223 
00224               <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00225                 <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00226                   nbuffer[j] += nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00227             }
00228 
00229           level = ngrp - 1;
00230         }
00231 
00232       MPI_Allgather(&amp;ndone, 1, MPI_INT, ndonelist, 1, MPI_INT, MPI_COMM_WORLD);
00233       <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00234         ntotleft -= ndonelist[j];
00235     }
00236 
00237   free(ndonelist);
00238   free(nsend);
00239   free(nsend_local);
00240   free(nbuffer);
00241   free(noffset);
00242 
00243 
00244   <span class="comment">/* add correction to exclude self-potential */</span>
00245 
00246   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00247     {
00248       <span class="comment">/* remove self-potential */</span>
00249       <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o6">Potential</a> += <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o1">Mass</a> / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a>];
00250 
00251       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00252         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o41">PeriodicBoundariesOn</a>)
00253           <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o6">Potential</a> -= 2.8372975 * <a class="code" href="proto_8h.html#a133">pow</a>(<a class="code" href="allvars_8c.html#a51">P</a>[i].Mass, 2.0 / 3) *
00254             <a class="code" href="proto_8h.html#a133">pow</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o36">Omega0</a> * 3 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> / (8 * M_PI * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o24">G</a>), 1.0 / 3);
00255     }
00256 
00257 
00258   <span class="comment">/* multiply with the gravitational constant */</span>
00259 
00260   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00261     <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o6">Potential</a> *= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o24">G</a>;
00262 
00263 
00264 <span class="preprocessor">#ifdef PMGRID</span>
00265 <span class="preprocessor"></span>
00266 <span class="preprocessor">#ifdef PERIODIC</span>
00267 <span class="preprocessor"></span>  <a class="code" href="pm__periodic_8c.html#a24">pmpotential_periodic</a>();
00268 <span class="preprocessor">#ifdef PLACEHIGHRESREGION</span>
00269 <span class="preprocessor"></span>  i = <a class="code" href="proto_8h.html#a131">pmpotential_nonperiodic</a>(1);
00270   <span class="keywordflow">if</span>(i == 1)  <span class="comment">/* this is returned if a particle lied outside allowed range */</span>
00271     {
00272       <a class="code" href="proto_8h.html#a127">pm_init_regionsize</a>();
00273       <a class="code" href="proto_8h.html#a128">pm_setup_nonperiodic_kernel</a>();
00274       i = <a class="code" href="proto_8h.html#a131">pmpotential_nonperiodic</a>(1);   <span class="comment">/* try again */</span>
00275     }
00276   <span class="keywordflow">if</span>(i == 1)
00277     <a class="code" href="proto_8h.html#a38">endrun</a>(88686);
00278 <span class="preprocessor">#endif</span>
00279 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00280 <span class="preprocessor"></span>  i = <a class="code" href="proto_8h.html#a131">pmpotential_nonperiodic</a>(0);
00281   <span class="keywordflow">if</span>(i == 1)                    <span class="comment">/* this is returned if a particle lied outside allowed range */</span>
00282     {
00283       <a class="code" href="proto_8h.html#a127">pm_init_regionsize</a>();
00284       <a class="code" href="proto_8h.html#a128">pm_setup_nonperiodic_kernel</a>();
00285       i = <a class="code" href="proto_8h.html#a131">pmpotential_nonperiodic</a>(0);   <span class="comment">/* try again */</span>
00286     }
00287   <span class="keywordflow">if</span>(i == 1)
00288     <a class="code" href="proto_8h.html#a38">endrun</a>(88687);
00289 <span class="preprocessor">#ifdef PLACEHIGHRESREGION</span>
00290 <span class="preprocessor"></span>  i = <a class="code" href="proto_8h.html#a131">pmpotential_nonperiodic</a>(1);
00291   <span class="keywordflow">if</span>(i == 1)                    <span class="comment">/* this is returned if a particle lied outside allowed range */</span>
00292     {
00293       <a class="code" href="proto_8h.html#a127">pm_init_regionsize</a>();
00294 
00295       i = <a class="code" href="proto_8h.html#a131">pmpotential_nonperiodic</a>(1);
00296     }
00297   <span class="keywordflow">if</span>(i != 0)
00298     <a class="code" href="proto_8h.html#a38">endrun</a>(88688);
00299 <span class="preprocessor">#endif</span>
00300 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00301 <span class="preprocessor"></span>
00302 <span class="preprocessor">#endif</span>
00303 <span class="preprocessor"></span>
00304 
00305 
00306   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00307     {
00308 <span class="preprocessor">#ifndef PERIODIC</span>
00309 <span class="preprocessor"></span>      fac = -0.5 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o36">Omega0</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a>;
00310 
00311       <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00312         {
00313           <span class="keywordflow">for</span>(k = 0, r2 = 0; k &lt; 3; k++)
00314             r2 += <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[k] * <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[k];
00315 
00316           <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o6">Potential</a> += fac * r2;
00317         }
00318 <span class="preprocessor">#endif</span>
00319 <span class="preprocessor"></span>    }
00320   <span class="keywordflow">else</span>
00321     {
00322       fac = -0.5 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o37">OmegaLambda</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a>;
00323       <span class="keywordflow">if</span>(fac != 0)
00324         {
00325           <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00326             {
00327               <span class="keywordflow">for</span>(k = 0, r2 = 0; k &lt; 3; k++)
00328                 r2 += <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[k] * <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[k];
00329 
00330               <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o6">Potential</a> += fac * r2;
00331             }
00332         }
00333     }
00334 
00335 
00336   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00337     {
00338       printf(<span class="stringliteral">"potential done.\n"</span>);
00339       fflush(stdout);
00340     }
00341 
00342   t1 = <a class="code" href="proto_8h.html#a145">second</a>();
00343 
00344   <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o74">CPU_Potential</a> += <a class="code" href="system_8c.html#a3">timediff</a>(t0, t1);
00345 
00346 <span class="preprocessor">#else</span>
00347 <span class="preprocessor"></span>  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00348     <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o6">Potential</a> = 0;
00349 <span class="preprocessor">#endif</span>
00350 <span class="preprocessor"></span>}
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 22 15:29:41 2006 for GADGET-2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
