<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GADGET-2: run.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>run.c</h1><a href="run_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00002 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00003 <span class="preprocessor">#include &lt;string.h&gt;</span>
00004 <span class="preprocessor">#include &lt;math.h&gt;</span>
00005 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
00006 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00007 
00008 <span class="preprocessor">#include "<a class="code" href="allvars_8h.html">allvars.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="proto_8h.html">proto.h</a>"</span>
00010 
<a name="l00020"></a><a class="code" href="run_8c.html#a0">00020</a> <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a143">run</a>(<span class="keywordtype">void</span>)
00021 {
00022   FILE *fd;
00023   <span class="keywordtype">int</span> stopflag = 0;
00024   <span class="keywordtype">char</span> stopfname[200], contfname[200];
00025   <span class="keywordtype">double</span> t0, t1;
00026 
00027 
00028   sprintf(stopfname, <span class="stringliteral">"%sstop"</span>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o115">OutputDir</a>);
00029   sprintf(contfname, <span class="stringliteral">"%scont"</span>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o115">OutputDir</a>);
00030   unlink(contfname);
00031 
00032   <span class="keywordflow">do</span>                            <span class="comment">/* main loop */</span>
00033     {
00034       t0 = <a class="code" href="proto_8h.html#a145">second</a>();
00035 
00036       <a class="code" href="proto_8h.html#a51">find_next_sync_point_and_drift</a>(); <span class="comment">/* find next synchronization point and drift particles to this time.</span>
00037 <span class="comment">                                         * If needed, this function will also write an output file</span>
00038 <span class="comment">                                         * at the desired time.</span>
00039 <span class="comment">                                         */</span>
00040 
00041       <a class="code" href="proto_8h.html#a40">every_timestep_stuff</a>();   <span class="comment">/* write some info to log-files */</span>
00042 
00043 
00044       <a class="code" href="domain_8c.html#a15">domain_Decomposition</a>();   <span class="comment">/* do domain decomposition if needed */</span>
00045 
00046 
00047       <a class="code" href="proto_8h.html#a10">compute_accelerations</a>(0); <span class="comment">/* compute accelerations for </span>
00048 <span class="comment">                                 * the particles that are to be advanced  </span>
00049 <span class="comment">                                 */</span>
00050 
00051       <span class="comment">/* check whether we want a full energy statistics */</span>
00052       <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o52">TimeLastStatistics</a>) &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o51">TimeBetStatistics</a>)
00053         {
00054 <span class="preprocessor">#ifdef COMPUTE_POTENTIAL_ENERGY</span>
00055 <span class="preprocessor"></span>          <a class="code" href="potential_8c.html#a0">compute_potential</a>();
00056 <span class="preprocessor">#endif</span>
00057 <span class="preprocessor"></span>          <a class="code" href="proto_8h.html#a39">energy_statistics</a>();  <span class="comment">/* compute and output energy statistics */</span>
00058           <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o52">TimeLastStatistics</a> += <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o51">TimeBetStatistics</a>;
00059         }
00060 
00061       <a class="code" href="proto_8h.html#a0">advance_and_find_timesteps</a>();     <span class="comment">/* 'kick' active particles in</span>
00062 <span class="comment">                                         * momentum space and compute new</span>
00063 <span class="comment">                                         * timesteps for them</span>
00064 <span class="comment">                                         */</span>
00065       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o53">NumCurrentTiStep</a>++;
00066 
00067       <span class="comment">/* Check whether we need to interrupt the run */</span>
00068       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00069         {
00070           <span class="comment">/* Is the stop-file present? If yes, interrupt the run. */</span>
00071           <span class="keywordflow">if</span>((fd = fopen(stopfname, <span class="stringliteral">"r"</span>)))
00072             {
00073               fclose(fd);
00074               stopflag = 1;
00075               unlink(stopfname);
00076             }
00077 
00078           <span class="comment">/* are we running out of CPU-time ? If yes, interrupt run. */</span>
00079           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a9">CPUThisRun</a> &gt; 0.85 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o70">TimeLimitCPU</a>)
00080             {
00081               printf(<span class="stringliteral">"reaching time-limit. stopping.\n"</span>);
00082               stopflag = 2;
00083             }
00084         }
00085 
00086       MPI_Bcast(&amp;stopflag, 1, MPI_INT, 0, MPI_COMM_WORLD);
00087 
00088       <span class="keywordflow">if</span>(stopflag)
00089         {
00090           <a class="code" href="restart_8c.html#a3">restart</a>(0);           <span class="comment">/* write restart file */</span>
00091           MPI_Barrier(MPI_COMM_WORLD);
00092 
00093           <span class="keywordflow">if</span>(stopflag == 2 &amp;&amp; <a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00094             {
00095               <span class="keywordflow">if</span>((fd = fopen(contfname, <span class="stringliteral">"w"</span>)))
00096                 fclose(fd);
00097             }
00098 
00099           <span class="keywordflow">if</span>(stopflag == 2 &amp;&amp; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o42">ResubmitOn</a> &amp;&amp; <a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00100             {
00101               <a class="code" href="begrun_8c.html#a7">close_outputfiles</a>();
00102               system(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o122">ResubmitCommand</a>);
00103             }
00104           <span class="keywordflow">return</span>;
00105         }
00106 
00107       <span class="comment">/* is it time to write a regular restart-file? (for security) */</span>
00108       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00109         {
00110           <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a9">CPUThisRun</a> - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o50">TimeLastRestartFile</a>) &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o49">CpuTimeBetRestartFile</a>)
00111             {
00112               <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o50">TimeLastRestartFile</a> = CPUThisRun;
00113               stopflag = 3;
00114             }
00115           <span class="keywordflow">else</span>
00116             stopflag = 0;
00117         }
00118 
00119       MPI_Bcast(&amp;stopflag, 1, MPI_INT, 0, MPI_COMM_WORLD);
00120 
00121       <span class="keywordflow">if</span>(stopflag == 3)
00122         {
00123           <a class="code" href="restart_8c.html#a3">restart</a>(0);           <span class="comment">/* write an occasional restart file */</span>
00124           stopflag = 0;
00125         }
00126 
00127       t1 = <a class="code" href="proto_8h.html#a145">second</a>();
00128 
00129       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o77">CPU_Total</a> += <a class="code" href="system_8c.html#a3">timediff</a>(t0, t1);
00130       <a class="code" href="allvars_8c.html#a9">CPUThisRun</a> += <a class="code" href="system_8c.html#a3">timediff</a>(t0, t1);
00131     }
00132   <span class="keywordflow">while</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a> &lt; <a class="code" href="allvars_8h.html#a1">TIMEBASE</a> &amp;&amp; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> &lt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o57">TimeMax</a>);
00133 
00134   <a class="code" href="restart_8c.html#a3">restart</a>(0);
00135 
00136   <a class="code" href="proto_8h.html#a144">savepositions</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o46">SnapshotFileCount</a>++);       <span class="comment">/* write a last snapshot</span>
00137 <span class="comment">                                                 * file at final time (will</span>
00138 <span class="comment">                                                 * be overwritten if</span>
00139 <span class="comment">                                                 * All.TimeMax is increased</span>
00140 <span class="comment">                                                 * and the run is continued)</span>
00141 <span class="comment">                                                 */</span>
00142 }
00143 
00144 
00151 <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a51">find_next_sync_point_and_drift</a>(<span class="keywordtype">void</span>)
00152 {
<a name="l00153"></a><a class="code" href="run_8c.html#a1">00153</a>   <span class="keywordtype">int</span> n, min, min_glob, flag, *temp;
00154   <span class="keywordtype">double</span> timeold;
00155   <span class="keywordtype">double</span> t0, t1;
00156 
00157   t0 = <a class="code" href="proto_8h.html#a145">second</a>();
00158 
00159   timeold = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>;
00160 
00161   <span class="keywordflow">for</span>(n = 1, min = <a class="code" href="allvars_8c.html#a51">P</a>[0].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a>; n &lt; NumPart; n++)
00162     <span class="keywordflow">if</span>(min &gt; <a class="code" href="allvars_8c.html#a51">P</a>[n].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a>)
00163       min = <a class="code" href="allvars_8c.html#a51">P</a>[n].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a>;
00164 
00165   MPI_Allreduce(&amp;min, &amp;min_glob, 1, MPI_INT, MPI_MIN, MPI_COMM_WORLD);
00166 
00167   <span class="comment">/* We check whether this is a full step where all particles are synchronized */</span>
00168   flag = 1;
00169   <span class="keywordflow">for</span>(n = 0; n &lt; NumPart; n++)
00170     <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[n].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> &gt; min_glob)
00171       flag = 0;
00172 
00173   MPI_Allreduce(&amp;flag, &amp;Flag_FullStep, 1, MPI_INT, MPI_MIN, MPI_COMM_WORLD);
00174 
00175 <span class="preprocessor">#ifdef PMGRID</span>
00176 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(min_glob &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a>)
00177     {
00178       min_glob = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a>;
00179       <a class="code" href="allvars_8c.html#a14">Flag_FullStep</a> = 1;
00180     }
00181 <span class="preprocessor">#endif</span>
00182 <span class="preprocessor"></span>
00183   <span class="comment">/* Determine 'NumForceUpdate', i.e. the number of particles on this processor that are going to be active */</span>
00184   <span class="keywordflow">for</span>(n = 0, <a class="code" href="allvars_8c.html#a7">NumForceUpdate</a> = 0; n &lt; NumPart; n++)
00185     {
00186       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[n].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> == min_glob)
00187 <span class="preprocessor">#ifdef SELECTIVE_NO_GRAVITY</span>
00188 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(!((1 &lt;&lt; <a class="code" href="allvars_8c.html#a51">P</a>[n].<a class="code" href="structparticle__data.html#o9">Type</a>) &amp; (SELECTIVE_NO_GRAVITY)))
00189 <span class="preprocessor">#endif</span>
00190 <span class="preprocessor"></span>          <a class="code" href="allvars_8c.html#a7">NumForceUpdate</a>++;
00191     }
00192 
00193   <span class="comment">/* note: NumForcesSinceLastDomainDecomp has type "long long" */</span>
00194   temp = malloc(NTask * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00195   MPI_Allgather(&amp;NumForceUpdate, 1, MPI_INT, temp, 1, MPI_INT, MPI_COMM_WORLD);
00196   <span class="keywordflow">for</span>(n = 0; n &lt; NTask; n++)
00197     <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o23">NumForcesSinceLastDomainDecomp</a> += temp[n];
00198   free(temp);
00199 
00200 
00201 
00202   t1 = <a class="code" href="proto_8h.html#a145">second</a>();
00203 
00204   <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o85">CPU_Predict</a> += <a class="code" href="system_8c.html#a3">timediff</a>(t0, t1);
00205 
00206   <span class="keywordflow">while</span>(min_glob &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o60">Ti_nextoutput</a> &amp;&amp; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o60">Ti_nextoutput</a> &gt;= 0)
00207     {
00208       <a class="code" href="proto_8h.html#a106">move_particles</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o60">Ti_nextoutput</a>);
00209 
00210       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o60">Ti_nextoutput</a>;
00211 
00212       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00213         <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o55">TimeBegin</a> * exp(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>);
00214       <span class="keywordflow">else</span>
00215         <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o55">TimeBegin</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00216 
00217 <span class="preprocessor">#ifdef OUTPUTPOTENTIAL</span>
00218 <span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o23">NumForcesSinceLastDomainDecomp</a> = 1 + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o96">TreeDomainUpdateFrequency</a>;
00219       <a class="code" href="domain_8c.html#a15">domain_Decomposition</a>();
00220       <a class="code" href="potential_8c.html#a0">compute_potential</a>();
00221 <span class="preprocessor">#endif</span>
00222 <span class="preprocessor"></span>      <a class="code" href="proto_8h.html#a144">savepositions</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o46">SnapshotFileCount</a>++);   <span class="comment">/* write snapshot file */</span>
00223 
00224       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o60">Ti_nextoutput</a> = <a class="code" href="run_8c.html#a2">find_next_outputtime</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o60">Ti_nextoutput</a> + 1);
00225     }
00226 
00227   <a class="code" href="proto_8h.html#a106">move_particles</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>, min_glob);
00228 
00229   <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a> = min_glob;
00230 
00231   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00232     <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o55">TimeBegin</a> * exp(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>);
00233   <span class="keywordflow">else</span>
00234     <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o55">TimeBegin</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00235 
00236   <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o56">TimeStep</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> - timeold;
00237 }
00238 
00239 
00240 
00244 <span class="keywordtype">int</span> <a class="code" href="run_8c.html#a2">find_next_outputtime</a>(<span class="keywordtype">int</span> ti_curr)
00245 {
<a name="l00246"></a><a class="code" href="run_8c.html#a2">00246</a>   <span class="keywordtype">int</span> i, ti, ti_next, iter = 0;
00247   <span class="keywordtype">double</span> next, time;
00248 
00249   ti_next = -1;
00250 
00251   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o45">OutputListOn</a>)
00252     {
00253       <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o125">OutputListLength</a>; i++)
00254         {
00255           time = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o124">OutputListTimes</a>[i];
00256 
00257           <span class="keywordflow">if</span>(time &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o55">TimeBegin</a> &amp;&amp; time &lt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o57">TimeMax</a>)
00258             {
00259               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00260                 ti = log(time / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o55">TimeBegin</a>) / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00261               <span class="keywordflow">else</span>
00262                 ti = (time - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o55">TimeBegin</a>) / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00263 
00264               <span class="keywordflow">if</span>(ti &gt;= ti_curr)
00265                 {
00266                   <span class="keywordflow">if</span>(ti_next == -1)
00267                     ti_next = ti;
00268 
00269                   <span class="keywordflow">if</span>(ti_next &gt; ti)
00270                     ti_next = ti;
00271                 }
00272             }
00273         }
00274     }
00275   <span class="keywordflow">else</span>
00276     {
00277       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00278         {
00279           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o47">TimeBetSnapshot</a> &lt;= 1.0)
00280             {
00281               printf(<span class="stringliteral">"TimeBetSnapshot &gt; 1.0 required for your simulation.\n"</span>);
00282               <a class="code" href="proto_8h.html#a38">endrun</a>(13123);
00283             }
00284         }
00285       <span class="keywordflow">else</span>
00286         {
00287           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o47">TimeBetSnapshot</a> &lt;= 0.0)
00288             {
00289               printf(<span class="stringliteral">"TimeBetSnapshot &gt; 0.0 required for your simulation.\n"</span>);
00290               <a class="code" href="proto_8h.html#a38">endrun</a>(13123);
00291             }
00292         }
00293 
00294       time = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o48">TimeOfFirstSnapshot</a>;
00295 
00296       iter = 0;
00297 
00298       <span class="keywordflow">while</span>(time &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o55">TimeBegin</a>)
00299         {
00300           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00301             time *= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o47">TimeBetSnapshot</a>;
00302           <span class="keywordflow">else</span>
00303             time += <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o47">TimeBetSnapshot</a>;
00304 
00305           iter++;
00306 
00307           <span class="keywordflow">if</span>(iter &gt; 1000000)
00308             {
00309               printf(<span class="stringliteral">"Can't determine next output time.\n"</span>);
00310               <a class="code" href="proto_8h.html#a38">endrun</a>(110);
00311             }
00312         }
00313 
00314       <span class="keywordflow">while</span>(time &lt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o57">TimeMax</a>)
00315         {
00316           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00317             ti = log(time / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o55">TimeBegin</a>) / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00318           <span class="keywordflow">else</span>
00319             ti = (time - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o55">TimeBegin</a>) / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00320 
00321           <span class="keywordflow">if</span>(ti &gt;= ti_curr)
00322             {
00323               ti_next = ti;
00324               <span class="keywordflow">break</span>;
00325             }
00326 
00327           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00328             time *= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o47">TimeBetSnapshot</a>;
00329           <span class="keywordflow">else</span>
00330             time += <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o47">TimeBetSnapshot</a>;
00331 
00332           iter++;
00333 
00334           <span class="keywordflow">if</span>(iter &gt; 1000000)
00335             {
00336               printf(<span class="stringliteral">"Can't determine next output time.\n"</span>);
00337               <a class="code" href="proto_8h.html#a38">endrun</a>(111);
00338             }
00339         }
00340     }
00341 
00342   <span class="keywordflow">if</span>(ti_next == -1)
00343     {
00344       ti_next = 2 * TIMEBASE;   <span class="comment">/* this will prevent any further output */</span>
00345 
00346       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00347         printf(<span class="stringliteral">"\nThere is no valid time for a further snapshot file.\n"</span>);
00348     }
00349   <span class="keywordflow">else</span>
00350     {
00351       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00352         next = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o55">TimeBegin</a> * exp(ti_next * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>);
00353       <span class="keywordflow">else</span>
00354         next = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o55">TimeBegin</a> + ti_next * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00355 
00356       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00357         printf(<span class="stringliteral">"\nSetting next time for snapshot file to Time_next= %g\n\n"</span>, next);
00358     }
00359 
00360   <span class="keywordflow">return</span> ti_next;
00361 }
00362 
00363 
00364 
00365 
00370 <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a40">every_timestep_stuff</a>(<span class="keywordtype">void</span>)
00371 {
00372   <span class="keywordtype">double</span> z;
00373 
<a name="l00374"></a><a class="code" href="run_8c.html#a3">00374</a>   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00375     {
00376       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00377         {
00378           z = 1.0 / (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>) - 1;
00379           fprintf(<a class="code" href="allvars_8c.html#a41">FdInfo</a>, <span class="stringliteral">"\nBegin Step %d, Time: %g, Redshift: %g, Systemstep: %g, Dloga: %g\n"</span>,
00380                   <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o53">NumCurrentTiStep</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>, z, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o56">TimeStep</a>,
00381                   log(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>) - log(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o56">TimeStep</a>));
00382           printf(<span class="stringliteral">"\nBegin Step %d, Time: %g, Redshift: %g, Systemstep: %g, Dloga: %g\n"</span>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o53">NumCurrentTiStep</a>,
00383                  <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>, z, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o56">TimeStep</a>, log(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>) - log(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o56">TimeStep</a>));
00384           fflush(<a class="code" href="allvars_8c.html#a41">FdInfo</a>);
00385         }
00386       <span class="keywordflow">else</span>
00387         {
00388           fprintf(<a class="code" href="allvars_8c.html#a41">FdInfo</a>, <span class="stringliteral">"\nBegin Step %d, Time: %g, Systemstep: %g\n"</span>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o53">NumCurrentTiStep</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>,
00389                   <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o56">TimeStep</a>);
00390           printf(<span class="stringliteral">"\nBegin Step %d, Time: %g, Systemstep: %g\n"</span>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o53">NumCurrentTiStep</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o56">TimeStep</a>);
00391           fflush(<a class="code" href="allvars_8c.html#a41">FdInfo</a>);
00392         }
00393 
00394       fprintf(<a class="code" href="allvars_8c.html#a44">FdCPU</a>, <span class="stringliteral">"Step %d, Time: %g, CPUs: %d\n"</span>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o53">NumCurrentTiStep</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>, <a class="code" href="allvars_8c.html#a1">NTask</a>);
00395 
00396       fprintf(<a class="code" href="allvars_8c.html#a44">FdCPU</a>,
00397               <span class="stringliteral">"%10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f\n"</span>,
00398               <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o77">CPU_Total</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o73">CPU_Gravity</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o83">CPU_Hydro</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o75">CPU_Domain</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o74">CPU_Potential</a>,
00399               <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o85">CPU_Predict</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o86">CPU_TimeLine</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o76">CPU_Snapshot</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o72">CPU_TreeWalk</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o71">CPU_TreeConstruction</a>,
00400               <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o78">CPU_CommSum</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o79">CPU_Imbalance</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o80">CPU_HydCompWalk</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o81">CPU_HydCommSumm</a>,
00401               <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o82">CPU_HydImbalance</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o84">CPU_EnsureNgb</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o87">CPU_PM</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o88">CPU_Peano</a>);
00402       fflush(<a class="code" href="allvars_8c.html#a44">FdCPU</a>);
00403     }
00404 
00405   <a class="code" href="proto_8h.html#a147">set_random_numbers</a>();
00406 }
00407 
00408 
00413 <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a39">energy_statistics</a>(<span class="keywordtype">void</span>)
00414 {
00415   <a class="code" href="global_8c.html#a0">compute_global_quantities_of_system</a>();
00416 
<a name="l00417"></a><a class="code" href="run_8c.html#a4">00417</a>   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00418     {
00419       fprintf(<a class="code" href="allvars_8c.html#a42">FdEnergy</a>,
00420               <span class="stringliteral">"%g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g %g\n"</span>,
00421               <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>, <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o3">EnergyInt</a>, <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o2">EnergyPot</a>, <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o1">EnergyKin</a>, <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o11">EnergyIntComp</a>[0],
00422               <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o10">EnergyPotComp</a>[0], <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o9">EnergyKinComp</a>[0], <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o11">EnergyIntComp</a>[1],
00423               <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o10">EnergyPotComp</a>[1], <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o9">EnergyKinComp</a>[1], <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o11">EnergyIntComp</a>[2],
00424               <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o10">EnergyPotComp</a>[2], <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o9">EnergyKinComp</a>[2], <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o11">EnergyIntComp</a>[3],
00425               <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o10">EnergyPotComp</a>[3], <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o9">EnergyKinComp</a>[3], <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o11">EnergyIntComp</a>[4],
00426               <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o10">EnergyPotComp</a>[4], <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o9">EnergyKinComp</a>[4], <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o11">EnergyIntComp</a>[5],
00427               <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o10">EnergyPotComp</a>[5], <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o9">EnergyKinComp</a>[5], <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o8">MassComp</a>[0],
00428               <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o8">MassComp</a>[1], <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o8">MassComp</a>[2], <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o8">MassComp</a>[3], <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o8">MassComp</a>[4],
00429               <a class="code" href="allvars_8c.html#a65">SysState</a>.<a class="code" href="structstate__of__system.html#o8">MassComp</a>[5]);
00430 
00431       fflush(<a class="code" href="allvars_8c.html#a42">FdEnergy</a>);
00432     }
00433 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 22 15:29:41 2006 for GADGET-2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
