<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GADGET-2: gravtree_forcetest.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>gravtree_forcetest.c</h1><a href="gravtree__forcetest_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00002 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00003 <span class="preprocessor">#include &lt;string.h&gt;</span>
00004 <span class="preprocessor">#include &lt;math.h&gt;</span>
00005 <span class="preprocessor">#include &lt;float.h&gt;</span>
00006 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
00007 
00008 <span class="preprocessor">#include "<a class="code" href="allvars_8h.html">allvars.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="proto_8h.html">proto.h</a>"</span>
00010 
00011 
00023 <span class="preprocessor">#ifdef FORCETEST</span>
00024 <span class="preprocessor"></span>
<a name="l00028"></a><a class="code" href="proto_8h.html#a90">00028</a> <span class="keywordtype">void</span> <a class="code" href="gravtree__forcetest_8c.html#a0">gravity_forcetest</a>(<span class="keywordtype">void</span>)
00029 {
00030   <span class="keywordtype">int</span> ntot, iter = 0, ntotleft, nthis;
00031   <span class="keywordtype">double</span> tstart, tend, timetree = 0;
00032   <span class="keywordtype">int</span> i, j, ndone, ngrp, maxfill, place, ndonetot;
00033 
00034 <span class="preprocessor">#ifndef NOGRAVITY</span>
00035 <span class="preprocessor"></span>  <span class="keywordtype">int</span> *noffset, *nbuffer, *nsend, *nsend_local;
00036   <span class="keywordtype">int</span> k, nexport;
00037   <span class="keywordtype">int</span> level, sendTask, recvTask;
00038   <span class="keywordtype">double</span> fac1;
00039   MPI_Status status;
00040 <span class="preprocessor">#endif</span>
00041 <span class="preprocessor"></span>  <span class="keywordtype">double</span> costtotal, *costtreelist;
00042   <span class="keywordtype">double</span> maxt, sumt, *timetreelist;
00043   <span class="keywordtype">double</span> fac;
00044   <span class="keywordtype">char</span> buf[200];
00045 
00046 <span class="preprocessor">#ifdef PMGRID</span>
00047 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a> != <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)
00048     <span class="keywordflow">return</span>;
00049 <span class="preprocessor">#endif</span>
00050 <span class="preprocessor"></span>
00051   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00052     <a class="code" href="gravtree_8c.html#a1">set_softenings</a>();           <span class="comment">/* set new softening lengths */</span>
00053 
00054   <span class="keywordflow">for</span>(i = 0, <a class="code" href="allvars_8c.html#a7">NumForceUpdate</a> = 0; i &lt; NumPart; i++)
00055     {
00056       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> == <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)
00057         {
00058           <span class="keywordflow">if</span>(<a class="code" href="system_8c.html#a0">get_random_number</a>(<a class="code" href="allvars_8c.html#a51">P</a>[i].ID) &lt; FORCETEST)
00059             {
00060               <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> = -<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> - 1;
00061               <a class="code" href="allvars_8c.html#a7">NumForceUpdate</a>++;
00062             }
00063         }
00064     }
00065 
00066   <span class="comment">/* NumForceUpdate is the number of particles on this processor that want a force update */</span>
00067 
00068   MPI_Allreduce(&amp;<a class="code" href="allvars_8c.html#a7">NumForceUpdate</a>, &amp;ntot, 1, MPI_INT, MPI_SUM, MPI_COMM_WORLD);
00069 
00070   costtotal = 0;
00071 
00072   noffset = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);        <span class="comment">/* offsets of bunches in common list */</span>
00073   nbuffer = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00074   nsend_local = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00075   nsend = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a> * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00076 
00077   i = 0;                        <span class="comment">/* beginn with this index */</span>
00078   ntotleft = ntot;              <span class="comment">/* particles left for all tasks together */</span>
00079 
00080   <span class="keywordflow">while</span>(ntotleft &gt; 0)
00081     {
00082       iter++;
00083 
00084       <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00085         nsend_local[j] = 0;
00086 
00087       <span class="comment">/* do local particles and prepare export list */</span>
00088       tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00089       <span class="keywordflow">for</span>(nexport = 0, ndone = 0; i &lt; <a class="code" href="allvars_8c.html#a3">NumPart</a> &amp;&amp; nexport &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o10">BunchSizeForce</a> - NTask; i++)
00090         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> &lt; 0)
00091           {
00092             ndone++;
00093 
00094             <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00095               <a class="code" href="allvars_8c.html#a11">Exportflag</a>[j] = 1;
00096             <a class="code" href="allvars_8c.html#a11">Exportflag</a>[ThisTask] = 0;
00097 
00098             costtotal += <a class="code" href="proto_8h.html#a61">force_treeevaluate_direct</a>(i, 0);
00099 
00100             <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00101               {
00102                 <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a11">Exportflag</a>[j])
00103                   {
00104                     <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00105                       <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[nexport].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o0">Pos</a>[k] = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[k];
00106 
00107 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
00108 <span class="preprocessor"></span>                    <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[nexport].Type = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a>;
00109 <span class="preprocessor">#endif</span>
00110 <span class="preprocessor"></span>                    <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[nexport].<a class="code" href="structgravdata__in.html#o6">w</a>.<a class="code" href="structgravdata__in.html#o4">OldAcc</a> = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o7">OldAcc</a>;
00111 
00112                     <a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a>[nexport].<a class="code" href="structgravdata__index.html#o0">Task</a> = j;
00113                     <a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a>[nexport].<a class="code" href="structgravdata__index.html#o1">Index</a> = i;
00114                     <a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a>[nexport].<a class="code" href="structgravdata__index.html#o2">SortIndex</a> = nexport;
00115 
00116                     nexport++;
00117                     nsend_local[j]++;
00118                   }
00119               }
00120           }
00121       tend = <a class="code" href="proto_8h.html#a145">second</a>();
00122       timetree += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00123 
00124       qsort(<a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a>, nexport, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__index.html">gravdata_index</a>), <a class="code" href="gravtree_8c.html#a2">grav_tree_compare_key</a>);
00125 
00126       <span class="keywordflow">for</span>(j = 0; j &lt; nexport; j++)
00127         <a class="code" href="allvars_8c.html#a66">GravDataIn</a>[j] = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[<a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a>[j].<a class="code" href="structgravdata__index.html#o2">SortIndex</a>];
00128 
00129       <span class="keywordflow">for</span>(j = 1, noffset[0] = 0; j &lt; NTask; j++)
00130         noffset[j] = noffset[j - 1] + nsend_local[j - 1];
00131 
00132       MPI_Allgather(nsend_local, <a class="code" href="allvars_8c.html#a1">NTask</a>, MPI_INT, nsend, <a class="code" href="allvars_8c.html#a1">NTask</a>, MPI_INT, MPI_COMM_WORLD);
00133 
00134       <span class="comment">/* now do the particles that need to be exported */</span>
00135 
00136       <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; PTask); level++)
00137         {
00138           <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00139             nbuffer[j] = 0;
00140           <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; PTask); ngrp++)
00141             {
00142               maxfill = 0;
00143               <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00144                 {
00145                   <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00146                     <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j])
00147                       maxfill = nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00148                 }
00149               <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o10">BunchSizeForce</a>)
00150                 <span class="keywordflow">break</span>;
00151 
00152               sendTask = ThisTask;
00153               recvTask = <a class="code" href="allvars_8c.html#a0">ThisTask</a> ^ ngrp;
00154 
00155               <span class="keywordflow">if</span>(recvTask &lt; NTask)
00156                 {
00157                   <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a0">ThisTask</a> * <a class="code" href="allvars_8c.html#a1">NTask</a> + recvTask] &gt; 0 || nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + ThisTask] &gt; 0)
00158                     {
00159                       <span class="comment">/* get the particles */</span>
00160                       MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a66">GravDataIn</a>[noffset[recvTask]],
00161                                    nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__in.html">gravdata_in</a>), MPI_BYTE,
00162                                    recvTask, <a class="code" href="tags_8h.html#a10">TAG_DIRECT_A</a>,
00163                                    &amp;<a class="code" href="allvars_8c.html#a67">GravDataGet</a>[nbuffer[<a class="code" href="allvars_8c.html#a0">ThisTask</a>]],
00164                                    nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + <a class="code" href="allvars_8c.html#a0">ThisTask</a>] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> gravdata_in), MPI_BYTE,
00165                                    recvTask, <a class="code" href="tags_8h.html#a10">TAG_DIRECT_A</a>, MPI_COMM_WORLD, &amp;status);
00166                     }
00167                 }
00168 
00169               <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00170                 <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00171                   nbuffer[j] += nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00172             }
00173 
00174           tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00175           <span class="keywordflow">for</span>(j = 0; j &lt; nbuffer[ThisTask]; j++)
00176             {
00177               costtotal += <a class="code" href="proto_8h.html#a61">force_treeevaluate_direct</a>(j, 1);
00178             }
00179           tend = <a class="code" href="proto_8h.html#a145">second</a>();
00180           timetree += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00181 
00182 
00183           <span class="comment">/* get the result */</span>
00184           <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00185             nbuffer[j] = 0;
00186           <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; PTask); ngrp++)
00187             {
00188               maxfill = 0;
00189               <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00190                 {
00191                   <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00192                     <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j])
00193                       maxfill = nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00194                 }
00195               <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o10">BunchSizeForce</a>)
00196                 <span class="keywordflow">break</span>;
00197 
00198               sendTask = ThisTask;
00199               recvTask = <a class="code" href="allvars_8c.html#a0">ThisTask</a> ^ ngrp;
00200               <span class="keywordflow">if</span>(recvTask &lt; NTask)
00201                 {
00202                   <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a0">ThisTask</a> * <a class="code" href="allvars_8c.html#a1">NTask</a> + recvTask] &gt; 0 || nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + ThisTask] &gt; 0)
00203                     {
00204                       <span class="comment">/* send the results */</span>
00205                       MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a68">GravDataResult</a>[nbuffer[<a class="code" href="allvars_8c.html#a0">ThisTask</a>]],
00206                                    nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + <a class="code" href="allvars_8c.html#a0">ThisTask</a>] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__in.html">gravdata_in</a>),
00207                                    MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a11">TAG_DIRECT_B</a>,
00208                                    &amp;<a class="code" href="allvars_8c.html#a69">GravDataOut</a>[noffset[recvTask]],
00209                                    nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> gravdata_in),
00210                                    MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a11">TAG_DIRECT_B</a>, MPI_COMM_WORLD, &amp;status);
00211 
00212                       <span class="comment">/* add the result to the particles */</span>
00213                       <span class="keywordflow">for</span>(j = 0; j &lt; nsend_local[recvTask]; j++)
00214                         {
00215                           place = <a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a>[noffset[recvTask] + j].<a class="code" href="structgravdata__index.html#o1">Index</a>;
00216 
00217                           <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00218                             <a class="code" href="allvars_8c.html#a51">P</a>[place].<a class="code" href="structparticle__data.html#o5">GravAccelDirect</a>[k] += <a class="code" href="allvars_8c.html#a69">GravDataOut</a>[j + noffset[recvTask]].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o1">Acc</a>[k];
00219                         }
00220                     }
00221                 }
00222 
00223               <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00224                 <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00225                   nbuffer[j] += nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00226             }
00227 
00228           level = ngrp - 1;
00229         }
00230 
00231       MPI_Allreduce(&amp;ndone, &amp;ndonetot, 1, MPI_INT, MPI_SUM, MPI_COMM_WORLD);
00232 
00233       ntotleft -= ndonetot;
00234     }
00235 
00236   free(nsend);
00237   free(nsend_local);
00238   free(nbuffer);
00239   free(noffset);
00240 
00241 
00242   <span class="comment">/* now add things for comoving integration */</span>
00243 
00244   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00245     {
00246 <span class="preprocessor">#ifndef PERIODIC</span>
00247 <span class="preprocessor"></span>      fac1 = 0.5 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o36">Omega0</a> / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o24">G</a>;
00248 
00249       <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00250         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> &lt; 0)
00251           <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
00252             <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o5">GravAccelDirect</a>[j] += fac1 * <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[j];
00253 <span class="preprocessor">#endif</span>
00254 <span class="preprocessor"></span>    }
00255 
00256 
00257 
00258   <span class="comment">/*  muliply by G */</span>
00259 
00260   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00261     <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> &lt; 0)
00262       <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
00263         <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o5">GravAccelDirect</a>[j] *= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o24">G</a>;
00264 
00265 
00266 
00267   <span class="comment">/* Finally, the following factor allows a computation of cosmological simulation </span>
00268 <span class="comment">     with vacuum energy in physical coordinates */</span>
00269 
00270   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a> == 0)
00271     {
00272       fac1 = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o37">OmegaLambda</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a>;
00273 
00274       <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00275         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> &lt; 0)
00276           <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
00277             <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o5">GravAccelDirect</a>[j] += fac1 * <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[j];
00278     }
00279 
00280   <span class="comment">/* now output the forces to a file */</span>
00281 
00282   <span class="keywordflow">for</span>(nthis = 0; nthis &lt; NTask; nthis++)
00283     {
00284       <span class="keywordflow">if</span>(nthis == ThisTask)
00285         {
00286           sprintf(buf, <span class="stringliteral">"%s%s"</span>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o115">OutputDir</a>, <span class="stringliteral">"forcetest.txt"</span>);
00287           <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#a45">FdForceTest</a> = fopen(buf, <span class="stringliteral">"a"</span>)))
00288             {
00289               printf(<span class="stringliteral">"error in opening file '%s'\n"</span>, buf);
00290               <a class="code" href="proto_8h.html#a38">endrun</a>(17);
00291             }
00292           <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00293             <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> &lt; 0)
00294               {
00295 <span class="preprocessor">#ifndef PMGRID</span>
00296 <span class="preprocessor"></span>                fprintf(<a class="code" href="allvars_8c.html#a45">FdForceTest</a>, <span class="stringliteral">"%d %g %g %g %g %g %g %g %g %g %g %g\n"</span>,
00297                         <a class="code" href="allvars_8c.html#a51">P</a>[i].Type, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> - <a class="code" href="allvars_8c.html#a39">TimeOfLastTreeConstruction</a>,
00298                         <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[0], <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[1], <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[2],
00299                         <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o5">GravAccelDirect</a>[0], <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o5">GravAccelDirect</a>[1], <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o5">GravAccelDirect</a>[2],
00300                         <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[0], <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[1], <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[2]);
00301 <span class="preprocessor">#else</span>
00302 <span class="preprocessor"></span>                fprintf(<a class="code" href="allvars_8c.html#a45">FdForceTest</a>, <span class="stringliteral">"%d %g %g %g %g %g %g %g %g %g %g %g %g %g %g\n"</span>,
00303                         <a class="code" href="allvars_8c.html#a51">P</a>[i].Type, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> - <a class="code" href="allvars_8c.html#a39">TimeOfLastTreeConstruction</a>,
00304                         <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[0], <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[1], <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[2],
00305                         <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o5">GravAccelDirect</a>[0], <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o5">GravAccelDirect</a>[1], <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o5">GravAccelDirect</a>[2],
00306                         <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[0], <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[1], <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[2],
00307                         <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o4">GravPM</a>[0] + <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[0],
00308                         <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o4">GravPM</a>[1] + <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[1], <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o4">GravPM</a>[2] + <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[2]);
00309 <span class="preprocessor">#endif</span>
00310 <span class="preprocessor"></span>              }
00311           fclose(<a class="code" href="allvars_8c.html#a45">FdForceTest</a>);
00312         }
00313       MPI_Barrier(MPI_COMM_WORLD);
00314     }
00315 
00316   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00317     <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> &lt; 0)
00318       <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> = -<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> - 1;
00319 
00320   <span class="comment">/* Now the force computation is finished */</span>
00321 
00322 
00323 
00324   timetreelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00325   costtreelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00326 
00327   MPI_Gather(&amp;costtotal, 1, MPI_DOUBLE, costtreelist, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD);
00328   MPI_Gather(&amp;timetree, 1, MPI_DOUBLE, timetreelist, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD);
00329 
00330   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00331     {
00332       fac = <a class="code" href="allvars_8c.html#a1">NTask</a> / ((double) <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a>);
00333 
00334       <span class="keywordflow">for</span>(i = 0, maxt = timetreelist[0], sumt = 0, costtotal = 0; i &lt; NTask; i++)
00335         {
00336           costtotal += costtreelist[i];
00337 
00338           <span class="keywordflow">if</span>(maxt &lt; timetreelist[i])
00339             maxt = timetreelist[i];
00340           sumt += timetreelist[i];
00341         }
00342 
00343       fprintf(<a class="code" href="allvars_8c.html#a43">FdTimings</a>, <span class="stringliteral">"DIRECT Nf= %d    part/sec=%g | %g  ia/part=%g \n"</span>, ntot, ntot / (sumt + 1.0e-20),
00344               ntot / (maxt * <a class="code" href="allvars_8c.html#a1">NTask</a>), ((<span class="keywordtype">double</span>) (costtotal)) / ntot);
00345       fprintf(<a class="code" href="allvars_8c.html#a43">FdTimings</a>, <span class="stringliteral">"\n"</span>);
00346 
00347       fflush(<a class="code" href="allvars_8c.html#a43">FdTimings</a>);
00348     }
00349 
00350   free(costtreelist);
00351   free(timetreelist);
00352 }
00353 
00354 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 22 15:29:40 2006 for GADGET-2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
