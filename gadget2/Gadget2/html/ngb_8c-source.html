<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GADGET-2: ngb.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>ngb.c</h1><a href="ngb_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00002 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00003 <span class="preprocessor">#include &lt;string.h&gt;</span>
00004 <span class="preprocessor">#include &lt;math.h&gt;</span>
00005 <span class="preprocessor">#include &lt;time.h&gt;</span>
00006 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
00007 
00008 <span class="preprocessor">#include "<a class="code" href="allvars_8h.html">allvars.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="proto_8h.html">proto.h</a>"</span>
00010 
00011 
00019 <span class="preprocessor">#ifdef PERIODIC</span>
00020 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">double</span> boxSize, boxHalf;
00021 
00022 <span class="preprocessor">#ifdef LONG_X</span>
00023 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">double</span> boxSize_X, boxHalf_X;
00024 <span class="preprocessor">#else</span>
<a name="l00025"></a><a class="code" href="ngb_8c.html#a0">00025</a> <span class="preprocessor"></span><span class="preprocessor">#define boxSize_X boxSize</span>
<a name="l00026"></a><a class="code" href="ngb_8c.html#a1">00026</a> <span class="preprocessor"></span><span class="preprocessor">#define boxHalf_X boxHalf</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Y</span>
00029 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">double</span> boxSize_Y, boxHalf_Y;
00030 <span class="preprocessor">#else</span>
<a name="l00031"></a><a class="code" href="ngb_8c.html#a2">00031</a> <span class="preprocessor"></span><span class="preprocessor">#define boxSize_Y boxSize</span>
<a name="l00032"></a><a class="code" href="ngb_8c.html#a3">00032</a> <span class="preprocessor"></span><span class="preprocessor">#define boxHalf_Y boxHalf</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Z</span>
00035 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">double</span> boxSize_Z, boxHalf_Z;
00036 <span class="preprocessor">#else</span>
<a name="l00037"></a><a class="code" href="ngb_8c.html#a4">00037</a> <span class="preprocessor"></span><span class="preprocessor">#define boxSize_Z boxSize</span>
<a name="l00038"></a><a class="code" href="ngb_8c.html#a5">00038</a> <span class="preprocessor"></span><span class="preprocessor">#define boxHalf_Z boxHalf</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00041 <span class="preprocessor"></span>
00042 
<a name="l00047"></a><a class="code" href="ngb_8c.html#a6">00047</a> <span class="preprocessor">#define NGB_PERIODIC_X(x) (xtmp=(x),(xtmp&gt;boxHalf_X)?(xtmp-boxSize_X):((xtmp&lt;-boxHalf_X)?(xtmp+boxSize_X):xtmp))</span>
<a name="l00048"></a><a class="code" href="ngb_8c.html#a7">00048</a> <span class="preprocessor"></span><span class="preprocessor">#define NGB_PERIODIC_Y(x) (xtmp=(x),(xtmp&gt;boxHalf_Y)?(xtmp-boxSize_Y):((xtmp&lt;-boxHalf_Y)?(xtmp+boxSize_Y):xtmp))</span>
<a name="l00049"></a><a class="code" href="ngb_8c.html#a8">00049</a> <span class="preprocessor"></span><span class="preprocessor">#define NGB_PERIODIC_Z(x) (xtmp=(x),(xtmp&gt;boxHalf_Z)?(xtmp-boxSize_Z):((xtmp&lt;-boxHalf_Z)?(xtmp+boxSize_Z):xtmp))</span>
00050 <span class="preprocessor"></span>
00051 
00052 
<a name="l00064"></a><a class="code" href="proto_8h.html#a112">00064</a> <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a112">ngb_treefind_pairs</a>(FLOAT searchcenter[3], FLOAT hsml, <span class="keywordtype">int</span> *startnode)
00065 {
00066   <span class="keywordtype">int</span> k, no, p, numngb;
00067   <a class="code" href="allvars_8h.html#a35">FLOAT</a> hdiff;
00068   <a class="code" href="allvars_8h.html#a35">FLOAT</a> searchmin[3], searchmax[3];
00069   <span class="keyword">struct </span><a class="code" href="structNODE.html">NODE</a> *<span class="keyword">this</span>;
00070 
00071 <span class="preprocessor">#ifdef PERIODIC</span>
00072 <span class="preprocessor"></span>  <span class="keywordtype">double</span> xtmp;
00073 <span class="preprocessor">#endif</span>
00074 <span class="preprocessor"></span>
00075   <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)        <span class="comment">/* cube-box window */</span>
00076     {
00077       searchmin[k] = searchcenter[k] - hsml;
00078       searchmax[k] = searchcenter[k] + hsml;
00079     }
00080 
00081   numngb = 0;
00082   no = *startnode;
00083 
00084   <span class="keywordflow">while</span>(no &gt;= 0)
00085     {
00086       <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>)      <span class="comment">/* single particle */</span>
00087         {
00088           p = no;
00089           no = <a class="code" href="allvars_8c.html#a59">Nextnode</a>[no];
00090 
00091           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o9">Type</a> &gt; 0)
00092             <span class="keywordflow">continue</span>;
00093 
00094           hdiff = <a class="code" href="allvars_8c.html#a53">SphP</a>[p].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> - hsml;
00095           <span class="keywordflow">if</span>(hdiff &lt; 0)
00096             hdiff = 0;
00097 
00098 <span class="preprocessor">#ifdef PERIODIC</span>
00099 <span class="preprocessor"></span>          <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a6">NGB_PERIODIC_X</a>(<a class="code" href="allvars_8c.html#a51">P</a>[p].Pos[0] - searchcenter[0]) &lt; (-hsml - hdiff))
00100             <span class="keywordflow">continue</span>;
00101           <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a6">NGB_PERIODIC_X</a>(<a class="code" href="allvars_8c.html#a51">P</a>[p].Pos[0] - searchcenter[0]) &gt; (hsml + hdiff))
00102             <span class="keywordflow">continue</span>;
00103           <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a7">NGB_PERIODIC_Y</a>(<a class="code" href="allvars_8c.html#a51">P</a>[p].Pos[1] - searchcenter[1]) &lt; (-hsml - hdiff))
00104             <span class="keywordflow">continue</span>;
00105           <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a7">NGB_PERIODIC_Y</a>(<a class="code" href="allvars_8c.html#a51">P</a>[p].Pos[1] - searchcenter[1]) &gt; (hsml + hdiff))
00106             <span class="keywordflow">continue</span>;
00107           <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a8">NGB_PERIODIC_Z</a>(<a class="code" href="allvars_8c.html#a51">P</a>[p].Pos[2] - searchcenter[2]) &lt; (-hsml - hdiff))
00108             <span class="keywordflow">continue</span>;
00109           <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a8">NGB_PERIODIC_Z</a>(<a class="code" href="allvars_8c.html#a51">P</a>[p].Pos[2] - searchcenter[2]) &gt; (hsml + hdiff))
00110             <span class="keywordflow">continue</span>;
00111 <span class="preprocessor">#else</span>
00112 <span class="preprocessor"></span>          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o0">Pos</a>[0] &lt; (searchmin[0] - hdiff))
00113             <span class="keywordflow">continue</span>;
00114           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o0">Pos</a>[0] &gt; (searchmax[0] + hdiff))
00115             <span class="keywordflow">continue</span>;
00116           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o0">Pos</a>[1] &lt; (searchmin[1] - hdiff))
00117             <span class="keywordflow">continue</span>;
00118           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o0">Pos</a>[1] &gt; (searchmax[1] + hdiff))
00119             <span class="keywordflow">continue</span>;
00120           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o0">Pos</a>[2] &lt; (searchmin[2] - hdiff))
00121             <span class="keywordflow">continue</span>;
00122           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o0">Pos</a>[2] &gt; (searchmax[2] + hdiff))
00123             <span class="keywordflow">continue</span>;
00124 <span class="preprocessor">#endif</span>
00125 <span class="preprocessor"></span>          <a class="code" href="allvars_8c.html#a12">Ngblist</a>[numngb++] = p;
00126 
00127           <span class="keywordflow">if</span>(numngb == MAX_NGB)
00128             {
00129               printf
00130                 (<span class="stringliteral">"ThisTask=%d: Need to do a second neighbour loop in hydro-force for (%g|%g|%g) hsml=%g no=%d\n"</span>,
00131                  ThisTask, searchcenter[0], searchcenter[1], searchcenter[2], hsml, no);
00132               *startnode = no;
00133               <span class="keywordflow">return</span> numngb;
00134             }
00135         }
00136       <span class="keywordflow">else</span>
00137         {
00138           <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)      <span class="comment">/* pseudo particle */</span>
00139             {
00140               <a class="code" href="allvars_8c.html#a11">Exportflag</a>[<a class="code" href="allvars_8c.html#a28">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)]] = 1;
00141               no = <a class="code" href="allvars_8c.html#a59">Nextnode</a>[no - MaxNodes];
00142               <span class="keywordflow">continue</span>;
00143             }
00144 
00145           <span class="keyword">this</span> = &amp;<a class="code" href="allvars_8c.html#a58">Nodes</a>[no];
00146           hdiff = <a class="code" href="allvars_8c.html#a62">Extnodes</a>[no].<a class="code" href="structextNODE.html#o0">hmax</a> - hsml;
00147           <span class="keywordflow">if</span>(hdiff &lt; 0)
00148             hdiff = 0;
00149 
00150           no = this-&gt;u.d.sibling;       <span class="comment">/* in case the node can be discarded */</span>
00151 
00152 <span class="preprocessor">#ifdef PERIODIC</span>
00153 <span class="preprocessor"></span>          <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a6">NGB_PERIODIC_X</a>(this-&gt;center[0] - searchcenter[0]) + 0.5 * this-&gt;len) &lt; (-hsml - hdiff))
00154             <span class="keywordflow">continue</span>;
00155           <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a6">NGB_PERIODIC_X</a>(this-&gt;center[0] - searchcenter[0]) - 0.5 * this-&gt;len) &gt; (hsml + hdiff))
00156             <span class="keywordflow">continue</span>;
00157           <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a7">NGB_PERIODIC_Y</a>(this-&gt;center[1] - searchcenter[1]) + 0.5 * this-&gt;len) &lt; (-hsml - hdiff))
00158             <span class="keywordflow">continue</span>;
00159           <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a7">NGB_PERIODIC_Y</a>(this-&gt;center[1] - searchcenter[1]) - 0.5 * this-&gt;len) &gt; (hsml + hdiff))
00160             <span class="keywordflow">continue</span>;
00161           <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a8">NGB_PERIODIC_Z</a>(this-&gt;center[2] - searchcenter[2]) + 0.5 * this-&gt;len) &lt; (-hsml - hdiff))
00162             <span class="keywordflow">continue</span>;
00163           <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a8">NGB_PERIODIC_Z</a>(this-&gt;center[2] - searchcenter[2]) - 0.5 * this-&gt;len) &gt; (hsml + hdiff))
00164             <span class="keywordflow">continue</span>;
00165 <span class="preprocessor">#else</span>
00166 <span class="preprocessor"></span>          <span class="keywordflow">if</span>((this-&gt;center[0] + 0.5 * this-&gt;len) &lt; (searchmin[0] - hdiff))
00167             <span class="keywordflow">continue</span>;
00168           <span class="keywordflow">if</span>((this-&gt;center[0] - 0.5 * this-&gt;len) &gt; (searchmax[0] + hdiff))
00169             <span class="keywordflow">continue</span>;
00170           <span class="keywordflow">if</span>((this-&gt;center[1] + 0.5 * this-&gt;len) &lt; (searchmin[1] - hdiff))
00171             <span class="keywordflow">continue</span>;
00172           <span class="keywordflow">if</span>((this-&gt;center[1] - 0.5 * this-&gt;len) &gt; (searchmax[1] + hdiff))
00173             <span class="keywordflow">continue</span>;
00174           <span class="keywordflow">if</span>((this-&gt;center[2] + 0.5 * this-&gt;len) &lt; (searchmin[2] - hdiff))
00175             <span class="keywordflow">continue</span>;
00176           <span class="keywordflow">if</span>((this-&gt;center[2] - 0.5 * this-&gt;len) &gt; (searchmax[2] + hdiff))
00177             <span class="keywordflow">continue</span>;
00178 <span class="preprocessor">#endif</span>
00179 <span class="preprocessor"></span>          no = this-&gt;u.d.nextnode;      <span class="comment">/* ok, we need to open the node */</span>
00180         }
00181     }
00182 
00183   *startnode = -1;
00184   <span class="keywordflow">return</span> numngb;
00185 }
00186 
00187 
00188 
<a name="l00194"></a><a class="code" href="proto_8h.html#a113">00194</a> <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a113">ngb_treefind_variable</a>(FLOAT searchcenter[3], FLOAT hsml, <span class="keywordtype">int</span> *startnode)
00195 {
00196   <span class="keywordtype">int</span> k, numngb;
00197   <span class="keywordtype">int</span> no, p;
00198   <span class="keyword">struct </span><a class="code" href="structNODE.html">NODE</a> *<span class="keyword">this</span>;
00199   <a class="code" href="allvars_8h.html#a35">FLOAT</a> searchmin[3], searchmax[3];
00200 
00201 <span class="preprocessor">#ifdef PERIODIC</span>
00202 <span class="preprocessor"></span>  <span class="keywordtype">double</span> xtmp;
00203 <span class="preprocessor">#endif</span>
00204 <span class="preprocessor"></span>
00205   <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)        <span class="comment">/* cube-box window */</span>
00206     {
00207       searchmin[k] = searchcenter[k] - hsml;
00208       searchmax[k] = searchcenter[k] + hsml;
00209     }
00210 
00211   numngb = 0;
00212   no = *startnode;
00213 
00214   <span class="keywordflow">while</span>(no &gt;= 0)
00215     {
00216       <span class="keywordflow">if</span>(no &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>)      <span class="comment">/* single particle */</span>
00217         {
00218           p = no;
00219           no = <a class="code" href="allvars_8c.html#a59">Nextnode</a>[no];
00220 
00221           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o9">Type</a> &gt; 0)
00222             <span class="keywordflow">continue</span>;
00223 
00224 <span class="preprocessor">#ifdef PERIODIC</span>
00225 <span class="preprocessor"></span>          <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a6">NGB_PERIODIC_X</a>(<a class="code" href="allvars_8c.html#a51">P</a>[p].Pos[0] - searchcenter[0]) &lt; -hsml)
00226             <span class="keywordflow">continue</span>;
00227           <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a6">NGB_PERIODIC_X</a>(<a class="code" href="allvars_8c.html#a51">P</a>[p].Pos[0] - searchcenter[0]) &gt; hsml)
00228             <span class="keywordflow">continue</span>;
00229           <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a7">NGB_PERIODIC_Y</a>(<a class="code" href="allvars_8c.html#a51">P</a>[p].Pos[1] - searchcenter[1]) &lt; -hsml)
00230             <span class="keywordflow">continue</span>;
00231           <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a7">NGB_PERIODIC_Y</a>(<a class="code" href="allvars_8c.html#a51">P</a>[p].Pos[1] - searchcenter[1]) &gt; hsml)
00232             <span class="keywordflow">continue</span>;
00233           <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a8">NGB_PERIODIC_Z</a>(<a class="code" href="allvars_8c.html#a51">P</a>[p].Pos[2] - searchcenter[2]) &lt; -hsml)
00234             <span class="keywordflow">continue</span>;
00235           <span class="keywordflow">if</span>(<a class="code" href="ngb_8c.html#a8">NGB_PERIODIC_Z</a>(<a class="code" href="allvars_8c.html#a51">P</a>[p].Pos[2] - searchcenter[2]) &gt; hsml)
00236             <span class="keywordflow">continue</span>;
00237 <span class="preprocessor">#else</span>
00238 <span class="preprocessor"></span>          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o0">Pos</a>[0] &lt; searchmin[0])
00239             <span class="keywordflow">continue</span>;
00240           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o0">Pos</a>[0] &gt; searchmax[0])
00241             <span class="keywordflow">continue</span>;
00242           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o0">Pos</a>[1] &lt; searchmin[1])
00243             <span class="keywordflow">continue</span>;
00244           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o0">Pos</a>[1] &gt; searchmax[1])
00245             <span class="keywordflow">continue</span>;
00246           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o0">Pos</a>[2] &lt; searchmin[2])
00247             <span class="keywordflow">continue</span>;
00248           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o0">Pos</a>[2] &gt; searchmax[2])
00249             <span class="keywordflow">continue</span>;
00250 <span class="preprocessor">#endif</span>
00251 <span class="preprocessor"></span>          <a class="code" href="allvars_8c.html#a12">Ngblist</a>[numngb++] = p;
00252 
00253           <span class="keywordflow">if</span>(numngb == MAX_NGB)
00254             {
00255               numngb = <a class="code" href="proto_8h.html#a109">ngb_clear_buf</a>(searchcenter, hsml, numngb);
00256               <span class="keywordflow">if</span>(numngb == MAX_NGB)
00257                 {
00258                   printf(<span class="stringliteral">"ThisTask=%d: Need to do a second neighbour loop for (%g|%g|%g) hsml=%g no=%d\n"</span>,
00259                          <a class="code" href="allvars_8c.html#a0">ThisTask</a>, searchcenter[0], searchcenter[1], searchcenter[2], hsml, no);
00260                   *startnode = no;
00261                   <span class="keywordflow">return</span> numngb;
00262                 }
00263             }
00264         }
00265       <span class="keywordflow">else</span>
00266         {
00267           <span class="keywordflow">if</span>(no &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)      <span class="comment">/* pseudo particle */</span>
00268             {
00269               <a class="code" href="allvars_8c.html#a11">Exportflag</a>[<a class="code" href="allvars_8c.html#a28">DomainTask</a>[no - (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> + MaxNodes)]] = 1;
00270               no = <a class="code" href="allvars_8c.html#a59">Nextnode</a>[no - MaxNodes];
00271               <span class="keywordflow">continue</span>;
00272             }
00273 
00274           <span class="keyword">this</span> = &amp;<a class="code" href="allvars_8c.html#a58">Nodes</a>[no];
00275 
00276           no = this-&gt;u.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o6">sibling</a>;       <span class="comment">/* in case the node can be discarded */</span>
00277 <span class="preprocessor">#ifdef PERIODIC</span>
00278 <span class="preprocessor"></span>          <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a6">NGB_PERIODIC_X</a>(this-&gt;center[0] - searchcenter[0]) + 0.5 * this-&gt;len) &lt; -hsml)
00279             <span class="keywordflow">continue</span>;
00280           <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a6">NGB_PERIODIC_X</a>(this-&gt;center[0] - searchcenter[0]) - 0.5 * this-&gt;len) &gt; hsml)
00281             <span class="keywordflow">continue</span>;
00282           <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a7">NGB_PERIODIC_Y</a>(this-&gt;center[1] - searchcenter[1]) + 0.5 * this-&gt;len) &lt; -hsml)
00283             <span class="keywordflow">continue</span>;
00284           <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a7">NGB_PERIODIC_Y</a>(this-&gt;center[1] - searchcenter[1]) - 0.5 * this-&gt;len) &gt; hsml)
00285             <span class="keywordflow">continue</span>;
00286           <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a8">NGB_PERIODIC_Z</a>(this-&gt;center[2] - searchcenter[2]) + 0.5 * this-&gt;len) &lt; -hsml)
00287             <span class="keywordflow">continue</span>;
00288           <span class="keywordflow">if</span>((<a class="code" href="ngb_8c.html#a8">NGB_PERIODIC_Z</a>(this-&gt;center[2] - searchcenter[2]) - 0.5 * this-&gt;len) &gt; hsml)
00289             <span class="keywordflow">continue</span>;
00290 <span class="preprocessor">#else</span>
00291 <span class="preprocessor"></span>          <span class="keywordflow">if</span>((this-&gt;center[0] + 0.5 * this-&gt;len) &lt; (searchmin[0]))
00292             <span class="keywordflow">continue</span>;
00293           <span class="keywordflow">if</span>((this-&gt;center[0] - 0.5 * this-&gt;len) &gt; (searchmax[0]))
00294             <span class="keywordflow">continue</span>;
00295           <span class="keywordflow">if</span>((this-&gt;center[1] + 0.5 * this-&gt;len) &lt; (searchmin[1]))
00296             <span class="keywordflow">continue</span>;
00297           <span class="keywordflow">if</span>((this-&gt;center[1] - 0.5 * this-&gt;len) &gt; (searchmax[1]))
00298             <span class="keywordflow">continue</span>;
00299           <span class="keywordflow">if</span>((this-&gt;center[2] + 0.5 * this-&gt;len) &lt; (searchmin[2]))
00300             <span class="keywordflow">continue</span>;
00301           <span class="keywordflow">if</span>((this-&gt;center[2] - 0.5 * this-&gt;len) &gt; (searchmax[2]))
00302             <span class="keywordflow">continue</span>;
00303 <span class="preprocessor">#endif</span>
00304 <span class="preprocessor"></span>          no = this-&gt;u.<a class="code" href="structNODE.html#o9">d</a>.<a class="code" href="structNODE.html#o7">nextnode</a>;      <span class="comment">/* ok, we need to open the node */</span>
00305         }
00306     }
00307 
00308   *startnode = -1;
00309   <span class="keywordflow">return</span> numngb;
00310 }
00311 
00312 
00313 
00314 
<a name="l00320"></a><a class="code" href="proto_8h.html#a109">00320</a> <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a109">ngb_clear_buf</a>(FLOAT searchcenter[3], FLOAT hsml, <span class="keywordtype">int</span> numngb)
00321 {
00322   <span class="keywordtype">int</span> i, p;
00323   <a class="code" href="allvars_8h.html#a35">FLOAT</a> dx, dy, dz, r2;
00324 
00325 <span class="preprocessor">#ifdef PERIODIC</span>
00326 <span class="preprocessor"></span>  <span class="keywordtype">double</span> xtmp;
00327 <span class="preprocessor">#endif</span>
00328 <span class="preprocessor"></span>
00329   <span class="keywordflow">for</span>(i = 0; i &lt; numngb; i++)
00330     {
00331       p = <a class="code" href="allvars_8c.html#a12">Ngblist</a>[i];
00332 <span class="preprocessor">#ifdef PERIODIC</span>
00333 <span class="preprocessor"></span>      dx = <a class="code" href="ngb_8c.html#a6">NGB_PERIODIC_X</a>(<a class="code" href="allvars_8c.html#a51">P</a>[p].Pos[0] - searchcenter[0]);
00334       dy = <a class="code" href="ngb_8c.html#a7">NGB_PERIODIC_Y</a>(<a class="code" href="allvars_8c.html#a51">P</a>[p].Pos[1] - searchcenter[1]);
00335       dz = <a class="code" href="ngb_8c.html#a8">NGB_PERIODIC_Z</a>(<a class="code" href="allvars_8c.html#a51">P</a>[p].Pos[2] - searchcenter[2]);
00336 <span class="preprocessor">#else</span>
00337 <span class="preprocessor"></span>      dx = <a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o0">Pos</a>[0] - searchcenter[0];
00338       dy = <a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o0">Pos</a>[1] - searchcenter[1];
00339       dz = <a class="code" href="allvars_8c.html#a51">P</a>[p].<a class="code" href="structparticle__data.html#o0">Pos</a>[2] - searchcenter[2];
00340 <span class="preprocessor">#endif</span>
00341 <span class="preprocessor"></span>      r2 = dx * dx + dy * dy + dz * dz;
00342 
00343       <span class="keywordflow">if</span>(r2 &gt; hsml * hsml)
00344         {
00345           <a class="code" href="allvars_8c.html#a12">Ngblist</a>[i] = <a class="code" href="allvars_8c.html#a12">Ngblist</a>[numngb - 1];
00346           i--;
00347           numngb--;
00348         }
00349     }
00350 
00351   <span class="keywordflow">return</span> numngb;
00352 }
00353 
00354 
00355 
<a name="l00358"></a><a class="code" href="proto_8h.html#a110">00358</a> <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a110">ngb_treeallocate</a>(<span class="keywordtype">int</span> npart)
00359 {
00360   <span class="keywordtype">double</span> totbytes = 0;
00361   size_t bytes;
00362 
00363 <span class="preprocessor">#ifdef PERIODIC</span>
00364 <span class="preprocessor"></span>  boxSize = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
00365   boxHalf = 0.5 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
00366 <span class="preprocessor">#ifdef LONG_X</span>
00367 <span class="preprocessor"></span>  <a class="code" href="density_8c.html#a1">boxHalf_X</a> = boxHalf * LONG_X;
00368   <a class="code" href="density_8c.html#a0">boxSize_X</a> = boxSize * LONG_X;
00369 <span class="preprocessor">#endif</span>
00370 <span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Y</span>
00371 <span class="preprocessor"></span>  <a class="code" href="density_8c.html#a3">boxHalf_Y</a> = boxHalf * LONG_Y;
00372   <a class="code" href="density_8c.html#a2">boxSize_Y</a> = boxSize * LONG_Y;
00373 <span class="preprocessor">#endif</span>
00374 <span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Z</span>
00375 <span class="preprocessor"></span>  <a class="code" href="density_8c.html#a5">boxHalf_Z</a> = boxHalf * LONG_Z;
00376   <a class="code" href="density_8c.html#a4">boxSize_Z</a> = boxSize * LONG_Z;
00377 <span class="preprocessor">#endif</span>
00378 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00379 <span class="preprocessor"></span>
00380   <span class="keywordflow">if</span>(!(<a class="code" href="allvars_8c.html#a12">Ngblist</a> = malloc(bytes = npart * (<span class="keywordtype">long</span>) <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>))))
00381     {
00382       printf(<span class="stringliteral">"Failed to allocate %g MB for ngblist array\n"</span>, bytes / (1024.0 * 1024.0));
00383       <a class="code" href="proto_8h.html#a38">endrun</a>(78);
00384     }
00385   totbytes += bytes;
00386 
00387   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00388     printf(<span class="stringliteral">"allocated %g Mbyte for ngb search.\n"</span>, totbytes / (1024.0 * 1024.0));
00389 }
00390 
00391 
<a name="l00394"></a><a class="code" href="proto_8h.html#a114">00394</a> <span class="keywordtype">void</span> <a class="code" href="ngb_8c.html#a15">ngb_treefree</a>(<span class="keywordtype">void</span>)
00395 {
00396   free(<a class="code" href="allvars_8c.html#a12">Ngblist</a>);
00397 }
00398 
<a name="l00403"></a><a class="code" href="proto_8h.html#a111">00403</a> <span class="keywordtype">void</span> <a class="code" href="ngb_8c.html#a16">ngb_treebuild</a>(<span class="keywordtype">void</span>)
00404 {
00405   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00406     printf(<span class="stringliteral">"Begin Ngb-tree construction.\n"</span>);
00407 
00408   <a class="code" href="proto_8h.html#a58">force_treebuild</a>(<a class="code" href="allvars_8c.html#a4">N_gas</a>);
00409 
00410   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00411     printf(<span class="stringliteral">"Ngb-Tree contruction finished \n"</span>);
00412 }
00413 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 22 15:29:41 2006 for GADGET-2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
