<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GADGET-2: hydra.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>hydra.c</h1><a href="hydra_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00002 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00003 <span class="preprocessor">#include &lt;string.h&gt;</span>
00004 <span class="preprocessor">#include &lt;math.h&gt;</span>
00005 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
00006 <span class="preprocessor">#include &lt;gsl/gsl_math.h&gt;</span>
00007 <span class="preprocessor">#include "<a class="code" href="allvars_8h.html">allvars.h</a>"</span>
00008 <span class="preprocessor">#include "<a class="code" href="proto_8h.html">proto.h</a>"</span>
00009 
00019 <span class="keyword">static</span> <span class="keywordtype">double</span> hubble_a, atime, hubble_a2, fac_mu, fac_vsic_fix, a3inv, fac_egy;
00020 
00021 <span class="preprocessor">#ifdef PERIODIC</span>
00022 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">double</span> boxSize, boxHalf;
00023 
00024 <span class="preprocessor">#ifdef LONG_X</span>
00025 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">double</span> boxSize_X, boxHalf_X;
00026 <span class="preprocessor">#else</span>
<a name="l00027"></a><a class="code" href="hydra_8c.html#a0">00027</a> <span class="preprocessor"></span><span class="preprocessor">#define boxSize_X boxSize</span>
<a name="l00028"></a><a class="code" href="hydra_8c.html#a1">00028</a> <span class="preprocessor"></span><span class="preprocessor">#define boxHalf_X boxHalf</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Y</span>
00031 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">double</span> boxSize_Y, boxHalf_Y;
00032 <span class="preprocessor">#else</span>
<a name="l00033"></a><a class="code" href="hydra_8c.html#a2">00033</a> <span class="preprocessor"></span><span class="preprocessor">#define boxSize_Y boxSize</span>
<a name="l00034"></a><a class="code" href="hydra_8c.html#a3">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define boxHalf_Y boxHalf</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Z</span>
00037 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">double</span> boxSize_Z, boxHalf_Z;
00038 <span class="preprocessor">#else</span>
<a name="l00039"></a><a class="code" href="hydra_8c.html#a4">00039</a> <span class="preprocessor"></span><span class="preprocessor">#define boxSize_Z boxSize</span>
<a name="l00040"></a><a class="code" href="hydra_8c.html#a5">00040</a> <span class="preprocessor"></span><span class="preprocessor">#define boxHalf_Z boxHalf</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00043 <span class="preprocessor"></span>
00044 
00045 
<a name="l00050"></a><a class="code" href="proto_8h.html#a96">00050</a> <span class="keywordtype">void</span> <a class="code" href="hydra_8c.html#a15">hydro_force</a>(<span class="keywordtype">void</span>)
00051 {
00052   <span class="keywordtype">long</span> <span class="keywordtype">long</span> ntot, ntotleft;
00053   <span class="keywordtype">int</span> i, j, k, n, ngrp, maxfill, source, ndone;
00054   <span class="keywordtype">int</span> *nbuffer, *noffset, *nsend_local, *nsend, *numlist, *ndonelist;
00055   <span class="keywordtype">int</span> level, sendTask, recvTask, nexport, place;
00056   <span class="keywordtype">double</span> soundspeed_i;
00057   <span class="keywordtype">double</span> tstart, tend, sumt, sumcomm;
00058   <span class="keywordtype">double</span> timecomp = 0, timecommsumm = 0, timeimbalance = 0, sumimbalance;
00059   MPI_Status status;
00060 
00061 <span class="preprocessor">#ifdef PERIODIC</span>
00062 <span class="preprocessor"></span>  boxSize = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
00063   boxHalf = 0.5 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
00064 <span class="preprocessor">#ifdef LONG_X</span>
00065 <span class="preprocessor"></span>  <a class="code" href="density_8c.html#a1">boxHalf_X</a> = boxHalf * LONG_X;
00066   <a class="code" href="density_8c.html#a0">boxSize_X</a> = boxSize * LONG_X;
00067 <span class="preprocessor">#endif</span>
00068 <span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Y</span>
00069 <span class="preprocessor"></span>  <a class="code" href="density_8c.html#a3">boxHalf_Y</a> = boxHalf * LONG_Y;
00070   <a class="code" href="density_8c.html#a2">boxSize_Y</a> = boxSize * LONG_Y;
00071 <span class="preprocessor">#endif</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Z</span>
00073 <span class="preprocessor"></span>  <a class="code" href="density_8c.html#a5">boxHalf_Z</a> = boxHalf * LONG_Z;
00074   <a class="code" href="density_8c.html#a4">boxSize_Z</a> = boxSize * LONG_Z;
00075 <span class="preprocessor">#endif</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00077 <span class="preprocessor"></span>
00078   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00079     {
00080       <span class="comment">/* Factors for comoving integration of hydro */</span>
00081       hubble_a = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o36">Omega0</a> / (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>)
00082         + (1 - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o36">Omega0</a> - <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o37">OmegaLambda</a>) / (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>) + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o37">OmegaLambda</a>;
00083 
00084       hubble_a = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> * sqrt(hubble_a);
00085       hubble_a2 = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> * hubble_a;
00086 
00087       fac_mu = <a class="code" href="proto_8h.html#a133">pow</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>, 3 * (<a class="code" href="allvars_8h.html#a9">GAMMA</a> - 1) / 2) / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>;
00088 
00089       fac_egy = <a class="code" href="proto_8h.html#a133">pow</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>, 3 * (<a class="code" href="allvars_8h.html#a9">GAMMA</a> - 1));
00090 
00091       fac_vsic_fix = hubble_a * <a class="code" href="proto_8h.html#a133">pow</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>, 3 * <a class="code" href="allvars_8h.html#a10">GAMMA_MINUS1</a>);
00092 
00093       a3inv = 1 / (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>);
00094       atime = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>;
00095     }
00096   <span class="keywordflow">else</span>
00097     hubble_a = hubble_a2 = atime = fac_mu = fac_vsic_fix = a3inv = fac_egy = 1.0;
00098 
00099 
00100   <span class="comment">/* `NumSphUpdate' gives the number of particles on this processor that want a force update */</span>
00101   <span class="keywordflow">for</span>(n = 0, <a class="code" href="allvars_8c.html#a8">NumSphUpdate</a> = 0; n &lt; N_gas; n++)
00102     {
00103       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[n].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> == <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)
00104         <a class="code" href="allvars_8c.html#a8">NumSphUpdate</a>++;
00105     }
00106 
00107   numlist = malloc(<a class="code" href="allvars_8c.html#a1">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00108   MPI_Allgather(&amp;<a class="code" href="allvars_8c.html#a8">NumSphUpdate</a>, 1, MPI_INT, numlist, 1, MPI_INT, MPI_COMM_WORLD);
00109   <span class="keywordflow">for</span>(i = 0, ntot = 0; i &lt; NTask; i++)
00110     ntot += numlist[i];
00111   free(numlist);
00112 
00113 
00114   noffset = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);        <span class="comment">/* offsets of bunches in common list */</span>
00115   nbuffer = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00116   nsend_local = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00117   nsend = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a> * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00118   ndonelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00119 
00120 
00121   i = 0;                        <span class="comment">/* first particle for this task */</span>
00122   ntotleft = ntot;              <span class="comment">/* particles left for all tasks together */</span>
00123 
00124   <span class="keywordflow">while</span>(ntotleft &gt; 0)
00125     {
00126       <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00127         nsend_local[j] = 0;
00128 
00129       <span class="comment">/* do local particles and prepare export list */</span>
00130       tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00131       <span class="keywordflow">for</span>(nexport = 0, ndone = 0; i &lt; <a class="code" href="allvars_8c.html#a4">N_gas</a> &amp;&amp; nexport &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o12">BunchSizeHydro</a> - NTask; i++)
00132         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> == <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)
00133           {
00134             ndone++;
00135 
00136             <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00137               <a class="code" href="allvars_8c.html#a11">Exportflag</a>[j] = 0;
00138 
00139             <a class="code" href="proto_8h.html#a95">hydro_evaluate</a>(i, 0);
00140 
00141             <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00142               {
00143                 <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a11">Exportflag</a>[j])
00144                   {
00145                     <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00146                       {
00147                         <a class="code" href="allvars_8c.html#a75">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#o0">Pos</a>[k] = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[k];
00148                         <a class="code" href="allvars_8c.html#a75">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#o1">Vel</a>[k] = <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o9">VelPred</a>[k];
00149                       }
00150                     <a class="code" href="allvars_8c.html#a75">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#o2">Hsml</a> = <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
00151                     <a class="code" href="allvars_8c.html#a75">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#o3">Mass</a> = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o1">Mass</a>;
00152                     <a class="code" href="allvars_8c.html#a75">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#o7">DhsmlDensityFactor</a> = <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o13">DhsmlDensityFactor</a>;
00153                     <a class="code" href="allvars_8c.html#a75">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#o4">Density</a> = <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o1">Density</a>;
00154                     <a class="code" href="allvars_8c.html#a75">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#o5">Pressure</a> = <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o6">Pressure</a>;
00155                     <a class="code" href="allvars_8c.html#a75">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#o8">Timestep</a> = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> - <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o11">Ti_begstep</a>;
00156 
00157                     <span class="comment">/* calculation of F1 */</span>
00158                     soundspeed_i = sqrt(<a class="code" href="allvars_8h.html#a9">GAMMA</a> * <a class="code" href="allvars_8c.html#a53">SphP</a>[i].Pressure / <a class="code" href="allvars_8c.html#a53">SphP</a>[i].Density);
00159                     <a class="code" href="allvars_8c.html#a75">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#o6">F1</a> = fabs(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].DivVel) /
00160                       (fabs(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].DivVel) + <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o11">CurlVel</a> +
00161                        0.0001 * soundspeed_i / <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> / fac_mu);
00162 
00163                     <a class="code" href="allvars_8c.html#a75">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#o10">Index</a> = i;
00164                     <a class="code" href="allvars_8c.html#a75">HydroDataIn</a>[nexport].<a class="code" href="structhydrodata__in.html#o9">Task</a> = j;
00165                     nexport++;
00166                     nsend_local[j]++;
00167                   }
00168               }
00169           }
00170       tend = <a class="code" href="proto_8h.html#a145">second</a>();
00171       timecomp += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00172 
00173       qsort(<a class="code" href="allvars_8c.html#a75">HydroDataIn</a>, nexport, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structhydrodata__in.html">hydrodata_in</a>), <a class="code" href="hydra_8c.html#a17">hydro_compare_key</a>);
00174 
00175       <span class="keywordflow">for</span>(j = 1, noffset[0] = 0; j &lt; NTask; j++)
00176         noffset[j] = noffset[j - 1] + nsend_local[j - 1];
00177 
00178       tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00179 
00180       MPI_Allgather(nsend_local, <a class="code" href="allvars_8c.html#a1">NTask</a>, MPI_INT, nsend, <a class="code" href="allvars_8c.html#a1">NTask</a>, MPI_INT, MPI_COMM_WORLD);
00181 
00182       tend = <a class="code" href="proto_8h.html#a145">second</a>();
00183       timeimbalance += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00184 
00185 
00186 
00187       <span class="comment">/* now do the particles that need to be exported */</span>
00188 
00189       <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; PTask); level++)
00190         {
00191           tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00192           <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00193             nbuffer[j] = 0;
00194           <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; PTask); ngrp++)
00195             {
00196               maxfill = 0;
00197               <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00198                 {
00199                   <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00200                     <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j])
00201                       maxfill = nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00202                 }
00203               <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o12">BunchSizeHydro</a>)
00204                 <span class="keywordflow">break</span>;
00205 
00206               sendTask = ThisTask;
00207               recvTask = <a class="code" href="allvars_8c.html#a0">ThisTask</a> ^ ngrp;
00208 
00209               <span class="keywordflow">if</span>(recvTask &lt; NTask)
00210                 {
00211                   <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a0">ThisTask</a> * <a class="code" href="allvars_8c.html#a1">NTask</a> + recvTask] &gt; 0 || nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + ThisTask] &gt; 0)
00212                     {
00213                       <span class="comment">/* get the particles */</span>
00214                       MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a75">HydroDataIn</a>[noffset[recvTask]],
00215                                    nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> hydrodata_in), MPI_BYTE,
00216                                    recvTask, <a class="code" href="tags_8h.html#a12">TAG_HYDRO_A</a>,
00217                                    &amp;<a class="code" href="allvars_8c.html#a76">HydroDataGet</a>[nbuffer[<a class="code" href="allvars_8c.html#a0">ThisTask</a>]],
00218                                    nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + <a class="code" href="allvars_8c.html#a0">ThisTask</a>] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> hydrodata_in), MPI_BYTE,
00219                                    recvTask, <a class="code" href="tags_8h.html#a12">TAG_HYDRO_A</a>, MPI_COMM_WORLD, &amp;status);
00220                     }
00221                 }
00222 
00223               <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00224                 <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00225                   nbuffer[j] += nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00226             }
00227           tend = <a class="code" href="proto_8h.html#a145">second</a>();
00228           timecommsumm += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00229 
00230           <span class="comment">/* now do the imported particles */</span>
00231           tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00232           <span class="keywordflow">for</span>(j = 0; j &lt; nbuffer[ThisTask]; j++)
00233             <a class="code" href="proto_8h.html#a95">hydro_evaluate</a>(j, 1);
00234           tend = <a class="code" href="proto_8h.html#a145">second</a>();
00235           timecomp += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00236 
00237           <span class="comment">/* do a block to measure imbalance */</span>
00238           tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00239           MPI_Barrier(MPI_COMM_WORLD);
00240           tend = <a class="code" href="proto_8h.html#a145">second</a>();
00241           timeimbalance += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00242 
00243           <span class="comment">/* get the result */</span>
00244           tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00245           <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00246             nbuffer[j] = 0;
00247           <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; PTask); ngrp++)
00248             {
00249               maxfill = 0;
00250               <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00251                 {
00252                   <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00253                     <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j])
00254                       maxfill = nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00255                 }
00256               <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o12">BunchSizeHydro</a>)
00257                 <span class="keywordflow">break</span>;
00258 
00259               sendTask = ThisTask;
00260               recvTask = <a class="code" href="allvars_8c.html#a0">ThisTask</a> ^ ngrp;
00261 
00262               <span class="keywordflow">if</span>(recvTask &lt; NTask)
00263                 {
00264                   <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a0">ThisTask</a> * <a class="code" href="allvars_8c.html#a1">NTask</a> + recvTask] &gt; 0 || nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + ThisTask] &gt; 0)
00265                     {
00266                       <span class="comment">/* send the results */</span>
00267                       MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a77">HydroDataResult</a>[nbuffer[<a class="code" href="allvars_8c.html#a0">ThisTask</a>]],
00268                                    nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + <a class="code" href="allvars_8c.html#a0">ThisTask</a>] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structhydrodata__out.html">hydrodata_out</a>),
00269                                    MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a13">TAG_HYDRO_B</a>,
00270                                    &amp;<a class="code" href="allvars_8c.html#a78">HydroDataPartialResult</a>[noffset[recvTask]],
00271                                    nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> hydrodata_out),
00272                                    MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a13">TAG_HYDRO_B</a>, MPI_COMM_WORLD, &amp;status);
00273 
00274                       <span class="comment">/* add the result to the particles */</span>
00275                       <span class="keywordflow">for</span>(j = 0; j &lt; nsend_local[recvTask]; j++)
00276                         {
00277                           source = j + noffset[recvTask];
00278                           place = <a class="code" href="allvars_8c.html#a75">HydroDataIn</a>[source].<a class="code" href="structhydrodata__in.html#o10">Index</a>;
00279 
00280                           <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00281                             <a class="code" href="allvars_8c.html#a53">SphP</a>[place].<a class="code" href="structsph__particle__data.html#o8">HydroAccel</a>[k] += <a class="code" href="allvars_8c.html#a78">HydroDataPartialResult</a>[source].<a class="code" href="structhydrodata__out.html#o0">Acc</a>[k];
00282 
00283                           <a class="code" href="allvars_8c.html#a53">SphP</a>[place].<a class="code" href="structsph__particle__data.html#o7">DtEntropy</a> += <a class="code" href="allvars_8c.html#a78">HydroDataPartialResult</a>[source].<a class="code" href="structhydrodata__out.html#o1">DtEntropy</a>;
00284 
00285                           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a53">SphP</a>[place].<a class="code" href="structsph__particle__data.html#o14">MaxSignalVel</a> &lt; <a class="code" href="allvars_8c.html#a78">HydroDataPartialResult</a>[source].<a class="code" href="structhydrodata__out.html#o2">MaxSignalVel</a>)
00286                             <a class="code" href="allvars_8c.html#a53">SphP</a>[place].<a class="code" href="structsph__particle__data.html#o14">MaxSignalVel</a> = <a class="code" href="allvars_8c.html#a78">HydroDataPartialResult</a>[source].<a class="code" href="structhydrodata__out.html#o2">MaxSignalVel</a>;
00287                         }
00288                     }
00289                 }
00290 
00291               <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00292                 <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00293                   nbuffer[j] += nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00294             }
00295           tend = <a class="code" href="proto_8h.html#a145">second</a>();
00296           timecommsumm += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00297 
00298           level = ngrp - 1;
00299         }
00300 
00301       MPI_Allgather(&amp;ndone, 1, MPI_INT, ndonelist, 1, MPI_INT, MPI_COMM_WORLD);
00302       <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00303         ntotleft -= ndonelist[j];
00304     }
00305 
00306   free(ndonelist);
00307   free(nsend);
00308   free(nsend_local);
00309   free(nbuffer);
00310   free(noffset);
00311 
00312 
00313 
00314   <span class="comment">/* do final operations on results */</span>
00315   tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00316 
00317   <span class="keywordflow">for</span>(i = 0; i &lt; N_gas; i++)
00318     <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> == <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)
00319       {
00320         <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o7">DtEntropy</a> *= <a class="code" href="allvars_8h.html#a10">GAMMA_MINUS1</a> / (hubble_a2 * <a class="code" href="proto_8h.html#a133">pow</a>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].Density, <a class="code" href="allvars_8h.html#a10">GAMMA_MINUS1</a>));
00321 <span class="preprocessor">#ifdef SPH_BND_PARTICLES</span>
00322 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o8">ID</a> == 0)
00323           {
00324             <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o7">DtEntropy</a> = 0;
00325             <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00326               <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o8">HydroAccel</a>[k] = 0;
00327           }
00328 <span class="preprocessor">#endif</span>
00329 <span class="preprocessor"></span>      }
00330 
00331   tend = <a class="code" href="proto_8h.html#a145">second</a>();
00332   timecomp += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00333 
00334   <span class="comment">/* collect some timing information */</span>
00335 
00336   MPI_Reduce(&amp;timecomp, &amp;sumt, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
00337   MPI_Reduce(&amp;timecommsumm, &amp;sumcomm, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
00338   MPI_Reduce(&amp;timeimbalance, &amp;sumimbalance, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
00339 
00340   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00341     {
00342       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o80">CPU_HydCompWalk</a> += sumt / NTask;
00343       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o81">CPU_HydCommSumm</a> += sumcomm / NTask;
00344       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o82">CPU_HydImbalance</a> += sumimbalance / NTask;
00345     }
00346 }
00347 
00348 
<a name="l00353"></a><a class="code" href="proto_8h.html#a95">00353</a> <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a95">hydro_evaluate</a>(<span class="keywordtype">int</span> target, <span class="keywordtype">int</span> mode)
00354 {
00355   <span class="keywordtype">int</span> j, k, n, timestep, startnode, numngb;
00356   <a class="code" href="allvars_8h.html#a35">FLOAT</a> *pos, *vel;
00357   <a class="code" href="allvars_8h.html#a35">FLOAT</a> mass, h_i, dhsmlDensityFactor, rho, pressure, f1, f2;
00358   <span class="keywordtype">double</span> acc[3], dtEntropy, maxSignalVel;
00359   <span class="keywordtype">double</span> dx, dy, dz, dvx, dvy, dvz;
00360   <span class="keywordtype">double</span> h_i2, hinv, hinv4;
00361   <span class="keywordtype">double</span> p_over_rho2_i, p_over_rho2_j, soundspeed_i, soundspeed_j;
00362   <span class="keywordtype">double</span> hfc, dwk_i, vdotr, vdotr2, visc, mu_ij, rho_ij, vsig;
00363   <span class="keywordtype">double</span> h_j, dwk_j, r, r2, u, hfc_visc;
00364 
00365 <span class="preprocessor">#ifndef NOVISCOSITYLIMITER</span>
00366 <span class="preprocessor"></span>  <span class="keywordtype">double</span> dt;
00367 <span class="preprocessor">#endif</span>
00368 <span class="preprocessor"></span>
00369   <span class="keywordflow">if</span>(mode == 0)
00370     {
00371       pos = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o0">Pos</a>;
00372       vel = <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o9">VelPred</a>;
00373       h_i = <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
00374       mass = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o1">Mass</a>;
00375       dhsmlDensityFactor = <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o13">DhsmlDensityFactor</a>;
00376       rho = <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o1">Density</a>;
00377       pressure = <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o6">Pressure</a>;
00378       timestep = <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> - <a class="code" href="allvars_8c.html#a51">P</a>[target].<a class="code" href="structparticle__data.html#o11">Ti_begstep</a>;
00379       soundspeed_i = sqrt(<a class="code" href="allvars_8h.html#a9">GAMMA</a> * pressure / rho);
00380       f1 = fabs(<a class="code" href="allvars_8c.html#a53">SphP</a>[target].DivVel) /
00381         (fabs(<a class="code" href="allvars_8c.html#a53">SphP</a>[target].DivVel) + <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o11">CurlVel</a> +
00382          0.0001 * soundspeed_i / <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> / fac_mu);
00383     }
00384   <span class="keywordflow">else</span>
00385     {
00386       pos = <a class="code" href="allvars_8c.html#a76">HydroDataGet</a>[target].<a class="code" href="structhydrodata__in.html#o0">Pos</a>;
00387       vel = <a class="code" href="allvars_8c.html#a76">HydroDataGet</a>[target].<a class="code" href="structhydrodata__in.html#o1">Vel</a>;
00388       h_i = <a class="code" href="allvars_8c.html#a76">HydroDataGet</a>[target].<a class="code" href="structhydrodata__in.html#o2">Hsml</a>;
00389       mass = <a class="code" href="allvars_8c.html#a76">HydroDataGet</a>[target].<a class="code" href="structhydrodata__in.html#o3">Mass</a>;
00390       dhsmlDensityFactor = <a class="code" href="allvars_8c.html#a76">HydroDataGet</a>[target].<a class="code" href="structhydrodata__in.html#o7">DhsmlDensityFactor</a>;
00391       rho = <a class="code" href="allvars_8c.html#a76">HydroDataGet</a>[target].<a class="code" href="structhydrodata__in.html#o4">Density</a>;
00392       pressure = <a class="code" href="allvars_8c.html#a76">HydroDataGet</a>[target].<a class="code" href="structhydrodata__in.html#o5">Pressure</a>;
00393       timestep = <a class="code" href="allvars_8c.html#a76">HydroDataGet</a>[target].<a class="code" href="structhydrodata__in.html#o8">Timestep</a>;
00394       soundspeed_i = sqrt(<a class="code" href="allvars_8h.html#a9">GAMMA</a> * pressure / rho);
00395       f1 = <a class="code" href="allvars_8c.html#a76">HydroDataGet</a>[target].<a class="code" href="structhydrodata__in.html#o6">F1</a>;
00396     }
00397 
00398 
00399   <span class="comment">/* initialize variables before SPH loop is started */</span>
00400   acc[0] = acc[1] = acc[2] = dtEntropy = 0;
00401   maxSignalVel = 0;
00402 
00403   p_over_rho2_i = pressure / (rho * rho) * dhsmlDensityFactor;
00404   h_i2 = h_i * h_i;
00405 
00406   <span class="comment">/* Now start the actual SPH computation for this particle */</span>
00407   startnode = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>;
00408   <span class="keywordflow">do</span>
00409     {
00410       numngb = <a class="code" href="proto_8h.html#a112">ngb_treefind_pairs</a>(&amp;pos[0], h_i, &amp;startnode);
00411 
00412       <span class="keywordflow">for</span>(n = 0; n &lt; numngb; n++)
00413         {
00414           j = <a class="code" href="allvars_8c.html#a12">Ngblist</a>[n];
00415 
00416           dx = pos[0] - <a class="code" href="allvars_8c.html#a51">P</a>[j].<a class="code" href="structparticle__data.html#o0">Pos</a>[0];
00417           dy = pos[1] - <a class="code" href="allvars_8c.html#a51">P</a>[j].<a class="code" href="structparticle__data.html#o0">Pos</a>[1];
00418           dz = pos[2] - <a class="code" href="allvars_8c.html#a51">P</a>[j].<a class="code" href="structparticle__data.html#o0">Pos</a>[2];
00419 
00420 <span class="preprocessor">#ifdef PERIODIC                 </span><span class="comment">/*  find the closest image in the given box size  */</span>
00421           <span class="keywordflow">if</span>(dx &gt; boxHalf_X)
00422             dx -= boxSize_X;
00423           <span class="keywordflow">if</span>(dx &lt; -boxHalf_X)
00424             dx += boxSize_X;
00425           <span class="keywordflow">if</span>(dy &gt; boxHalf_Y)
00426             dy -= boxSize_Y;
00427           <span class="keywordflow">if</span>(dy &lt; -boxHalf_Y)
00428             dy += boxSize_Y;
00429           <span class="keywordflow">if</span>(dz &gt; boxHalf_Z)
00430             dz -= boxSize_Z;
00431           <span class="keywordflow">if</span>(dz &lt; -boxHalf_Z)
00432             dz += boxSize_Z;
00433 <span class="preprocessor">#endif</span>
00434 <span class="preprocessor"></span>          r2 = dx * dx + dy * dy + dz * dz;
00435           h_j = <a class="code" href="allvars_8c.html#a53">SphP</a>[j].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
00436           <span class="keywordflow">if</span>(r2 &lt; h_i2 || r2 &lt; h_j * h_j)
00437             {
00438               r = sqrt(r2);
00439               <span class="keywordflow">if</span>(r &gt; 0)
00440                 {
00441                   p_over_rho2_j = <a class="code" href="allvars_8c.html#a53">SphP</a>[j].<a class="code" href="structsph__particle__data.html#o6">Pressure</a> / (<a class="code" href="allvars_8c.html#a53">SphP</a>[j].<a class="code" href="structsph__particle__data.html#o1">Density</a> * <a class="code" href="allvars_8c.html#a53">SphP</a>[j].<a class="code" href="structsph__particle__data.html#o1">Density</a>);
00442                   soundspeed_j = sqrt(<a class="code" href="allvars_8h.html#a9">GAMMA</a> * p_over_rho2_j * <a class="code" href="allvars_8c.html#a53">SphP</a>[j].Density);
00443                   dvx = vel[0] - <a class="code" href="allvars_8c.html#a53">SphP</a>[j].<a class="code" href="structsph__particle__data.html#o9">VelPred</a>[0];
00444                   dvy = vel[1] - <a class="code" href="allvars_8c.html#a53">SphP</a>[j].<a class="code" href="structsph__particle__data.html#o9">VelPred</a>[1];
00445                   dvz = vel[2] - <a class="code" href="allvars_8c.html#a53">SphP</a>[j].<a class="code" href="structsph__particle__data.html#o9">VelPred</a>[2];
00446                   vdotr = dx * dvx + dy * dvy + dz * dvz;
00447 
00448                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00449                     vdotr2 = vdotr + hubble_a2 * r2;
00450                   <span class="keywordflow">else</span>
00451                     vdotr2 = vdotr;
00452 
00453                   <span class="keywordflow">if</span>(r2 &lt; h_i2)
00454                     {
00455                       hinv = 1.0 / h_i;
00456 <span class="preprocessor">#ifndef  TWODIMS</span>
00457 <span class="preprocessor"></span>                      hinv4 = hinv * hinv * hinv * hinv;
00458 <span class="preprocessor">#else</span>
00459 <span class="preprocessor"></span>                      hinv4 = hinv * hinv * hinv / boxSize_Z;
00460 <span class="preprocessor">#endif</span>
00461 <span class="preprocessor"></span>                      u = r * hinv;
00462                       <span class="keywordflow">if</span>(u &lt; 0.5)
00463                         dwk_i = hinv4 * u * (<a class="code" href="allvars_8h.html#a39">KERNEL_COEFF_3</a> * u - KERNEL_COEFF_4);
00464                       <span class="keywordflow">else</span>
00465                         dwk_i = hinv4 * <a class="code" href="allvars_8h.html#a42">KERNEL_COEFF_6</a> * (1.0 - u) * (1.0 - u);
00466                     }
00467                   <span class="keywordflow">else</span>
00468                     {
00469                       dwk_i = 0;
00470                     }
00471 
00472                   <span class="keywordflow">if</span>(r2 &lt; h_j * h_j)
00473                     {
00474                       hinv = 1.0 / h_j;
00475 <span class="preprocessor">#ifndef  TWODIMS</span>
00476 <span class="preprocessor"></span>                      hinv4 = hinv * hinv * hinv * hinv;
00477 <span class="preprocessor">#else</span>
00478 <span class="preprocessor"></span>                      hinv4 = hinv * hinv * hinv / boxSize_Z;
00479 <span class="preprocessor">#endif</span>
00480 <span class="preprocessor"></span>                      u = r * hinv;
00481                       <span class="keywordflow">if</span>(u &lt; 0.5)
00482                         dwk_j = hinv4 * u * (<a class="code" href="allvars_8h.html#a39">KERNEL_COEFF_3</a> * u - KERNEL_COEFF_4);
00483                       <span class="keywordflow">else</span>
00484                         dwk_j = hinv4 * <a class="code" href="allvars_8h.html#a42">KERNEL_COEFF_6</a> * (1.0 - u) * (1.0 - u);
00485                     }
00486                   <span class="keywordflow">else</span>
00487                     {
00488                       dwk_j = 0;
00489                     }
00490 
00491                   <span class="keywordflow">if</span>(soundspeed_i + soundspeed_j &gt; maxSignalVel)
00492                     maxSignalVel = soundspeed_i + soundspeed_j;
00493 
00494                   <span class="keywordflow">if</span>(vdotr2 &lt; 0)        <span class="comment">/* ... artificial viscosity */</span>
00495                     {
00496                       mu_ij = fac_mu * vdotr2 / r;      <span class="comment">/* note: this is negative! */</span>
00497 
00498                       vsig = soundspeed_i + soundspeed_j - 3 * mu_ij;
00499 
00500                       <span class="keywordflow">if</span>(vsig &gt; maxSignalVel)
00501                         maxSignalVel = vsig;
00502 
00503                       rho_ij = 0.5 * (rho + <a class="code" href="allvars_8c.html#a53">SphP</a>[j].<a class="code" href="structsph__particle__data.html#o1">Density</a>);
00504                       f2 =
00505                         fabs(<a class="code" href="allvars_8c.html#a53">SphP</a>[j].DivVel) / (fabs(<a class="code" href="allvars_8c.html#a53">SphP</a>[j].DivVel) + <a class="code" href="allvars_8c.html#a53">SphP</a>[j].<a class="code" href="structsph__particle__data.html#o11">CurlVel</a> +
00506                                                 0.0001 * soundspeed_j / fac_mu / <a class="code" href="allvars_8c.html#a53">SphP</a>[j].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>);
00507 
00508                       visc = 0.25 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o18">ArtBulkViscConst</a> * vsig * (-mu_ij) / rho_ij * (f1 + f2);
00509 
00510                       <span class="comment">/* .... end artificial viscosity evaluation */</span>
00511 <span class="preprocessor">#ifndef NOVISCOSITYLIMITER</span>
00512 <span class="preprocessor"></span>                      <span class="comment">/* make sure that viscous acceleration is not too large */</span>
00513                       dt = <a class="code" href="system_8c.html#a6">imax</a>(timestep, (<a class="code" href="allvars_8c.html#a51">P</a>[j].Ti_endstep - <a class="code" href="allvars_8c.html#a51">P</a>[j].Ti_begstep)) * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00514                       <span class="keywordflow">if</span>(dt &gt; 0 &amp;&amp; (dwk_i + dwk_j) &lt; 0)
00515                         {
00516                           visc = <a class="code" href="system_8c.html#a5">dmin</a>(visc, 0.5 * fac_vsic_fix * vdotr2 /
00517                                       (0.5 * (mass + <a class="code" href="allvars_8c.html#a51">P</a>[j].Mass) * (dwk_i + dwk_j) * r * dt));
00518                         }
00519 <span class="preprocessor">#endif</span>
00520 <span class="preprocessor"></span>                    }
00521                   <span class="keywordflow">else</span>
00522                     visc = 0;
00523 
00524                   p_over_rho2_j *= <a class="code" href="allvars_8c.html#a53">SphP</a>[j].<a class="code" href="structsph__particle__data.html#o13">DhsmlDensityFactor</a>;
00525 
00526                   hfc_visc = 0.5 * <a class="code" href="allvars_8c.html#a51">P</a>[j].<a class="code" href="structparticle__data.html#o1">Mass</a> * visc * (dwk_i + dwk_j) / r;
00527 
00528                   hfc = hfc_visc + <a class="code" href="allvars_8c.html#a51">P</a>[j].<a class="code" href="structparticle__data.html#o1">Mass</a> * (p_over_rho2_i * dwk_i + p_over_rho2_j * dwk_j) / r;
00529 
00530                   acc[0] -= hfc * dx;
00531                   acc[1] -= hfc * dy;
00532                   acc[2] -= hfc * dz;
00533                   dtEntropy += 0.5 * hfc_visc * vdotr2;
00534                 }
00535             }
00536         }
00537     }
00538   <span class="keywordflow">while</span>(startnode &gt;= 0);
00539 
00540   <span class="comment">/* Now collect the result at the right place */</span>
00541   <span class="keywordflow">if</span>(mode == 0)
00542     {
00543       <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00544         <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o8">HydroAccel</a>[k] = acc[k];
00545       <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o7">DtEntropy</a> = dtEntropy;
00546       <a class="code" href="allvars_8c.html#a53">SphP</a>[target].<a class="code" href="structsph__particle__data.html#o14">MaxSignalVel</a> = maxSignalVel;
00547     }
00548   <span class="keywordflow">else</span>
00549     {
00550       <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00551         <a class="code" href="allvars_8c.html#a77">HydroDataResult</a>[target].<a class="code" href="structhydrodata__out.html#o0">Acc</a>[k] = acc[k];
00552       <a class="code" href="allvars_8c.html#a77">HydroDataResult</a>[target].<a class="code" href="structhydrodata__out.html#o1">DtEntropy</a> = dtEntropy;
00553       <a class="code" href="allvars_8c.html#a77">HydroDataResult</a>[target].<a class="code" href="structhydrodata__out.html#o2">MaxSignalVel</a> = maxSignalVel;
00554     }
00555 }
00556 
00557 
00558 
00559 
<a name="l00563"></a><a class="code" href="proto_8h.html#a94">00563</a> <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a94">hydro_compare_key</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *a, <span class="keyword">const</span> <span class="keywordtype">void</span> *b)
00564 {
00565   <span class="keywordflow">if</span>(((<span class="keyword">struct </span><a class="code" href="structhydrodata__in.html">hydrodata_in</a> *) a)-&gt;Task &lt; (((<span class="keyword">struct </span><a class="code" href="structhydrodata__in.html">hydrodata_in</a> *) b)-&gt;Task))
00566     <span class="keywordflow">return</span> -1;
00567   <span class="keywordflow">if</span>(((<span class="keyword">struct </span><a class="code" href="structhydrodata__in.html">hydrodata_in</a> *) a)-&gt;Task &gt; (((<span class="keyword">struct </span><a class="code" href="structhydrodata__in.html">hydrodata_in</a> *) b)-&gt;Task))
00568     <span class="keywordflow">return</span> +1;
00569   <span class="keywordflow">return</span> 0;
00570 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 22 15:29:40 2006 for GADGET-2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
