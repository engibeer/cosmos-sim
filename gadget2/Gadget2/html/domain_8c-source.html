<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GADGET-2: domain.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>domain.c</h1><a href="domain_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00002 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00003 <span class="preprocessor">#include &lt;string.h&gt;</span>
00004 <span class="preprocessor">#include &lt;math.h&gt;</span>
00005 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
00006 
00007 <span class="preprocessor">#include "<a class="code" href="allvars_8h.html">allvars.h</a>"</span>
00008 <span class="preprocessor">#include "<a class="code" href="proto_8h.html">proto.h</a>"</span>
00009 
00010 
00011 
<a name="l00029"></a><a class="code" href="domain_8c.html#a0">00029</a> <span class="preprocessor">#define TOPNODEFACTOR  20.0</span>
00030 <span class="preprocessor"></span>
<a name="l00031"></a><a class="code" href="domain_8c.html#a1">00031</a> <span class="preprocessor">#define REDUC_FAC      0.98</span>
00032 <span class="preprocessor"></span>
00033 
00037 <span class="keyword">static</span> <span class="keywordtype">int</span> *toGo, *toGoSph;
00038 <span class="keyword">static</span> <span class="keywordtype">int</span> *local_toGo, *local_toGoSph;
00039 <span class="keyword">static</span> <span class="keywordtype">int</span> *list_NumPart;
00040 <span class="keyword">static</span> <span class="keywordtype">int</span> *list_N_gas;
00041 <span class="keyword">static</span> <span class="keywordtype">int</span> *list_load;
00042 <span class="keyword">static</span> <span class="keywordtype">int</span> *list_loadsph;
00043 <span class="keyword">static</span> <span class="keywordtype">double</span> *list_work;
00044 
00045 <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> maxload, maxloadsph;
00046 
00047 <span class="keyword">static</span> <span class="keyword">struct </span>topnode_exchange
00048 {
00049   <a class="code" href="allvars_8h.html#a45">peanokey</a> Startkey;
00050   <span class="keywordtype">int</span> Count;
00051 }
00052  *toplist, *toplist_local;
00053 
00054 
00055 
<a name="l00062"></a><a class="code" href="proto_8h.html#a21">00062</a> <span class="keywordtype">void</span> <a class="code" href="domain_8c.html#a15">domain_Decomposition</a>(<span class="keywordtype">void</span>)
00063 {
00064   <span class="keywordtype">double</span> t0, t1;
00065 
00066 <span class="preprocessor">#ifdef PMGRID</span>
00067 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a> == <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)
00068     {
00069       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o23">NumForcesSinceLastDomainDecomp</a> = 1 + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o96">TreeDomainUpdateFrequency</a>;
00070       <span class="comment">/* to make sure that we do a domain decomposition before the PM-force is evaluated.</span>
00071 <span class="comment">         this is needed to make sure that the particles are wrapped into the box */</span>
00072     }
00073 <span class="preprocessor">#endif</span>
00074 <span class="preprocessor"></span>
00075   <span class="comment">/* Check whether it is really time for a new domain decomposition */</span>
00076   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o23">NumForcesSinceLastDomainDecomp</a> &gt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o96">TreeDomainUpdateFrequency</a>)
00077     {
00078       t0 = <a class="code" href="proto_8h.html#a145">second</a>();
00079 
00080 <span class="preprocessor">#ifdef PERIODIC</span>
00081 <span class="preprocessor"></span>      <a class="code" href="predict_8c.html#a1">do_box_wrapping</a>();        <span class="comment">/* map the particles back onto the box */</span>
00082 <span class="preprocessor">#endif</span>
00083 <span class="preprocessor"></span>      <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o23">NumForcesSinceLastDomainDecomp</a> = 0;
00084       <a class="code" href="allvars_8c.html#a13">TreeReconstructFlag</a> = 1;  <span class="comment">/* ensures that new tree will be constructed */</span>
00085 
00086       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00087         {
00088           printf(<span class="stringliteral">"domain decomposition... \n"</span>);
00089           fflush(stdout);
00090         }
00091 
00092       <a class="code" href="allvars_8c.html#a34">Key</a> = malloc(<span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a45">peanokey</a>) * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>);
00093       <a class="code" href="allvars_8c.html#a35">KeySorted</a> = malloc(<span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a45">peanokey</a>) * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>);
00094 
00095       toGo = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a> * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00096       toGoSph = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a> * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00097       local_toGo = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00098       local_toGoSph = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00099       list_NumPart = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00100       list_N_gas = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00101       list_load = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00102       list_loadsph = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00103       list_work = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00104 
00105       MPI_Allgather(&amp;<a class="code" href="allvars_8c.html#a3">NumPart</a>, 1, MPI_INT, list_NumPart, 1, MPI_INT, MPI_COMM_WORLD);
00106       MPI_Allgather(&amp;<a class="code" href="allvars_8c.html#a4">N_gas</a>, 1, MPI_INT, list_N_gas, 1, MPI_INT, MPI_COMM_WORLD);
00107 
00108       maxload = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> * REDUC_FAC;
00109       maxloadsph = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o3">MaxPartSph</a> * REDUC_FAC;
00110 
00111       <a class="code" href="domain_8c.html#a16">domain_decompose</a>();
00112 
00113       free(list_work);
00114       free(list_loadsph);
00115       free(list_load);
00116       free(list_N_gas);
00117       free(list_NumPart);
00118       free(local_toGoSph);
00119       free(local_toGo);
00120       free(toGoSph);
00121       free(toGo);
00122 
00123 
00124       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00125         {
00126           printf(<span class="stringliteral">"domain decomposition done. \n"</span>);
00127           fflush(stdout);
00128         }
00129 
00130       t1 = <a class="code" href="proto_8h.html#a145">second</a>();
00131       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o75">CPU_Domain</a> += <a class="code" href="system_8c.html#a3">timediff</a>(t0, t1);
00132 
00133 <span class="preprocessor">#ifdef PEANOHILBERT</span>
00134 <span class="preprocessor"></span>      t0 = <a class="code" href="proto_8h.html#a145">second</a>();
00135       <a class="code" href="peano_8c.html#a12">peano_hilbert_order</a>();
00136       t1 = <a class="code" href="proto_8h.html#a145">second</a>();
00137       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o88">CPU_Peano</a> += <a class="code" href="system_8c.html#a3">timediff</a>(t0, t1);
00138 <span class="preprocessor">#endif</span>
00139 <span class="preprocessor"></span>
00140       free(<a class="code" href="allvars_8c.html#a35">KeySorted</a>);
00141       free(<a class="code" href="allvars_8c.html#a34">Key</a>);
00142     }
00143 
00144 }
00145 
00146 
00147 
<a name="l00154"></a><a class="code" href="proto_8h.html#a25">00154</a> <span class="keywordtype">void</span> <a class="code" href="domain_8c.html#a16">domain_decompose</a>(<span class="keywordtype">void</span>)
00155 {
00156   <span class="keywordtype">int</span> i, j, status;
00157   <span class="keywordtype">int</span> ngrp, task, partner, sendcount, recvcount;
00158   <span class="keywordtype">long</span> <span class="keywordtype">long</span> sumtogo, sumload;
00159   <span class="keywordtype">int</span> maxload, *temp;
00160   <span class="keywordtype">double</span> sumwork, maxwork;
00161 
00162   <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
00163     <a class="code" href="allvars_8c.html#a6">NtypeLocal</a>[i] = 0;
00164 
00165   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00166     <a class="code" href="allvars_8c.html#a6">NtypeLocal</a>[<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a>]++;
00167 
00168   <span class="comment">/* because Ntype[] is of type `long long', we cannot do a simple</span>
00169 <span class="comment">   * MPI_Allreduce() to sum the total particle numbers </span>
00170 <span class="comment">   */</span>
00171   temp = malloc(<a class="code" href="allvars_8c.html#a1">NTask</a> * 6 * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00172   MPI_Allgather(<a class="code" href="allvars_8c.html#a6">NtypeLocal</a>, 6, MPI_INT, temp, 6, MPI_INT, MPI_COMM_WORLD);
00173   <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
00174     {
00175       <a class="code" href="allvars_8c.html#a5">Ntype</a>[i] = 0;
00176       <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00177         <a class="code" href="allvars_8c.html#a5">Ntype</a>[i] += temp[j * 6 + i];
00178     }
00179   free(temp);
00180 
00181 <span class="preprocessor">#ifndef UNEQUALSOFTENINGS</span>
00182 <span class="preprocessor"></span>  <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
00183     <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a5">Ntype</a>[i] &gt; 0)
00184       <span class="keywordflow">break</span>;
00185 
00186   <span class="keywordflow">for</span>(ngrp = i + 1; ngrp &lt; 6; ngrp++)
00187     {
00188       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a5">Ntype</a>[ngrp] &gt; 0)
00189         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[ngrp] != <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[i])
00190           {
00191             <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00192               {
00193                 fprintf(stdout, <span class="stringliteral">"Code was not compiled with UNEQUALSOFTENINGS, but some of the\n"</span>);
00194                 fprintf(stdout, <span class="stringliteral">"softening lengths are unequal nevertheless.\n"</span>);
00195                 fprintf(stdout, <span class="stringliteral">"This is not allowed.\n"</span>);
00196               }
00197             <a class="code" href="proto_8h.html#a38">endrun</a>(0);
00198           }
00199     }
00200 <span class="preprocessor">#endif</span>
00201 <span class="preprocessor"></span>
00202 
00203   <span class="comment">/* determine global dimensions of domain grid */</span>
00204   <a class="code" href="domain_8c.html#a24">domain_findExtent</a>();
00205 
00206   <a class="code" href="domain_8c.html#a25">domain_determineTopTree</a>();
00207 
00208   <span class="comment">/* determine cost distribution in domain grid */</span>
00209   <a class="code" href="domain_8c.html#a23">domain_sumCost</a>();
00210 
00211   <span class="comment">/* find the split of the domain grid recursively */</span>
00212   status = <a class="code" href="proto_8h.html#a30">domain_findSplit</a>(0, <a class="code" href="allvars_8c.html#a1">NTask</a>, 0, <a class="code" href="allvars_8c.html#a37">NTopleaves</a> - 1);
00213   <span class="keywordflow">if</span>(status != 0)
00214     {
00215       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00216         printf(<span class="stringliteral">"\nNo domain decomposition that stays within memory bounds is possible.\n"</span>);
00217       <a class="code" href="proto_8h.html#a38">endrun</a>(0);
00218     }
00219 
00220   <span class="comment">/* now try to improve the work-load balance of the split */</span>
00221   <a class="code" href="domain_8c.html#a18">domain_shiftSplit</a>();
00222 
00223   <a class="code" href="allvars_8c.html#a21">DomainMyStart</a> = <a class="code" href="allvars_8c.html#a23">DomainStartList</a>[ThisTask];
00224   <a class="code" href="allvars_8c.html#a22">DomainMyLast</a> = <a class="code" href="allvars_8c.html#a24">DomainEndList</a>[ThisTask];
00225 
00226   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00227     {
00228       sumload = maxload = 0;
00229       sumwork = maxwork = 0;
00230       <span class="keywordflow">for</span>(i = 0; i &lt; NTask; i++)
00231         {
00232           sumload += list_load[i];
00233           sumwork += list_work[i];
00234 
00235           <span class="keywordflow">if</span>(list_load[i] &gt; maxload)
00236             maxload = list_load[i];
00237 
00238           <span class="keywordflow">if</span>(list_work[i] &gt; maxwork)
00239             maxwork = list_work[i];
00240         }
00241 
00242       printf(<span class="stringliteral">"work-load balance=%g   memory-balance=%g\n"</span>,
00243              maxwork / (sumwork / <a class="code" href="allvars_8c.html#a1">NTask</a>), maxload / (((<span class="keywordtype">double</span>) sumload) / <a class="code" href="allvars_8c.html#a1">NTask</a>));
00244     }
00245 
00246 
00247   <span class="comment">/* determine for each cpu how many particles have to be shifted to other cpus */</span>
00248   <a class="code" href="domain_8c.html#a21">domain_countToGo</a>();
00249 
00250   <span class="keywordflow">for</span>(i = 0, sumtogo = 0; i &lt; <a class="code" href="allvars_8c.html#a1">NTask</a> * NTask; i++)
00251     sumtogo += toGo[i];
00252 
00253   <span class="keywordflow">while</span>(sumtogo &gt; 0)
00254     {
00255       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00256         {
00257           printf(<span class="stringliteral">"exchange of %d%09d particles\n"</span>, (<span class="keywordtype">int</span>) (sumtogo / 1000000000),
00258                  (<span class="keywordtype">int</span>) (sumtogo % 1000000000));
00259           fflush(stdout);
00260         }
00261 
00262       <span class="keywordflow">for</span>(ngrp = 1; ngrp &lt; (1 &lt;&lt; PTask); ngrp++)
00263         {
00264           <span class="keywordflow">for</span>(task = 0; task &lt; NTask; task++)
00265             {
00266               partner = task ^ ngrp;
00267 
00268               <span class="keywordflow">if</span>(partner &lt; <a class="code" href="allvars_8c.html#a1">NTask</a> &amp;&amp; task &lt; partner)
00269                 {
00270                   <span class="comment">/* treat SPH separately */</span>
00271                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o1">TotN_gas</a> &gt; 0)
00272                     {
00273                       <a class="code" href="proto_8h.html#a28">domain_findExchangeNumbers</a>(task, partner, 1, &amp;sendcount, &amp;recvcount);
00274 
00275                       list_NumPart[task] += recvcount - sendcount;
00276                       list_NumPart[partner] -= recvcount - sendcount;
00277                       list_N_gas[task] += recvcount - sendcount;
00278                       list_N_gas[partner] -= recvcount - sendcount;
00279 
00280                       toGo[task * <a class="code" href="allvars_8c.html#a1">NTask</a> + partner] -= sendcount;
00281                       toGo[partner * <a class="code" href="allvars_8c.html#a1">NTask</a> + task] -= recvcount;
00282                       toGoSph[task * <a class="code" href="allvars_8c.html#a1">NTask</a> + partner] -= sendcount;
00283                       toGoSph[partner * <a class="code" href="allvars_8c.html#a1">NTask</a> + task] -= recvcount;
00284 
00285                       <span class="keywordflow">if</span>(task == ThisTask)      <span class="comment">/* actually carry out the exchange */</span>
00286                         <a class="code" href="proto_8h.html#a27">domain_exchangeParticles</a>(partner, 1, sendcount, recvcount);
00287                       <span class="keywordflow">if</span>(partner == ThisTask)
00288                         <a class="code" href="proto_8h.html#a27">domain_exchangeParticles</a>(task, 1, recvcount, sendcount);
00289                     }
00290 
00291                   <a class="code" href="proto_8h.html#a28">domain_findExchangeNumbers</a>(task, partner, 0, &amp;sendcount, &amp;recvcount);
00292 
00293                   list_NumPart[task] += recvcount - sendcount;
00294                   list_NumPart[partner] -= recvcount - sendcount;
00295 
00296                   toGo[task * <a class="code" href="allvars_8c.html#a1">NTask</a> + partner] -= sendcount;
00297                   toGo[partner * <a class="code" href="allvars_8c.html#a1">NTask</a> + task] -= recvcount;
00298 
00299                   <span class="keywordflow">if</span>(task == ThisTask)  <span class="comment">/* actually carry out the exchange */</span>
00300                     <a class="code" href="proto_8h.html#a27">domain_exchangeParticles</a>(partner, 0, sendcount, recvcount);
00301                   <span class="keywordflow">if</span>(partner == ThisTask)
00302                     <a class="code" href="proto_8h.html#a27">domain_exchangeParticles</a>(task, 0, recvcount, sendcount);
00303                 }
00304             }
00305         }
00306 
00307       <span class="keywordflow">for</span>(i = 0, sumtogo = 0; i &lt; <a class="code" href="allvars_8c.html#a1">NTask</a> * NTask; i++)
00308         sumtogo += toGo[i];
00309     }
00310 }
00311 
<a name="l00327"></a><a class="code" href="proto_8h.html#a30">00327</a> <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a30">domain_findSplit</a>(<span class="keywordtype">int</span> cpustart, <span class="keywordtype">int</span> ncpu, <span class="keywordtype">int</span> first, <span class="keywordtype">int</span> last)
00328 {
00329   <span class="keywordtype">int</span> i, split, ok_left, ok_right;
00330   <span class="keywordtype">long</span> <span class="keywordtype">long</span> load, sphload, load_leftOfSplit, sphload_leftOfSplit;
00331   <span class="keywordtype">int</span> ncpu_leftOfSplit;
00332   <span class="keywordtype">double</span> maxAvgLoad_CurrentSplit, maxAvgLoad_NewSplit;
00333 
00334 
00335   ncpu_leftOfSplit = ncpu / 2;
00336 
00337   <span class="keywordflow">for</span>(i = first, load = 0, sphload = 0; i &lt;= last; i++)
00338     {
00339       load += <a class="code" href="allvars_8c.html#a26">DomainCount</a>[i];
00340       sphload += <a class="code" href="allvars_8c.html#a27">DomainCountSph</a>[i];
00341     }
00342 
00343   split = first + ncpu_leftOfSplit;
00344 
00345   <span class="keywordflow">for</span>(i = first, load_leftOfSplit = sphload_leftOfSplit = 0; i &lt; split; i++)
00346     {
00347       load_leftOfSplit += <a class="code" href="allvars_8c.html#a26">DomainCount</a>[i];
00348       sphload_leftOfSplit += <a class="code" href="allvars_8c.html#a27">DomainCountSph</a>[i];
00349     }
00350 
00351   <span class="comment">/* find the best split point in terms of work-load balance */</span>
00352 
00353   <span class="keywordflow">while</span>(split &lt; last - (ncpu - ncpu_leftOfSplit - 1) &amp;&amp; split &gt; 0)
00354     {
00355       maxAvgLoad_CurrentSplit =
00356         <a class="code" href="system_8c.html#a4">dmax</a>(load_leftOfSplit / ncpu_leftOfSplit, (load - load_leftOfSplit) / (ncpu - ncpu_leftOfSplit));
00357 
00358       maxAvgLoad_NewSplit =
00359         <a class="code" href="system_8c.html#a4">dmax</a>((load_leftOfSplit + <a class="code" href="allvars_8c.html#a26">DomainCount</a>[split]) / ncpu_leftOfSplit,
00360              (load - load_leftOfSplit - <a class="code" href="allvars_8c.html#a26">DomainCount</a>[split]) / (ncpu - ncpu_leftOfSplit));
00361 
00362       <span class="keywordflow">if</span>(maxAvgLoad_NewSplit &lt;= maxAvgLoad_CurrentSplit)
00363         {
00364           load_leftOfSplit += <a class="code" href="allvars_8c.html#a26">DomainCount</a>[split];
00365           sphload_leftOfSplit += <a class="code" href="allvars_8c.html#a27">DomainCountSph</a>[split];
00366           split++;
00367         }
00368       <span class="keywordflow">else</span>
00369         <span class="keywordflow">break</span>;
00370     }
00371 
00372 
00373   <span class="comment">/* we will now have to check whether this solution is possible given the restrictions on the maximum load */</span>
00374 
00375   <span class="keywordflow">for</span>(i = first, load_leftOfSplit = 0, sphload_leftOfSplit = 0; i &lt; split; i++)
00376     {
00377       load_leftOfSplit += <a class="code" href="allvars_8c.html#a26">DomainCount</a>[i];
00378       sphload_leftOfSplit += <a class="code" href="allvars_8c.html#a27">DomainCountSph</a>[i];
00379     }
00380 
00381   <span class="keywordflow">if</span>(load_leftOfSplit &gt; maxload * ncpu_leftOfSplit ||
00382      (load - load_leftOfSplit) &gt; maxload * (ncpu - ncpu_leftOfSplit))
00383     {
00384       <span class="comment">/* we did not find a viable split */</span>
00385       <span class="keywordflow">return</span> -1;
00386     }
00387 
00388   <span class="keywordflow">if</span>(sphload_leftOfSplit &gt; maxloadsph * ncpu_leftOfSplit ||
00389      (sphload - sphload_leftOfSplit) &gt; maxloadsph * (ncpu - ncpu_leftOfSplit))
00390     {
00391       <span class="comment">/* we did not find a viable split */</span>
00392       <span class="keywordflow">return</span> -1;
00393     }
00394 
00395   <span class="keywordflow">if</span>(ncpu_leftOfSplit &gt;= 2)
00396     ok_left = <a class="code" href="proto_8h.html#a30">domain_findSplit</a>(cpustart, ncpu_leftOfSplit, first, split - 1);
00397   <span class="keywordflow">else</span>
00398     ok_left = 0;
00399 
00400   <span class="keywordflow">if</span>((ncpu - ncpu_leftOfSplit) &gt;= 2)
00401     ok_right = <a class="code" href="proto_8h.html#a30">domain_findSplit</a>(cpustart + ncpu_leftOfSplit, ncpu - ncpu_leftOfSplit, split, last);
00402   <span class="keywordflow">else</span>
00403     ok_right = 0;
00404 
00405   <span class="keywordflow">if</span>(ok_left == 0 &amp;&amp; ok_right == 0)
00406     {
00407       <span class="comment">/* found a viable split */</span>
00408 
00409       <span class="keywordflow">if</span>(ncpu_leftOfSplit == 1)
00410         {
00411           <span class="keywordflow">for</span>(i = first; i &lt; split; i++)
00412             <a class="code" href="allvars_8c.html#a28">DomainTask</a>[i] = cpustart;
00413 
00414           list_load[cpustart] = load_leftOfSplit;
00415           list_loadsph[cpustart] = sphload_leftOfSplit;
00416           <a class="code" href="allvars_8c.html#a23">DomainStartList</a>[cpustart] = first;
00417           <a class="code" href="allvars_8c.html#a24">DomainEndList</a>[cpustart] = split - 1;
00418         }
00419 
00420       <span class="keywordflow">if</span>((ncpu - ncpu_leftOfSplit) == 1)
00421         {
00422           <span class="keywordflow">for</span>(i = split; i &lt;= last; i++)
00423             <a class="code" href="allvars_8c.html#a28">DomainTask</a>[i] = cpustart + ncpu_leftOfSplit;
00424 
00425           list_load[cpustart + ncpu_leftOfSplit] = load - load_leftOfSplit;
00426           list_loadsph[cpustart + ncpu_leftOfSplit] = sphload - sphload_leftOfSplit;
00427           <a class="code" href="allvars_8c.html#a23">DomainStartList</a>[cpustart + ncpu_leftOfSplit] = split;
00428           <a class="code" href="allvars_8c.html#a24">DomainEndList</a>[cpustart + ncpu_leftOfSplit] = last;
00429         }
00430 
00431       <span class="keywordflow">return</span> 0;
00432     }
00433 
00434   <span class="comment">/* we did not find a viable split */</span>
00435   <span class="keywordflow">return</span> -1;
00436 }
00437 
00438 
00439 
<a name="l00447"></a><a class="code" href="proto_8h.html#a31">00447</a> <span class="keywordtype">void</span> <a class="code" href="domain_8c.html#a18">domain_shiftSplit</a>(<span class="keywordtype">void</span>)
00448 {
00449   <span class="keywordtype">int</span> i, task, iter = 0, moved;
00450   <span class="keywordtype">double</span> maxw, newmaxw;
00451 
00452   <span class="keywordflow">for</span>(task = 0; task &lt; NTask; task++)
00453     list_work[task] = 0;
00454 
00455   <span class="keywordflow">for</span>(i = 0; i &lt; NTopleaves; i++)
00456     list_work[<a class="code" href="allvars_8c.html#a28">DomainTask</a>[i]] += <a class="code" href="allvars_8c.html#a25">DomainWork</a>[i];
00457 
00458   <span class="keywordflow">do</span>
00459     {
00460       <span class="keywordflow">for</span>(task = 0, moved = 0; task &lt; <a class="code" href="allvars_8c.html#a1">NTask</a> - 1; task++)
00461         {
00462           maxw = <a class="code" href="system_8c.html#a4">dmax</a>(list_work[task], list_work[task + 1]);
00463 
00464           <span class="keywordflow">if</span>(list_work[task] &lt; list_work[task + 1])
00465             {
00466               newmaxw = <a class="code" href="system_8c.html#a4">dmax</a>(list_work[task] + <a class="code" href="allvars_8c.html#a25">DomainWork</a>[<a class="code" href="allvars_8c.html#a23">DomainStartList</a>[task + 1]],
00467                              list_work[task + 1] - <a class="code" href="allvars_8c.html#a25">DomainWork</a>[<a class="code" href="allvars_8c.html#a23">DomainStartList</a>[task + 1]]);
00468               <span class="keywordflow">if</span>(newmaxw &lt;= maxw)
00469                 {
00470                   <span class="keywordflow">if</span>(list_load[task] + <a class="code" href="allvars_8c.html#a26">DomainCount</a>[<a class="code" href="allvars_8c.html#a23">DomainStartList</a>[task + 1]] &lt;= maxload)
00471                     {
00472                       <span class="keywordflow">if</span>(list_loadsph[task] + <a class="code" href="allvars_8c.html#a27">DomainCountSph</a>[<a class="code" href="allvars_8c.html#a23">DomainStartList</a>[task + 1]] &gt; maxloadsph)
00473                         <span class="keywordflow">continue</span>;
00474 
00475                       <span class="comment">/* ok, we can move one domain cell from right to left */</span>
00476                       list_work[task] += <a class="code" href="allvars_8c.html#a25">DomainWork</a>[<a class="code" href="allvars_8c.html#a23">DomainStartList</a>[task + 1]];
00477                       list_load[task] += <a class="code" href="allvars_8c.html#a26">DomainCount</a>[<a class="code" href="allvars_8c.html#a23">DomainStartList</a>[task + 1]];
00478                       list_loadsph[task] += <a class="code" href="allvars_8c.html#a27">DomainCountSph</a>[<a class="code" href="allvars_8c.html#a23">DomainStartList</a>[task + 1]];
00479                       list_work[task + 1] -= <a class="code" href="allvars_8c.html#a25">DomainWork</a>[<a class="code" href="allvars_8c.html#a23">DomainStartList</a>[task + 1]];
00480                       list_load[task + 1] -= <a class="code" href="allvars_8c.html#a26">DomainCount</a>[<a class="code" href="allvars_8c.html#a23">DomainStartList</a>[task + 1]];
00481                       list_loadsph[task + 1] -= <a class="code" href="allvars_8c.html#a27">DomainCountSph</a>[<a class="code" href="allvars_8c.html#a23">DomainStartList</a>[task + 1]];
00482 
00483                       <a class="code" href="allvars_8c.html#a28">DomainTask</a>[<a class="code" href="allvars_8c.html#a23">DomainStartList</a>[task + 1]] = task;
00484                       <a class="code" href="allvars_8c.html#a23">DomainStartList</a>[task + 1] += 1;
00485                       <a class="code" href="allvars_8c.html#a24">DomainEndList</a>[task] += 1;
00486 
00487                       moved++;
00488                     }
00489                 }
00490             }
00491           <span class="keywordflow">else</span>
00492             {
00493               newmaxw = <a class="code" href="system_8c.html#a4">dmax</a>(list_work[task] - <a class="code" href="allvars_8c.html#a25">DomainWork</a>[<a class="code" href="allvars_8c.html#a24">DomainEndList</a>[task]],
00494                              list_work[task + 1] + <a class="code" href="allvars_8c.html#a25">DomainWork</a>[<a class="code" href="allvars_8c.html#a24">DomainEndList</a>[task]]);
00495               <span class="keywordflow">if</span>(newmaxw &lt;= maxw)
00496                 {
00497                   <span class="keywordflow">if</span>(list_load[task + 1] + <a class="code" href="allvars_8c.html#a26">DomainCount</a>[<a class="code" href="allvars_8c.html#a24">DomainEndList</a>[task]] &lt;= maxload)
00498                     {
00499                       <span class="keywordflow">if</span>(list_loadsph[task + 1] + <a class="code" href="allvars_8c.html#a27">DomainCountSph</a>[<a class="code" href="allvars_8c.html#a24">DomainEndList</a>[task]] &gt; maxloadsph)
00500                         <span class="keywordflow">continue</span>;
00501 
00502                       <span class="comment">/* ok, we can move one domain cell from left to right */</span>
00503                       list_work[task] -= <a class="code" href="allvars_8c.html#a25">DomainWork</a>[<a class="code" href="allvars_8c.html#a24">DomainEndList</a>[task]];
00504                       list_load[task] -= <a class="code" href="allvars_8c.html#a26">DomainCount</a>[<a class="code" href="allvars_8c.html#a24">DomainEndList</a>[task]];
00505                       list_loadsph[task] -= <a class="code" href="allvars_8c.html#a27">DomainCountSph</a>[<a class="code" href="allvars_8c.html#a24">DomainEndList</a>[task]];
00506                       list_work[task + 1] += <a class="code" href="allvars_8c.html#a25">DomainWork</a>[<a class="code" href="allvars_8c.html#a24">DomainEndList</a>[task]];
00507                       list_load[task + 1] += <a class="code" href="allvars_8c.html#a26">DomainCount</a>[<a class="code" href="allvars_8c.html#a24">DomainEndList</a>[task]];
00508                       list_loadsph[task + 1] += <a class="code" href="allvars_8c.html#a27">DomainCountSph</a>[<a class="code" href="allvars_8c.html#a24">DomainEndList</a>[task]];
00509 
00510                       <a class="code" href="allvars_8c.html#a28">DomainTask</a>[<a class="code" href="allvars_8c.html#a24">DomainEndList</a>[task]] = task + 1;
00511                       <a class="code" href="allvars_8c.html#a24">DomainEndList</a>[task] -= 1;
00512                       <a class="code" href="allvars_8c.html#a23">DomainStartList</a>[task + 1] -= 1;
00513 
00514                       moved++;
00515                     }
00516                 }
00517 
00518             }
00519         }
00520 
00521       iter++;
00522     }
00523   <span class="keywordflow">while</span>(moved &gt; 0 &amp;&amp; iter &lt; 10 * NTopleaves);
00524 }
00525 
00526 
<a name="l00534"></a><a class="code" href="proto_8h.html#a28">00534</a> <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a28">domain_findExchangeNumbers</a>(<span class="keywordtype">int</span> task, <span class="keywordtype">int</span> partner, <span class="keywordtype">int</span> sphflag, <span class="keywordtype">int</span> *send, <span class="keywordtype">int</span> *recv)
00535 {
00536   <span class="keywordtype">int</span> numpartA, numpartsphA, ntobesentA, maxsendA, maxsendA_old;
00537   <span class="keywordtype">int</span> numpartB, numpartsphB, ntobesentB, maxsendB, maxsendB_old;
00538 
00539   numpartA = list_NumPart[task];
00540   numpartsphA = list_N_gas[task];
00541 
00542   numpartB = list_NumPart[partner];
00543   numpartsphB = list_N_gas[partner];
00544 
00545   <span class="keywordflow">if</span>(sphflag == 1)
00546     {
00547       ntobesentA = toGoSph[task * <a class="code" href="allvars_8c.html#a1">NTask</a> + partner];
00548       ntobesentB = toGoSph[partner * <a class="code" href="allvars_8c.html#a1">NTask</a> + task];
00549     }
00550   <span class="keywordflow">else</span>
00551     {
00552       ntobesentA = toGo[task * <a class="code" href="allvars_8c.html#a1">NTask</a> + partner] - toGoSph[task * <a class="code" href="allvars_8c.html#a1">NTask</a> + partner];
00553       ntobesentB = toGo[partner * <a class="code" href="allvars_8c.html#a1">NTask</a> + task] - toGoSph[partner * <a class="code" href="allvars_8c.html#a1">NTask</a> + task];
00554     }
00555 
00556   maxsendA = <a class="code" href="system_8c.html#a7">imin</a>(ntobesentA, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o13">BunchSizeDomain</a>);
00557   maxsendB = <a class="code" href="system_8c.html#a7">imin</a>(ntobesentB, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o13">BunchSizeDomain</a>);
00558 
00559   <span class="keywordflow">do</span>
00560     {
00561       maxsendA_old = maxsendA;
00562       maxsendB_old = maxsendB;
00563 
00564       maxsendA = <a class="code" href="system_8c.html#a7">imin</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> - numpartB + maxsendB, maxsendA);
00565       maxsendB = <a class="code" href="system_8c.html#a7">imin</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> - numpartA + maxsendA, maxsendB);
00566     }
00567   <span class="keywordflow">while</span>((maxsendA != maxsendA_old) || (maxsendB != maxsendB_old));
00568 
00569 
00570   <span class="comment">/* now make also sure that there is enough space for SPH particeles */</span>
00571   <span class="keywordflow">if</span>(sphflag == 1)
00572     {
00573       <span class="keywordflow">do</span>
00574         {
00575           maxsendA_old = maxsendA;
00576           maxsendB_old = maxsendB;
00577 
00578           maxsendA = <a class="code" href="system_8c.html#a7">imin</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o3">MaxPartSph</a> - numpartsphB + maxsendB, maxsendA);
00579           maxsendB = <a class="code" href="system_8c.html#a7">imin</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o3">MaxPartSph</a> - numpartsphA + maxsendA, maxsendB);
00580         }
00581       <span class="keywordflow">while</span>((maxsendA != maxsendA_old) || (maxsendB != maxsendB_old));
00582     }
00583 
00584   *send = maxsendA;
00585   *recv = maxsendB;
00586 }
00587 
00588 
00589 
00590 
<a name="l00595"></a><a class="code" href="proto_8h.html#a27">00595</a> <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a27">domain_exchangeParticles</a>(<span class="keywordtype">int</span> partner, <span class="keywordtype">int</span> sphflag, <span class="keywordtype">int</span> send_count, <span class="keywordtype">int</span> recv_count)
00596 {
00597   <span class="keywordtype">int</span> i, no, n, count, rep;
00598   MPI_Status status;
00599 
00600   <span class="keywordflow">for</span>(n = 0, count = 0; count &lt; send_count &amp;&amp; n &lt; NumPart; n++)
00601     {
00602       <span class="keywordflow">if</span>(sphflag)
00603         {
00604           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[n].<a class="code" href="structparticle__data.html#o9">Type</a> != 0)
00605             <span class="keywordflow">continue</span>;
00606         }
00607       <span class="keywordflow">else</span>
00608         {
00609           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[n].<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
00610             <span class="keywordflow">continue</span>;
00611         }
00612 
00613       no = 0;
00614 
00615       <span class="keywordflow">while</span>(<a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o0">Daughter</a> &gt;= 0)
00616         no = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o0">Daughter</a> + (<a class="code" href="allvars_8c.html#a34">Key</a>[n] - <a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o5">StartKey</a>) / (<a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o4">Size</a> / 8);
00617 
00618       no = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o3">Leaf</a>;
00619 
00620       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a28">DomainTask</a>[no] == partner)
00621         {
00622           <span class="keywordflow">if</span>(sphflag)           <span class="comment">/* special reorder routine for SPH particles (need to stay at beginning) */</span>
00623             {
00624               <a class="code" href="allvars_8c.html#a52">DomainPartBuf</a>[count] = <a class="code" href="allvars_8c.html#a51">P</a>[n];      <span class="comment">/* copy particle and collect in contiguous memory */</span>
00625               <a class="code" href="allvars_8c.html#a33">DomainKeyBuf</a>[count] = <a class="code" href="allvars_8c.html#a34">Key</a>[n];
00626               <a class="code" href="allvars_8c.html#a54">DomainSphBuf</a>[count] = <a class="code" href="allvars_8c.html#a53">SphP</a>[n];
00627 
00628               <a class="code" href="allvars_8c.html#a51">P</a>[n] = <a class="code" href="allvars_8c.html#a51">P</a>[<a class="code" href="allvars_8c.html#a4">N_gas</a> - 1];
00629               <a class="code" href="allvars_8c.html#a51">P</a>[<a class="code" href="allvars_8c.html#a4">N_gas</a> - 1] = <a class="code" href="allvars_8c.html#a51">P</a>[<a class="code" href="allvars_8c.html#a3">NumPart</a> - 1];
00630 
00631               <a class="code" href="allvars_8c.html#a34">Key</a>[n] = <a class="code" href="allvars_8c.html#a34">Key</a>[<a class="code" href="allvars_8c.html#a4">N_gas</a> - 1];
00632               <a class="code" href="allvars_8c.html#a34">Key</a>[<a class="code" href="allvars_8c.html#a4">N_gas</a> - 1] = <a class="code" href="allvars_8c.html#a34">Key</a>[<a class="code" href="allvars_8c.html#a3">NumPart</a> - 1];
00633 
00634               <a class="code" href="allvars_8c.html#a53">SphP</a>[n] = <a class="code" href="allvars_8c.html#a53">SphP</a>[<a class="code" href="allvars_8c.html#a4">N_gas</a> - 1];
00635 
00636               <a class="code" href="allvars_8c.html#a4">N_gas</a>--;
00637             }
00638           <span class="keywordflow">else</span>
00639             {
00640               <a class="code" href="allvars_8c.html#a52">DomainPartBuf</a>[count] = <a class="code" href="allvars_8c.html#a51">P</a>[n];      <span class="comment">/* copy particle and collect in contiguous memory */</span>
00641               <a class="code" href="allvars_8c.html#a33">DomainKeyBuf</a>[count] = <a class="code" href="allvars_8c.html#a34">Key</a>[n];
00642               <a class="code" href="allvars_8c.html#a51">P</a>[n] = <a class="code" href="allvars_8c.html#a51">P</a>[<a class="code" href="allvars_8c.html#a3">NumPart</a> - 1];
00643               <a class="code" href="allvars_8c.html#a34">Key</a>[n] = <a class="code" href="allvars_8c.html#a34">Key</a>[<a class="code" href="allvars_8c.html#a3">NumPart</a> - 1];
00644             }
00645 
00646           count++;
00647           <a class="code" href="allvars_8c.html#a3">NumPart</a>--;
00648           n--;
00649         }
00650     }
00651 
00652   <span class="keywordflow">if</span>(count != send_count)
00653     {
00654       printf(<span class="stringliteral">"Houston, we got a problem...\n"</span>);
00655       printf(<span class="stringliteral">"ThisTask=%d count=%d send_count=%d\n"</span>, <a class="code" href="allvars_8c.html#a0">ThisTask</a>, count, send_count);
00656       <a class="code" href="proto_8h.html#a38">endrun</a>(88);
00657     }
00658 
00659   <span class="comment">/* transmit */</span>
00660 
00661   <span class="keywordflow">for</span>(rep = 0; rep &lt; 2; rep++)
00662     {
00663       <span class="keywordflow">if</span>((rep == 0 &amp;&amp; ThisTask &lt; partner) || (rep == 1 &amp;&amp; ThisTask &gt; partner))
00664         {
00665           <span class="keywordflow">if</span>(send_count &gt; 0)
00666             {
00667               MPI_Ssend(&amp;<a class="code" href="allvars_8c.html#a52">DomainPartBuf</a>[0], send_count * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structparticle__data.html">particle_data</a>), MPI_BYTE, partner,
00668                         <a class="code" href="tags_8h.html#a2">TAG_PDATA</a>, MPI_COMM_WORLD);
00669 
00670               MPI_Ssend(&amp;<a class="code" href="allvars_8c.html#a33">DomainKeyBuf</a>[0], send_count * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a45">peanokey</a>), MPI_BYTE, partner, <a class="code" href="tags_8h.html#a4">TAG_KEY</a>,
00671                         MPI_COMM_WORLD);
00672 
00673               <span class="keywordflow">if</span>(sphflag)
00674                 MPI_Ssend(&amp;<a class="code" href="allvars_8c.html#a54">DomainSphBuf</a>[0], send_count * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structsph__particle__data.html">sph_particle_data</a>), MPI_BYTE, partner,
00675                           <a class="code" href="tags_8h.html#a3">TAG_SPHDATA</a>, MPI_COMM_WORLD);
00676             }
00677         }
00678 
00679       <span class="keywordflow">if</span>((rep == 1 &amp;&amp; ThisTask &lt; partner) || (rep == 0 &amp;&amp; ThisTask &gt; partner))
00680         {
00681           <span class="keywordflow">if</span>(recv_count &gt; 0)
00682             {
00683               <span class="keywordflow">if</span>(sphflag)
00684                 {
00685                   <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a3">NumPart</a> - N_gas) &gt; recv_count)
00686                     {
00687                       <span class="keywordflow">for</span>(i = 0; i &lt; recv_count; i++)
00688                         {
00689                           <a class="code" href="allvars_8c.html#a51">P</a>[<a class="code" href="allvars_8c.html#a3">NumPart</a> + i] = <a class="code" href="allvars_8c.html#a51">P</a>[<a class="code" href="allvars_8c.html#a4">N_gas</a> + i];
00690                           <a class="code" href="allvars_8c.html#a34">Key</a>[<a class="code" href="allvars_8c.html#a3">NumPart</a> + i] = <a class="code" href="allvars_8c.html#a34">Key</a>[<a class="code" href="allvars_8c.html#a4">N_gas</a> + i];
00691                         }
00692                     }
00693                   <span class="keywordflow">else</span>
00694                     {
00695                       <span class="keywordflow">for</span>(i = <a class="code" href="allvars_8c.html#a3">NumPart</a> - 1; i &gt;= N_gas; i--)
00696                         {
00697                           <a class="code" href="allvars_8c.html#a51">P</a>[i + recv_count] = <a class="code" href="allvars_8c.html#a51">P</a>[i];
00698                           <a class="code" href="allvars_8c.html#a34">Key</a>[i + recv_count] = <a class="code" href="allvars_8c.html#a34">Key</a>[i];
00699                         }
00700                     }
00701 
00702                   MPI_Recv(&amp;<a class="code" href="allvars_8c.html#a51">P</a>[<a class="code" href="allvars_8c.html#a4">N_gas</a>], recv_count * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structparticle__data.html">particle_data</a>), MPI_BYTE, partner, <a class="code" href="tags_8h.html#a2">TAG_PDATA</a>,
00703                            MPI_COMM_WORLD, &amp;status);
00704                   MPI_Recv(&amp;<a class="code" href="allvars_8c.html#a34">Key</a>[<a class="code" href="allvars_8c.html#a4">N_gas</a>], recv_count * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a45">peanokey</a>), MPI_BYTE, partner, <a class="code" href="tags_8h.html#a4">TAG_KEY</a>,
00705                            MPI_COMM_WORLD, &amp;status);
00706                   MPI_Recv(&amp;<a class="code" href="allvars_8c.html#a53">SphP</a>[<a class="code" href="allvars_8c.html#a4">N_gas</a>], recv_count * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structsph__particle__data.html">sph_particle_data</a>), MPI_BYTE, partner,
00707                            <a class="code" href="tags_8h.html#a3">TAG_SPHDATA</a>, MPI_COMM_WORLD, &amp;status);
00708 
00709                   <a class="code" href="allvars_8c.html#a4">N_gas</a> += recv_count;
00710                 }
00711               <span class="keywordflow">else</span>
00712                 {
00713                   MPI_Recv(&amp;<a class="code" href="allvars_8c.html#a51">P</a>[<a class="code" href="allvars_8c.html#a3">NumPart</a>], recv_count * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structparticle__data.html">particle_data</a>), MPI_BYTE, partner,
00714                            <a class="code" href="tags_8h.html#a2">TAG_PDATA</a>, MPI_COMM_WORLD, &amp;status);
00715                   MPI_Recv(&amp;<a class="code" href="allvars_8c.html#a34">Key</a>[<a class="code" href="allvars_8c.html#a3">NumPart</a>], recv_count * <span class="keyword">sizeof</span>(<a class="code" href="allvars_8h.html#a45">peanokey</a>), MPI_BYTE, partner,
00716                            <a class="code" href="tags_8h.html#a4">TAG_KEY</a>, MPI_COMM_WORLD, &amp;status);
00717                 }
00718 
00719               <a class="code" href="allvars_8c.html#a3">NumPart</a> += recv_count;
00720             }
00721         }
00722     }
00723 }
00724 
<a name="l00729"></a><a class="code" href="proto_8h.html#a24">00729</a> <span class="keywordtype">void</span> <a class="code" href="domain_8c.html#a21">domain_countToGo</a>(<span class="keywordtype">void</span>)
00730 {
00731   <span class="keywordtype">int</span> n, no;
00732 
00733   <span class="keywordflow">for</span>(n = 0; n &lt; NTask; n++)
00734     {
00735       local_toGo[n] = 0;
00736       local_toGoSph[n] = 0;
00737     }
00738 
00739   <span class="keywordflow">for</span>(n = 0; n &lt; NumPart; n++)
00740     {
00741       no = 0;
00742 
00743       <span class="keywordflow">while</span>(<a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o0">Daughter</a> &gt;= 0)
00744         no = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o0">Daughter</a> + (<a class="code" href="allvars_8c.html#a34">Key</a>[n] - <a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o5">StartKey</a>) / (<a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o4">Size</a> / 8);
00745 
00746       no = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o3">Leaf</a>;
00747 
00748       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a28">DomainTask</a>[no] != ThisTask)
00749         {
00750           local_toGo[<a class="code" href="allvars_8c.html#a28">DomainTask</a>[no]] += 1;
00751           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[n].<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
00752             local_toGoSph[<a class="code" href="allvars_8c.html#a28">DomainTask</a>[no]] += 1;
00753         }
00754     }
00755 
00756   MPI_Allgather(local_toGo, <a class="code" href="allvars_8c.html#a1">NTask</a>, MPI_INT, toGo, <a class="code" href="allvars_8c.html#a1">NTask</a>, MPI_INT, MPI_COMM_WORLD);
00757   MPI_Allgather(local_toGoSph, <a class="code" href="allvars_8c.html#a1">NTask</a>, MPI_INT, toGoSph, <a class="code" href="allvars_8c.html#a1">NTask</a>, MPI_INT, MPI_COMM_WORLD);
00758 }
00759 
00760 
<a name="l00765"></a><a class="code" href="domain_8c.html#a22">00765</a> <span class="keywordtype">void</span> <a class="code" href="domain_8c.html#a22">domain_walktoptree</a>(<span class="keywordtype">int</span> no)
00766 {
00767   <span class="keywordtype">int</span> i;
00768 
00769   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o0">Daughter</a> == -1)
00770     {
00771       <a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o3">Leaf</a> = NTopleaves;
00772       <a class="code" href="allvars_8c.html#a37">NTopleaves</a>++;
00773     }
00774   <span class="keywordflow">else</span>
00775     {
00776       <span class="keywordflow">for</span>(i = 0; i &lt; 8; i++)
00777         <a class="code" href="domain_8c.html#a22">domain_walktoptree</a>(<a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].Daughter + i);
00778     }
00779 }
00780 
<a name="l00786"></a><a class="code" href="proto_8h.html#a32">00786</a> <span class="keywordtype">void</span> <a class="code" href="domain_8c.html#a23">domain_sumCost</a>(<span class="keywordtype">void</span>)
00787 {
00788   <span class="keywordtype">int</span> i, n, no;
00789   <span class="keywordtype">double</span> *local_DomainWork;
00790   <span class="keywordtype">int</span> *local_DomainCount;
00791   <span class="keywordtype">int</span> *local_DomainCountSph;
00792 
00793   local_DomainWork = malloc(<a class="code" href="allvars_8c.html#a36">NTopnodes</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00794   local_DomainCount = malloc(<a class="code" href="allvars_8c.html#a36">NTopnodes</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00795   local_DomainCountSph = malloc(<a class="code" href="allvars_8c.html#a36">NTopnodes</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00796 
00797 
00798 
00799   <a class="code" href="allvars_8c.html#a37">NTopleaves</a> = 0;
00800 
00801   <a class="code" href="domain_8c.html#a22">domain_walktoptree</a>(0);
00802 
00803   <span class="keywordflow">for</span>(i = 0; i &lt; NTopleaves; i++)
00804     {
00805       local_DomainWork[i] = 0;
00806       local_DomainCount[i] = 0;
00807       local_DomainCountSph[i] = 0;
00808     }
00809 
00810   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00811     printf(<span class="stringliteral">"NTopleaves= %d\n"</span>, <a class="code" href="allvars_8c.html#a37">NTopleaves</a>);
00812 
00813   <span class="keywordflow">for</span>(n = 0; n &lt; NumPart; n++)
00814     {
00815       no = 0;
00816 
00817       <span class="keywordflow">while</span>(<a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o0">Daughter</a> &gt;= 0)
00818         no = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o0">Daughter</a> + (<a class="code" href="allvars_8c.html#a34">Key</a>[n] - <a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o5">StartKey</a>) / (<a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o4">Size</a> / 8);
00819 
00820       no = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[no].<a class="code" href="structtopnode__data.html#o3">Leaf</a>;
00821 
00822       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[n].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> &gt; <a class="code" href="allvars_8c.html#a51">P</a>[n].<a class="code" href="structparticle__data.html#o11">Ti_begstep</a>)
00823         local_DomainWork[no] += (1.0 + <a class="code" href="allvars_8c.html#a51">P</a>[n].<a class="code" href="structparticle__data.html#o12">GravCost</a>) / (<a class="code" href="allvars_8c.html#a51">P</a>[n].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> - <a class="code" href="allvars_8c.html#a51">P</a>[n].<a class="code" href="structparticle__data.html#o11">Ti_begstep</a>);
00824       <span class="keywordflow">else</span>
00825         local_DomainWork[no] += (1.0 + <a class="code" href="allvars_8c.html#a51">P</a>[n].<a class="code" href="structparticle__data.html#o12">GravCost</a>);
00826 
00827       local_DomainCount[no] += 1;
00828       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[n].<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
00829         local_DomainCountSph[no] += 1;
00830     }
00831 
00832   MPI_Allreduce(local_DomainWork, <a class="code" href="allvars_8c.html#a25">DomainWork</a>, <a class="code" href="allvars_8c.html#a37">NTopleaves</a>, MPI_DOUBLE, MPI_SUM, MPI_COMM_WORLD);
00833   MPI_Allreduce(local_DomainCount, <a class="code" href="allvars_8c.html#a26">DomainCount</a>, <a class="code" href="allvars_8c.html#a37">NTopleaves</a>, MPI_INT, MPI_SUM, MPI_COMM_WORLD);
00834   MPI_Allreduce(local_DomainCountSph, <a class="code" href="allvars_8c.html#a27">DomainCountSph</a>, <a class="code" href="allvars_8c.html#a37">NTopleaves</a>, MPI_INT, MPI_SUM, MPI_COMM_WORLD);
00835 
00836 
00837   free(local_DomainCountSph);
00838   free(local_DomainCount);
00839   free(local_DomainWork);
00840 }
00841 
00842 
<a name="l00845"></a><a class="code" href="proto_8h.html#a29">00845</a> <span class="keywordtype">void</span> <a class="code" href="domain_8c.html#a24">domain_findExtent</a>(<span class="keywordtype">void</span>)
00846 {
00847   <span class="keywordtype">int</span> i, j;
00848   <span class="keywordtype">double</span> len, xmin[3], xmax[3], xmin_glob[3], xmax_glob[3];
00849 
00850   <span class="comment">/* determine local extension */</span>
00851   <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
00852     {
00853       xmin[j] = MAX_REAL_NUMBER;
00854       xmax[j] = -MAX_REAL_NUMBER;
00855     }
00856 
00857   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00858     {
00859       <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
00860         {
00861           <span class="keywordflow">if</span>(xmin[j] &gt; <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[j])
00862             xmin[j] = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[j];
00863 
00864           <span class="keywordflow">if</span>(xmax[j] &lt; <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[j])
00865             xmax[j] = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[j];
00866         }
00867     }
00868 
00869   MPI_Allreduce(xmin, xmin_glob, 3, MPI_DOUBLE, MPI_MIN, MPI_COMM_WORLD);
00870   MPI_Allreduce(xmax, xmax_glob, 3, MPI_DOUBLE, MPI_MAX, MPI_COMM_WORLD);
00871 
00872   len = 0;
00873   <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
00874     <span class="keywordflow">if</span>(xmax_glob[j] - xmin_glob[j] &gt; len)
00875       len = xmax_glob[j] - xmin_glob[j];
00876 
00877   len *= 1.001;
00878 
00879   <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
00880     {
00881       <a class="code" href="allvars_8c.html#a18">DomainCenter</a>[j] = 0.5 * (xmin_glob[j] + xmax_glob[j]);
00882       <a class="code" href="allvars_8c.html#a17">DomainCorner</a>[j] = 0.5 * (xmin_glob[j] + xmax_glob[j]) - 0.5 * len;
00883     }
00884 
00885   <a class="code" href="allvars_8c.html#a19">DomainLen</a> = len;
00886   <a class="code" href="allvars_8c.html#a20">DomainFac</a> = 1.0 / len * (((peanokey) 1) &lt;&lt; (BITS_PER_DIMENSION));
00887 }
00888 
00889 
00896 <span class="keywordtype">void</span> <a class="code" href="domain_8c.html#a25">domain_determineTopTree</a>(<span class="keywordtype">void</span>)
00897 {
<a name="l00898"></a><a class="code" href="proto_8h.html#a26">00898</a>   <span class="keywordtype">int</span> i, ntop_local, ntop;
00899   <span class="keywordtype">int</span> *ntopnodelist, *ntopoffset;
00900 
00901   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00902     {
00903       <a class="code" href="allvars_8c.html#a35">KeySorted</a>[i] = <a class="code" href="allvars_8c.html#a34">Key</a>[i] = <a class="code" href="proto_8h.html#a119">peano_hilbert_key</a>((<a class="code" href="allvars_8c.html#a51">P</a>[i].Pos[0] - <a class="code" href="allvars_8c.html#a17">DomainCorner</a>[0]) * <a class="code" href="allvars_8c.html#a20">DomainFac</a>,
00904                                                 (<a class="code" href="allvars_8c.html#a51">P</a>[i].Pos[1] - <a class="code" href="allvars_8c.html#a17">DomainCorner</a>[1]) * <a class="code" href="allvars_8c.html#a20">DomainFac</a>,
00905                                                 (<a class="code" href="allvars_8c.html#a51">P</a>[i].Pos[2] - <a class="code" href="allvars_8c.html#a17">DomainCorner</a>[2]) * <a class="code" href="allvars_8c.html#a20">DomainFac</a>,
00906                                                 <a class="code" href="allvars_8h.html#a3">BITS_PER_DIMENSION</a>);
00907     }
00908 
00909   qsort(KeySorted, NumPart, <span class="keyword">sizeof</span>(peanokey), domain_compare_key);
00910 
00911   <a class="code" href="allvars_8c.html#a36">NTopnodes</a> = 1;
00912   <a class="code" href="allvars_8c.html#a38">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#o0">Daughter</a> = -1;
00913   <a class="code" href="allvars_8c.html#a38">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#o4">Size</a> = PEANOCELLS;
00914   <a class="code" href="allvars_8c.html#a38">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#o5">StartKey</a> = 0;
00915   <a class="code" href="allvars_8c.html#a38">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#o6">Count</a> = NumPart;
00916   <a class="code" href="allvars_8c.html#a38">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#o1">Pstart</a> = 0;
00917 
00918   <a class="code" href="proto_8h.html#a34">domain_topsplit_local</a>(0, 0);
00919 
00920   toplist_local = malloc(NTopnodes * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> topnode_exchange));
00921 
00922   <span class="keywordflow">for</span>(i = 0, ntop_local = 0; i &lt; NTopnodes; i++)
00923     {
00924       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a38">TopNodes</a>[i].<a class="code" href="structtopnode__data.html#o0">Daughter</a> == -1)    <span class="comment">/* only use leaves */</span>
00925         {
00926           toplist_local[ntop_local].Startkey = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[i].<a class="code" href="structtopnode__data.html#o5">StartKey</a>;
00927           toplist_local[ntop_local].<a class="code" href="structtopnode__data.html#o6">Count</a> = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[i].<a class="code" href="structtopnode__data.html#o6">Count</a>;
00928           ntop_local++;
00929         }
00930     }
00931 
00932   ntopnodelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask);
00933   ntopoffset = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * NTask);
00934 
00935   MPI_Allgather(&amp;ntop_local, 1, MPI_INT, ntopnodelist, 1, MPI_INT, MPI_COMM_WORLD);
00936 
00937   <span class="keywordflow">for</span>(i = 0, ntop = 0, ntopoffset[0] = 0; i &lt; NTask; i++)
00938     {
00939       ntop += ntopnodelist[i];
00940       <span class="keywordflow">if</span>(i &gt; 0)
00941         ntopoffset[i] = ntopoffset[i - 1] + ntopnodelist[i - 1];
00942     }
00943 
00944 
00945   toplist = malloc(ntop * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> topnode_exchange));
00946 
00947   <span class="keywordflow">for</span>(i = 0; i &lt; NTask; i++)
00948     {
00949       ntopnodelist[i] *= <span class="keyword">sizeof</span>(<span class="keyword">struct </span>topnode_exchange);
00950       ntopoffset[i] *= <span class="keyword">sizeof</span>(<span class="keyword">struct </span>topnode_exchange);
00951     }
00952 
00953   MPI_Allgatherv(toplist_local, ntop_local * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> topnode_exchange), MPI_BYTE,
00954                  toplist, ntopnodelist, ntopoffset, MPI_BYTE, MPI_COMM_WORLD);
00955 
00956   qsort(toplist, ntop, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> topnode_exchange), domain_compare_toplist);
00957 
00958   <a class="code" href="allvars_8c.html#a36">NTopnodes</a> = 1;
00959   <a class="code" href="allvars_8c.html#a38">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#o0">Daughter</a> = -1;
00960   <a class="code" href="allvars_8c.html#a38">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#o4">Size</a> = PEANOCELLS;
00961   <a class="code" href="allvars_8c.html#a38">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#o5">StartKey</a> = 0;
00962   <a class="code" href="allvars_8c.html#a38">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#o6">Count</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a>;
00963   <a class="code" href="allvars_8c.html#a38">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#o1">Pstart</a> = 0;
00964   <a class="code" href="allvars_8c.html#a38">TopNodes</a>[0].<a class="code" href="structtopnode__data.html#o2">Blocks</a> = ntop;
00965 
00966   <a class="code" href="proto_8h.html#a33">domain_topsplit</a>(0, 0);
00967 
00968   free(toplist);
00969   free(ntopoffset);
00970   free(ntopnodelist);
00971   free(toplist_local);
00972 
00973 }
00974 
00975 
00976 
00982 <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a34">domain_topsplit_local</a>(<span class="keywordtype">int</span> node, peanokey startkey)
00983 {
00984   <span class="keywordtype">int</span> i, p, sub, bin;
00985 
00986   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o4">Size</a> &gt;= 8)
00987     {
00988       <a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o0">Daughter</a> = NTopnodes;
00989 
<a name="l00990"></a><a class="code" href="proto_8h.html#a34">00990</a>       <span class="keywordflow">for</span>(i = 0; i &lt; 8; i++)
00991         {
00992           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a36">NTopnodes</a> &lt; MAXTOPNODES)
00993             {
00994               sub = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o0">Daughter</a> + i;
00995               <a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o4">Size</a> = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o4">Size</a> / 8;
00996               <a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o6">Count</a> = 0;
00997               <a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o0">Daughter</a> = -1;
00998               <a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o5">StartKey</a> = startkey + i * <a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o4">Size</a>;
00999               <a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o1">Pstart</a> = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o1">Pstart</a>;
01000 
01001               <a class="code" href="allvars_8c.html#a36">NTopnodes</a>++;
01002             }
01003           <span class="keywordflow">else</span>
01004             {
01005               printf(<span class="stringliteral">"task=%d: We are out of Topnodes. Increasing the constant MAXTOPNODES might help.\n"</span>,
01006                      <a class="code" href="allvars_8c.html#a0">ThisTask</a>);
01007               fflush(stdout);
01008               <a class="code" href="proto_8h.html#a38">endrun</a>(13213);
01009             }
01010         }
01011 
01012       <span class="keywordflow">for</span>(p = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o1">Pstart</a>; p &lt; <a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o1">Pstart</a> + <a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o6">Count</a>; p++)
01013         {
01014           bin = (<a class="code" href="allvars_8c.html#a35">KeySorted</a>[p] - startkey) / (<a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o4">Size</a> / 8);
01015 
01016           <span class="keywordflow">if</span>(bin &lt; 0 || bin &gt; 7)
01017             {
01018               printf(<span class="stringliteral">"task=%d: something odd has happened here. bin=%d\n"</span>, ThisTask, bin);
01019               fflush(stdout);
01020               <a class="code" href="proto_8h.html#a38">endrun</a>(13123123);
01021             }
01022 
01023           sub = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o0">Daughter</a> + bin;
01024 
01025           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o6">Count</a> == 0)
01026             <a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o1">Pstart</a> = p;
01027 
01028           <a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o6">Count</a>++;
01029         }
01030 
01031       <span class="keywordflow">for</span>(i = 0; i &lt; 8; i++)
01032         {
01033           sub = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o0">Daughter</a> + i;
01034           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o6">Count</a> &gt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a> / (<a class="code" href="domain_8c.html#a0">TOPNODEFACTOR</a> * <a class="code" href="allvars_8c.html#a1">NTask</a> * NTask))
01035             <a class="code" href="proto_8h.html#a34">domain_topsplit_local</a>(sub, TopNodes[sub].StartKey);
01036         }
01037     }
01038 }
01039 
01040 
01041 
01049 <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a33">domain_topsplit</a>(<span class="keywordtype">int</span> node, peanokey startkey)
01050 {
01051   <span class="keywordtype">int</span> i, p, sub, bin;
01052 
01053   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o4">Size</a> &gt;= 8)
01054     {
01055       <a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o0">Daughter</a> = NTopnodes;
01056 
<a name="l01057"></a><a class="code" href="proto_8h.html#a33">01057</a>       <span class="keywordflow">for</span>(i = 0; i &lt; 8; i++)
01058         {
01059           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a36">NTopnodes</a> &lt; MAXTOPNODES)
01060             {
01061               sub = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o0">Daughter</a> + i;
01062               <a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o4">Size</a> = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o4">Size</a> / 8;
01063               <a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o6">Count</a> = 0;
01064               <a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o2">Blocks</a> = 0;
01065               <a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o0">Daughter</a> = -1;
01066               <a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o5">StartKey</a> = startkey + i * <a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o4">Size</a>;
01067               <a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o1">Pstart</a> = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o1">Pstart</a>;
01068               <a class="code" href="allvars_8c.html#a36">NTopnodes</a>++;
01069             }
01070           <span class="keywordflow">else</span>
01071             {
01072               printf(<span class="stringliteral">"Task=%d: We are out of Topnodes. Increasing the constant MAXTOPNODES might help.\n"</span>,
01073                      <a class="code" href="allvars_8c.html#a0">ThisTask</a>);
01074               fflush(stdout);
01075               <a class="code" href="proto_8h.html#a38">endrun</a>(137213);
01076             }
01077         }
01078 
01079       <span class="keywordflow">for</span>(p = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o1">Pstart</a>; p &lt; <a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o1">Pstart</a> + <a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o2">Blocks</a>; p++)
01080         {
01081           bin = (toplist[p].Startkey - startkey) / (<a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o4">Size</a> / 8);
01082           sub = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o0">Daughter</a> + bin;
01083 
01084           <span class="keywordflow">if</span>(bin &lt; 0 || bin &gt; 7)
01085             <a class="code" href="proto_8h.html#a38">endrun</a>(77);
01086 
01087           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o2">Blocks</a> == 0)
01088             <a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o1">Pstart</a> = p;
01089 
01090           <a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o6">Count</a> += toplist[p].<a class="code" href="structtopnode__data.html#o6">Count</a>;
01091           <a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o2">Blocks</a>++;
01092         }
01093 
01094       <span class="keywordflow">for</span>(i = 0; i &lt; 8; i++)
01095         {
01096           sub = <a class="code" href="allvars_8c.html#a38">TopNodes</a>[node].<a class="code" href="structtopnode__data.html#o0">Daughter</a> + i;
01097           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a38">TopNodes</a>[sub].<a class="code" href="structtopnode__data.html#o6">Count</a> &gt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a> / (<a class="code" href="domain_8c.html#a0">TOPNODEFACTOR</a> * NTask))
01098             <a class="code" href="proto_8h.html#a33">domain_topsplit</a>(sub, TopNodes[sub].StartKey);
01099         }
01100     }
01101 }
01102 
01103 
01106 <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a23">domain_compare_toplist</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *a, <span class="keyword">const</span> <span class="keywordtype">void</span> *b)
01107 {
01108   <span class="keywordflow">if</span>(((<span class="keyword">struct </span>topnode_exchange *) a)-&gt;Startkey &lt; (((<span class="keyword">struct </span>topnode_exchange *) b)-&gt;Startkey))
01109     <span class="keywordflow">return</span> -1;
01110 
01111   <span class="keywordflow">if</span>(((<span class="keyword">struct </span>topnode_exchange *) a)-&gt;Startkey &gt; (((<span class="keyword">struct </span>topnode_exchange *) b)-&gt;Startkey))
01112     <span class="keywordflow">return</span> +1;
01113 
<a name="l01114"></a><a class="code" href="proto_8h.html#a23">01114</a>   <span class="keywordflow">return</span> 0;
01115 }
01116 
01119 <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a22">domain_compare_key</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *a, <span class="keyword">const</span> <span class="keywordtype">void</span> *b)
01120 {
01121   <span class="keywordflow">if</span>(*(<a class="code" href="allvars_8h.html#a45">peanokey</a> *) a &lt; *(<a class="code" href="allvars_8h.html#a45">peanokey</a> *) b)
01122     <span class="keywordflow">return</span> -1;
01123 
01124   <span class="keywordflow">if</span>(*(<a class="code" href="allvars_8h.html#a45">peanokey</a> *) a &gt; *(<a class="code" href="allvars_8h.html#a45">peanokey</a> *) b)
01125     <span class="keywordflow">return</span> +1;
01126 
<a name="l01127"></a><a class="code" href="proto_8h.html#a22">01127</a>   <span class="keywordflow">return</span> 0;
01128 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 22 15:29:40 2006 for GADGET-2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
