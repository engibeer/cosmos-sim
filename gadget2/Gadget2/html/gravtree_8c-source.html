<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GADGET-2: gravtree.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>gravtree.c</h1><a href="gravtree_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00002 <span class="preprocessor">#include &lt;string.h&gt;</span>
00003 <span class="preprocessor">#include &lt;math.h&gt;</span>
00004 <span class="preprocessor">#include &lt;float.h&gt;</span>
00005 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
00006 
00007 <span class="preprocessor">#include "<a class="code" href="allvars_8h.html">allvars.h</a>"</span>
00008 <span class="preprocessor">#include "<a class="code" href="proto_8h.html">proto.h</a>"</span>
00009 
<a name="l00027"></a><a class="code" href="proto_8h.html#a91">00027</a> <span class="keywordtype">void</span> <a class="code" href="gravtree_8c.html#a0">gravity_tree</a>(<span class="keywordtype">void</span>)
00028 {
00029   <span class="keywordtype">long</span> <span class="keywordtype">long</span> ntot;
00030   <span class="keywordtype">int</span> numnodes, nexportsum = 0;
00031   <span class="keywordtype">int</span> i, j, iter = 0;
00032   <span class="keywordtype">int</span> *numnodeslist, maxnumnodes, nexport, *numlist, *nrecv, *ndonelist;
00033   <span class="keywordtype">double</span> tstart, tend, timetree = 0, timecommsumm = 0, timeimbalance = 0, sumimbalance;
00034   <span class="keywordtype">double</span> ewaldcount;
00035   <span class="keywordtype">double</span> costtotal, ewaldtot, *costtreelist, *ewaldlist;
00036   <span class="keywordtype">double</span> maxt, sumt, *timetreelist, *timecommlist;
00037   <span class="keywordtype">double</span> fac, plb, plb_max, sumcomm;
00038 
00039 <span class="preprocessor">#ifndef NOGRAVITY</span>
00040 <span class="preprocessor"></span>  <span class="keywordtype">int</span> *noffset, *nbuffer, *nsend, *nsend_local;
00041   <span class="keywordtype">long</span> <span class="keywordtype">long</span> ntotleft;
00042   <span class="keywordtype">int</span> ndone, maxfill, ngrp;
00043   <span class="keywordtype">int</span> k, place;
00044   <span class="keywordtype">int</span> level, sendTask, recvTask;
00045   <span class="keywordtype">double</span> ax, ay, az;
00046   MPI_Status status;
00047 <span class="preprocessor">#endif</span>
00048 <span class="preprocessor"></span>
00049   <span class="comment">/* set new softening lengths */</span>
00050   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00051     <a class="code" href="gravtree_8c.html#a1">set_softenings</a>();
00052 
00053 
00054   <span class="comment">/* contruct tree if needed */</span>
00055   tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00056   <span class="keywordflow">if</span>(TreeReconstructFlag)
00057     {
00058       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00059         printf(<span class="stringliteral">"Tree construction.\n"</span>);
00060 
00061       <a class="code" href="proto_8h.html#a58">force_treebuild</a>(<a class="code" href="allvars_8c.html#a3">NumPart</a>);
00062 
00063       <a class="code" href="allvars_8c.html#a13">TreeReconstructFlag</a> = 0;
00064 
00065       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00066         printf(<span class="stringliteral">"Tree construction done.\n"</span>);
00067     }
00068   tend = <a class="code" href="proto_8h.html#a145">second</a>();
00069   <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o71">CPU_TreeConstruction</a> += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00070 
00071   costtotal = ewaldcount = 0;
00072 
00073   <span class="comment">/* Note: 'NumForceUpdate' has already been determined in find_next_sync_point_and_drift() */</span>
00074   numlist = malloc(<a class="code" href="allvars_8c.html#a1">NTask</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00075   MPI_Allgather(&amp;<a class="code" href="allvars_8c.html#a7">NumForceUpdate</a>, 1, MPI_INT, numlist, 1, MPI_INT, MPI_COMM_WORLD);
00076   <span class="keywordflow">for</span>(i = 0, ntot = 0; i &lt; NTask; i++)
00077     ntot += numlist[i];
00078   free(numlist);
00079 
00080 
00081 <span class="preprocessor">#ifndef NOGRAVITY</span>
00082 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00083     printf(<span class="stringliteral">"Begin tree force.\n"</span>);
00084 
00085 
00086 <span class="preprocessor">#ifdef SELECTIVE_NO_GRAVITY</span>
00087 <span class="preprocessor"></span>  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00088     <span class="keywordflow">if</span>(((1 &lt;&lt; <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a>) &amp; (SELECTIVE_NO_GRAVITY)))
00089       <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> = -<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> - 1;
00090 <span class="preprocessor">#endif</span>
00091 <span class="preprocessor"></span>
00092 
00093   noffset = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);        <span class="comment">/* offsets of bunches in common list */</span>
00094   nbuffer = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00095   nsend_local = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00096   nsend = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a> * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00097   ndonelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00098 
00099   i = 0;                        <span class="comment">/* beginn with this index */</span>
00100   ntotleft = ntot;              <span class="comment">/* particles left for all tasks together */</span>
00101 
00102   <span class="keywordflow">while</span>(ntotleft &gt; 0)
00103     {
00104       iter++;
00105 
00106       <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00107         nsend_local[j] = 0;
00108 
00109       <span class="comment">/* do local particles and prepare export list */</span>
00110       tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00111       <span class="keywordflow">for</span>(nexport = 0, ndone = 0; i &lt; <a class="code" href="allvars_8c.html#a3">NumPart</a> &amp;&amp; nexport &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o10">BunchSizeForce</a> - NTask; i++)
00112         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> == <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)
00113           {
00114             ndone++;
00115 
00116             <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00117               <a class="code" href="allvars_8c.html#a11">Exportflag</a>[j] = 0;
00118 <span class="preprocessor">#ifndef PMGRID</span>
00119 <span class="preprocessor"></span>            costtotal += <a class="code" href="proto_8h.html#a60">force_treeevaluate</a>(i, 0, &amp;ewaldcount);
00120 <span class="preprocessor">#else</span>
00121 <span class="preprocessor"></span>            costtotal += <a class="code" href="proto_8h.html#a65">force_treeevaluate_shortrange</a>(i, 0);
00122 <span class="preprocessor">#endif</span>
00123 <span class="preprocessor"></span>            <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00124               {
00125                 <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a11">Exportflag</a>[j])
00126                   {
00127                     <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00128                       <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[nexport].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o0">Pos</a>[k] = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[k];
00129 <span class="preprocessor">#ifdef UNEQUALSOFTENINGS</span>
00130 <span class="preprocessor"></span>                    <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[nexport].Type = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a>;
00131 <span class="preprocessor">#ifdef ADAPTIVE_GRAVSOFT_FORGAS</span>
00132 <span class="preprocessor"></span>                    <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
00133                       <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[nexport].Soft = <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
00134 <span class="preprocessor">#endif</span>
00135 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00136 <span class="preprocessor"></span>                    <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[nexport].<a class="code" href="structgravdata__in.html#o6">w</a>.<a class="code" href="structgravdata__in.html#o4">OldAcc</a> = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o7">OldAcc</a>;
00137                     <a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a>[nexport].<a class="code" href="structgravdata__index.html#o0">Task</a> = j;
00138                     <a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a>[nexport].<a class="code" href="structgravdata__index.html#o1">Index</a> = i;
00139                     <a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a>[nexport].<a class="code" href="structgravdata__index.html#o2">SortIndex</a> = nexport;
00140                     nexport++;
00141                     nexportsum++;
00142                     nsend_local[j]++;
00143                   }
00144               }
00145           }
00146       tend = <a class="code" href="proto_8h.html#a145">second</a>();
00147       timetree += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00148 
00149       qsort(<a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a>, nexport, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__index.html">gravdata_index</a>), <a class="code" href="gravtree_8c.html#a2">grav_tree_compare_key</a>);
00150 
00151       <span class="keywordflow">for</span>(j = 0; j &lt; nexport; j++)
00152         <a class="code" href="allvars_8c.html#a66">GravDataIn</a>[j] = <a class="code" href="allvars_8c.html#a67">GravDataGet</a>[<a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a>[j].<a class="code" href="structgravdata__index.html#o2">SortIndex</a>];
00153 
00154       <span class="keywordflow">for</span>(j = 1, noffset[0] = 0; j &lt; NTask; j++)
00155         noffset[j] = noffset[j - 1] + nsend_local[j - 1];
00156 
00157       tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00158 
00159       MPI_Allgather(nsend_local, <a class="code" href="allvars_8c.html#a1">NTask</a>, MPI_INT, nsend, <a class="code" href="allvars_8c.html#a1">NTask</a>, MPI_INT, MPI_COMM_WORLD);
00160 
00161       tend = <a class="code" href="proto_8h.html#a145">second</a>();
00162       timeimbalance += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00163 
00164       <span class="comment">/* now do the particles that need to be exported */</span>
00165 
00166       <span class="keywordflow">for</span>(level = 1; level &lt; (1 &lt;&lt; PTask); level++)
00167         {
00168           tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00169           <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00170             nbuffer[j] = 0;
00171           <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; PTask); ngrp++)
00172             {
00173               maxfill = 0;
00174               <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00175                 {
00176                   <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00177                     <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j])
00178                       maxfill = nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00179                 }
00180               <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o10">BunchSizeForce</a>)
00181                 <span class="keywordflow">break</span>;
00182 
00183               sendTask = ThisTask;
00184               recvTask = <a class="code" href="allvars_8c.html#a0">ThisTask</a> ^ ngrp;
00185 
00186               <span class="keywordflow">if</span>(recvTask &lt; NTask)
00187                 {
00188                   <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a0">ThisTask</a> * <a class="code" href="allvars_8c.html#a1">NTask</a> + recvTask] &gt; 0 || nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + ThisTask] &gt; 0)
00189                     {
00190                       <span class="comment">/* get the particles */</span>
00191                       MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a66">GravDataIn</a>[noffset[recvTask]],
00192                                    nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__in.html">gravdata_in</a>), MPI_BYTE,
00193                                    recvTask, <a class="code" href="tags_8h.html#a8">TAG_GRAV_A</a>,
00194                                    &amp;<a class="code" href="allvars_8c.html#a67">GravDataGet</a>[nbuffer[<a class="code" href="allvars_8c.html#a0">ThisTask</a>]],
00195                                    nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + <a class="code" href="allvars_8c.html#a0">ThisTask</a>] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> gravdata_in), MPI_BYTE,
00196                                    recvTask, <a class="code" href="tags_8h.html#a8">TAG_GRAV_A</a>, MPI_COMM_WORLD, &amp;status);
00197                     }
00198                 }
00199 
00200               <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00201                 <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00202                   nbuffer[j] += nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00203             }
00204           tend = <a class="code" href="proto_8h.html#a145">second</a>();
00205           timecommsumm += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00206 
00207 
00208           tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00209           <span class="keywordflow">for</span>(j = 0; j &lt; nbuffer[ThisTask]; j++)
00210             {
00211 <span class="preprocessor">#ifndef PMGRID</span>
00212 <span class="preprocessor"></span>              costtotal += <a class="code" href="proto_8h.html#a60">force_treeevaluate</a>(j, 1, &amp;ewaldcount);
00213 <span class="preprocessor">#else</span>
00214 <span class="preprocessor"></span>              costtotal += <a class="code" href="proto_8h.html#a65">force_treeevaluate_shortrange</a>(j, 1);
00215 <span class="preprocessor">#endif</span>
00216 <span class="preprocessor"></span>            }
00217           tend = <a class="code" href="proto_8h.html#a145">second</a>();
00218           timetree += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00219 
00220           tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00221           MPI_Barrier(MPI_COMM_WORLD);
00222           tend = <a class="code" href="proto_8h.html#a145">second</a>();
00223           timeimbalance += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00224 
00225           <span class="comment">/* get the result */</span>
00226           tstart = <a class="code" href="proto_8h.html#a145">second</a>();
00227           <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00228             nbuffer[j] = 0;
00229           <span class="keywordflow">for</span>(ngrp = level; ngrp &lt; (1 &lt;&lt; PTask); ngrp++)
00230             {
00231               maxfill = 0;
00232               <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00233                 {
00234                   <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00235                     <span class="keywordflow">if</span>(maxfill &lt; nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j])
00236                       maxfill = nbuffer[j] + nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00237                 }
00238               <span class="keywordflow">if</span>(maxfill &gt;= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o10">BunchSizeForce</a>)
00239                 <span class="keywordflow">break</span>;
00240 
00241               sendTask = ThisTask;
00242               recvTask = <a class="code" href="allvars_8c.html#a0">ThisTask</a> ^ ngrp;
00243               <span class="keywordflow">if</span>(recvTask &lt; NTask)
00244                 {
00245                   <span class="keywordflow">if</span>(nsend[<a class="code" href="allvars_8c.html#a0">ThisTask</a> * <a class="code" href="allvars_8c.html#a1">NTask</a> + recvTask] &gt; 0 || nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + ThisTask] &gt; 0)
00246                     {
00247                       <span class="comment">/* send the results */</span>
00248                       MPI_Sendrecv(&amp;<a class="code" href="allvars_8c.html#a68">GravDataResult</a>[nbuffer[<a class="code" href="allvars_8c.html#a0">ThisTask</a>]],
00249                                    nsend[recvTask * <a class="code" href="allvars_8c.html#a1">NTask</a> + <a class="code" href="allvars_8c.html#a0">ThisTask</a>] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structgravdata__in.html">gravdata_in</a>),
00250                                    MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a9">TAG_GRAV_B</a>,
00251                                    &amp;<a class="code" href="allvars_8c.html#a69">GravDataOut</a>[noffset[recvTask]],
00252                                    nsend_local[recvTask] * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> gravdata_in),
00253                                    MPI_BYTE, recvTask, <a class="code" href="tags_8h.html#a9">TAG_GRAV_B</a>, MPI_COMM_WORLD, &amp;status);
00254 
00255                       <span class="comment">/* add the result to the particles */</span>
00256                       <span class="keywordflow">for</span>(j = 0; j &lt; nsend_local[recvTask]; j++)
00257                         {
00258                           place = <a class="code" href="allvars_8c.html#a70">GravDataIndexTable</a>[noffset[recvTask] + j].<a class="code" href="structgravdata__index.html#o1">Index</a>;
00259 
00260                           <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00261                             <a class="code" href="allvars_8c.html#a51">P</a>[place].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[k] += <a class="code" href="allvars_8c.html#a69">GravDataOut</a>[j + noffset[recvTask]].<a class="code" href="structgravdata__in.html#o3">u</a>.<a class="code" href="structgravdata__in.html#o1">Acc</a>[k];
00262 
00263                           <a class="code" href="allvars_8c.html#a51">P</a>[place].<a class="code" href="structparticle__data.html#o12">GravCost</a> += <a class="code" href="allvars_8c.html#a69">GravDataOut</a>[j + noffset[recvTask]].<a class="code" href="structgravdata__in.html#o6">w</a>.<a class="code" href="structgravdata__in.html#o5">Ninteractions</a>;
00264                         }
00265                     }
00266                 }
00267 
00268               <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00269                 <span class="keywordflow">if</span>((j ^ ngrp) &lt; NTask)
00270                   nbuffer[j] += nsend[(j ^ ngrp) * <a class="code" href="allvars_8c.html#a1">NTask</a> + j];
00271             }
00272           tend = <a class="code" href="proto_8h.html#a145">second</a>();
00273           timecommsumm += <a class="code" href="system_8c.html#a3">timediff</a>(tstart, tend);
00274 
00275           level = ngrp - 1;
00276         }
00277 
00278       MPI_Allgather(&amp;ndone, 1, MPI_INT, ndonelist, 1, MPI_INT, MPI_COMM_WORLD);
00279       <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00280         ntotleft -= ndonelist[j];
00281     }
00282 
00283   free(ndonelist);
00284   free(nsend);
00285   free(nsend_local);
00286   free(nbuffer);
00287   free(noffset);
00288 
00289   <span class="comment">/* now add things for comoving integration */</span>
00290 
00291 <span class="preprocessor">#ifndef PERIODIC</span>
00292 <span class="preprocessor"></span><span class="preprocessor">#ifndef PMGRID</span>
00293 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00294     {
00295       fac = 0.5 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o36">Omega0</a> / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o24">G</a>;
00296 
00297       <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00298         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> == <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)
00299           <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
00300             <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[j] += fac * <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[j];
00301     }
00302 <span class="preprocessor">#endif</span>
00303 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00304 <span class="preprocessor"></span>
00305   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00306     <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> == <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)
00307       {
00308 <span class="preprocessor">#ifdef PMGRID</span>
00309 <span class="preprocessor"></span>        ax = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[0] + <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o4">GravPM</a>[0] / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o24">G</a>;
00310         ay = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[1] + <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o4">GravPM</a>[1] / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o24">G</a>;
00311         az = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[2] + <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o4">GravPM</a>[2] / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o24">G</a>;
00312 <span class="preprocessor">#else</span>
00313 <span class="preprocessor"></span>        ax = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[0];
00314         ay = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[1];
00315         az = <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[2];
00316 <span class="preprocessor">#endif</span>
00317 <span class="preprocessor"></span>        <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o7">OldAcc</a> = sqrt(ax * ax + ay * ay + az * az);
00318       }
00319 
00320 
00321   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o43">TypeOfOpeningCriterion</a> == 1)
00322     <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o89">ErrTolTheta</a> = 0;        <span class="comment">/* This will switch to the relative opening criterion for the following force computations */</span>
00323 
00324   <span class="comment">/*  muliply by G */</span>
00325   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00326     <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> == <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)
00327       <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
00328         <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[j] *= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o24">G</a>;
00329 
00330 
00331   <span class="comment">/* Finally, the following factor allows a computation of a cosmological simulation </span>
00332 <span class="comment">     with vacuum energy in physical coordinates */</span>
00333 <span class="preprocessor">#ifndef PERIODIC</span>
00334 <span class="preprocessor"></span><span class="preprocessor">#ifndef PMGRID</span>
00335 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a> == 0)
00336     {
00337       fac = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o37">OmegaLambda</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o35">Hubble</a>;
00338 
00339       <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00340         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> == <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)
00341           <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
00342             <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[j] += fac * <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o0">Pos</a>[j];
00343     }
00344 <span class="preprocessor">#endif</span>
00345 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00346 <span class="preprocessor"></span>
00347 <span class="preprocessor">#ifdef SELECTIVE_NO_GRAVITY</span>
00348 <span class="preprocessor"></span>  <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00349     <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> &lt; 0)
00350       <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> = -<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> - 1;
00351 <span class="preprocessor">#endif</span>
00352 <span class="preprocessor"></span>
00353   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00354     printf(<span class="stringliteral">"tree is done.\n"</span>);
00355 
00356 <span class="preprocessor">#else </span><span class="comment">/* gravity is switched off */</span>
00357 
00358   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00359     <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> == <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>)
00360       <span class="keywordflow">for</span>(j = 0; j &lt; 3; j++)
00361         <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[j] = 0;
00362 
00363 <span class="preprocessor">#endif</span>
00364 <span class="preprocessor"></span>
00365 
00366 
00367 
00368   <span class="comment">/* Now the force computation is finished */</span>
00369 
00370   <span class="comment">/*  gather some diagnostic information */</span>
00371 
00372   timetreelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00373   timecommlist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00374   costtreelist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00375   numnodeslist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00376   ewaldlist = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00377   nrecv = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a1">NTask</a>);
00378 
00379   numnodes = Numnodestree;
00380 
00381   MPI_Gather(&amp;costtotal, 1, MPI_DOUBLE, costtreelist, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD);
00382   MPI_Gather(&amp;numnodes, 1, MPI_INT, numnodeslist, 1, MPI_INT, 0, MPI_COMM_WORLD);
00383   MPI_Gather(&amp;timetree, 1, MPI_DOUBLE, timetreelist, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD);
00384   MPI_Gather(&amp;timecommsumm, 1, MPI_DOUBLE, timecommlist, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD);
00385   MPI_Gather(&amp;<a class="code" href="allvars_8c.html#a3">NumPart</a>, 1, MPI_INT, nrecv, 1, MPI_INT, 0, MPI_COMM_WORLD);
00386   MPI_Gather(&amp;ewaldcount, 1, MPI_DOUBLE, ewaldlist, 1, MPI_DOUBLE, 0, MPI_COMM_WORLD);
00387   MPI_Reduce(&amp;nexportsum, &amp;nexport, 1, MPI_INT, MPI_SUM, 0, MPI_COMM_WORLD);
00388   MPI_Reduce(&amp;timeimbalance, &amp;sumimbalance, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
00389 
00390   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00391     {
00392       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o22">TotNumOfForces</a> += ntot;
00393 
00394       fprintf(<a class="code" href="allvars_8c.html#a43">FdTimings</a>, <span class="stringliteral">"Step= %d  t= %g  dt= %g \n"</span>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o53">NumCurrentTiStep</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o56">TimeStep</a>);
00395       fprintf(<a class="code" href="allvars_8c.html#a43">FdTimings</a>, <span class="stringliteral">"Nf= %d%09d  total-Nf= %d%09d  ex-frac= %g  iter= %d\n"</span>,
00396               (<span class="keywordtype">int</span>) (ntot / 1000000000), (<span class="keywordtype">int</span>) (ntot % 1000000000),
00397               (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o22">TotNumOfForces</a> / 1000000000), (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o22">TotNumOfForces</a> % 1000000000),
00398               nexport / ((<span class="keywordtype">double</span>) ntot), iter);
00399       <span class="comment">/* note: on Linux, the 8-byte integer could be printed with the format identifier "%qd", but doesn't work on AIX */</span>
00400 
00401       fac = <a class="code" href="allvars_8c.html#a1">NTask</a> / ((double) <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a>);
00402 
00403       <span class="keywordflow">for</span>(i = 0, maxt = timetreelist[0], sumt = 0, plb_max = 0,
00404           maxnumnodes = 0, costtotal = 0, sumcomm = 0, ewaldtot = 0; i &lt; NTask; i++)
00405         {
00406           costtotal += costtreelist[i];
00407 
00408           sumcomm += timecommlist[i];
00409 
00410           <span class="keywordflow">if</span>(maxt &lt; timetreelist[i])
00411             maxt = timetreelist[i];
00412           sumt += timetreelist[i];
00413 
00414           plb = nrecv[i] * fac;
00415 
00416           <span class="keywordflow">if</span>(plb &gt; plb_max)
00417             plb_max = plb;
00418 
00419           <span class="keywordflow">if</span>(numnodeslist[i] &gt; maxnumnodes)
00420             maxnumnodes = numnodeslist[i];
00421 
00422           ewaldtot += ewaldlist[i];
00423         }
00424       fprintf(<a class="code" href="allvars_8c.html#a43">FdTimings</a>, <span class="stringliteral">"work-load balance: %g  max=%g avg=%g PE0=%g\n"</span>,
00425               maxt / (sumt / <a class="code" href="allvars_8c.html#a1">NTask</a>), maxt, sumt / <a class="code" href="allvars_8c.html#a1">NTask</a>, timetreelist[0]);
00426       fprintf(<a class="code" href="allvars_8c.html#a43">FdTimings</a>, <span class="stringliteral">"particle-load balance: %g\n"</span>, plb_max);
00427       fprintf(<a class="code" href="allvars_8c.html#a43">FdTimings</a>, <span class="stringliteral">"max. nodes: %d, filled: %g\n"</span>, maxnumnodes,
00428               maxnumnodes / (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o15">TreeAllocFactor</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>));
00429       fprintf(<a class="code" href="allvars_8c.html#a43">FdTimings</a>, <span class="stringliteral">"part/sec=%g | %g  ia/part=%g (%g)\n"</span>, ntot / (sumt + 1.0e-20),
00430               ntot / (maxt * <a class="code" href="allvars_8c.html#a1">NTask</a>), ((<span class="keywordtype">double</span>) (costtotal)) / ntot, ((<span class="keywordtype">double</span>) ewaldtot) / ntot);
00431       fprintf(<a class="code" href="allvars_8c.html#a43">FdTimings</a>, <span class="stringliteral">"\n"</span>);
00432 
00433       fflush(<a class="code" href="allvars_8c.html#a43">FdTimings</a>);
00434 
00435       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o72">CPU_TreeWalk</a> += sumt / NTask;
00436       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o79">CPU_Imbalance</a> += sumimbalance / NTask;
00437       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o78">CPU_CommSum</a> += sumcomm / NTask;
00438     }
00439 
00440   free(nrecv);
00441   free(ewaldlist);
00442   free(numnodeslist);
00443   free(costtreelist);
00444   free(timecommlist);
00445   free(timetreelist);
00446 }
00447 
00448 
00449 
<a name="l00454"></a><a class="code" href="proto_8h.html#a148">00454</a> <span class="keywordtype">void</span> <a class="code" href="gravtree_8c.html#a1">set_softenings</a>(<span class="keywordtype">void</span>)
00455 {
00456   <span class="keywordtype">int</span> i;
00457 
00458   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00459     {
00460       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o99">SofteningGas</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> &gt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o105">SofteningGasMaxPhys</a>)
00461         <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[0] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o105">SofteningGasMaxPhys</a> / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>;
00462       <span class="keywordflow">else</span>
00463         <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[0] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o99">SofteningGas</a>;
00464       
00465       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o100">SofteningHalo</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> &gt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o106">SofteningHaloMaxPhys</a>)
00466         <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[1] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o106">SofteningHaloMaxPhys</a> / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>;
00467       <span class="keywordflow">else</span>
00468         <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[1] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o100">SofteningHalo</a>;
00469       
00470       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o101">SofteningDisk</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> &gt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o107">SofteningDiskMaxPhys</a>)
00471         <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[2] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o107">SofteningDiskMaxPhys</a> / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>;
00472       <span class="keywordflow">else</span>
00473         <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[2] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o101">SofteningDisk</a>;
00474       
00475       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o102">SofteningBulge</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> &gt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o108">SofteningBulgeMaxPhys</a>)
00476         <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[3] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o108">SofteningBulgeMaxPhys</a> / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>;
00477       <span class="keywordflow">else</span>
00478         <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[3] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o102">SofteningBulge</a>;
00479       
00480       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o103">SofteningStars</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> &gt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o109">SofteningStarsMaxPhys</a>)
00481         <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[4] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o109">SofteningStarsMaxPhys</a> / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>;
00482       <span class="keywordflow">else</span>
00483         <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[4] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o103">SofteningStars</a>;
00484       
00485       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o104">SofteningBndry</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> &gt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o110">SofteningBndryMaxPhys</a>)
00486         <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[5] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o110">SofteningBndryMaxPhys</a> / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>;
00487       <span class="keywordflow">else</span>
00488         <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[5] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o104">SofteningBndry</a>;
00489     }
00490   <span class="keywordflow">else</span>
00491     {
00492       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[0] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o99">SofteningGas</a>;
00493       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[1] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o100">SofteningHalo</a>;
00494       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[2] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o101">SofteningDisk</a>;
00495       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[3] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o102">SofteningBulge</a>;
00496       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[4] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o103">SofteningStars</a>;
00497       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[5] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o104">SofteningBndry</a>;
00498     }
00499 
00500   <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
00501     <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[i] = 2.8 * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o111">SofteningTable</a>[i];
00502 
00503   <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o98">MinGasHsml</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o97">MinGasHsmlFractional</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o112">ForceSoftening</a>[0];
00504 }
00505 
00506 
<a name="l00511"></a><a class="code" href="proto_8h.html#a89">00511</a> <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a89">grav_tree_compare_key</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *a, <span class="keyword">const</span> <span class="keywordtype">void</span> *b)
00512 {
00513   <span class="keywordflow">if</span>(((<span class="keyword">struct </span><a class="code" href="structgravdata__index.html">gravdata_index</a> *) a)-&gt;Task &lt; (((<span class="keyword">struct </span><a class="code" href="structgravdata__index.html">gravdata_index</a> *) b)-&gt;Task))
00514     <span class="keywordflow">return</span> -1;
00515 
00516   <span class="keywordflow">if</span>(((<span class="keyword">struct </span><a class="code" href="structgravdata__index.html">gravdata_index</a> *) a)-&gt;Task &gt; (((<span class="keyword">struct </span><a class="code" href="structgravdata__index.html">gravdata_index</a> *) b)-&gt;Task))
00517     <span class="keywordflow">return</span> +1;
00518 
00519   <span class="keywordflow">return</span> 0;
00520 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 22 15:29:40 2006 for GADGET-2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
