<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GADGET-2: peano.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>peano.c</h1><a href="peano_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00002 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00003 <span class="preprocessor">#include &lt;string.h&gt;</span>
00004 <span class="preprocessor">#include &lt;math.h&gt;</span>
00005 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
00006 
00007 <span class="preprocessor">#include "<a class="code" href="allvars_8h.html">allvars.h</a>"</span>
00008 <span class="preprocessor">#include "<a class="code" href="proto_8h.html">proto.h</a>"</span>
00009 
00019 <span class="keyword">static</span> <span class="keyword">struct </span>peano_hilbert_data
00020 {
00021   <a class="code" href="allvars_8h.html#a45">peanokey</a> key;
00022   <span class="keywordtype">int</span> index;
00023 }
00024  *mp;
00025 
00026 <span class="keyword">static</span> <span class="keywordtype">int</span> *Id;
00027 
00028 
<a name="l00034"></a><a class="code" href="proto_8h.html#a120">00034</a> <span class="keywordtype">void</span> <a class="code" href="peano_8c.html#a12">peano_hilbert_order</a>(<span class="keywordtype">void</span>)
00035 {
00036   <span class="keywordtype">int</span> i;
00037 
00038   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00039     printf(<span class="stringliteral">"begin Peano-Hilbert order...\n"</span>);
00040 
00041   <span class="keywordflow">if</span>(N_gas)
00042     {
00043       mp = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> peano_hilbert_data) * <a class="code" href="allvars_8c.html#a4">N_gas</a>);
00044       Id = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="allvars_8c.html#a4">N_gas</a>);
00045 
00046       <span class="keywordflow">for</span>(i = 0; i &lt; N_gas; i++)
00047         {
00048           mp[i].index = i;
00049           mp[i].key = <a class="code" href="allvars_8c.html#a34">Key</a>[i];
00050         }
00051 
00052       qsort(mp, <a class="code" href="allvars_8c.html#a4">N_gas</a>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> peano_hilbert_data), <a class="code" href="peano_8c.html#a13">compare_key</a>);
00053 
00054       <span class="keywordflow">for</span>(i = 0; i &lt; N_gas; i++)
00055         Id[mp[i].index] = i;
00056 
00057       <a class="code" href="peano_8c.html#a14">reorder_gas</a>();
00058 
00059       free(Id);
00060       free(mp);
00061     }
00062 
00063 
00064   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a3">NumPart</a> - <a class="code" href="allvars_8c.html#a4">N_gas</a> &gt; 0)
00065     {
00066       mp = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> peano_hilbert_data) * (<a class="code" href="allvars_8c.html#a3">NumPart</a> - <a class="code" href="allvars_8c.html#a4">N_gas</a>));
00067       mp -= (N_gas);
00068 
00069       Id = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * (<a class="code" href="allvars_8c.html#a3">NumPart</a> - <a class="code" href="allvars_8c.html#a4">N_gas</a>));
00070       Id -= (N_gas);
00071 
00072       <span class="keywordflow">for</span>(i = N_gas; i &lt; NumPart; i++)
00073         {
00074           mp[i].index = i;
00075           mp[i].key = <a class="code" href="allvars_8c.html#a34">Key</a>[i];
00076         }
00077 
00078       qsort(mp + <a class="code" href="allvars_8c.html#a4">N_gas</a>, <a class="code" href="allvars_8c.html#a3">NumPart</a> - <a class="code" href="allvars_8c.html#a4">N_gas</a>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> peano_hilbert_data), <a class="code" href="peano_8c.html#a13">compare_key</a>);
00079 
00080       <span class="keywordflow">for</span>(i = N_gas; i &lt; NumPart; i++)
00081         Id[mp[i].index] = i;
00082 
00083       <a class="code" href="peano_8c.html#a15">reorder_particles</a>();
00084 
00085       Id += N_gas;
00086       free(Id);
00087       mp += N_gas;
00088       free(mp);
00089     }
00090 
00091   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00092     printf(<span class="stringliteral">"Peano-Hilbert done.\n"</span>);
00093 }
00094 
00095 
<a name="l00098"></a><a class="code" href="proto_8h.html#a9">00098</a> <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a9">compare_key</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *a, <span class="keyword">const</span> <span class="keywordtype">void</span> *b)
00099 {
00100   <span class="keywordflow">if</span>(((<span class="keyword">struct </span>peano_hilbert_data *) a)-&gt;key &lt; (((<span class="keyword">struct </span>peano_hilbert_data *) b)-&gt;key))
00101     <span class="keywordflow">return</span> -1;
00102 
00103   <span class="keywordflow">if</span>(((<span class="keyword">struct </span>peano_hilbert_data *) a)-&gt;key &gt; (((<span class="keyword">struct </span>peano_hilbert_data *) b)-&gt;key))
00104     <span class="keywordflow">return</span> +1;
00105 
00106   <span class="keywordflow">return</span> 0;
00107 }
00108 
00109 
<a name="l00117"></a><a class="code" href="proto_8h.html#a140">00117</a> <span class="keywordtype">void</span> <a class="code" href="peano_8c.html#a14">reorder_gas</a>(<span class="keywordtype">void</span>)
00118 {
00119   <span class="keywordtype">int</span> i;
00120   <span class="keyword">struct </span><a class="code" href="structparticle__data.html">particle_data</a> Psave, Psource;
00121   <span class="keyword">struct </span><a class="code" href="structsph__particle__data.html">sph_particle_data</a> SphPsave, SphPsource;
00122   <span class="keywordtype">int</span> idsource, idsave, dest;
00123 
00124   <span class="keywordflow">for</span>(i = 0; i &lt; N_gas; i++)
00125     {
00126       <span class="keywordflow">if</span>(Id[i] != i)
00127         {
00128           Psource = <a class="code" href="allvars_8c.html#a51">P</a>[i];
00129           SphPsource = <a class="code" href="allvars_8c.html#a53">SphP</a>[i];
00130 
00131           idsource = Id[i];
00132           dest = Id[i];
00133 
00134           <span class="keywordflow">do</span>
00135             {
00136               Psave = <a class="code" href="allvars_8c.html#a51">P</a>[dest];
00137               SphPsave = <a class="code" href="allvars_8c.html#a53">SphP</a>[dest];
00138               idsave = Id[dest];
00139 
00140               <a class="code" href="allvars_8c.html#a51">P</a>[dest] = Psource;
00141               <a class="code" href="allvars_8c.html#a53">SphP</a>[dest] = SphPsource;
00142               Id[dest] = idsource;
00143 
00144               <span class="keywordflow">if</span>(dest == i)
00145                 <span class="keywordflow">break</span>;
00146 
00147               Psource = Psave;
00148               SphPsource = SphPsave;
00149               idsource = idsave;
00150 
00151               dest = idsource;
00152             }
00153           <span class="keywordflow">while</span>(1);
00154         }
00155     }
00156 }
00157 
00158 
<a name="l00166"></a><a class="code" href="proto_8h.html#a141">00166</a> <span class="keywordtype">void</span> <a class="code" href="peano_8c.html#a15">reorder_particles</a>(<span class="keywordtype">void</span>)
00167 {
00168   <span class="keywordtype">int</span> i;
00169   <span class="keyword">struct </span><a class="code" href="structparticle__data.html">particle_data</a> Psave, Psource;
00170   <span class="keywordtype">int</span> idsource, idsave, dest;
00171 
00172   <span class="keywordflow">for</span>(i = N_gas; i &lt; NumPart; i++)
00173     {
00174       <span class="keywordflow">if</span>(Id[i] != i)
00175         {
00176           Psource = <a class="code" href="allvars_8c.html#a51">P</a>[i];
00177           idsource = Id[i];
00178 
00179           dest = Id[i];
00180 
00181           <span class="keywordflow">do</span>
00182             {
00183               Psave = <a class="code" href="allvars_8c.html#a51">P</a>[dest];
00184               idsave = Id[dest];
00185 
00186               <a class="code" href="allvars_8c.html#a51">P</a>[dest] = Psource;
00187               Id[dest] = idsource;
00188 
00189               <span class="keywordflow">if</span>(dest == i)
00190                 <span class="keywordflow">break</span>;
00191 
00192               Psource = Psave;
00193               idsource = idsave;
00194 
00195               dest = idsource;
00196             }
00197           <span class="keywordflow">while</span>(1);
00198         }
00199     }
00200 }
00201 
00202 
00203 
00204 
00205 
00206 
00207 <span class="keyword">static</span> <span class="keywordtype">int</span> quadrants[24][2][2][2] = {
00208   <span class="comment">/* rotx=0, roty=0-3 */</span>
00209   {{{0, 7}, {1, 6}}, {{3, 4}, {2, 5}}},
00210   {{{7, 4}, {6, 5}}, {{0, 3}, {1, 2}}},
00211   {{{4, 3}, {5, 2}}, {{7, 0}, {6, 1}}},
00212   {{{3, 0}, {2, 1}}, {{4, 7}, {5, 6}}},
00213   <span class="comment">/* rotx=1, roty=0-3 */</span>
00214   {{{1, 0}, {6, 7}}, {{2, 3}, {5, 4}}},
00215   {{{0, 3}, {7, 4}}, {{1, 2}, {6, 5}}},
00216   {{{3, 2}, {4, 5}}, {{0, 1}, {7, 6}}},
00217   {{{2, 1}, {5, 6}}, {{3, 0}, {4, 7}}},
00218   <span class="comment">/* rotx=2, roty=0-3 */</span>
00219   {{{6, 1}, {7, 0}}, {{5, 2}, {4, 3}}},
00220   {{{1, 2}, {0, 3}}, {{6, 5}, {7, 4}}},
00221   {{{2, 5}, {3, 4}}, {{1, 6}, {0, 7}}},
00222   {{{5, 6}, {4, 7}}, {{2, 1}, {3, 0}}},
00223   <span class="comment">/* rotx=3, roty=0-3 */</span>
00224   {{{7, 6}, {0, 1}}, {{4, 5}, {3, 2}}},
00225   {{{6, 5}, {1, 2}}, {{7, 4}, {0, 3}}},
00226   {{{5, 4}, {2, 3}}, {{6, 7}, {1, 0}}},
00227   {{{4, 7}, {3, 0}}, {{5, 6}, {2, 1}}},
00228   <span class="comment">/* rotx=4, roty=0-3 */</span>
00229   {{{6, 7}, {5, 4}}, {{1, 0}, {2, 3}}},
00230   {{{7, 0}, {4, 3}}, {{6, 1}, {5, 2}}},
00231   {{{0, 1}, {3, 2}}, {{7, 6}, {4, 5}}},
00232   {{{1, 6}, {2, 5}}, {{0, 7}, {3, 4}}},
00233   <span class="comment">/* rotx=5, roty=0-3 */</span>
00234   {{{2, 3}, {1, 0}}, {{5, 4}, {6, 7}}},
00235   {{{3, 4}, {0, 7}}, {{2, 5}, {1, 6}}},
00236   {{{4, 5}, {7, 6}}, {{3, 2}, {0, 1}}},
00237   {{{5, 2}, {6, 1}}, {{4, 3}, {7, 0}}}
00238 };
00239 
00240 
00241 <span class="keyword">static</span> <span class="keywordtype">int</span> rotxmap_table[24] = { 4, 5, 6, 7, 8, 9, 10, 11,
00242   12, 13, 14, 15, 0, 1, 2, 3, 17, 18, 19, 16, 23, 20, 21, 22
00243 };
00244 
00245 <span class="keyword">static</span> <span class="keywordtype">int</span> rotymap_table[24] = { 1, 2, 3, 0, 16, 17, 18, 19,
00246   11, 8, 9, 10, 22, 23, 20, 21, 14, 15, 12, 13, 4, 5, 6, 7
00247 };
00248 
00249 <span class="keyword">static</span> <span class="keywordtype">int</span> rotx_table[8] = { 3, 0, 0, 2, 2, 0, 0, 1 };
00250 <span class="keyword">static</span> <span class="keywordtype">int</span> roty_table[8] = { 0, 1, 1, 2, 2, 3, 3, 0 };
00251 
00252 <span class="keyword">static</span> <span class="keywordtype">int</span> sense_table[8] = { -1, -1, -1, +1, +1, -1, -1, -1 };
00253 
00254 <span class="keyword">static</span> <span class="keywordtype">int</span> flag_quadrants_inverse = 1;
00255 <span class="keyword">static</span> <span class="keywordtype">char</span> quadrants_inverse_x[24][8];
00256 <span class="keyword">static</span> <span class="keywordtype">char</span> quadrants_inverse_y[24][8];
00257 <span class="keyword">static</span> <span class="keywordtype">char</span> quadrants_inverse_z[24][8];
00258 
00259 
<a name="l00263"></a><a class="code" href="proto_8h.html#a119">00263</a> <a class="code" href="allvars_8h.html#a45">peanokey</a> <a class="code" href="proto_8h.html#a119">peano_hilbert_key</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> z, <span class="keywordtype">int</span> bits)
00264 {
00265   <span class="keywordtype">int</span> i, quad, bitx, bity, bitz;
00266   <span class="keywordtype">int</span> mask, rotation, rotx, roty, sense;
00267   <a class="code" href="allvars_8h.html#a45">peanokey</a> key;
00268 
00269 
00270   mask = 1 &lt;&lt; (bits - 1);
00271   key = 0;
00272   rotation = 0;
00273   sense = 1;
00274 
00275 
00276   <span class="keywordflow">for</span>(i = 0; i &lt; bits; i++, mask &gt;&gt;= 1)
00277     {
00278       bitx = (x &amp; mask) ? 1 : 0;
00279       bity = (y &amp; mask) ? 1 : 0;
00280       bitz = (z &amp; mask) ? 1 : 0;
00281 
00282       quad = quadrants[rotation][bitx][bity][bitz];
00283 
00284       key &lt;&lt;= 3;
00285       key += (sense == 1) ? (quad) : (7 - quad);
00286 
00287       rotx = rotx_table[quad];
00288       roty = roty_table[quad];
00289       sense *= sense_table[quad];
00290 
00291       <span class="keywordflow">while</span>(rotx &gt; 0)
00292         {
00293           rotation = rotxmap_table[rotation];
00294           rotx--;
00295         }
00296 
00297       <span class="keywordflow">while</span>(roty &gt; 0)
00298         {
00299           rotation = rotymap_table[rotation];
00300           roty--;
00301         }
00302     }
00303 
00304   <span class="keywordflow">return</span> key;
00305 }
00306 
00307 
<a name="l00313"></a><a class="code" href="peano_8c.html#a17">00313</a> <span class="keywordtype">void</span> <a class="code" href="peano_8c.html#a17">peano_hilbert_key_inverse</a>(peanokey key, <span class="keywordtype">int</span> bits, <span class="keywordtype">int</span> *x, <span class="keywordtype">int</span> *y, <span class="keywordtype">int</span> *z)
00314 {
00315   <span class="keywordtype">int</span> i, keypart, bitx, bity, bitz, mask, quad, rotation, shift;
00316   <span class="keywordtype">char</span> sense, rotx, roty;
00317 
00318   <span class="keywordflow">if</span>(flag_quadrants_inverse)
00319     {
00320       flag_quadrants_inverse = 0;
00321       <span class="keywordflow">for</span>(rotation = 0; rotation &lt; 24; rotation++)
00322         <span class="keywordflow">for</span>(bitx = 0; bitx &lt; 2; bitx++)
00323           <span class="keywordflow">for</span>(bity = 0; bity &lt; 2; bity++)
00324             <span class="keywordflow">for</span>(bitz = 0; bitz &lt; 2; bitz++)
00325               {
00326                 quad = quadrants[rotation][bitx][bity][bitz];
00327                 quadrants_inverse_x[rotation][quad] = bitx;
00328                 quadrants_inverse_y[rotation][quad] = bity;
00329                 quadrants_inverse_z[rotation][quad] = bitz;
00330               }
00331     }
00332 
00333   shift = 3 * (bits - 1);
00334   mask = 7 &lt;&lt; shift;
00335 
00336   rotation = 0;
00337   sense = 1;
00338 
00339   *x = *y = *z = 0;
00340 
00341   <span class="keywordflow">for</span>(i = 0; i &lt; bits; i++, mask &gt;&gt;= 3, shift -= 3)
00342     {
00343       keypart = (key &amp; mask) &gt;&gt; shift;
00344 
00345       quad = (sense == 1) ? (keypart) : (7 - keypart);
00346 
00347       *x = (*x &lt;&lt; 1) + quadrants_inverse_x[rotation][quad];
00348       *y = (*y &lt;&lt; 1) + quadrants_inverse_y[rotation][quad];
00349       *z = (*z &lt;&lt; 1) + quadrants_inverse_z[rotation][quad];
00350 
00351       rotx = rotx_table[quad];
00352       roty = roty_table[quad];
00353       sense *= sense_table[quad];
00354 
00355       <span class="keywordflow">while</span>(rotx &gt; 0)
00356         {
00357           rotation = rotxmap_table[rotation];
00358           rotx--;
00359         }
00360 
00361       <span class="keywordflow">while</span>(roty &gt; 0)
00362         {
00363           rotation = rotymap_table[rotation];
00364           roty--;
00365         }
00366     }
00367 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 22 15:29:41 2006 for GADGET-2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
