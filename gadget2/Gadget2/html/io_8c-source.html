<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GADGET-2: io.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>io.c</h1><a href="io_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00002 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00003 <span class="preprocessor">#include &lt;string.h&gt;</span>
00004 <span class="preprocessor">#include &lt;math.h&gt;</span>
00005 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
00006 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00007 
00008 <span class="preprocessor">#ifdef HAVE_HDF5</span>
00009 <span class="preprocessor"></span><span class="preprocessor">#include &lt;hdf5.h&gt;</span>
00010 <span class="preprocessor">#endif</span>
00011 <span class="preprocessor"></span>
00012 <span class="preprocessor">#include "<a class="code" href="allvars_8h.html">allvars.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="proto_8h.html">proto.h</a>"</span>
00014 
00015 
00016 
00021 <span class="keyword">static</span> <span class="keywordtype">int</span> n_type[6];
00022 <span class="keyword">static</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> ntot_type_all[6];
00023 
00024 
00025 
00026 
<a name="l00033"></a><a class="code" href="proto_8h.html#a144">00033</a> <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a144">savepositions</a>(<span class="keywordtype">int</span> num)
00034 {
00035   <span class="keywordtype">double</span> t0, t1;
00036   <span class="keywordtype">char</span> buf[500];
00037   <span class="keywordtype">int</span> i, j, *temp, n, filenr, gr, ngroups, masterTask, lastTask;
00038 
00039   t0 = <a class="code" href="proto_8h.html#a145">second</a>();
00040 
00041   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00042     printf(<span class="stringliteral">"\nwriting snapshot file... \n"</span>);
00043 
00044 <span class="preprocessor">#if defined(SFR) || defined(BLACK_HOLES)</span>
00045 <span class="preprocessor"></span>  rearrange_particle_sequence();
00046   <span class="comment">/* ensures that new tree will be constructed */</span>
00047   <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o23">NumForcesSinceLastDomainDecomp</a> = 1 + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o96">TreeDomainUpdateFrequency</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a>;
00048 <span class="preprocessor">#endif</span>
00049 <span class="preprocessor"></span>
00050   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a1">NTask</a> &lt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o7">NumFilesPerSnapshot</a>)
00051     {
00052       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00053         printf(<span class="stringliteral">"Fatal error.\nNumber of processors must be larger or equal than All.NumFilesPerSnapshot.\n"</span>);
00054       <a class="code" href="proto_8h.html#a38">endrun</a>(0);
00055     }
00056   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o6">SnapFormat</a> &lt; 1 || <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o6">SnapFormat</a> &gt; 3)
00057     {
00058       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00059         printf(<span class="stringliteral">"Unsupported File-Format\n"</span>);
00060       <a class="code" href="proto_8h.html#a38">endrun</a>(0);
00061     }
00062 <span class="preprocessor">#ifndef  HAVE_HDF5</span>
00063 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o6">SnapFormat</a> == 3)
00064     {
00065       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00066         printf(<span class="stringliteral">"Code wasn't compiled with HDF5 support enabled!\n"</span>);
00067       <a class="code" href="proto_8h.html#a38">endrun</a>(0);
00068     }
00069 <span class="preprocessor">#endif</span>
00070 <span class="preprocessor"></span>
00071 
00072   <span class="comment">/* determine global and local particle numbers */</span>
00073   <span class="keywordflow">for</span>(n = 0; n &lt; 6; n++)
00074     n_type[n] = 0;
00075 
00076   <span class="keywordflow">for</span>(n = 0; n &lt; NumPart; n++)
00077     n_type[<a class="code" href="allvars_8c.html#a51">P</a>[n].<a class="code" href="structparticle__data.html#o9">Type</a>]++;
00078 
00079   <span class="comment">/* because ntot_type_all[] is of type `long long', we cannot do a simple</span>
00080 <span class="comment">   * MPI_Allreduce() to sum the total particle numbers </span>
00081 <span class="comment">   */</span>
00082   temp = malloc(<a class="code" href="allvars_8c.html#a1">NTask</a> * 6 * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00083   MPI_Allgather(n_type, 6, MPI_INT, temp, 6, MPI_INT, MPI_COMM_WORLD);
00084   <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
00085     {
00086       ntot_type_all[i] = 0;
00087       <span class="keywordflow">for</span>(j = 0; j &lt; NTask; j++)
00088         ntot_type_all[i] += temp[j * 6 + i];
00089     }
00090   free(temp);
00091 
00092 
00093   <span class="comment">/* assign processors to output files */</span>
00094   <a class="code" href="read__ic_8c.html#a6">distribute_file</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o7">NumFilesPerSnapshot</a>, 0, 0, <a class="code" href="allvars_8c.html#a1">NTask</a> - 1, &amp;filenr, &amp;masterTask, &amp;lastTask);
00095 
00096   <a class="code" href="io_8c.html#a10">fill_Tab_IO_Labels</a>();
00097 
00098   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o7">NumFilesPerSnapshot</a> &gt; 1)
00099     sprintf(buf, <span class="stringliteral">"%s%s_%03d.%d"</span>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o115">OutputDir</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o116">SnapshotFileBase</a>, num, filenr);
00100   <span class="keywordflow">else</span>
00101     sprintf(buf, <span class="stringliteral">"%s%s_%03d"</span>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o115">OutputDir</a>, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o116">SnapshotFileBase</a>, num);
00102 
00103   ngroups = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o7">NumFilesPerSnapshot</a> / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o8">NumFilesWrittenInParallel</a>;
00104   <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o7">NumFilesPerSnapshot</a> % <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o8">NumFilesWrittenInParallel</a>))
00105     ngroups++;
00106 
00107   <span class="keywordflow">for</span>(gr = 0; gr &lt; ngroups; gr++)
00108     {
00109       <span class="keywordflow">if</span>((filenr / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o8">NumFilesWrittenInParallel</a>) == gr)        <span class="comment">/* ok, it's this processor's turn */</span>
00110         <a class="code" href="proto_8h.html#a155">write_file</a>(buf, masterTask, lastTask);
00111       MPI_Barrier(MPI_COMM_WORLD);
00112     }
00113 
00114 
00115   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00116     printf(<span class="stringliteral">"done with snapshot.\n"</span>);
00117 
00118   t1 = <a class="code" href="proto_8h.html#a145">second</a>();
00119 
00120   <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o76">CPU_Snapshot</a> += <a class="code" href="system_8c.html#a3">timediff</a>(t0, t1);
00121 
00122 }
00123 
00124 
00125 
<a name="l00129"></a><a class="code" href="proto_8h.html#a47">00129</a> <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a47">fill_write_buffer</a>(<span class="keyword">enum</span> iofields blocknr, <span class="keywordtype">int</span> *startindex, <span class="keywordtype">int</span> pc, <span class="keywordtype">int</span> type)
00130 {
00131   <span class="keywordtype">int</span> n, k, pindex;
00132   <span class="keywordtype">float</span> *fp;
00133 
00134 <span class="preprocessor">#ifdef LONGIDS</span>
00135 <span class="preprocessor"></span>  <span class="keywordtype">long</span> <span class="keywordtype">long</span> *ip;
00136 <span class="preprocessor">#else</span>
00137 <span class="preprocessor"></span>  <span class="keywordtype">int</span> *ip;
00138 <span class="preprocessor">#endif</span>
00139 <span class="preprocessor"></span>
00140 <span class="preprocessor">#ifdef PERIODIC</span>
00141 <span class="preprocessor"></span>  <a class="code" href="allvars_8h.html#a35">FLOAT</a> boxSize;
00142 <span class="preprocessor">#endif</span>
00143 <span class="preprocessor"></span><span class="preprocessor">#ifdef PMGRID</span>
00144 <span class="preprocessor"></span>  <span class="keywordtype">double</span> dt_gravkick_pm = 0;
00145 <span class="preprocessor">#endif</span>
00146 <span class="preprocessor"></span>  <span class="keywordtype">double</span> dt_gravkick, dt_hydrokick, a3inv = 1, fac1, fac2;
00147 
00148 
00149   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00150     {
00151       a3inv = 1 / (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>);
00152       fac1 = 1 / (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>);
00153       fac2 = 1 / <a class="code" href="proto_8h.html#a133">pow</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>, 3 * <a class="code" href="allvars_8h.html#a9">GAMMA</a> - 2);
00154     }
00155   <span class="keywordflow">else</span>
00156     a3inv = fac1 = fac2 = 1;
00157 
00158 <span class="preprocessor">#ifdef PMGRID</span>
00159 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00160     dt_gravkick_pm =
00161       <a class="code" href="proto_8h.html#a83">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o62">PM_Ti_begstep</a>,
00162                           <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>) -
00163       <a class="code" href="proto_8h.html#a83">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o62">PM_Ti_begstep</a>, (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o62">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a>) / 2);
00164   <span class="keywordflow">else</span>
00165     dt_gravkick_pm = (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a> - (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o62">PM_Ti_begstep</a> + <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o61">PM_Ti_endstep</a>) / 2) * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00166 <span class="preprocessor">#endif</span>
00167 <span class="preprocessor"></span>
00168 
00169 
00170   fp = CommBuffer;
00171   ip = CommBuffer;
00172 
00173   pindex = *startindex;
00174 
00175   <span class="keywordflow">switch</span> (blocknr)
00176     {
00177     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a125">IO_POS</a>:                <span class="comment">/* positions */</span>
00178       <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
00179         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o9">Type</a> == type)
00180           {
00181             <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00182               {
00183                 fp[k] = <a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o0">Pos</a>[k];
00184 <span class="preprocessor">#ifdef PERIODIC</span>
00185 <span class="preprocessor"></span>                boxSize = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
00186 <span class="preprocessor">#ifdef LONG_X</span>
00187 <span class="preprocessor"></span>                <span class="keywordflow">if</span>(k == 0)
00188                   boxSize = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a> * LONG_X;
00189 <span class="preprocessor">#endif</span>
00190 <span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Y</span>
00191 <span class="preprocessor"></span>                <span class="keywordflow">if</span>(k == 1)
00192                   boxSize = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a> * LONG_Y;
00193 <span class="preprocessor">#endif</span>
00194 <span class="preprocessor"></span><span class="preprocessor">#ifdef LONG_Z</span>
00195 <span class="preprocessor"></span>                <span class="keywordflow">if</span>(k == 2)
00196                   boxSize = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a> * LONG_Z;
00197 <span class="preprocessor">#endif</span>
00198 <span class="preprocessor"></span>                <span class="keywordflow">while</span>(fp[k] &lt; 0)
00199                   fp[k] += boxSize;
00200                 <span class="keywordflow">while</span>(fp[k] &gt;= boxSize)
00201                   fp[k] -= boxSize;
00202 <span class="preprocessor">#endif</span>
00203 <span class="preprocessor"></span>              }
00204             n++;
00205             fp += 3;
00206           }
00207       <span class="keywordflow">break</span>;
00208 
00209     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a126">IO_VEL</a>:                <span class="comment">/* velocities */</span>
00210       <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
00211         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o9">Type</a> == type)
00212           {
00213             <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00214               {
00215                 dt_gravkick =
00216                   <a class="code" href="proto_8h.html#a83">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a51">P</a>[pindex].Ti_begstep,
00217                                       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>) -
00218                   <a class="code" href="proto_8h.html#a83">get_gravkick_factor</a>(<a class="code" href="allvars_8c.html#a51">P</a>[pindex].Ti_begstep,
00219                                       (<a class="code" href="allvars_8c.html#a51">P</a>[pindex].Ti_begstep + <a class="code" href="allvars_8c.html#a51">P</a>[pindex].Ti_endstep) / 2);
00220                 dt_hydrokick =
00221                   <a class="code" href="proto_8h.html#a84">get_hydrokick_factor</a>(<a class="code" href="allvars_8c.html#a51">P</a>[pindex].Ti_begstep,
00222                                        <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a>) -
00223                   <a class="code" href="proto_8h.html#a84">get_hydrokick_factor</a>(<a class="code" href="allvars_8c.html#a51">P</a>[pindex].Ti_begstep,
00224                                        (<a class="code" href="allvars_8c.html#a51">P</a>[pindex].Ti_begstep + <a class="code" href="allvars_8c.html#a51">P</a>[pindex].Ti_endstep) / 2);
00225               }
00226             <span class="keywordflow">else</span>
00227               dt_gravkick = dt_hydrokick =
00228                 (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o59">Ti_Current</a> - (<a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o11">Ti_begstep</a> + <a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a>) / 2) * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00229 
00230             <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00231               {
00232                 fp[k] = <a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o2">Vel</a>[k] + <a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[k] * dt_gravkick;
00233                 <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
00234                   fp[k] += <a class="code" href="allvars_8c.html#a53">SphP</a>[pindex].<a class="code" href="structsph__particle__data.html#o8">HydroAccel</a>[k] * dt_hydrokick;
00235               }
00236 <span class="preprocessor">#ifdef PMGRID</span>
00237 <span class="preprocessor"></span>            <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00238               fp[k] += <a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o4">GravPM</a>[k] * dt_gravkick_pm;
00239 <span class="preprocessor">#endif</span>
00240 <span class="preprocessor"></span>            <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00241               fp[k] *= sqrt(a3inv);
00242 
00243             n++;
00244             fp += 3;
00245           }
00246       <span class="keywordflow">break</span>;
00247 
00248     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a127">IO_ID</a>:         <span class="comment">/* particle ID */</span>
00249       <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
00250         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o9">Type</a> == type)
00251           {
00252             *ip++ = <a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o8">ID</a>;
00253             n++;
00254           }
00255       <span class="keywordflow">break</span>;
00256 
00257     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a128">IO_MASS</a>:               <span class="comment">/* particle mass */</span>
00258       <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
00259         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o9">Type</a> == type)
00260           {
00261             *fp++ = <a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o1">Mass</a>;
00262             n++;
00263           }
00264       <span class="keywordflow">break</span>;
00265 
00266     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a129">IO_U</a>:                  <span class="comment">/* internal energy */</span>
00267       <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
00268         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o9">Type</a> == type)
00269           {
00270 <span class="preprocessor">#ifdef ISOTHERM_EQS</span>
00271 <span class="preprocessor"></span>            *fp++ = <a class="code" href="allvars_8c.html#a53">SphP</a>[pindex].<a class="code" href="structsph__particle__data.html#o0">Entropy</a>;
00272 <span class="preprocessor">#else</span>
00273 <span class="preprocessor"></span>            *fp++ =
00274               <a class="code" href="system_8c.html#a4">dmax</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o21">MinEgySpec</a>,
00275                    <a class="code" href="allvars_8c.html#a53">SphP</a>[pindex].<a class="code" href="structsph__particle__data.html#o0">Entropy</a> / <a class="code" href="allvars_8h.html#a10">GAMMA_MINUS1</a> * <a class="code" href="proto_8h.html#a133">pow</a>(<a class="code" href="allvars_8c.html#a53">SphP</a>[pindex].Density * a3inv, <a class="code" href="allvars_8h.html#a10">GAMMA_MINUS1</a>));
00276 <span class="preprocessor">#endif</span>
00277 <span class="preprocessor"></span>            n++;
00278           }
00279       <span class="keywordflow">break</span>;
00280 
00281     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a130">IO_RHO</a>:                <span class="comment">/* density */</span>
00282       <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
00283         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o9">Type</a> == type)
00284           {
00285             *fp++ = <a class="code" href="allvars_8c.html#a53">SphP</a>[pindex].<a class="code" href="structsph__particle__data.html#o1">Density</a>;
00286             n++;
00287           }
00288       <span class="keywordflow">break</span>;
00289 
00290     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a131">IO_HSML</a>:               <span class="comment">/* SPH smoothing length */</span>
00291       <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
00292         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o9">Type</a> == type)
00293           {
00294             *fp++ = <a class="code" href="allvars_8c.html#a53">SphP</a>[pindex].<a class="code" href="structsph__particle__data.html#o2">Hsml</a>;
00295             n++;
00296           }
00297       <span class="keywordflow">break</span>;
00298 
00299 
00300     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a132">IO_POT</a>:                <span class="comment">/* gravitational potential */</span>
00301 <span class="preprocessor">#ifdef OUTPUTPOTENTIAL</span>
00302 <span class="preprocessor"></span>      <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
00303         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o9">Type</a> == type)
00304           {
00305             *fp++ = <a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o6">Potential</a>;
00306             n++;
00307           }
00308 <span class="preprocessor">#endif</span>
00309 <span class="preprocessor"></span>      <span class="keywordflow">break</span>;
00310 
00311     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a133">IO_ACCEL</a>:              <span class="comment">/* acceleration */</span>
00312 <span class="preprocessor">#ifdef OUTPUTACCELERATION</span>
00313 <span class="preprocessor"></span>      <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
00314         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o9">Type</a> == type)
00315           {
00316             <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00317               fp[k] = fac1 * <a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o3">GravAccel</a>[k];
00318 <span class="preprocessor">#ifdef PMGRID</span>
00319 <span class="preprocessor"></span>            <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00320               fp[k] += fac1 * <a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o4">GravPM</a>[k];
00321 <span class="preprocessor">#endif</span>
00322 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o9">Type</a> == 0)
00323               <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00324                 fp[k] += fac2 * <a class="code" href="allvars_8c.html#a53">SphP</a>[pindex].<a class="code" href="structsph__particle__data.html#o8">HydroAccel</a>[k];
00325             fp += 3;
00326             n++;
00327           }
00328 <span class="preprocessor">#endif</span>
00329 <span class="preprocessor"></span>      <span class="keywordflow">break</span>;
00330 
00331     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a134">IO_DTENTR</a>:             <span class="comment">/* rate of change of entropy */</span>
00332 <span class="preprocessor">#ifdef OUTPUTCHANGEOFENTROPY</span>
00333 <span class="preprocessor"></span>      <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
00334         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o9">Type</a> == type)
00335           {
00336             *fp++ = <a class="code" href="allvars_8c.html#a53">SphP</a>[pindex].<a class="code" href="structsph__particle__data.html#o7">DtEntropy</a>;
00337             n++;
00338           }
00339 <span class="preprocessor">#endif</span>
00340 <span class="preprocessor"></span>      <span class="keywordflow">break</span>;
00341 
00342     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a135">IO_TSTP</a>:               <span class="comment">/* timestep  */</span>
00343 <span class="preprocessor">#ifdef OUTPUTTIMESTEP</span>
00344 <span class="preprocessor"></span>
00345       <span class="keywordflow">for</span>(n = 0; n &lt; pc; pindex++)
00346         <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o9">Type</a> == type)
00347           {
00348             *fp++ = (<a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o10">Ti_endstep</a> - <a class="code" href="allvars_8c.html#a51">P</a>[pindex].<a class="code" href="structparticle__data.html#o11">Ti_begstep</a>) * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o58">Timebase_interval</a>;
00349             n++;
00350           }
00351 <span class="preprocessor">#endif</span>
00352 <span class="preprocessor"></span>      <span class="keywordflow">break</span>;
00353 
00354     }
00355 
00356   *startindex = pindex;
00357 }
00358 
00359 
00360 
00361 
<a name="l00366"></a><a class="code" href="proto_8h.html#a79">00366</a> <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a79">get_bytes_per_blockelement</a>(<span class="keyword">enum</span> iofields blocknr)
00367 {
00368   <span class="keywordtype">int</span> bytes_per_blockelement = 0;
00369 
00370   <span class="keywordflow">switch</span> (blocknr)
00371     {
00372     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a125">IO_POS</a>:
00373     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a126">IO_VEL</a>:
00374     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a133">IO_ACCEL</a>:
00375       bytes_per_blockelement = 3 * <span class="keyword">sizeof</span>(float);
00376       <span class="keywordflow">break</span>;
00377 
00378     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a127">IO_ID</a>:
00379 <span class="preprocessor">#ifdef LONGIDS</span>
00380 <span class="preprocessor"></span>      bytes_per_blockelement = <span class="keyword">sizeof</span>(<span class="keywordtype">long</span> long);
00381 <span class="preprocessor">#else</span>
00382 <span class="preprocessor"></span>      bytes_per_blockelement = <span class="keyword">sizeof</span>(int);
00383 <span class="preprocessor">#endif</span>
00384 <span class="preprocessor"></span>      <span class="keywordflow">break</span>;
00385 
00386     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a128">IO_MASS</a>:
00387     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a129">IO_U</a>:
00388     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a130">IO_RHO</a>:
00389     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a131">IO_HSML</a>:
00390     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a132">IO_POT</a>:
00391     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a134">IO_DTENTR</a>:
00392     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a135">IO_TSTP</a>:
00393       bytes_per_blockelement = <span class="keyword">sizeof</span>(float);
00394       <span class="keywordflow">break</span>;
00395     }
00396 
00397   <span class="keywordflow">return</span> bytes_per_blockelement;
00398 }
00399 
00400 
<a name="l00405"></a><a class="code" href="proto_8h.html#a81">00405</a> <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a81">get_datatype_in_block</a>(<span class="keyword">enum</span> iofields blocknr)
00406 {
00407   <span class="keywordtype">int</span> typekey;
00408 
00409   <span class="keywordflow">switch</span> (blocknr)
00410     {
00411     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a127">IO_ID</a>:
00412 <span class="preprocessor">#ifdef LONGIDS</span>
00413 <span class="preprocessor"></span>      typekey = 2;              <span class="comment">/* native long long */</span>
00414 <span class="preprocessor">#else</span>
00415 <span class="preprocessor"></span>      typekey = 0;              <span class="comment">/* native int */</span>
00416 <span class="preprocessor">#endif</span>
00417 <span class="preprocessor"></span>      <span class="keywordflow">break</span>;
00418 
00419     <span class="keywordflow">default</span>:
00420       typekey = 1;              <span class="comment">/* native float */</span>
00421       <span class="keywordflow">break</span>;
00422     }
00423 
00424   <span class="keywordflow">return</span> typekey;
00425 }
00426 
00427 
<a name="l00432"></a><a class="code" href="proto_8h.html#a88">00432</a> <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a88">get_values_per_blockelement</a>(<span class="keyword">enum</span> iofields blocknr)
00433 {
00434   <span class="keywordtype">int</span> values = 0;
00435 
00436   <span class="keywordflow">switch</span> (blocknr)
00437     {
00438     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a125">IO_POS</a>:
00439     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a126">IO_VEL</a>:
00440     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a133">IO_ACCEL</a>:
00441       values = 3;
00442       <span class="keywordflow">break</span>;
00443 
00444     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a127">IO_ID</a>:
00445     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a128">IO_MASS</a>:
00446     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a129">IO_U</a>:
00447     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a130">IO_RHO</a>:
00448     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a131">IO_HSML</a>:
00449     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a132">IO_POT</a>:
00450     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a134">IO_DTENTR</a>:
00451     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a135">IO_TSTP</a>:
00452       values = 1;
00453       <span class="keywordflow">break</span>;
00454     }
00455 
00456   <span class="keywordflow">return</span> values;
00457 }
00458 
00459 
<a name="l00465"></a><a class="code" href="proto_8h.html#a85">00465</a> <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a85">get_particles_in_block</a>(<span class="keyword">enum</span> iofields blocknr, <span class="keywordtype">int</span> *typelist)
00466 {
00467   <span class="keywordtype">int</span> i, nall, ntot_withmasses, ngas, nstars;
00468 
00469   nall = 0;
00470   ntot_withmasses = 0;
00471 
00472   <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
00473     {
00474       typelist[i] = 0;
00475 
00476       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[i] &gt; 0)
00477         {
00478           nall += <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[i];
00479           typelist[i] = 1;
00480         }
00481 
00482       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o113">MassTable</a>[i] == 0)
00483         ntot_withmasses += <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[i];
00484     }
00485 
00486   ngas = <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[0];
00487   nstars = <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[4];
00488 
00489 
00490   <span class="keywordflow">switch</span> (blocknr)
00491     {
00492     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a125">IO_POS</a>:
00493     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a126">IO_VEL</a>:
00494     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a133">IO_ACCEL</a>:
00495     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a135">IO_TSTP</a>:
00496     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a127">IO_ID</a>:
00497     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a132">IO_POT</a>:
00498       <span class="keywordflow">return</span> nall;
00499       <span class="keywordflow">break</span>;
00500 
00501     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a128">IO_MASS</a>:
00502       <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
00503         {
00504           typelist[i] = 0;
00505           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o113">MassTable</a>[i] == 0 &amp;&amp; <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[i] &gt; 0)
00506             typelist[i] = 1;
00507         }
00508       <span class="keywordflow">return</span> ntot_withmasses;
00509       <span class="keywordflow">break</span>;
00510 
00511     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a129">IO_U</a>:
00512     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a130">IO_RHO</a>:
00513     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a131">IO_HSML</a>:
00514     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a134">IO_DTENTR</a>:
00515       <span class="keywordflow">for</span>(i = 1; i &lt; 6; i++)
00516         typelist[i] = 0;
00517       <span class="keywordflow">return</span> ngas;
00518       <span class="keywordflow">break</span>;
00519     }
00520 
00521   <a class="code" href="proto_8h.html#a38">endrun</a>(212);
00522   <span class="keywordflow">return</span> 0;
00523 }
00524 
00525 
00526 
<a name="l00532"></a><a class="code" href="proto_8h.html#a4">00532</a> <span class="keywordtype">int</span> <a class="code" href="proto_8h.html#a4">blockpresent</a>(<span class="keyword">enum</span> iofields blocknr)
00533 {
00534 
00535 <span class="preprocessor">#ifndef OUTPUTPOTENTIAL</span>
00536 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(blocknr == IO_POT)
00537     <span class="keywordflow">return</span> 0;
00538 <span class="preprocessor">#endif</span>
00539 <span class="preprocessor"></span>
00540 <span class="preprocessor">#ifndef OUTPUTACCELERATION</span>
00541 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(blocknr == IO_ACCEL)
00542     <span class="keywordflow">return</span> 0;
00543 <span class="preprocessor">#endif</span>
00544 <span class="preprocessor"></span>
00545 <span class="preprocessor">#ifndef OUTPUTCHANGEOFENTROPY</span>
00546 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(blocknr == IO_DTENTR)
00547     <span class="keywordflow">return</span> 0;
00548 <span class="preprocessor">#endif</span>
00549 <span class="preprocessor"></span>
00550 <span class="preprocessor">#ifndef OUTPUTTIMESTEP</span>
00551 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(blocknr == IO_TSTP)
00552     <span class="keywordflow">return</span> 0;
00553 <span class="preprocessor">#endif</span>
00554 <span class="preprocessor"></span>
00555   <span class="keywordflow">return</span> 1;                     <span class="comment">/* default: present */</span>
00556 }
00557 
00558 
00559 
00560 
<a name="l00566"></a><a class="code" href="proto_8h.html#a46">00566</a> <span class="keywordtype">void</span> <a class="code" href="io_8c.html#a10">fill_Tab_IO_Labels</a>(<span class="keywordtype">void</span>)
00567 {
00568   <span class="keyword">enum</span> <a class="code" href="allvars_8h.html#a136">iofields</a> i;
00569 
00570   <span class="keywordflow">for</span>(i = 0; i &lt; IO_NBLOCKS; i++)
00571     <span class="keywordflow">switch</span> (i)
00572       {
00573       <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a125">IO_POS</a>:
00574         strncpy(<a class="code" href="allvars_8c.html#a64">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a136a125">IO_POS</a>], <span class="stringliteral">"POS "</span>, 4);
00575         <span class="keywordflow">break</span>;
00576       <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a126">IO_VEL</a>:
00577         strncpy(<a class="code" href="allvars_8c.html#a64">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a136a126">IO_VEL</a>], <span class="stringliteral">"VEL "</span>, 4);
00578         <span class="keywordflow">break</span>;
00579       <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a127">IO_ID</a>:
00580         strncpy(<a class="code" href="allvars_8c.html#a64">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a136a127">IO_ID</a>], <span class="stringliteral">"ID  "</span>, 4);
00581         <span class="keywordflow">break</span>;
00582       <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a128">IO_MASS</a>:
00583         strncpy(<a class="code" href="allvars_8c.html#a64">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a136a128">IO_MASS</a>], <span class="stringliteral">"MASS"</span>, 4);
00584         <span class="keywordflow">break</span>;
00585       <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a129">IO_U</a>:
00586         strncpy(<a class="code" href="allvars_8c.html#a64">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a136a129">IO_U</a>], <span class="stringliteral">"U   "</span>, 4);
00587         <span class="keywordflow">break</span>;
00588       <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a130">IO_RHO</a>:
00589         strncpy(<a class="code" href="allvars_8c.html#a64">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a136a130">IO_RHO</a>], <span class="stringliteral">"RHO "</span>, 4);
00590         <span class="keywordflow">break</span>;
00591       <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a131">IO_HSML</a>:
00592         strncpy(<a class="code" href="allvars_8c.html#a64">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a136a131">IO_HSML</a>], <span class="stringliteral">"HSML"</span>, 4);
00593         <span class="keywordflow">break</span>;
00594       <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a132">IO_POT</a>:
00595         strncpy(<a class="code" href="allvars_8c.html#a64">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a136a132">IO_POT</a>], <span class="stringliteral">"POT "</span>, 4);
00596         <span class="keywordflow">break</span>;
00597       <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a133">IO_ACCEL</a>:
00598         strncpy(<a class="code" href="allvars_8c.html#a64">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a136a133">IO_ACCEL</a>], <span class="stringliteral">"ACCE"</span>, 4);
00599         <span class="keywordflow">break</span>;
00600       <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a134">IO_DTENTR</a>:
00601         strncpy(<a class="code" href="allvars_8c.html#a64">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a136a134">IO_DTENTR</a>], <span class="stringliteral">"ENDT"</span>, 4);
00602         <span class="keywordflow">break</span>;
00603       <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a135">IO_TSTP</a>:
00604         strncpy(<a class="code" href="allvars_8c.html#a64">Tab_IO_Labels</a>[<a class="code" href="allvars_8h.html#a136a135">IO_TSTP</a>], <span class="stringliteral">"TSTP"</span>, 4);
00605         <span class="keywordflow">break</span>;
00606       }
00607 }
00608 
00613 <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a80">get_dataset_name</a>(<span class="keyword">enum</span> iofields blocknr, <span class="keywordtype">char</span> *buf)
<a name="l00614"></a><a class="code" href="proto_8h.html#a80">00614</a> {
00615 
00616   strcpy(buf, <span class="stringliteral">"default"</span>);
00617 
00618   <span class="keywordflow">switch</span> (blocknr)
00619     {
00620     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a125">IO_POS</a>:
00621       strcpy(buf, <span class="stringliteral">"Coordinates"</span>);
00622       <span class="keywordflow">break</span>;
00623     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a126">IO_VEL</a>:
00624       strcpy(buf, <span class="stringliteral">"Velocities"</span>);
00625       <span class="keywordflow">break</span>;
00626     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a127">IO_ID</a>:
00627       strcpy(buf, <span class="stringliteral">"ParticleIDs"</span>);
00628       <span class="keywordflow">break</span>;
00629     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a128">IO_MASS</a>:
00630       strcpy(buf, <span class="stringliteral">"Masses"</span>);
00631       <span class="keywordflow">break</span>;
00632     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a129">IO_U</a>:
00633       strcpy(buf, <span class="stringliteral">"InternalEnergy"</span>);
00634       <span class="keywordflow">break</span>;
00635     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a130">IO_RHO</a>:
00636       strcpy(buf, <span class="stringliteral">"Density"</span>);
00637       <span class="keywordflow">break</span>;
00638     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a131">IO_HSML</a>:
00639       strcpy(buf, <span class="stringliteral">"SmoothingLength"</span>);
00640       <span class="keywordflow">break</span>;
00641     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a132">IO_POT</a>:
00642       strcpy(buf, <span class="stringliteral">"Potential"</span>);
00643       <span class="keywordflow">break</span>;
00644     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a133">IO_ACCEL</a>:
00645       strcpy(buf, <span class="stringliteral">"Acceleration"</span>);
00646       <span class="keywordflow">break</span>;
00647     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a134">IO_DTENTR</a>:
00648       strcpy(buf, <span class="stringliteral">"RateOfChangeOfEntropy"</span>);
00649       <span class="keywordflow">break</span>;
00650     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a135">IO_TSTP</a>:
00651       strcpy(buf, <span class="stringliteral">"TimeStep"</span>);
00652       <span class="keywordflow">break</span>;
00653     }
00654 }
00655 
00656 
00657 
00672 <span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a155">write_file</a>(<span class="keywordtype">char</span> *fname, <span class="keywordtype">int</span> writeTask, <span class="keywordtype">int</span> lastTask)
<a name="l00673"></a><a class="code" href="proto_8h.html#a155">00673</a> {
00674   <span class="keywordtype">int</span> type, bytes_per_blockelement, npart, nextblock, typelist[6];
00675   <span class="keywordtype">int</span> n_for_this_task, ntask, n, p, pc, offset = 0, task;
00676   <span class="keywordtype">int</span> blockmaxlen, ntot_type[6], nn[6];
00677   <span class="keyword">enum</span> <a class="code" href="allvars_8h.html#a136">iofields</a> blocknr;
00678   <span class="keywordtype">int</span> blksize;
00679   MPI_Status status;
00680   FILE *fd = 0;
00681 
00682 <span class="preprocessor">#ifdef HAVE_HDF5</span>
00683 <span class="preprocessor"></span>  hid_t hdf5_file = 0, hdf5_grp[6], hdf5_headergrp = 0, hdf5_dataspace_memory;
00684   hid_t hdf5_datatype = 0, hdf5_dataspace_in_file = 0, hdf5_dataset = 0;
00685   herr_t hdf5_status;
00686   hsize_t dims[2], count[2], start[2];
00687   <span class="keywordtype">int</span> rank, pcsum = 0;
00688   <span class="keywordtype">char</span> buf[500];
00689 <span class="preprocessor">#endif</span>
00690 <span class="preprocessor"></span>
00691 <span class="preprocessor">#define SKIP  {my_fwrite(&amp;blksize,sizeof(int),1,fd);}</span>
00692 <span class="preprocessor"></span>
00693   <span class="comment">/* determine particle numbers of each type in file */</span>
00694 
00695   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == writeTask)
00696     {
00697       <span class="keywordflow">for</span>(n = 0; n &lt; 6; n++)
00698         ntot_type[n] = n_type[n];
00699 
00700       <span class="keywordflow">for</span>(task = writeTask + 1; task &lt;= lastTask; task++)
00701         {
00702           MPI_Recv(&amp;nn[0], 6, MPI_INT, task, <a class="code" href="tags_8h.html#a27">TAG_LOCALN</a>, MPI_COMM_WORLD, &amp;status);
00703           <span class="keywordflow">for</span>(n = 0; n &lt; 6; n++)
00704             ntot_type[n] += nn[n];
00705         }
00706 
00707       <span class="keywordflow">for</span>(task = writeTask + 1; task &lt;= lastTask; task++)
00708         MPI_Send(&amp;ntot_type[0], 6, MPI_INT, task, <a class="code" href="tags_8h.html#a0">TAG_N</a>, MPI_COMM_WORLD);
00709     }
00710   <span class="keywordflow">else</span>
00711     {
00712       MPI_Send(&amp;n_type[0], 6, MPI_INT, writeTask, <a class="code" href="tags_8h.html#a27">TAG_LOCALN</a>, MPI_COMM_WORLD);
00713       MPI_Recv(&amp;ntot_type[0], 6, MPI_INT, writeTask, <a class="code" href="tags_8h.html#a0">TAG_N</a>, MPI_COMM_WORLD, &amp;status);
00714     }
00715 
00716 
00717 
00718   <span class="comment">/* fill file header */</span>
00719 
00720   <span class="keywordflow">for</span>(n = 0; n &lt; 6; n++)
00721     {
00722       <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[n] = ntot_type[n];
00723       <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o6">npartTotal</a>[n] = (<span class="keywordtype">unsigned</span> int) ntot_type_all[n];
00724       <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o15">npartTotalHighWord</a>[n] = (<span class="keywordtype">unsigned</span> int) (ntot_type_all[n] &gt;&gt; 32);
00725     }
00726 
00727   <span class="keywordflow">for</span>(n = 0; n &lt; 6; n++)
00728     <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o1">mass</a>[n] = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o113">MassTable</a>[n];
00729 
00730   <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o2">time</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a>;
00731 
00732   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o40">ComovingIntegrationOn</a>)
00733     <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o3">redshift</a> = 1.0 / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> - 1;
00734   <span class="keywordflow">else</span>
00735     <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o3">redshift</a> = 0;
00736 
00737   <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o4">flag_sfr</a> = 0;
00738   <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o5">flag_feedback</a> = 0;
00739   <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o7">flag_cooling</a> = 0;
00740   <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o13">flag_stellarage</a> = 0;
00741   <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o14">flag_metals</a> = 0;
00742 
00743 <span class="preprocessor">#ifdef COOLING</span>
00744 <span class="preprocessor"></span>  <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o7">flag_cooling</a> = 1;
00745 <span class="preprocessor">#endif</span>
00746 <span class="preprocessor"></span><span class="preprocessor">#ifdef SFR</span>
00747 <span class="preprocessor"></span>  <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o4">flag_sfr</a> = 1;
00748   <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o5">flag_feedback</a> = 1;
00749 <span class="preprocessor">#ifdef STELLARAGE</span>
00750 <span class="preprocessor"></span>  <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o13">flag_stellarage</a> = 1;
00751 <span class="preprocessor">#endif</span>
00752 <span class="preprocessor"></span><span class="preprocessor">#ifdef METALS</span>
00753 <span class="preprocessor"></span>  <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o14">flag_metals</a> = 1;
00754 <span class="preprocessor">#endif</span>
00755 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00756 <span class="preprocessor"></span>
00757   <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o8">num_files</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o7">NumFilesPerSnapshot</a>;
00758   <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o9">BoxSize</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o4">BoxSize</a>;
00759   <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o10">Omega0</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o36">Omega0</a>;
00760   <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o11">OmegaLambda</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o37">OmegaLambda</a>;
00761   <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o12">HubbleParam</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o39">HubbleParam</a>;
00762 
00763 
00764   <span class="comment">/* open file and write header */</span>
00765 
00766   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == writeTask)
00767     {
00768       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o6">SnapFormat</a> == 3)
00769         {
00770 <span class="preprocessor">#ifdef HAVE_HDF5</span>
00771 <span class="preprocessor"></span>          sprintf(buf, <span class="stringliteral">"%s.hdf5"</span>, fname);
00772           hdf5_file = H5Fcreate(buf, H5F_ACC_TRUNC, H5P_DEFAULT, H5P_DEFAULT);
00773 
00774           hdf5_headergrp = H5Gcreate(hdf5_file, <span class="stringliteral">"/Header"</span>, 0);
00775 
00776           <span class="keywordflow">for</span>(type = 0; type &lt; 6; type++)
00777             {
00778               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[type] &gt; 0)
00779                 {
00780                   sprintf(buf, <span class="stringliteral">"/PartType%d"</span>, type);
00781                   hdf5_grp[type] = H5Gcreate(hdf5_file, buf, 0);
00782                 }
00783             }
00784 
00785           <a class="code" href="proto_8h.html#a154">write_header_attributes_in_hdf5</a>(hdf5_headergrp);
00786 <span class="preprocessor">#endif</span>
00787 <span class="preprocessor"></span>        }
00788       <span class="keywordflow">else</span>
00789         {
00790           <span class="keywordflow">if</span>(!(fd = fopen(fname, <span class="stringliteral">"w"</span>)))
00791             {
00792               printf(<span class="stringliteral">"can't open file `%s' for writing snapshot.\n"</span>, fname);
00793               <a class="code" href="proto_8h.html#a38">endrun</a>(123);
00794             }
00795 
00796           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o6">SnapFormat</a> == 2)
00797             {
00798               blksize = <span class="keyword">sizeof</span>(int) + 4 * <span class="keyword">sizeof</span>(char);
00799               SKIP;
00800               <a class="code" href="proto_8h.html#a108">my_fwrite</a>(<span class="stringliteral">"HEAD"</span>, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), 4, fd);
00801               nextblock = <span class="keyword">sizeof</span>(header) + 2 * <span class="keyword">sizeof</span>(int);
00802               <a class="code" href="proto_8h.html#a108">my_fwrite</a>(&amp;nextblock, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), 1, fd);
00803               SKIP;
00804             }
00805 
00806           blksize = <span class="keyword">sizeof</span>(header);
00807           SKIP;
00808           <a class="code" href="proto_8h.html#a108">my_fwrite</a>(&amp;<a class="code" href="allvars_8c.html#a63">header</a>, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8c.html#a63">header</a>), 1, fd);
00809           SKIP;
00810         }
00811     }
00812 
00813   ntask = lastTask - writeTask + 1;
00814 
00815   <span class="keywordflow">for</span>(blocknr = 0; blocknr &lt; IO_NBLOCKS; blocknr++)
00816     {
00817       <span class="keywordflow">if</span>(<a class="code" href="proto_8h.html#a4">blockpresent</a>(blocknr))
00818         {
00819           bytes_per_blockelement = <a class="code" href="proto_8h.html#a79">get_bytes_per_blockelement</a>(blocknr);
00820 
00821           blockmaxlen = ((int) (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o9">BufferSize</a> * 1024 * 1024)) / bytes_per_blockelement;
00822 
00823           npart = <a class="code" href="proto_8h.html#a85">get_particles_in_block</a>(blocknr, &amp;typelist[0]);
00824 
00825           <span class="keywordflow">if</span>(npart &gt; 0)
00826             {
00827               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == writeTask)
00828                 {
00829 
00830                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o6">SnapFormat</a> == 1 || <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o6">SnapFormat</a> == 2)
00831                     {
00832                       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o6">SnapFormat</a> == 2)
00833                         {
00834                           blksize = <span class="keyword">sizeof</span>(int) + 4 * <span class="keyword">sizeof</span>(char);
00835                           SKIP;
00836                           <a class="code" href="proto_8h.html#a108">my_fwrite</a>(<a class="code" href="allvars_8c.html#a64">Tab_IO_Labels</a>[blocknr], <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), 4, fd);
00837                           nextblock = npart * bytes_per_blockelement + 2 * <span class="keyword">sizeof</span>(int);
00838                           <a class="code" href="proto_8h.html#a108">my_fwrite</a>(&amp;nextblock, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), 1, fd);
00839                           SKIP;
00840                         }
00841 
00842                       blksize = npart * bytes_per_blockelement;
00843                       SKIP;
00844 
00845                     }
00846                 }
00847 
00848               <span class="keywordflow">for</span>(type = 0; type &lt; 6; type++)
00849                 {
00850                   <span class="keywordflow">if</span>(typelist[type])
00851                     {
00852 <span class="preprocessor">#ifdef HAVE_HDF5</span>
00853 <span class="preprocessor"></span>                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == writeTask &amp;&amp; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o6">SnapFormat</a> == 3 &amp;&amp; <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[type] &gt; 0)
00854                         {
00855                           <span class="keywordflow">switch</span> (<a class="code" href="proto_8h.html#a81">get_datatype_in_block</a>(blocknr))
00856                             {
00857                             <span class="keywordflow">case</span> 0:
00858                               hdf5_datatype = H5Tcopy(H5T_NATIVE_UINT);
00859                               <span class="keywordflow">break</span>;
00860                             <span class="keywordflow">case</span> 1:
00861                               hdf5_datatype = H5Tcopy(H5T_NATIVE_FLOAT);
00862                               <span class="keywordflow">break</span>;
00863                             <span class="keywordflow">case</span> 2:
00864                               hdf5_datatype = H5Tcopy(H5T_NATIVE_UINT64);
00865                               <span class="keywordflow">break</span>;
00866                             }
00867 
00868                           dims[0] = <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[type];
00869                           dims[1] = <a class="code" href="proto_8h.html#a88">get_values_per_blockelement</a>(blocknr);
00870                           <span class="keywordflow">if</span>(dims[1] == 1)
00871                             rank = 1;
00872                           <span class="keywordflow">else</span>
00873                             rank = 2;
00874 
00875                           <a class="code" href="proto_8h.html#a80">get_dataset_name</a>(blocknr, buf);
00876 
00877                           hdf5_dataspace_in_file = H5Screate_simple(rank, dims, NULL);
00878                           hdf5_dataset =
00879                             H5Dcreate(hdf5_grp[type], buf, hdf5_datatype, hdf5_dataspace_in_file,
00880                                       H5P_DEFAULT);
00881                           pcsum = 0;
00882                         }
00883 <span class="preprocessor">#endif</span>
00884 <span class="preprocessor"></span>
00885                       <span class="keywordflow">for</span>(task = writeTask, offset = 0; task &lt;= lastTask; task++)
00886                         {
00887                           <span class="keywordflow">if</span>(task == ThisTask)
00888                             {
00889                               n_for_this_task = n_type[type];
00890 
00891                               <span class="keywordflow">for</span>(p = writeTask; p &lt;= lastTask; p++)
00892                                 <span class="keywordflow">if</span>(p != ThisTask)
00893                                   MPI_Send(&amp;n_for_this_task, 1, MPI_INT, p, <a class="code" href="tags_8h.html#a14">TAG_NFORTHISTASK</a>, MPI_COMM_WORLD);
00894                             }
00895                           <span class="keywordflow">else</span>
00896                             MPI_Recv(&amp;n_for_this_task, 1, MPI_INT, task, <a class="code" href="tags_8h.html#a14">TAG_NFORTHISTASK</a>, MPI_COMM_WORLD,
00897                                      &amp;status);
00898 
00899                           <span class="keywordflow">while</span>(n_for_this_task &gt; 0)
00900                             {
00901                               pc = n_for_this_task;
00902 
00903                               <span class="keywordflow">if</span>(pc &gt; blockmaxlen)
00904                                 pc = blockmaxlen;
00905 
00906                               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == task)
00907                                 <a class="code" href="proto_8h.html#a47">fill_write_buffer</a>(blocknr, &amp;offset, pc, type);
00908 
00909                               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == writeTask &amp;&amp; task != writeTask)
00910                                 MPI_Recv(<a class="code" href="allvars_8c.html#a49">CommBuffer</a>, bytes_per_blockelement * pc, MPI_BYTE, task,
00911                                          <a class="code" href="tags_8h.html#a2">TAG_PDATA</a>, MPI_COMM_WORLD, &amp;status);
00912 
00913                               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> != writeTask &amp;&amp; task == ThisTask)
00914                                 MPI_Ssend(<a class="code" href="allvars_8c.html#a49">CommBuffer</a>, bytes_per_blockelement * pc, MPI_BYTE, writeTask,
00915                                           <a class="code" href="tags_8h.html#a2">TAG_PDATA</a>, MPI_COMM_WORLD);
00916 
00917                               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == writeTask)
00918                                 {
00919                                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o6">SnapFormat</a> == 3)
00920                                     {
00921 <span class="preprocessor">#ifdef HAVE_HDF5</span>
00922 <span class="preprocessor"></span>                                      start[0] = pcsum;
00923                                       start[1] = 0;
00924 
00925                                       count[0] = pc;
00926                                       count[1] = <a class="code" href="proto_8h.html#a88">get_values_per_blockelement</a>(blocknr);
00927                                       pcsum += pc;
00928 
00929                                       H5Sselect_hyperslab(hdf5_dataspace_in_file, H5S_SELECT_SET,
00930                                                           start, NULL, count, NULL);
00931 
00932                                       dims[0] = pc;
00933                                       dims[1] = <a class="code" href="proto_8h.html#a88">get_values_per_blockelement</a>(blocknr);
00934                                       hdf5_dataspace_memory = H5Screate_simple(rank, dims, NULL);
00935 
00936                                       hdf5_status =
00937                                         H5Dwrite(hdf5_dataset, hdf5_datatype, hdf5_dataspace_memory,
00938                                                  hdf5_dataspace_in_file, H5P_DEFAULT, <a class="code" href="allvars_8c.html#a49">CommBuffer</a>);
00939 
00940                                       H5Sclose(hdf5_dataspace_memory);
00941 <span class="preprocessor">#endif</span>
00942 <span class="preprocessor"></span>                                    }
00943                                   <span class="keywordflow">else</span>
00944                                     <a class="code" href="proto_8h.html#a108">my_fwrite</a>(<a class="code" href="allvars_8c.html#a49">CommBuffer</a>, bytes_per_blockelement, pc, fd);
00945                                 }
00946 
00947                               n_for_this_task -= pc;
00948                             }
00949                         }
00950 
00951 <span class="preprocessor">#ifdef HAVE_HDF5</span>
00952 <span class="preprocessor"></span>                      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == writeTask &amp;&amp; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o6">SnapFormat</a> == 3 &amp;&amp; <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[type] &gt; 0)
00953                         {
00954                           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o6">SnapFormat</a> == 3)
00955                             {
00956                               H5Dclose(hdf5_dataset);
00957                               H5Sclose(hdf5_dataspace_in_file);
00958                               H5Tclose(hdf5_datatype);
00959                             }
00960                         }
00961 <span class="preprocessor">#endif</span>
00962 <span class="preprocessor"></span>                    }
00963                 }
00964 
00965               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == writeTask)
00966                 {
00967                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o6">SnapFormat</a> == 1 || <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o6">SnapFormat</a> == 2)
00968                     SKIP;
00969                 }
00970             }
00971         }
00972     }
00973 
00974   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == writeTask)
00975     {
00976       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o6">SnapFormat</a> == 3)
00977         {
00978 <span class="preprocessor">#ifdef HAVE_HDF5</span>
00979 <span class="preprocessor"></span>          <span class="keywordflow">for</span>(type = 5; type &gt;= 0; type--)
00980             <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[type] &gt; 0)
00981               H5Gclose(hdf5_grp[type]);
00982           H5Gclose(hdf5_headergrp);
00983           H5Fclose(hdf5_file);
00984 <span class="preprocessor">#endif</span>
00985 <span class="preprocessor"></span>        }
00986       <span class="keywordflow">else</span>
00987         fclose(fd);
00988     }
00989 }
00990 
00991 
00992 
00993 
00997 <span class="preprocessor">#ifdef HAVE_HDF5</span>
00998 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="proto_8h.html#a154">write_header_attributes_in_hdf5</a>(hid_t handle)
00999 {
<a name="l01000"></a><a class="code" href="proto_8h.html#a154">01000</a>   hsize_t adim[1] = { 6 };
01001   hid_t hdf5_dataspace, hdf5_attribute;
01002 
01003   hdf5_dataspace = H5Screate(H5S_SIMPLE);
01004   H5Sset_extent_simple(hdf5_dataspace, 1, adim, NULL);
01005   hdf5_attribute = H5Acreate(handle, <span class="stringliteral">"NumPart_ThisFile"</span>, H5T_NATIVE_INT, hdf5_dataspace, H5P_DEFAULT);
01006   H5Awrite(hdf5_attribute, H5T_NATIVE_UINT, <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>);
01007   H5Aclose(hdf5_attribute);
01008   H5Sclose(hdf5_dataspace);
01009 
01010   hdf5_dataspace = H5Screate(H5S_SIMPLE);
01011   H5Sset_extent_simple(hdf5_dataspace, 1, adim, NULL);
01012   hdf5_attribute = H5Acreate(handle, <span class="stringliteral">"NumPart_Total"</span>, H5T_NATIVE_UINT, hdf5_dataspace, H5P_DEFAULT);
01013   H5Awrite(hdf5_attribute, H5T_NATIVE_UINT, <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o6">npartTotal</a>);
01014   H5Aclose(hdf5_attribute);
01015   H5Sclose(hdf5_dataspace);
01016 
01017   hdf5_dataspace = H5Screate(H5S_SIMPLE);
01018   H5Sset_extent_simple(hdf5_dataspace, 1, adim, NULL);
01019   hdf5_attribute = H5Acreate(handle, <span class="stringliteral">"NumPart_Total_HW"</span>, H5T_NATIVE_UINT, hdf5_dataspace, H5P_DEFAULT);
01020   H5Awrite(hdf5_attribute, H5T_NATIVE_UINT, <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o15">npartTotalHighWord</a>);
01021   H5Aclose(hdf5_attribute);
01022   H5Sclose(hdf5_dataspace);
01023 
01024 
01025   hdf5_dataspace = H5Screate(H5S_SIMPLE);
01026   H5Sset_extent_simple(hdf5_dataspace, 1, adim, NULL);
01027   hdf5_attribute = H5Acreate(handle, <span class="stringliteral">"MassTable"</span>, H5T_NATIVE_DOUBLE, hdf5_dataspace, H5P_DEFAULT);
01028   H5Awrite(hdf5_attribute, H5T_NATIVE_DOUBLE, <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o1">mass</a>);
01029   H5Aclose(hdf5_attribute);
01030   H5Sclose(hdf5_dataspace);
01031 
01032   hdf5_dataspace = H5Screate(H5S_SCALAR);
01033   hdf5_attribute = H5Acreate(handle, <span class="stringliteral">"Time"</span>, H5T_NATIVE_DOUBLE, hdf5_dataspace, H5P_DEFAULT);
01034   H5Awrite(hdf5_attribute, H5T_NATIVE_DOUBLE, &amp;<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o2">time</a>);
01035   H5Aclose(hdf5_attribute);
01036   H5Sclose(hdf5_dataspace);
01037 
01038   hdf5_dataspace = H5Screate(H5S_SCALAR);
01039   hdf5_attribute = H5Acreate(handle, <span class="stringliteral">"Redshift"</span>, H5T_NATIVE_DOUBLE, hdf5_dataspace, H5P_DEFAULT);
01040   H5Awrite(hdf5_attribute, H5T_NATIVE_DOUBLE, &amp;<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o3">redshift</a>);
01041   H5Aclose(hdf5_attribute);
01042   H5Sclose(hdf5_dataspace);
01043 
01044   hdf5_dataspace = H5Screate(H5S_SCALAR);
01045   hdf5_attribute = H5Acreate(handle, <span class="stringliteral">"BoxSize"</span>, H5T_NATIVE_DOUBLE, hdf5_dataspace, H5P_DEFAULT);
01046   H5Awrite(hdf5_attribute, H5T_NATIVE_DOUBLE, &amp;<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o9">BoxSize</a>);
01047   H5Aclose(hdf5_attribute);
01048   H5Sclose(hdf5_dataspace);
01049 
01050   hdf5_dataspace = H5Screate(H5S_SCALAR);
01051   hdf5_attribute = H5Acreate(handle, <span class="stringliteral">"NumFilesPerSnapshot"</span>, H5T_NATIVE_INT, hdf5_dataspace, H5P_DEFAULT);
01052   H5Awrite(hdf5_attribute, H5T_NATIVE_INT, &amp;<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o8">num_files</a>);
01053   H5Aclose(hdf5_attribute);
01054   H5Sclose(hdf5_dataspace);
01055 
01056   hdf5_dataspace = H5Screate(H5S_SCALAR);
01057   hdf5_attribute = H5Acreate(handle, <span class="stringliteral">"Omega0"</span>, H5T_NATIVE_DOUBLE, hdf5_dataspace, H5P_DEFAULT);
01058   H5Awrite(hdf5_attribute, H5T_NATIVE_DOUBLE, &amp;<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o10">Omega0</a>);
01059   H5Aclose(hdf5_attribute);
01060   H5Sclose(hdf5_dataspace);
01061 
01062   hdf5_dataspace = H5Screate(H5S_SCALAR);
01063   hdf5_attribute = H5Acreate(handle, <span class="stringliteral">"OmegaLambda"</span>, H5T_NATIVE_DOUBLE, hdf5_dataspace, H5P_DEFAULT);
01064   H5Awrite(hdf5_attribute, H5T_NATIVE_DOUBLE, &amp;<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o11">OmegaLambda</a>);
01065   H5Aclose(hdf5_attribute);
01066   H5Sclose(hdf5_dataspace);
01067 
01068   hdf5_dataspace = H5Screate(H5S_SCALAR);
01069   hdf5_attribute = H5Acreate(handle, <span class="stringliteral">"HubbleParam"</span>, H5T_NATIVE_DOUBLE, hdf5_dataspace, H5P_DEFAULT);
01070   H5Awrite(hdf5_attribute, H5T_NATIVE_DOUBLE, &amp;<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o12">HubbleParam</a>);
01071   H5Aclose(hdf5_attribute);
01072   H5Sclose(hdf5_dataspace);
01073 
01074   hdf5_dataspace = H5Screate(H5S_SCALAR);
01075   hdf5_attribute = H5Acreate(handle, <span class="stringliteral">"Flag_Sfr"</span>, H5T_NATIVE_INT, hdf5_dataspace, H5P_DEFAULT);
01076   H5Awrite(hdf5_attribute, H5T_NATIVE_INT, &amp;<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o4">flag_sfr</a>);
01077   H5Aclose(hdf5_attribute);
01078   H5Sclose(hdf5_dataspace);
01079 
01080   hdf5_dataspace = H5Screate(H5S_SCALAR);
01081   hdf5_attribute = H5Acreate(handle, <span class="stringliteral">"Flag_Cooling"</span>, H5T_NATIVE_INT, hdf5_dataspace, H5P_DEFAULT);
01082   H5Awrite(hdf5_attribute, H5T_NATIVE_INT, &amp;<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o7">flag_cooling</a>);
01083   H5Aclose(hdf5_attribute);
01084   H5Sclose(hdf5_dataspace);
01085 
01086   hdf5_dataspace = H5Screate(H5S_SCALAR);
01087   hdf5_attribute = H5Acreate(handle, <span class="stringliteral">"Flag_StellarAge"</span>, H5T_NATIVE_INT, hdf5_dataspace, H5P_DEFAULT);
01088   H5Awrite(hdf5_attribute, H5T_NATIVE_INT, &amp;<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o13">flag_stellarage</a>);
01089   H5Aclose(hdf5_attribute);
01090   H5Sclose(hdf5_dataspace);
01091 
01092   hdf5_dataspace = H5Screate(H5S_SCALAR);
01093   hdf5_attribute = H5Acreate(handle, <span class="stringliteral">"Flag_Metals"</span>, H5T_NATIVE_INT, hdf5_dataspace, H5P_DEFAULT);
01094   H5Awrite(hdf5_attribute, H5T_NATIVE_INT, &amp;<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o14">flag_metals</a>);
01095   H5Aclose(hdf5_attribute);
01096   H5Sclose(hdf5_dataspace);
01097 
01098   hdf5_dataspace = H5Screate(H5S_SCALAR);
01099   hdf5_attribute = H5Acreate(handle, <span class="stringliteral">"Flag_Feedback"</span>, H5T_NATIVE_INT, hdf5_dataspace, H5P_DEFAULT);
01100   H5Awrite(hdf5_attribute, H5T_NATIVE_INT, &amp;<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o5">flag_feedback</a>);
01101   H5Aclose(hdf5_attribute);
01102   H5Sclose(hdf5_dataspace);
01103 
01104   <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o16">flag_entropy_instead_u</a> = 0;
01105 
01106   hdf5_dataspace = H5Screate(H5S_SIMPLE);
01107   H5Sset_extent_simple(hdf5_dataspace, 1, adim, NULL);
01108   hdf5_attribute = H5Acreate(handle, <span class="stringliteral">"Flag_Entropy_ICs"</span>, H5T_NATIVE_UINT, hdf5_dataspace, H5P_DEFAULT);
01109   H5Awrite(hdf5_attribute, H5T_NATIVE_UINT, &amp;<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o16">flag_entropy_instead_u</a>);
01110   H5Aclose(hdf5_attribute);
01111   H5Sclose(hdf5_dataspace);
01112 }
01113 <span class="preprocessor">#endif</span>
01114 <span class="preprocessor"></span>
01115 
01116 
01117 
01118 
01122 size_t <a class="code" href="proto_8h.html#a108">my_fwrite</a>(<span class="keywordtype">void</span> *ptr, size_t size, size_t nmemb, FILE * stream)
01123 {
<a name="l01124"></a><a class="code" href="proto_8h.html#a108">01124</a>   size_t nwritten;
01125 
01126   <span class="keywordflow">if</span>((nwritten = fwrite(ptr, size, nmemb, stream)) != nmemb)
01127     {
01128       printf(<span class="stringliteral">"I/O error (fwrite) on task=%d has occured: %s\n"</span>, <a class="code" href="allvars_8c.html#a0">ThisTask</a>, strerror(errno));
01129       fflush(stdout);
01130       <a class="code" href="proto_8h.html#a38">endrun</a>(777);
01131     }
01132   <span class="keywordflow">return</span> nwritten;
01133 }
01134 
01135 
01139 size_t <a class="code" href="proto_8h.html#a107">my_fread</a>(<span class="keywordtype">void</span> *ptr, size_t size, size_t nmemb, FILE * stream)
01140 {
<a name="l01141"></a><a class="code" href="proto_8h.html#a107">01141</a>   size_t nread;
01142 
01143   <span class="keywordflow">if</span>((nread = fread(ptr, size, nmemb, stream)) != nmemb)
01144     {
01145       printf(<span class="stringliteral">"I/O error (fread) on task=%d has occured: %s\n"</span>, <a class="code" href="allvars_8c.html#a0">ThisTask</a>, strerror(errno));
01146       fflush(stdout);
01147       <a class="code" href="proto_8h.html#a38">endrun</a>(778);
01148     }
01149   <span class="keywordflow">return</span> nread;
01150 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 22 15:29:41 2006 for GADGET-2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
