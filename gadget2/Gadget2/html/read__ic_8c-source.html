<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GADGET-2: read_ic.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>read_ic.c</h1><a href="read__ic_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00002 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00003 <span class="preprocessor">#include &lt;string.h&gt;</span>
00004 <span class="preprocessor">#include &lt;math.h&gt;</span>
00005 <span class="preprocessor">#include &lt;string.h&gt;</span>
00006 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
00007 
00008 <span class="preprocessor">#include "<a class="code" href="allvars_8h.html">allvars.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="proto_8h.html">proto.h</a>"</span>
00010 
00011 
<a name="l00031"></a><a class="code" href="read__ic_8c.html#a2">00031</a> <span class="keywordtype">void</span> <a class="code" href="read__ic_8c.html#a2">read_ic</a>(<span class="keywordtype">char</span> *fname)
00032 {
00033   <span class="keywordtype">int</span> i, num_files, rest_files, ngroups, gr, filenr, masterTask, lastTask, groupMaster;
00034   <span class="keywordtype">double</span> u_init;
00035   <span class="keywordtype">char</span> buf[500];
00036 
00037 <span class="preprocessor">#ifndef ISOTHERM_EQS</span>
00038 <span class="preprocessor"></span>  <span class="keywordtype">double</span> molecular_weight;
00039 <span class="preprocessor">#endif</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#ifdef SFR</span>
00041 <span class="preprocessor"></span>  <span class="keywordtype">double</span> original_gas_mass, mass, masstot;
00042 <span class="preprocessor">#endif</span>
00043 <span class="preprocessor"></span>
00044   <a class="code" href="allvars_8c.html#a3">NumPart</a> = 0;
00045   <a class="code" href="allvars_8c.html#a4">N_gas</a> = 0;
00046   <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a> = 0;
00047 
00048   num_files = <a class="code" href="read__ic_8c.html#a5">find_files</a>(fname);
00049 
00050   rest_files = num_files;
00051 
00052   <a class="code" href="io_8c.html#a10">fill_Tab_IO_Labels</a>();
00053 
00054   <span class="keywordflow">while</span>(rest_files &gt; NTask)
00055     {
00056       sprintf(buf, <span class="stringliteral">"%s.%d"</span>, fname, <a class="code" href="allvars_8c.html#a0">ThisTask</a> + (rest_files - <a class="code" href="allvars_8c.html#a1">NTask</a>));
00057       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 3)
00058         sprintf(buf, <span class="stringliteral">"%s.%d.hdf5"</span>, fname, <a class="code" href="allvars_8c.html#a0">ThisTask</a> + (rest_files - <a class="code" href="allvars_8c.html#a1">NTask</a>));
00059 
00060       ngroups = <a class="code" href="allvars_8c.html#a1">NTask</a> / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o8">NumFilesWrittenInParallel</a>;
00061       <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a1">NTask</a> % <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o8">NumFilesWrittenInParallel</a>))
00062         ngroups++;
00063       groupMaster = (<a class="code" href="allvars_8c.html#a0">ThisTask</a> / ngroups) * ngroups;
00064 
00065       <span class="keywordflow">for</span>(gr = 0; gr &lt; ngroups; gr++)
00066         {
00067           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == (groupMaster + gr))    <span class="comment">/* ok, it's this processor's turn */</span>
00068             <a class="code" href="read__ic_8c.html#a4">read_file</a>(buf, <a class="code" href="allvars_8c.html#a0">ThisTask</a>, <a class="code" href="allvars_8c.html#a0">ThisTask</a>);
00069           MPI_Barrier(MPI_COMM_WORLD);
00070         }
00071 
00072       rest_files -= NTask;
00073     }
00074 
00075 
00076   <span class="keywordflow">if</span>(rest_files &gt; 0)
00077     {
00078       <a class="code" href="read__ic_8c.html#a6">distribute_file</a>(rest_files, 0, 0, <a class="code" href="allvars_8c.html#a1">NTask</a> - 1, &amp;filenr, &amp;masterTask, &amp;lastTask);
00079 
00080       <span class="keywordflow">if</span>(num_files &gt; 1)
00081         {
00082           sprintf(buf, <span class="stringliteral">"%s.%d"</span>, fname, filenr);
00083           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 3)
00084             sprintf(buf, <span class="stringliteral">"%s.%d.hdf5"</span>, fname, filenr);
00085         }
00086       <span class="keywordflow">else</span>
00087         {
00088           sprintf(buf, <span class="stringliteral">"%s"</span>, fname);
00089           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 3)
00090             sprintf(buf, <span class="stringliteral">"%s.hdf5"</span>, fname);
00091         }
00092 
00093       ngroups = rest_files / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o8">NumFilesWrittenInParallel</a>;
00094       <span class="keywordflow">if</span>((rest_files % <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o8">NumFilesWrittenInParallel</a>))
00095         ngroups++;
00096 
00097       <span class="keywordflow">for</span>(gr = 0; gr &lt; ngroups; gr++)
00098         {
00099           <span class="keywordflow">if</span>((filenr / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o8">NumFilesWrittenInParallel</a>) == gr)    <span class="comment">/* ok, it's this processor's turn */</span>
00100             <a class="code" href="read__ic_8c.html#a4">read_file</a>(buf, masterTask, lastTask);
00101           MPI_Barrier(MPI_COMM_WORLD);
00102         }
00103     }
00104 
00105 
00106   <span class="comment">/* this makes sure that masses are initialized in the case that the mass-block</span>
00107 <span class="comment">     is completely empty */</span>
00108   <span class="keywordflow">for</span>(i = 0; i &lt; NumPart; i++)
00109     {
00110       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o113">MassTable</a>[<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a>] != 0)
00111         <a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o1">Mass</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o113">MassTable</a>[<a class="code" href="allvars_8c.html#a51">P</a>[i].<a class="code" href="structparticle__data.html#o9">Type</a>];
00112     }
00113 
00114   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a10">RestartFlag</a> == 0)
00115     {
00116       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o19">InitGasTemp</a> &gt; 0)
00117         {
00118           u_init = (<a class="code" href="allvars_8h.html#a17">BOLTZMANN</a> / PROTONMASS) * <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o19">InitGasTemp</a>;
00119           u_init *= <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o26">UnitMass_in_g</a> / <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o32">UnitEnergy_in_cgs</a>;  <span class="comment">/* unit conversion */</span>
00120 
00121 <span class="preprocessor">#ifdef ISOTHERM_EQS</span>
00122 <span class="preprocessor"></span>          u_init *= 1.0;
00123 <span class="preprocessor">#else</span>
00124 <span class="preprocessor"></span>          u_init *= (1.0 / GAMMA_MINUS1);
00125 
00126           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o19">InitGasTemp</a> &gt; 1.0e4)   <span class="comment">/* assuming FULL ionization */</span>
00127             molecular_weight = 4 / (8 - 5 * (1 - HYDROGEN_MASSFRAC));
00128           <span class="keywordflow">else</span>                  <span class="comment">/* assuming NEUTRAL GAS */</span>
00129             molecular_weight = 4 / (1 + 3 * HYDROGEN_MASSFRAC);
00130 
00131           u_init /= molecular_weight;
00132 <span class="preprocessor">#endif</span>
00133 <span class="preprocessor"></span>
00134           <span class="keywordflow">for</span>(i = 0; i &lt; N_gas; i++)
00135             {
00136               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o0">Entropy</a> == 0)
00137                 <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o0">Entropy</a> = u_init;
00138 
00139               <span class="comment">/* Note: the coversion to entropy will be done in the function init(),</span>
00140 <span class="comment">                 after the densities have been computed */</span>
00141             }
00142         }
00143     }
00144 
00145   <span class="keywordflow">for</span>(i = 0; i &lt; N_gas; i++)
00146     <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o0">Entropy</a> = <a class="code" href="system_8c.html#a4">dmax</a>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o21">MinEgySpec</a>, <a class="code" href="allvars_8c.html#a53">SphP</a>[i].<a class="code" href="structsph__particle__data.html#o0">Entropy</a>);
00147 
00148   MPI_Barrier(MPI_COMM_WORLD);
00149 
00150   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00151     {
00152       printf(<span class="stringliteral">"reading done.\n"</span>);
00153       fflush(stdout);
00154     }
00155 
00156   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00157     {
00158       printf(<span class="stringliteral">"Total number of particles :  %d%09d\n\n"</span>,
00159              (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a> / 1000000000), (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a> % 1000000000));
00160       fflush(stdout);
00161     }
00162 }
00163 
00164 
<a name="l00168"></a><a class="code" href="read__ic_8c.html#a3">00168</a> <span class="keywordtype">void</span> <a class="code" href="read__ic_8c.html#a3">empty_read_buffer</a>(<span class="keyword">enum</span> iofields blocknr, <span class="keywordtype">int</span> offset, <span class="keywordtype">int</span> pc, <span class="keywordtype">int</span> type)
00169 {
00170   <span class="keywordtype">int</span> n, k;
00171   <span class="keywordtype">float</span> *fp;
00172 
00173 <span class="preprocessor">#ifdef LONGIDS</span>
00174 <span class="preprocessor"></span>  <span class="keywordtype">long</span> <span class="keywordtype">long</span> *ip;
00175 <span class="preprocessor">#else</span>
00176 <span class="preprocessor"></span>  <span class="keywordtype">int</span> *ip;
00177 <span class="preprocessor">#endif</span>
00178 <span class="preprocessor"></span>
00179   fp = CommBuffer;
00180   ip = CommBuffer;
00181 
00182   <span class="keywordflow">switch</span> (blocknr)
00183     {
00184     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a125">IO_POS</a>:                <span class="comment">/* positions */</span>
00185       <span class="keywordflow">for</span>(n = 0; n &lt; pc; n++)
00186         <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00187           <a class="code" href="allvars_8c.html#a51">P</a>[offset + n].<a class="code" href="structparticle__data.html#o0">Pos</a>[k] = *fp++;
00188 
00189       <span class="keywordflow">for</span>(n = 0; n &lt; pc; n++)
00190         <a class="code" href="allvars_8c.html#a51">P</a>[offset + n].<a class="code" href="structparticle__data.html#o9">Type</a> = type;      <span class="comment">/* initialize type here as well */</span>
00191       <span class="keywordflow">break</span>;
00192 
00193     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a126">IO_VEL</a>:                <span class="comment">/* velocities */</span>
00194       <span class="keywordflow">for</span>(n = 0; n &lt; pc; n++)
00195         <span class="keywordflow">for</span>(k = 0; k &lt; 3; k++)
00196           <a class="code" href="allvars_8c.html#a51">P</a>[offset + n].<a class="code" href="structparticle__data.html#o2">Vel</a>[k] = *fp++;
00197       <span class="keywordflow">break</span>;
00198 
00199     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a127">IO_ID</a>:         <span class="comment">/* particle ID */</span>
00200       <span class="keywordflow">for</span>(n = 0; n &lt; pc; n++)
00201         <a class="code" href="allvars_8c.html#a51">P</a>[offset + n].<a class="code" href="structparticle__data.html#o8">ID</a> = *ip++;
00202       <span class="keywordflow">break</span>;
00203 
00204     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a128">IO_MASS</a>:               <span class="comment">/* particle mass */</span>
00205       <span class="keywordflow">for</span>(n = 0; n &lt; pc; n++)
00206         <a class="code" href="allvars_8c.html#a51">P</a>[offset + n].<a class="code" href="structparticle__data.html#o1">Mass</a> = *fp++;
00207       <span class="keywordflow">break</span>;
00208 
00209     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a129">IO_U</a>:                  <span class="comment">/* temperature */</span>
00210       <span class="keywordflow">for</span>(n = 0; n &lt; pc; n++)
00211         <a class="code" href="allvars_8c.html#a53">SphP</a>[offset + n].<a class="code" href="structsph__particle__data.html#o0">Entropy</a> = *fp++;
00212       <span class="keywordflow">break</span>;
00213 
00214     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a130">IO_RHO</a>:                <span class="comment">/* density */</span>
00215       <span class="keywordflow">for</span>(n = 0; n &lt; pc; n++)
00216         <a class="code" href="allvars_8c.html#a53">SphP</a>[offset + n].<a class="code" href="structsph__particle__data.html#o1">Density</a> = *fp++;
00217       <span class="keywordflow">break</span>;
00218 
00219 
00220     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a131">IO_HSML</a>:               <span class="comment">/* SPH smoothing length */</span>
00221       <span class="keywordflow">for</span>(n = 0; n &lt; pc; n++)
00222         <a class="code" href="allvars_8c.html#a53">SphP</a>[offset + n].<a class="code" href="structsph__particle__data.html#o2">Hsml</a> = *fp++;
00223       <span class="keywordflow">break</span>;
00224 
00225 
00226 
00227 
00228       <span class="comment">/* the other input fields (if present) are not needed to define the </span>
00229 <span class="comment">         initial conditions of the code */</span>
00230 
00231     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a132">IO_POT</a>:
00232     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a133">IO_ACCEL</a>:
00233     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a134">IO_DTENTR</a>:
00234     <span class="keywordflow">case</span> <a class="code" href="allvars_8h.html#a136a135">IO_TSTP</a>:
00235       <span class="keywordflow">break</span>;
00236     }
00237 }
00238 
00239 
00240 
<a name="l00244"></a><a class="code" href="read__ic_8c.html#a4">00244</a> <span class="keywordtype">void</span> <a class="code" href="read__ic_8c.html#a4">read_file</a>(<span class="keywordtype">char</span> *fname, <span class="keywordtype">int</span> readTask, <span class="keywordtype">int</span> lastTask)
00245 {
00246   <span class="keywordtype">int</span> blockmaxlen;
00247   <span class="keywordtype">int</span> i, n_in_file, n_for_this_task, ntask, pc, offset = 0, task;
00248   <span class="keywordtype">int</span> blksize1, blksize2;
00249   MPI_Status status;
00250   FILE *fd = 0;
00251   <span class="keywordtype">int</span> nall;
00252   <span class="keywordtype">int</span> type;
00253   <span class="keywordtype">char</span> label[4];
00254   <span class="keywordtype">int</span> nstart, bytes_per_blockelement, npart, nextblock, typelist[6];
00255   <span class="keyword">enum</span> <a class="code" href="allvars_8h.html#a136">iofields</a> blocknr;
00256 
00257 <span class="preprocessor">#ifdef HAVE_HDF5</span>
00258 <span class="preprocessor"></span>  <span class="keywordtype">char</span> buf[500];
00259   <span class="keywordtype">int</span> rank, pcsum;
00260   hid_t hdf5_file, hdf5_grp[6], hdf5_dataspace_in_file;
00261   hid_t hdf5_datatype, hdf5_dataspace_in_memory, hdf5_dataset;
00262   hsize_t dims[2], count[2], start[2];
00263 <span class="preprocessor">#endif</span>
00264 <span class="preprocessor"></span>
00265 <span class="preprocessor">#define SKIP  {my_fread(&amp;blksize1,sizeof(int),1,fd);}</span>
00266 <span class="preprocessor"></span><span class="preprocessor">#define SKIP2  {my_fread(&amp;blksize2,sizeof(int),1,fd);}</span>
00267 <span class="preprocessor"></span>
00268   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == readTask)
00269     {
00270       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 1 || <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 2)
00271         {
00272           <span class="keywordflow">if</span>(!(fd = fopen(fname, <span class="stringliteral">"r"</span>)))
00273             {
00274               printf(<span class="stringliteral">"can't open file `%s' for reading initial conditions.\n"</span>, fname);
00275               <a class="code" href="proto_8h.html#a38">endrun</a>(123);
00276             }
00277 
00278           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 2)
00279             {
00280               SKIP;
00281               <a class="code" href="proto_8h.html#a107">my_fread</a>(&amp;label, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), 4, fd);
00282               <a class="code" href="proto_8h.html#a107">my_fread</a>(&amp;nextblock, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), 1, fd);
00283               printf(<span class="stringliteral">"Reading header =&gt; '%c%c%c%c' (%d byte)\n"</span>, label[0], label[1], label[2], label[3],
00284                      nextblock);
00285               SKIP2;
00286             }
00287 
00288           SKIP;
00289           <a class="code" href="proto_8h.html#a107">my_fread</a>(&amp;<a class="code" href="allvars_8c.html#a63">header</a>, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8c.html#a63">header</a>), 1, fd);
00290           SKIP2;
00291 
00292           <span class="keywordflow">if</span>(blksize1 != 256 || blksize2 != 256)
00293             {
00294               printf(<span class="stringliteral">"incorrect header format\n"</span>);
00295               fflush(stdout);
00296               <a class="code" href="proto_8h.html#a38">endrun</a>(890);
00297             }
00298         }
00299 
00300 
00301 <span class="preprocessor">#ifdef HAVE_HDF5</span>
00302 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 3)
00303         {
00304           <a class="code" href="read__ic_8c.html#a7">read_header_attributes_in_hdf5</a>(fname);
00305 
00306           hdf5_file = H5Fopen(fname, H5F_ACC_RDONLY, H5P_DEFAULT);
00307 
00308           <span class="keywordflow">for</span>(type = 0; type &lt; 6; type++)
00309             {
00310               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[type] &gt; 0)
00311                 {
00312                   sprintf(buf, <span class="stringliteral">"/PartType%d"</span>, type);
00313                   hdf5_grp[type] = H5Gopen(hdf5_file, buf);
00314                 }
00315             }
00316         }
00317 <span class="preprocessor">#endif</span>
00318 <span class="preprocessor"></span>
00319       <span class="keywordflow">for</span>(task = readTask + 1; task &lt;= lastTask; task++)
00320         MPI_Ssend(&amp;<a class="code" href="allvars_8c.html#a63">header</a>, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8c.html#a63">header</a>), MPI_BYTE, task, <a class="code" href="tags_8h.html#a1">TAG_HEADER</a>, MPI_COMM_WORLD);
00321     }
00322   <span class="keywordflow">else</span>
00323     MPI_Recv(&amp;<a class="code" href="allvars_8c.html#a63">header</a>, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8c.html#a63">header</a>), MPI_BYTE, readTask, <a class="code" href="tags_8h.html#a1">TAG_HEADER</a>, MPI_COMM_WORLD, &amp;status);
00324 
00325 
00326   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a> == 0)
00327     {
00328       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o8">num_files</a> &lt;= 1)
00329         <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
00330           <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o6">npartTotal</a>[i] = <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[i];
00331 
00332       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o1">TotN_gas</a> = <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o6">npartTotal</a>[0] + (((<span class="keywordtype">long</span> long) <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o15">npartTotalHighWord</a>[0]) &lt;&lt; 32);
00333 
00334       <span class="keywordflow">for</span>(i = 0, <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a> = 0; i &lt; 6; i++)
00335         {
00336           <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a> += <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o6">npartTotal</a>[i];
00337           <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a> += (((<span class="keywordtype">long</span> long) <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o15">npartTotalHighWord</a>[i]) &lt;&lt; 32);
00338         }
00339 
00340 
00341       <span class="keywordflow">for</span>(i = 0; i &lt; 6; i++)
00342         <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o113">MassTable</a>[i] = <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o1">mass</a>[i];
00343 
00344       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o14">PartAllocFactor</a> * (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o0">TotNumPart</a> / NTask);     <span class="comment">/* sets the maximum number of particles that may */</span>
00345       <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o3">MaxPartSph</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o14">PartAllocFactor</a> * (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o1">TotN_gas</a> / NTask);    <span class="comment">/* sets the maximum number of particles that may </span>
00346 <span class="comment">                                                                           reside on a processor */</span>
00347       <a class="code" href="allocate_8c.html#a1">allocate_memory</a>();
00348 
00349       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a10">RestartFlag</a> == 2)
00350         <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o54">Time</a> = <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o55">TimeBegin</a> = <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o2">time</a>;
00351     }
00352 
00353   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == readTask)
00354     {
00355       <span class="keywordflow">for</span>(i = 0, n_in_file = 0; i &lt; 6; i++)
00356         n_in_file += <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[i];
00357 
00358       printf(<span class="stringliteral">"\nreading file `%s' on task=%d (contains %d particles.)\n"</span>
00359              <span class="stringliteral">"distributing this file to tasks %d-%d\n"</span>
00360              <span class="stringliteral">"Type 0 (gas):   %8d  (tot=%6d%09d) masstab=%g\n"</span>
00361              <span class="stringliteral">"Type 1 (halo):  %8d  (tot=%6d%09d) masstab=%g\n"</span>
00362              <span class="stringliteral">"Type 2 (disk):  %8d  (tot=%6d%09d) masstab=%g\n"</span>
00363              <span class="stringliteral">"Type 3 (bulge): %8d  (tot=%6d%09d) masstab=%g\n"</span>
00364              <span class="stringliteral">"Type 4 (stars): %8d  (tot=%6d%09d) masstab=%g\n"</span>
00365              <span class="stringliteral">"Type 5 (bndry): %8d  (tot=%6d%09d) masstab=%g\n\n"</span>, fname, <a class="code" href="allvars_8c.html#a0">ThisTask</a>, n_in_file, readTask,
00366              lastTask, <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[0], (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o6">npartTotal</a>[0] / 1000000000),
00367              (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o6">npartTotal</a>[0] % 1000000000), <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o113">MassTable</a>[0], <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[1],
00368              (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o6">npartTotal</a>[1] / 1000000000), (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o6">npartTotal</a>[1] % 1000000000),
00369              <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o113">MassTable</a>[1], <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[2], (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o6">npartTotal</a>[2] / 1000000000),
00370              (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o6">npartTotal</a>[2] % 1000000000), <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o113">MassTable</a>[2], <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[3],
00371              (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o6">npartTotal</a>[3] / 1000000000), (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o6">npartTotal</a>[3] % 1000000000),
00372              <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o113">MassTable</a>[3], <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[4], (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o6">npartTotal</a>[4] / 1000000000),
00373              (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o6">npartTotal</a>[4] % 1000000000), <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o113">MassTable</a>[4], <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[5],
00374              (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o6">npartTotal</a>[5] / 1000000000), (<span class="keywordtype">int</span>) (<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o6">npartTotal</a>[5] % 1000000000),
00375              <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o113">MassTable</a>[5]);
00376       fflush(stdout);
00377     }
00378 
00379 
00380   ntask = lastTask - readTask + 1;
00381 
00382 
00383   <span class="comment">/* to collect the gas particles all at the beginning (in case several</span>
00384 <span class="comment">     snapshot files are read on the current CPU) we move the collisionless</span>
00385 <span class="comment">     particles such that a gap of the right size is created */</span>
00386 
00387   <span class="keywordflow">for</span>(type = 0, nall = 0; type &lt; 6; type++)
00388     {
00389       n_in_file = <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[type];
00390 
00391       n_for_this_task = n_in_file / ntask;
00392       <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a0">ThisTask</a> - readTask) &lt; (n_in_file % ntask))
00393         n_for_this_task++;
00394 
00395       nall += n_for_this_task;
00396     }
00397 
00398   memmove(&amp;<a class="code" href="allvars_8c.html#a51">P</a>[<a class="code" href="allvars_8c.html#a4">N_gas</a> + nall], &amp;<a class="code" href="allvars_8c.html#a51">P</a>[<a class="code" href="allvars_8c.html#a4">N_gas</a>], (<a class="code" href="allvars_8c.html#a3">NumPart</a> - <a class="code" href="allvars_8c.html#a4">N_gas</a>) * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structparticle__data.html">particle_data</a>));
00399   nstart = N_gas;
00400 
00401 
00402 
00403   <span class="keywordflow">for</span>(blocknr = 0; blocknr &lt; IO_NBLOCKS; blocknr++)
00404     {
00405       <span class="keywordflow">if</span>(<a class="code" href="proto_8h.html#a4">blockpresent</a>(blocknr))
00406         {
00407           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a10">RestartFlag</a> == 0 &amp;&amp; blocknr &gt; IO_U)
00408             <span class="keywordflow">continue</span>;           <span class="comment">/* ignore all other blocks in initial conditions */</span>
00409 
00410           bytes_per_blockelement = <a class="code" href="proto_8h.html#a79">get_bytes_per_blockelement</a>(blocknr);
00411 
00412           blockmaxlen = ((int) (<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o9">BufferSize</a> * 1024 * 1024)) / bytes_per_blockelement;
00413 
00414           npart = <a class="code" href="proto_8h.html#a85">get_particles_in_block</a>(blocknr, &amp;typelist[0]);
00415 
00416           <span class="keywordflow">if</span>(npart &gt; 0)
00417             {
00418               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == readTask)
00419                 {
00420                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 2)
00421                     {
00422                       SKIP;
00423                       <a class="code" href="proto_8h.html#a107">my_fread</a>(&amp;label, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), 4, fd);
00424                       <a class="code" href="proto_8h.html#a107">my_fread</a>(&amp;nextblock, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), 1, fd);
00425                       printf(<span class="stringliteral">"Reading header =&gt; '%c%c%c%c' (%d byte)\n"</span>, label[0], label[1], label[2],
00426                              label[3], nextblock);
00427                       SKIP2;
00428 
00429                       <span class="keywordflow">if</span>(strncmp(label, <a class="code" href="allvars_8c.html#a64">Tab_IO_Labels</a>[blocknr], 4) != 0)
00430                         {
00431                           printf(<span class="stringliteral">"incorrect block-structure!\n"</span>);
00432                           printf(<span class="stringliteral">"expected '%c%c%c%c' but found '%c%c%c%c'\n"</span>,
00433                                  label[0], label[1], label[2], label[3],
00434                                  <a class="code" href="allvars_8c.html#a64">Tab_IO_Labels</a>[blocknr][0], <a class="code" href="allvars_8c.html#a64">Tab_IO_Labels</a>[blocknr][1],
00435                                  <a class="code" href="allvars_8c.html#a64">Tab_IO_Labels</a>[blocknr][2], <a class="code" href="allvars_8c.html#a64">Tab_IO_Labels</a>[blocknr][3]);
00436                           fflush(stdout);
00437                           <a class="code" href="proto_8h.html#a38">endrun</a>(1890);
00438                         }
00439                     }
00440 
00441                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 1 || <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 2)
00442                     SKIP;
00443                 }
00444 
00445               <span class="keywordflow">for</span>(type = 0, offset = 0; type &lt; 6; type++)
00446                 {
00447                   n_in_file = <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[type];
00448 <span class="preprocessor">#ifdef HAVE_HDF5</span>
00449 <span class="preprocessor"></span>                  pcsum = 0;
00450 <span class="preprocessor">#endif</span>
00451 <span class="preprocessor"></span>                  <span class="keywordflow">if</span>(typelist[type] == 0)
00452                     {
00453                       n_for_this_task = n_in_file / ntask;
00454                       <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a0">ThisTask</a> - readTask) &lt; (n_in_file % ntask))
00455                         n_for_this_task++;
00456 
00457                       offset += n_for_this_task;
00458                     }
00459                   <span class="keywordflow">else</span>
00460                     {
00461                       <span class="keywordflow">for</span>(task = readTask; task &lt;= lastTask; task++)
00462                         {
00463                           n_for_this_task = n_in_file / ntask;
00464                           <span class="keywordflow">if</span>((task - readTask) &lt; (n_in_file % ntask))
00465                             n_for_this_task++;
00466 
00467                           <span class="keywordflow">if</span>(task == ThisTask)
00468                             <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a3">NumPart</a> + n_for_this_task &gt; <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o2">MaxPart</a>)
00469                               {
00470                                 printf(<span class="stringliteral">"too many particles\n"</span>);
00471                                 <a class="code" href="proto_8h.html#a38">endrun</a>(1313);
00472                               }
00473 
00474 
00475                           <span class="keywordflow">do</span>
00476                             {
00477                               pc = n_for_this_task;
00478 
00479                               <span class="keywordflow">if</span>(pc &gt; blockmaxlen)
00480                                 pc = blockmaxlen;
00481 
00482                               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == readTask)
00483                                 {
00484                                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 1 || <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 2)
00485                                     <a class="code" href="proto_8h.html#a107">my_fread</a>(<a class="code" href="allvars_8c.html#a49">CommBuffer</a>, bytes_per_blockelement, pc, fd);
00486 <span class="preprocessor">#ifdef HAVE_HDF5</span>
00487 <span class="preprocessor"></span>                                  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 3)
00488                                     {
00489                                       <a class="code" href="proto_8h.html#a80">get_dataset_name</a>(blocknr, buf);
00490                                       hdf5_dataset = H5Dopen(hdf5_grp[type], buf);
00491 
00492                                       dims[0] = <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[type];
00493                                       dims[1] = <a class="code" href="proto_8h.html#a88">get_values_per_blockelement</a>(blocknr);
00494                                       <span class="keywordflow">if</span>(dims[1] == 1)
00495                                         rank = 1;
00496                                       <span class="keywordflow">else</span>
00497                                         rank = 2;
00498 
00499                                       hdf5_dataspace_in_file = H5Screate_simple(rank, dims, NULL);
00500 
00501                                       dims[0] = pc;
00502                                       hdf5_dataspace_in_memory = H5Screate_simple(rank, dims, NULL);
00503 
00504                                       start[0] = pcsum;
00505                                       start[1] = 0;
00506 
00507                                       count[0] = pc;
00508                                       count[1] = <a class="code" href="proto_8h.html#a88">get_values_per_blockelement</a>(blocknr);
00509                                       pcsum += pc;
00510 
00511                                       H5Sselect_hyperslab(hdf5_dataspace_in_file, H5S_SELECT_SET,
00512                                                           start, NULL, count, NULL);
00513 
00514                                       <span class="keywordflow">switch</span> (<a class="code" href="proto_8h.html#a81">get_datatype_in_block</a>(blocknr))
00515                                         {
00516                                         <span class="keywordflow">case</span> 0:
00517                                           hdf5_datatype = H5Tcopy(H5T_NATIVE_UINT);
00518                                           <span class="keywordflow">break</span>;
00519                                         <span class="keywordflow">case</span> 1:
00520                                           hdf5_datatype = H5Tcopy(H5T_NATIVE_FLOAT);
00521                                           <span class="keywordflow">break</span>;
00522                                         <span class="keywordflow">case</span> 2:
00523                                           hdf5_datatype = H5Tcopy(H5T_NATIVE_UINT64);
00524                                           <span class="keywordflow">break</span>;
00525                                         }
00526 
00527                                       H5Dread(hdf5_dataset, hdf5_datatype, hdf5_dataspace_in_memory,
00528                                               hdf5_dataspace_in_file, H5P_DEFAULT, <a class="code" href="allvars_8c.html#a49">CommBuffer</a>);
00529 
00530                                       H5Tclose(hdf5_datatype);
00531                                       H5Sclose(hdf5_dataspace_in_memory);
00532                                       H5Sclose(hdf5_dataspace_in_file);
00533                                       H5Dclose(hdf5_dataset);
00534                                     }
00535 <span class="preprocessor">#endif</span>
00536 <span class="preprocessor"></span>                                }
00537 
00538                               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == readTask &amp;&amp; task != readTask)
00539                                 MPI_Ssend(<a class="code" href="allvars_8c.html#a49">CommBuffer</a>, bytes_per_blockelement * pc, MPI_BYTE, task, <a class="code" href="tags_8h.html#a2">TAG_PDATA</a>,
00540                                           MPI_COMM_WORLD);
00541 
00542                               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> != readTask &amp;&amp; task == ThisTask)
00543                                 MPI_Recv(<a class="code" href="allvars_8c.html#a49">CommBuffer</a>, bytes_per_blockelement * pc, MPI_BYTE, readTask,
00544                                          <a class="code" href="tags_8h.html#a2">TAG_PDATA</a>, MPI_COMM_WORLD, &amp;status);
00545 
00546                               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == task)
00547                                 {
00548                                   <a class="code" href="read__ic_8c.html#a3">empty_read_buffer</a>(blocknr, nstart + offset, pc, type);
00549 
00550                                   offset += pc;
00551                                 }
00552 
00553                               n_for_this_task -= pc;
00554                             }
00555                           <span class="keywordflow">while</span>(n_for_this_task &gt; 0);
00556                         }
00557                     }
00558                 }
00559               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == readTask)
00560                 {
00561                   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 1 || <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 2)
00562                     {
00563                       SKIP2;
00564                       <span class="keywordflow">if</span>(blksize1 != blksize2)
00565                         {
00566                           printf(<span class="stringliteral">"incorrect block-sizes detected!\n"</span>);
00567                           printf(<span class="stringliteral">"Task=%d   blocknr=%d  blksize1=%d  blksize2=%d\n"</span>, <a class="code" href="allvars_8c.html#a0">ThisTask</a>, blocknr,
00568                                  blksize1, blksize2);
00569                           fflush(stdout);
00570                           <a class="code" href="proto_8h.html#a38">endrun</a>(1889);
00571                         }
00572                     }
00573                 }
00574             }
00575         }
00576     }
00577 
00578 
00579   <span class="keywordflow">for</span>(type = 0; type &lt; 6; type++)
00580     {
00581       n_in_file = <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[type];
00582 
00583       n_for_this_task = n_in_file / ntask;
00584       <span class="keywordflow">if</span>((<a class="code" href="allvars_8c.html#a0">ThisTask</a> - readTask) &lt; (n_in_file % ntask))
00585         n_for_this_task++;
00586 
00587       <a class="code" href="allvars_8c.html#a3">NumPart</a> += n_for_this_task;
00588 
00589       <span class="keywordflow">if</span>(type == 0)
00590         <a class="code" href="allvars_8c.html#a4">N_gas</a> += n_for_this_task;
00591     }
00592 
00593   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == readTask)
00594     {
00595       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 1 || <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 2)
00596         fclose(fd);
00597 <span class="preprocessor">#ifdef HAVE_HDF5</span>
00598 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 3)
00599         {
00600           <span class="keywordflow">for</span>(type = 5; type &gt;= 0; type--)
00601             <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>[type] &gt; 0)
00602               H5Gclose(hdf5_grp[type]);
00603           H5Fclose(hdf5_file);
00604         }
00605 <span class="preprocessor">#endif</span>
00606 <span class="preprocessor"></span>    }
00607 }
00608 
00609 
00610 
00611 
00615 <span class="keywordtype">int</span> <a class="code" href="read__ic_8c.html#a5">find_files</a>(<span class="keywordtype">char</span> *fname)
<a name="l00616"></a><a class="code" href="read__ic_8c.html#a5">00616</a> {
00617   FILE *fd;
00618   <span class="keywordtype">char</span> buf[200], buf1[200];
00619   <span class="keywordtype">int</span> dummy;
00620 
00621   sprintf(buf, <span class="stringliteral">"%s.%d"</span>, fname, 0);
00622   sprintf(buf1, <span class="stringliteral">"%s"</span>, fname);
00623 
00624   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 3)
00625     {
00626       sprintf(buf, <span class="stringliteral">"%s.%d.hdf5"</span>, fname, 0);
00627       sprintf(buf1, <span class="stringliteral">"%s.hdf5"</span>, fname);
00628     }
00629 
00630 <span class="preprocessor">#ifndef  HAVE_HDF5</span>
00631 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 3)
00632     {
00633       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00634         printf(<span class="stringliteral">"Code wasn't compiled with HDF5 support enabled!\n"</span>);
00635       <a class="code" href="proto_8h.html#a38">endrun</a>(0);
00636     }
00637 <span class="preprocessor">#endif</span>
00638 <span class="preprocessor"></span>
00639   <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o8">num_files</a> = 0;
00640 
00641   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00642     {
00643       <span class="keywordflow">if</span>((fd = fopen(buf, <span class="stringliteral">"r"</span>)))
00644         {
00645           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 1 || <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 2)
00646             {
00647               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 2)
00648                 {
00649                   fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
00650                   fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
00651                   fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
00652                   fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
00653                 }
00654 
00655               fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
00656               fread(&amp;<a class="code" href="allvars_8c.html#a63">header</a>, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8c.html#a63">header</a>), 1, fd);
00657               fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
00658             }
00659           fclose(fd);
00660 
00661 <span class="preprocessor">#ifdef HAVE_HDF5</span>
00662 <span class="preprocessor"></span>          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 3)
00663             <a class="code" href="read__ic_8c.html#a7">read_header_attributes_in_hdf5</a>(buf);
00664 <span class="preprocessor">#endif</span>
00665 <span class="preprocessor"></span>        }
00666     }
00667 
00668   MPI_Bcast(&amp;<a class="code" href="allvars_8c.html#a63">header</a>, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8c.html#a63">header</a>), MPI_BYTE, 0, MPI_COMM_WORLD);
00669 
00670   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o8">num_files</a> &gt; 0)
00671     <span class="keywordflow">return</span> <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o8">num_files</a>;
00672 
00673   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00674     {
00675       <span class="keywordflow">if</span>((fd = fopen(buf1, <span class="stringliteral">"r"</span>)))
00676         {
00677           <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 1 || <a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 2)
00678             {
00679               <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 2)
00680                 {
00681                   fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
00682                   fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
00683                   fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
00684                   fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
00685                 }
00686 
00687               fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
00688               fread(&amp;<a class="code" href="allvars_8c.html#a63">header</a>, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8c.html#a63">header</a>), 1, fd);
00689               fread(&amp;dummy, <span class="keyword">sizeof</span>(dummy), 1, fd);
00690             }
00691           fclose(fd);
00692 
00693 <span class="preprocessor">#ifdef HAVE_HDF5</span>
00694 <span class="preprocessor"></span>          <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a50">All</a>.<a class="code" href="structglobal__data__all__processes.html#o5">ICFormat</a> == 3)
00695             <a class="code" href="read__ic_8c.html#a7">read_header_attributes_in_hdf5</a>(buf1);
00696 <span class="preprocessor">#endif</span>
00697 <span class="preprocessor"></span>          <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o8">num_files</a> = 1;
00698         }
00699     }
00700 
00701   MPI_Bcast(&amp;<a class="code" href="allvars_8c.html#a63">header</a>, <span class="keyword">sizeof</span>(<a class="code" href="allvars_8c.html#a63">header</a>), MPI_BYTE, 0, MPI_COMM_WORLD);
00702 
00703   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o8">num_files</a> &gt; 0)
00704     <span class="keywordflow">return</span> <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o8">num_files</a>;
00705 
00706   <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> == 0)
00707     {
00708       printf(<span class="stringliteral">"\nCan't find initial conditions file."</span>);
00709       printf(<span class="stringliteral">"neither as '%s'\nnor as '%s'\n"</span>, buf, buf1);
00710       fflush(stdout);
00711     }
00712 
00713   <a class="code" href="proto_8h.html#a38">endrun</a>(0);
00714   <span class="keywordflow">return</span> 0;
00715 }
00716 
00717 
00718 
00724 <span class="keywordtype">void</span> <a class="code" href="read__ic_8c.html#a6">distribute_file</a>(<span class="keywordtype">int</span> nfiles, <span class="keywordtype">int</span> firstfile, <span class="keywordtype">int</span> firsttask, <span class="keywordtype">int</span> lasttask, <span class="keywordtype">int</span> *filenr, <span class="keywordtype">int</span> *master,
<a name="l00725"></a><a class="code" href="read__ic_8c.html#a6">00725</a>                      <span class="keywordtype">int</span> *last)
00726 {
00727   <span class="keywordtype">int</span> ntask, filesleft, filesright, tasksleft, tasksright;
00728 
00729   <span class="keywordflow">if</span>(nfiles &gt; 1)
00730     {
00731       ntask = lasttask - firsttask + 1;
00732 
00733       filesleft = (((double) (ntask / 2)) / ntask) * nfiles;
00734       <span class="keywordflow">if</span>(filesleft &lt;= 0)
00735         filesleft = 1;
00736       <span class="keywordflow">if</span>(filesleft &gt;= nfiles)
00737         filesleft = nfiles - 1;
00738 
00739       filesright = nfiles - filesleft;
00740 
00741       tasksleft = ntask / 2;
00742       tasksright = ntask - tasksleft;
00743 
00744       <a class="code" href="read__ic_8c.html#a6">distribute_file</a>(filesleft, firstfile, firsttask, firsttask + tasksleft - 1, filenr, master, last);
00745       <a class="code" href="read__ic_8c.html#a6">distribute_file</a>(filesright, firstfile + filesleft, firsttask + tasksleft, lasttask, filenr, master,
00746                       last);
00747     }
00748   <span class="keywordflow">else</span>
00749     {
00750       <span class="keywordflow">if</span>(<a class="code" href="allvars_8c.html#a0">ThisTask</a> &gt;= firsttask &amp;&amp; <a class="code" href="allvars_8c.html#a0">ThisTask</a> &lt;= lasttask)
00751         {
00752           *filenr = firstfile;
00753           *master = firsttask;
00754           *last = lasttask;
00755         }
00756     }
00757 }
00758 
00759 
00763 <span class="preprocessor">#ifdef HAVE_HDF5</span>
00764 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="read__ic_8c.html#a7">read_header_attributes_in_hdf5</a>(<span class="keywordtype">char</span> *fname)
<a name="l00765"></a><a class="code" href="read__ic_8c.html#a7">00765</a> {
00766   hid_t hdf5_file, hdf5_headergrp, hdf5_attribute;
00767 
00768 
00769   hdf5_file = H5Fopen(fname, H5F_ACC_RDONLY, H5P_DEFAULT);
00770   hdf5_headergrp = H5Gopen(hdf5_file, <span class="stringliteral">"/Header"</span>);
00771 
00772 
00773   hdf5_attribute = H5Aopen_name(hdf5_headergrp, <span class="stringliteral">"NumPart_ThisFile"</span>);
00774   H5Aread(hdf5_attribute, H5T_NATIVE_INT, <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o0">npart</a>);
00775   H5Aclose(hdf5_attribute);
00776 
00777   hdf5_attribute = H5Aopen_name(hdf5_headergrp, <span class="stringliteral">"NumPart_Total"</span>);
00778   H5Aread(hdf5_attribute, H5T_NATIVE_UINT, <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o6">npartTotal</a>);
00779   H5Aclose(hdf5_attribute);
00780 
00781   hdf5_attribute = H5Aopen_name(hdf5_headergrp, <span class="stringliteral">"NumPart_Total_HighWord"</span>);
00782   H5Aread(hdf5_attribute, H5T_NATIVE_UINT, <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o15">npartTotalHighWord</a>);
00783   H5Aclose(hdf5_attribute);
00784 
00785   hdf5_attribute = H5Aopen_name(hdf5_headergrp, <span class="stringliteral">"MassTable"</span>);
00786   H5Aread(hdf5_attribute, H5T_NATIVE_DOUBLE, <a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o1">mass</a>);
00787   H5Aclose(hdf5_attribute);
00788 
00789   hdf5_attribute = H5Aopen_name(hdf5_headergrp, <span class="stringliteral">"Time"</span>);
00790   H5Aread(hdf5_attribute, H5T_NATIVE_DOUBLE, &amp;<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o2">time</a>);
00791   H5Aclose(hdf5_attribute);
00792 
00793   hdf5_attribute = H5Aopen_name(hdf5_headergrp, <span class="stringliteral">"NumFilesPerSnapshot"</span>);
00794   H5Aread(hdf5_attribute, H5T_NATIVE_INT, &amp;<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o8">num_files</a>);
00795   H5Aclose(hdf5_attribute);
00796 
00797   hdf5_attribute = H5Aopen_name(hdf5_headergrp, <span class="stringliteral">"Flag_Entropy_ICs"</span>);
00798   H5Aread(hdf5_attribute, H5T_NATIVE_INT, &amp;<a class="code" href="allvars_8c.html#a63">header</a>.<a class="code" href="structio__header.html#o16">flag_entropy_instead_u</a>);
00799   H5Aclose(hdf5_attribute);
00800 
00801   H5Gclose(hdf5_headergrp);
00802   H5Fclose(hdf5_file);
00803 }
00804 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Apr 22 15:29:41 2006 for GADGET-2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
